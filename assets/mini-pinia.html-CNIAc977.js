import{_ as t}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as e,o as p,c as o,a as n,b as s,d as c,e as i}from"./app-qRgzBIvm.js";const l="data:image/png;base64,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",u="/dcblog/assets/image-20230614220822579-jQDgoxyE.png",r={},k=n("h1",{id:"实现mini-pinia",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#实现mini-pinia"},[n("span",null,"实现mini-Pinia")])],-1),d={href:"https://juejin.cn/post/6855474001838342151",target:"_blank",rel:"noopener noreferrer"},v=i(`<h2 id="一、pinia基础使用" tabindex="-1"><a class="header-anchor" href="#一、pinia基础使用"><span>一、Pinia基础使用</span></a></h2><h3 id="_1-vue3-vite安装" tabindex="-1"><a class="header-anchor" href="#_1-vue3-vite安装"><span>1. vue3+vite安装</span></a></h3><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">npm</span> create vite@latest 或 <span class="token function">npm</span> create vue3_pinia
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>根据提示输入项目名称创建脚手架，选择Vue+Typescript，保证能够正确运行</p><h3 id="_2-pinia安装与使用" tabindex="-1"><a class="header-anchor" href="#_2-pinia安装与使用"><span>2. pinia安装与使用</span></a></h3><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> pinia
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>项目根目录按照上述方式安装pinia</p><h3 id="_3-main-ts注入use" tabindex="-1"><a class="header-anchor" href="#_3-main-ts注入use"><span>3. main.ts注入use</span></a></h3><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token string">&#39;./style.css&#39;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&#39;./App.vue&#39;</span>
<span class="token comment">//引入createPinia()</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createPinia<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>

<span class="token keyword">const</span> pinia <span class="token operator">=</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//注册pinia</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>pinia<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-创建pinia模块" tabindex="-1"><a class="header-anchor" href="#_4-创建pinia模块"><span>4. 创建Pinia模块</span></a></h3><p>常规操作时在src文件夹下创建一个store文件夹专门用来管理pinia模块，在这个文件夹下可以创建多个js和ts模块。</p><figure><img src="`+l+`" alt="image-20230613223249677" tabindex="0" loading="lazy"><figcaption>image-20230613223249677</figcaption></figure><h3 id="_5-index-ts" tabindex="-1"><a class="header-anchor" href="#_5-index-ts"><span>5. index.ts</span></a></h3><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;pinia&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;storeId&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">state</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Eduardo&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">isAdmin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">getters</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token function">counterPar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;getter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">actions</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token function">changeCounter</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">+=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-在组件中使用pinia" tabindex="-1"><a class="header-anchor" href="#_6-在组件中使用pinia"><span>6. 在组件中使用pinia</span></a></h3><div class="language-vue line-numbers-mode" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>state值：{{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>getter值：{{store.counterPar}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>actions值：{{newStore}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">//引入store</span>
    <span class="token keyword">import</span> <span class="token punctuation">{</span> useStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../store&#39;</span>
    <span class="token comment">//创建store对象</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//结构name</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> store<span class="token punctuation">.</span>name
    <span class="token comment">//调用actions</span>
    <span class="token keyword">const</span> newStore <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">changeCounter</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-最终显示" tabindex="-1"><a class="header-anchor" href="#_7-最终显示"><span>7. 最终显示</span></a></h3><figure><img src="`+u+`" alt="image-20230614220822579" tabindex="0" loading="lazy"><figcaption>image-20230614220822579</figcaption></figure><h3 id="_8-需求总结" tabindex="-1"><a class="header-anchor" href="#_8-需求总结"><span>8. 需求总结</span></a></h3><p><strong>1.pinia 可以解构操作的有两个数据（createPinia）（defineStore），都是函数</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2.createPinia返回一个pinia对象</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> pinia对象
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3.defineStore返回一个useStore()函数</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">userStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> userStore
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>4.useStore返回store存储数据对象</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">userStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> store对象<span class="token comment">//所有状态机的数据state函数返回，（副作用-getters和actions）</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> userStore
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="二、实现createpinia" tabindex="-1"><a class="header-anchor" href="#二、实现createpinia"><span>二、实现createPinia</span></a></h2><p><code>createPinia</code>返回的是一个pinia对象，首先我们需要构造一个这样的对象并返回。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> piniaStore <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> piniaStore
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回的pinia对象可以通过<code>app.use</code>进行注册，我们知道注册时实际执行的是对象内的install方法，因此还需要实现一个<code>install</code>函数。</p><p>在vue2中使用<code>Vue.use</code>注册插件时，大多会将额外需要的数据和方法挂载到组件实例中，如vuex或vue-router中实现的那样，先将其实例作为options在Vue实例化时作为参数传入，然后利用钩子函数和组件间的父子关系挂载到每个组件的实例上，如下所示：</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">let</span> <span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>store<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 如果是根组件</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>store
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果是子组件</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$store
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而在vue3中因为不存在vue实例，所以需要新的全局挂载方式。全局化方法有两种写法：</p><ul><li>注入注册操作<code>provide-inject</code>。这种方式可以让vue3的所有组件都通过使用<code>app.inject(&quot;key&quot;)</code>来访问到注入的piniaStore。</li><li><code>config.globalProperties</code>。兼容vue2的组件实例共享模式</li></ul><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> piniaStore <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>piniaSymbol<span class="token punctuation">,</span> piniaStore<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$pinia <span class="token operator">=</span> piniaStore<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> piniaStore
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后在pinia对象上新建一个stores对象来维护所有defineStore返回的函数创建的store对象。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> piniaSymbol <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./piniaSymbol&#39;</span><span class="token punctuation">;</span> <span class="token comment">// piniaSymbol = Symbol()</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> piniaStore <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">_stores</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//存放所有store对象的位置</span>
        <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//初始化一个state对象，后续会完成计算属性和对象的使用</span>

        <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>piniaSymbol<span class="token punctuation">,</span> piniaStore<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$pinia <span class="token operator">=</span> piniaStore<span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;createPinia正常运行&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 方便观察</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> piniaStore<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>state</code> 是一个对象，保存的是所有 store 的状态数据。它的主要作用包括：</p><ul><li><p><strong>集中管理状态数据</strong> ：将所有 store 的状态数据集中在一个地方，方便统一管理和调试。</p></li><li><p><strong>响应式状态</strong>：Vue 的响应式系统会自动追踪 <code>state</code> 对象的变化，使得应用在状态变化时能够自动更新视图。</p></li><li><p><strong>快照和持久化</strong>：因为所有的状态数据都集中在 <code>state</code> 对象里，所以可以很容易地实现状态的快照和恢复功能，也可以将整个状态对象持久化保存并在页面刷新时恢复。</p></li></ul><p>为什么有了<code>_stores</code>还需要state对象？</p><ul><li><strong>分工明确</strong>：<code>_stores</code> 用于管理 store 实例，<code>state</code> 用于管理状态数据。这样分工明确，各自处理不同的职责。</li><li><strong>提高性能</strong>：<code>_stores</code> 采用 <code>Map</code> 数据结构，查找速度快，适合存放大量 store 实例。<code>state</code> 是一个普通对象，更加直观且易于响应式管理。</li><li><strong>解耦合</strong>：<code>_stores</code> 和 <code>state</code> 分开存储有助于解耦逻辑，使得管理 store 实例和状态数据的逻辑彼此独立，减少相互影响。</li></ul><h2 id="三、实现definestore" tabindex="-1"><a class="header-anchor" href="#三、实现definestore"><span>三、实现defineStore</span></a></h2><h3 id="_1-基本结构" tabindex="-1"><a class="header-anchor" href="#_1-基本结构"><span>1. 基本结构</span></a></h3><p><code>defineStore</code>返回一个函数，此函数执行会返回对应的store对象，习惯上我们会将此函数命名为<code>use{Name}Store</code>。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//返回函数</span>
  <span class="token keyword">function</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> useStore<span class="token punctuation">;</span> <span class="token comment">//用户使用这个函数就能获取 store实例对象</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-参数情况" tabindex="-1"><a class="header-anchor" href="#_2-参数情况"><span>2. 参数情况</span></a></h3><p>defineStore接受三种传参方式</p><ul><li><p>第一种是传入id+options</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;stroeId&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;jack chen&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">increment</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">+</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">getters</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">doubleAge</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>age <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>第二种是只传入options（而id包含在这个options内部），options是对象</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;storeId&#39;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;alice&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">increment</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">+</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">getters</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">doubleAge</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>age <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>第三种是传入id+setup函数</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> useStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">&#39;storedId&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&#39;jack&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">changeCounter</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    age<span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> age<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> age10 <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> age<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    age<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    changeCounter<span class="token punctuation">,</span>
    age10<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>首先需要根据传入参数的情况进行参数归一化，如下所示：</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> computed<span class="token punctuation">,</span> getCurrentInstance<span class="token punctuation">,</span> inject<span class="token punctuation">,</span> isReactive<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> isRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> piniaSymbol <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./piniaSymbol&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token parameter">idOrOptions<span class="token punctuation">,</span> optionsOrSetup</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//单独定义id和Options</span>
    <span class="token keyword">let</span> id<span class="token punctuation">,</span> options<span class="token punctuation">;</span>
    <span class="token comment">//接受和处理第一个参数,id:string,options:object</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> idOrOptions <span class="token operator">==</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> idOrOptions<span class="token punctuation">;</span>
        options <span class="token operator">=</span> optionsOrSetup<span class="token punctuation">;</span> <span class="token comment">//对象或函数</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        options <span class="token operator">=</span> idOrOptions<span class="token punctuation">;</span> <span class="token comment">//对象</span>
        id <span class="token operator">=</span> options<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//当前组件实例是否存在</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取当前组件实例</span>
        <span class="token keyword">let</span> piniaStore <span class="token operator">=</span> instance <span class="token operator">&amp;&amp;</span> <span class="token function">inject</span><span class="token punctuation">(</span>piniaSymbol<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果当前组件实例存在就注入整个piniaStore(因为只有在vue组件里才可以使用inject)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>piniaStore<span class="token punctuation">.</span>_stores<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果在piniastore的map中没有对应的id，则表示需要新建，如果已经存在则只需要返回数据</span>
            <span class="token comment">//录入新的数据（state,actions,getters）包含的对象一起放入map中</span>
            <span class="token comment">//id不存在则添加的是options数据</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> optionsOrSetup <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//传入进来的是一个函数</span>
                <span class="token comment">//将对应的id里的options，放置到piniaStore</span>
                <span class="token function">createSetupStore</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> optionsOrSetup<span class="token punctuation">,</span> piniaStore<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//函数形式</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//前两种传参方式都用这个来解构store</span>
                <span class="token comment">//将对应的id里的options，放置到piniaStore</span>
                <span class="token function">createOptionsStore</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> options<span class="token punctuation">,</span> piniaStore<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//对象形式</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> piniaStore<span class="token punctuation">.</span>_stores<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取目前use的这个store</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> useStore<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-createsetupstore" tabindex="-1"><a class="header-anchor" href="#_3-createsetupstore"><span>3. createSetupStore</span></a></h3><p>createSetupStore的第四个参数表示此store是否通过options调用所创建。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">//处理函数式defineStore</span>
<span class="token keyword">function</span> <span class="token function">createSetupStore</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> setup<span class="token punctuation">,</span> piniaStore<span class="token punctuation">,</span> isOptionsStore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//建立一个将来返回数据的响应式对象</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//执行setup函数，返回一个包含state,actions,getters的对象</span>
    <span class="token keyword">const</span> setupStore <span class="token operator">=</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//遍历一个store里所有的属性，做进一步处理</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> setupStore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> prop <span class="token operator">=</span> setupStore<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.处理actions</span>
        <span class="token comment">// 改变函数的指向问题</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> prop <span class="token operator">==</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            setupStore<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">wrapAction</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.处理state</span>
        <span class="token comment">// 如果是setup函数，则把里面的state存到全局state中去</span>
        <span class="token comment">// createOptionStore 直接在 pinia.state.value 中设置状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isComputed</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isReactive</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果它是ref或者reactive则说明他是state</span>
            <span class="token comment">// 由于computed也是ref，所以要排除计算属性</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isOptionsStore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                piniaStore<span class="token punctuation">.</span>state<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> prop<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//判断计算属性，ref，同时也是一个effect</span>
    <span class="token keyword">function</span> <span class="token function">isComputed</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">isRef</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>effect
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">wrapAction</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> setupStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    piniaStore<span class="token punctuation">.</span>_stores<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-createoptionsstore" tabindex="-1"><a class="header-anchor" href="#_4-createoptionsstore"><span>4. createOptionsStore</span></a></h3><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// defineStore传入options时调用这个函数</span>
<span class="token keyword">function</span> <span class="token function">createOptionsStore</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> options<span class="token punctuation">,</span> piniaStore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> state<span class="token punctuation">,</span> actions<span class="token punctuation">,</span> getters <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span> <span class="token comment">//解构当前的对象数据</span>

  <span class="token keyword">function</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 专门处理store里的state,actions,getters</span>
    piniaStore<span class="token punctuation">.</span>state<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> state <span class="token operator">?</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">//将解构出的state存入到全局state对象中</span>
    <span class="token keyword">const</span> localState <span class="token operator">=</span> piniaStore<span class="token punctuation">.</span>state<span class="token punctuation">[</span>id<span class="token punctuation">]</span> 

    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>
      localState<span class="token punctuation">,</span>
      actions<span class="token punctuation">,</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>getters<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">computedGetters<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        computedGetters<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">//获取当前store的指向</span>
          <span class="token keyword">let</span> store <span class="token operator">=</span> piniaStore<span class="token punctuation">.</span>_stores<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> getters<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> store<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> computedGetters<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token function">createSetupStore</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> setup<span class="token punctuation">,</span> piniaStore<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,56);function m(b,g){const a=e("ExternalLinkIcon");return p(),o("div",null,[k,n("blockquote",null,[n("p",null,[s("vuex的基本原理参考："),n("a",d,[s("手写vuex原理"),c(a)])])]),v])}const h=t(r,[["render",m],["__file","mini-pinia.html.vue"]]),w=JSON.parse('{"path":"/source_code/vue_related/mini-pinia.html","title":"实现mini-Pinia","lang":"zh-CN","frontmatter":{"description":"实现mini-Pinia vuex的基本原理参考：手写vuex原理 一、Pinia基础使用 1. vue3+vite安装 根据提示输入项目名称创建脚手架，选择Vue+Typescript，保证能够正确运行 2. pinia安装与使用 项目根目录按照上述方式安装pinia 3. main.ts注入use 4. 创建Pinia模块 常规操作时在src文件夹...","head":[["meta",{"property":"og:url","content":"https://github.com/dcblog/source_code/vue_related/mini-pinia.html"}],["meta",{"property":"og:site_name","content":"dcBlog"}],["meta",{"property":"og:title","content":"实现mini-Pinia"}],["meta",{"property":"og:description","content":"实现mini-Pinia vuex的基本原理参考：手写vuex原理 一、Pinia基础使用 1. vue3+vite安装 根据提示输入项目名称创建脚手架，选择Vue+Typescript，保证能够正确运行 2. pinia安装与使用 项目根目录按照上述方式安装pinia 3. main.ts注入use 4. 创建Pinia模块 常规操作时在src文件夹..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-08-29T16:36:49.000Z"}],["meta",{"property":"article:author","content":"Dachao"}],["meta",{"property":"article:modified_time","content":"2024-08-29T16:36:49.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"实现mini-Pinia\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-08-29T16:36:49.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Dachao\\",\\"email\\":\\"wyc168hard@163.com\\"}]}"]]},"headers":[{"level":2,"title":"一、Pinia基础使用","slug":"一、pinia基础使用","link":"#一、pinia基础使用","children":[{"level":3,"title":"1. vue3+vite安装","slug":"_1-vue3-vite安装","link":"#_1-vue3-vite安装","children":[]},{"level":3,"title":"2. pinia安装与使用","slug":"_2-pinia安装与使用","link":"#_2-pinia安装与使用","children":[]},{"level":3,"title":"3. main.ts注入use","slug":"_3-main-ts注入use","link":"#_3-main-ts注入use","children":[]},{"level":3,"title":"4. 创建Pinia模块","slug":"_4-创建pinia模块","link":"#_4-创建pinia模块","children":[]},{"level":3,"title":"5. index.ts","slug":"_5-index-ts","link":"#_5-index-ts","children":[]},{"level":3,"title":"6. 在组件中使用pinia","slug":"_6-在组件中使用pinia","link":"#_6-在组件中使用pinia","children":[]},{"level":3,"title":"7. 最终显示","slug":"_7-最终显示","link":"#_7-最终显示","children":[]},{"level":3,"title":"8. 需求总结","slug":"_8-需求总结","link":"#_8-需求总结","children":[]}]},{"level":2,"title":"二、实现createPinia","slug":"二、实现createpinia","link":"#二、实现createpinia","children":[]},{"level":2,"title":"三、实现defineStore","slug":"三、实现definestore","link":"#三、实现definestore","children":[{"level":3,"title":"1. 基本结构","slug":"_1-基本结构","link":"#_1-基本结构","children":[]},{"level":3,"title":"2. 参数情况","slug":"_2-参数情况","link":"#_2-参数情况","children":[]},{"level":3,"title":"3. createSetupStore","slug":"_3-createsetupstore","link":"#_3-createsetupstore","children":[]},{"level":3,"title":"4. createOptionsStore","slug":"_4-createoptionsstore","link":"#_4-createoptionsstore","children":[]}]}],"git":{"createdTime":1724949409000,"updatedTime":1724949409000,"contributors":[{"name":"dachao","email":"1114686398@qq.com","commits":1}]},"readingTime":{"minutes":6.69,"words":2008},"filePathRelative":"source_code/vue_related/mini-pinia.md","localizedDate":"2024年8月29日","excerpt":"\\n<blockquote>\\n<p>vuex的基本原理参考：<a href=\\"https://juejin.cn/post/6855474001838342151\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">手写vuex原理</a></p>\\n</blockquote>\\n<h2>一、Pinia基础使用</h2>\\n<h3>1. vue3+vite安装</h3>\\n<div class=\\"language-bash\\" data-ext=\\"sh\\" data-title=\\"sh\\"><pre class=\\"language-bash\\"><code><span class=\\"token function\\">npm</span> create vite@latest 或 <span class=\\"token function\\">npm</span> create vue3_pinia\\n</code></pre></div>","autoDesc":true}');export{h as comp,w as data};
