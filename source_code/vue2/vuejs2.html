<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.8" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.31" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://github.com/dcBlog/source_code/vue2/vuejs2.html"><meta property="og:site_name" content="dcBlog"><meta property="og:title" content="vue2æºç ç†è§£ï¼ˆæ€»è§ˆç¯‡ï¼‰"><meta property="og:description" content="ç›®å½•ç»“æ„ æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒVueå®é™…ä¸Šå®Œæˆäº†ä¸¤ä»¶äº‹ï¼Œ ç»„ä»¶åŒ– å’Œ å“åº”å¼ ã€‚ å“åº”å¼ä½¿æˆ‘ä»¬æ›´åŠ å…³æ³¨äºæ•°æ®çš„å˜åŒ–ï¼Œç”±Vueè‡ªèº«æ¥æ ¹æ®æ•°æ®å˜åŒ–é©±åŠ¨è§†å›¾æ›´æ–°ã€‚ç»„ä»¶åŒ–ä¸­åŒ…å«äº† æ¨¡æ¿ç¼–è¯‘ ï¼Œ Diffç®—æ³• ï¼Œ æ¸²æŸ“å™¨ ç­‰å†…å®¹ã€‚ template ==> render ==> VNode ==> DOM ä¸€ã€å“åº”å¼ è¦æƒ³å®ç°å“åº”å¼ï¼Œæœ‰ä¸¤ä¸ªå…³é”®æ€§çš„é—®é¢˜ï¼Œä¸€ä¸ªæ˜¯ æ—¶æœº ..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-20T09:24:35.000Z"><meta property="article:author" content="Dachao"><meta property="article:modified_time" content="2024-03-20T09:24:35.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"vue2æºç ç†è§£ï¼ˆæ€»è§ˆç¯‡ï¼‰","image":[""],"dateModified":"2024-03-20T09:24:35.000Z","author":[{"@type":"Person","name":"Dachao","email":"wyc168hard@163.com"}]}</script><link rel="icon" href="/dcBlog/favicon.ico"><link rel="icon" href="/dcBlog/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/dcBlog/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/dcBlog/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/dcBlog/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/dcBlog/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/dcBlog/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/dcBlog/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><title>vue2æºç ç†è§£ï¼ˆæ€»è§ˆç¯‡ï¼‰ | dcBlog</title><meta name="description" content="ç›®å½•ç»“æ„ æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒVueå®é™…ä¸Šå®Œæˆäº†ä¸¤ä»¶äº‹ï¼Œ ç»„ä»¶åŒ– å’Œ å“åº”å¼ ã€‚ å“åº”å¼ä½¿æˆ‘ä»¬æ›´åŠ å…³æ³¨äºæ•°æ®çš„å˜åŒ–ï¼Œç”±Vueè‡ªèº«æ¥æ ¹æ®æ•°æ®å˜åŒ–é©±åŠ¨è§†å›¾æ›´æ–°ã€‚ç»„ä»¶åŒ–ä¸­åŒ…å«äº† æ¨¡æ¿ç¼–è¯‘ ï¼Œ Diffç®—æ³• ï¼Œ æ¸²æŸ“å™¨ ç­‰å†…å®¹ã€‚ template ==> render ==> VNode ==> DOM ä¸€ã€å“åº”å¼ è¦æƒ³å®ç°å“åº”å¼ï¼Œæœ‰ä¸¤ä¸ªå…³é”®æ€§çš„é—®é¢˜ï¼Œä¸€ä¸ªæ˜¯ æ—¶æœº ...">
    <link rel="preload" href="/dcBlog/assets/style-CAOcJs_8.css" as="style"><link rel="stylesheet" href="/dcBlog/assets/style-CAOcJs_8.css">
    <link rel="modulepreload" href="/dcBlog/assets/app-DDDGjlek.js"><link rel="modulepreload" href="/dcBlog/assets/vuejs2.html-CGptif4R.js"><link rel="modulepreload" href="/dcBlog/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/dcBlog/"><img class="vp-nav-logo" src="/dcBlog/logo.png" alt><!----><span class="vp-site-name hide-in-pad">dcBlog</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcBlog/" aria-label="ä¸»é¡µ"><span class="font-icon icon iconfont icon-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcBlog/basic_language/" aria-label="è¯­è¨€åŸºç¡€"><span class="font-icon icon iconfont icon-code" style=""></span>è¯­è¨€åŸºç¡€<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link active" href="/dcBlog/source_code/" aria-label="æºç è§£æ"><span class="font-icon icon iconfont icon-read" style=""></span>æºç è§£æ<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcBlog/Server/" aria-label="æœåŠ¡ç«¯"><span class="font-icon icon iconfont icon-back-stage" style=""></span>æœåŠ¡ç«¯<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcBlog/Efficiency/" aria-label="æ•ˆç‡åä½œ"><span class="font-icon icon iconfont icon-group" style=""></span>æ•ˆç‡åä½œ<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcBlog/browser_internet/" aria-label="æµè§ˆå™¨é€šä¿¡"><span class="font-icon icon iconfont icon-network" style=""></span>æµè§ˆå™¨é€šä¿¡<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcBlog/algorithm/" aria-label="ç®—æ³•"><span class="font-icon icon iconfont icon-edit" style=""></span>ç®—æ³•<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcBlog/Project_50/" aria-label="é¡µé¢ç»ƒä¹ "><span class="font-icon icon iconfont icon-page" style=""></span>é¡µé¢ç»ƒä¹ <!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcBlog/paper/" aria-label="è®ºæ–‡è¯¾é¢˜"><span class="font-icon icon iconfont icon-study" style=""></span>è®ºæ–‡è¯¾é¢˜<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcBlog/reference/" aria-label="æ–‡æ¡£æ•™ç¨‹"><span class="font-icon icon iconfont icon-article" style=""></span>æ–‡æ¡£æ•™ç¨‹<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/dcbestwords/dcBlog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><span class="font-icon icon iconfont icon-lodash" style=""></span><a class="route-link nav-link vp-sidebar-title" href="/dcBlog/source_code/lodash/" aria-label="Lodash"><!---->Lodash<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcBlog/source_code/lodash/mock_get.html" aria-label="_.get() å‡½æ•°"><!---->_.get() å‡½æ•°<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><!----><a class="route-link nav-link vp-sidebar-title" href="/dcBlog/source_code/promise/" aria-label="promise"><!---->promise<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcBlog/source_code/promise/async.html" aria-label="asyncçš„å®ç°åŸç†"><!---->asyncçš„å®ç°åŸç†<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcBlog/source_code/promise/promise.html" aria-label="æ‰‹å†™promise"><!---->æ‰‹å†™promise<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable active"><span class="font-icon icon iconfont icon-vue" style=""></span><a class="route-link nav-link active vp-sidebar-title" href="/dcBlog/source_code/vue2/" aria-label="vue2"><!---->vue2<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcBlog/source_code/vue2/vuejs2_1.html" aria-label="Vue2æºç ï¼ˆåŠŸèƒ½ç¯‡ï¼‰"><!---->Vue2æºç ï¼ˆåŠŸèƒ½ç¯‡ï¼‰<!----></a></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/dcBlog/source_code/vue2/vuejs2.html" aria-label="vue2æºç ç†è§£ï¼ˆæ€»è§ˆç¯‡ï¼‰"><!---->vue2æºç ç†è§£ï¼ˆæ€»è§ˆç¯‡ï¼‰<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><span class="font-icon icon iconfont icon-vue" style=""></span><a class="route-link nav-link vp-sidebar-title" href="/dcBlog/source_code/vue3/" aria-label="vue3"><!---->vue3<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcBlog/source_code/vue3/vue3%E6%80%BB%E7%BB%93.html" aria-label="vue3å“åº”å¼æ€»ç»“"><!---->vue3å“åº”å¼æ€»ç»“<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcBlog/source_code/vue3/vuejs1-4.html" aria-label="vueçš„è®¾è®¡ä¸å®ç°ï¼ˆ1-4ç« ï¼‰"><!---->vueçš„è®¾è®¡ä¸å®ç°ï¼ˆ1-4ç« ï¼‰<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcBlog/source_code/vue3/vuejs5.html" aria-label="äº”ã€éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ"><!---->äº”ã€éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcBlog/source_code/vue3/vuejs6.html" aria-label="å…­ã€åŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ"><!---->å…­ã€åŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ<!----></a></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->vue2æºç ç†è§£ï¼ˆæ€»è§ˆç¯‡ï¼‰</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Dachao</span></span><span property="author" content="Dachao"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-19T13:13:32.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 55 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT55M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcBlog/#ä¸€ã€å“åº”å¼">ä¸€ã€å“åº”å¼</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_1-å¯¹è±¡çš„å“åº”å¼">1. å¯¹è±¡çš„å“åº”å¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_2-æ•°ç»„çš„å“åº”å¼">2. æ•°ç»„çš„å“åº”å¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_3-ç›¸å…³api">3. ç›¸å…³api</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcBlog/#äºŒã€diffç®—æ³•">äºŒã€Diffç®—æ³•</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_1-è™šæ‹Ÿdom">1. è™šæ‹ŸDOM</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_2-diffç®—æ³•">2. Diffç®—æ³•</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcBlog/#ä¸‰ã€æ¨¡æ¿ç¼–è¯‘">ä¸‰ã€æ¨¡æ¿ç¼–è¯‘</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_1-æ¨¡æ¿è§£æ">1. æ¨¡æ¿è§£æ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_2-ä¼˜åŒ–é˜¶æ®µ">2. ä¼˜åŒ–é˜¶æ®µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_3-ä»£ç ç”Ÿæˆ">3.ä»£ç ç”Ÿæˆ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcBlog/#å››ã€ç”Ÿå‘½å‘¨æœŸ">å››ã€ç”Ÿå‘½å‘¨æœŸ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_1-åˆå§‹åŒ–æ•´ä½“æµç¨‹">1. åˆå§‹åŒ–æ•´ä½“æµç¨‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_2-åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸ">2. åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_3-åˆå§‹åŒ–äº‹ä»¶">3. åˆå§‹åŒ–äº‹ä»¶</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_4-åˆå§‹åŒ–inject">4.  åˆå§‹åŒ–inject</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_5-åˆå§‹åŒ–state">5. åˆå§‹åŒ–State</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_6-æ¨¡æ¿ç¼–è¯‘">6. æ¨¡æ¿ç¼–è¯‘</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_7-æ¨¡æ¿æŒ‚è½½">7. æ¨¡æ¿æŒ‚è½½</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_8-é”€æ¯é˜¶æ®µ">8. é”€æ¯é˜¶æ®µ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcBlog/#äº”ã€å®ä¾‹æ–¹æ³•">äº”ã€å®ä¾‹æ–¹æ³•</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_1-æ•°æ®ç›¸å…³">1. æ•°æ®ç›¸å…³</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_2-äº‹ä»¶ç›¸å…³">2. äº‹ä»¶ç›¸å…³</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_3-ç”Ÿå‘½å‘¨æœŸç›¸å…³">3. ç”Ÿå‘½å‘¨æœŸç›¸å…³</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcBlog/#å…­ã€å…¨å±€api">å…­ã€å…¨å±€API</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_1-vue-use">1.  vue.use</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_2-vue-extend">2. vue.extend</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_3-vue-mixin">3. vue.mixin</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_4-vue-observable-object">4. Vue.observable( object )</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcBlog/#_5-directiveã€filterã€component">5. directiveã€filterã€component</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><p><strong>ç›®å½•ç»“æ„</strong></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>â”œâ”€src                    <span class="token comment"># é¡¹ç›®æºä»£ç </span>
â”‚    â”œâ”€complier          <span class="token comment"># ä¸æ¨¡æ¿ç¼–è¯‘ç›¸å…³çš„ä»£ç </span>
â”‚    â”œâ”€core              <span class="token comment"># é€šç”¨çš„ã€ä¸è¿è¡Œå¹³å°æ— å…³çš„è¿è¡Œæ—¶ä»£ç </span>
â”‚    â”‚  â”œâ”€observe        <span class="token comment"># å®ç°å˜åŒ–ä¾¦æµ‹çš„ä»£ç </span>
â”‚    â”‚  â”œâ”€vdom           <span class="token comment"># å®ç°virtual domçš„ä»£ç </span>
â”‚    â”‚  â”œâ”€instance       <span class="token comment"># Vue.jså®ä¾‹çš„æ„é€ å‡½æ•°å’ŒåŸå‹æ–¹æ³•</span>
â”‚    â”‚  â”œâ”€global-api     <span class="token comment"># å…¨å±€apiçš„ä»£ç </span>
â”‚    â”‚  â””â”€components     <span class="token comment"># å†…ç½®ç»„ä»¶çš„ä»£ç </span>
â”‚    â”œâ”€server            <span class="token comment"># ä¸æœåŠ¡ç«¯æ¸²æŸ“ç›¸å…³çš„ä»£ç </span>
â”‚    â”œâ”€platforms         <span class="token comment"># ç‰¹å®šè¿è¡Œå¹³å°çš„ä»£ç ï¼Œå¦‚weexsh</span>
â”‚    â”œâ”€sfc               <span class="token comment"># å•æ–‡ä»¶ç»„ä»¶çš„è§£æä»£ç </span>
â”‚    â””â”€shared            <span class="token comment"># é¡¹ç›®å…¬ç”¨çš„å·¥å…·ä»£ç </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒVueå®é™…ä¸Šå®Œæˆäº†ä¸¤ä»¶äº‹ï¼Œ <mark>ç»„ä»¶åŒ–</mark> å’Œ <mark>å“åº”å¼</mark> ã€‚</p><p>å“åº”å¼ä½¿æˆ‘ä»¬æ›´åŠ å…³æ³¨äºæ•°æ®çš„å˜åŒ–ï¼Œç”±Vueè‡ªèº«æ¥æ ¹æ®æ•°æ®å˜åŒ–é©±åŠ¨è§†å›¾æ›´æ–°ã€‚ç»„ä»¶åŒ–ä¸­åŒ…å«äº† <mark>æ¨¡æ¿ç¼–è¯‘</mark> ï¼Œ <mark>Diffç®—æ³•</mark> ï¼Œ <mark>æ¸²æŸ“å™¨</mark> ç­‰å†…å®¹ã€‚</p><figure><img src="/dcBlog/assets/1-BlOQ6Fhm.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>template ==&gt; render ==&gt; VNode ==&gt; DOM</code></p><h2 id="ä¸€ã€å“åº”å¼" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å“åº”å¼"><span>ä¸€ã€å“åº”å¼</span></a></h2><p>è¦æƒ³å®ç°å“åº”å¼ï¼Œæœ‰ä¸¤ä¸ªå…³é”®æ€§çš„é—®é¢˜ï¼Œä¸€ä¸ªæ˜¯ <mark>æ—¶æœº</mark> ï¼Œä¸€ä¸ªæ˜¯ <mark>å¯¹è±¡</mark> ã€‚å³æˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“æ•°æ®ä»€ä¹ˆæ—¶å€™å‘ç”Ÿå˜åŒ–ï¼Œå…¶æ¬¡è¦çŸ¥é“æ•°æ®å˜åŒ–æ—¶é€šçŸ¥å“ªéƒ¨åˆ†çš„è§†å›¾è¿›è¡Œæ›´æ–°ï¼ˆè°ç”¨åˆ°æ•°æ®æ›´æ–°è°ï¼‰ã€‚</p><h3 id="_1-å¯¹è±¡çš„å“åº”å¼" tabindex="-1"><a class="header-anchor" href="#_1-å¯¹è±¡çš„å“åº”å¼"><span>1. å¯¹è±¡çš„å“åº”å¼</span></a></h3><figure><img src="/dcBlog/assets/reactive-C77Xpxq3.png" alt="reactive" tabindex="0" loading="lazy"><figcaption>reactive</figcaption></figure><p>å½“ä¸ºæ·»åŠ äº†å“åº”å¼çš„å¯¹è±¡å±æ€§è®¾ç½®æ–°çš„å€¼æ—¶ï¼Œä¼šå–å‡º<code>prop.__ob__.dep</code>ä¸­çš„æ‰€æœ‰<code>watcher</code>å®ä¾‹ï¼Œé‡æ–°æ‰§è¡Œå…¶ä¸­çš„<code>expOrFn</code>ã€‚</p><blockquote><p>Observer(value)</p></blockquote><p><strong>åŠŸèƒ½</strong>ï¼š</p><ul><li>å®ä¾‹åŒ–æ—¶é€’å½’åœ°ä¸ºvalueå¯¹è±¡çš„æ¯ä¸ªå±æ€§æ·»åŠ <code>getter/setter</code>ï¼Œåœ¨<code>getter</code>ä¸­æ”¶é›†ä¾èµ–ï¼Œåœ¨<code>setter</code>ä¸­é€šçŸ¥ä¾èµ–æ›´æ–°ã€‚</li><li>ä¸ºvalueæ·»åŠ äº†<code>__ob__</code>å±æ€§ï¼ŒæŒ‡å‘åˆ›å»ºçš„<code>Observer</code>å®ä¾‹ï¼Œæ ‡è®°æ­¤æ•°æ®å·²ç»è½¬ä¸ºå“åº”å¼ã€‚</li></ul><p><strong>å®ä¾‹å±æ€§</strong>ï¼š</p><ul><li>valueï¼šè§‚å¯Ÿå¯¹è±¡ï¼›</li><li>depï¼šä¾èµ–ç®¡ç†å™¨</li><li>vmCountï¼šå°†valueä½œä¸ºdataçš„ç»„ä»¶æ•°é‡</li></ul><blockquote><p>Dep()</p></blockquote><p><strong>åŠŸèƒ½</strong>ï¼šç”¨æ¥ç®¡ç†å·²æ·»åŠ <code>getter/setter</code>å±æ€§çš„ä¾èµ–</p><p><strong>å®ä¾‹å±æ€§</strong>ï¼š</p><ul><li>idï¼šdepçš„å”¯ä¸€æ ‡è¯†</li><li>subsï¼šç®¡ç†ä¾èµ–çš„æ•°ç»„ï¼ˆå…¶ä¸­å­˜å‚¨çš„ä¸ºwatcherå®ä¾‹ï¼‰</li></ul><p><strong>é™æ€å±æ€§</strong>ï¼š</p><ul><li>targetï¼šç”¨æ¥æš‚å­˜å½“å‰è¿è¡Œä¸­çš„watcherå®ä¾‹</li></ul><blockquote><p>Watcher(vm,expOrFn,cb,[options,isRenderWatcher])</p></blockquote><p><strong>åŠŸèƒ½</strong>ï¼šç±»ä¼¼äºå‰¯ä½œç”¨å‡½æ•°çš„æ³¨å†Œå‡½æ•°ï¼Œdepå­˜å‚¨çš„ä¾èµ–æœ¬èº«ï¼Œé€šçŸ¥æ›´æ–°æ—¶é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ã€‚</p><p><strong>å®ä¾‹å±æ€§</strong>ï¼š</p><ul><li><p>deep: æ˜¯å¦æ·±åº¦ç›‘æµ‹</p></li><li><p>userï¼šæ­¤watcherå®ä¾‹æ˜¯å¦ä¸ºç”¨æˆ·æ‰‹åŠ¨åˆ›å»º</p></li><li><p>lazyï¼šæ˜¯å¦æ‡’æ‰§è¡Œ</p></li><li><p>dirtyï¼šä¸lazyé…å¥—ä½¿ç”¨è¡¨æ˜æ‰§è¡Œæ—¶æœº</p></li><li><p>syncï¼šæ˜¯å¦åŒæ­¥</p></li><li><p>å½“<code>sync</code>ä¸º<code>true</code>æ—¶ï¼Œè¡¨ç¤ºè¯¥Watcheræ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚å³ï¼Œåœ¨æ•°æ®å˜åŒ–åï¼ŒWatcherä¼šç«‹å³æ‰§è¡ŒåŒæ­¥ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å›è°ƒï¼Œè€Œä¸ä¼šå¼‚æ­¥å»¶è¿Ÿæ‰§è¡Œ</p></li><li><p>å½“<code>sync</code>ä¸º<code>false</code>æ—¶ï¼Œè¡¨ç¤ºè¯¥Watcheræ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚å³ï¼Œåœ¨æ•°æ®å˜åŒ–åï¼ŒWatcherä¼šè¢«æ¨å…¥å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰æ—¶æ‰æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚è¿™æ ·å¯ä»¥åˆ©ç”¨Vueçš„ <mark>æ‰¹é‡å¼‚æ­¥æ›´æ–°æœºåˆ¶</mark> ï¼Œæé«˜æ€§èƒ½å’Œæ•ˆç‡ã€‚</p></li><li><p>beforeï¼š éœ€è¦åœ¨å›è°ƒå‰æ‰§è¡Œçš„å‡½æ•°</p></li></ul><h3 id="_2-æ•°ç»„çš„å“åº”å¼" tabindex="-1"><a class="header-anchor" href="#_2-æ•°ç»„çš„å“åº”å¼"><span>2. æ•°ç»„çš„å“åº”å¼</span></a></h3><p>å¾ˆæ˜æ˜¾å¯¹äºä½¿ç”¨<code>Object.defineProperty</code>å®ç°çš„å“åº”å¼å¹¶ä¸é€‚ç”¨äºæ•°ç»„å¯¹è±¡ï¼Œå› æ­¤Vueä¸ºæ•°ç»„è®¾ç«‹äº†å…¶ç‹¬è‡ªçš„å“åº”å¼æ–¹æ¡ˆã€‚</p><p>é‡å†™ä¼šæ”¹å˜åŸå§‹æ•°ç»„çš„åŸç”Ÿæ–¹æ³•ï¼Œå°†å…¶æ‹¦æˆªåœ¨æ•°ç»„å®ä¾‹ä¸<code>Array.prototype</code>ä¹‹é—´ï¼Œè¿™æ ·ä½¿ç”¨è¿™äº›æ–¹æ³•æ—¶ä¼šä¼˜å…ˆä½¿ç”¨æ”¹å†™ä¹‹åçš„ã€‚</p><p><strong>å®šä¹‰</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">const</span> arrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> methodsToPatch <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;shift&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;unshift&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;splice&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;sort&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;reverse&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
methodsToPatch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç¼“å­˜åŸç”Ÿæ–¹æ³•</span>
  <span class="token keyword">const</span> original <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">mutator</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span> <span class="token comment">// è¿™é‡Œçš„thisä¸ºå“åº”å¼æ•°æ®value</span>
    <span class="token keyword">let</span> inserted<span class="token punctuation">;</span>
    <span class="token comment">// å¯¹æ•°ç»„æ–°å¢å…ƒç´ æ·»åŠ ä¾¦æµ‹ï¼ˆpushã€unshiftã€spliceï¼‰</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&quot;push&quot;</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">&quot;unshift&quot;</span><span class="token operator">:</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">;</span> <span class="token comment">// å¦‚æœæ˜¯pushæˆ–unshiftæ–¹æ³•ï¼Œé‚£ä¹ˆä¼ å…¥å‚æ•°å°±æ˜¯æ–°å¢çš„å…ƒç´ </span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">&quot;splice&quot;</span><span class="token operator">:</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¦‚æœæ˜¯spliceæ–¹æ³•ï¼Œé‚£ä¹ˆä¼ å…¥å‚æ•°åˆ—è¡¨ä¸­ä¸‹æ ‡ä¸º2çš„å°±æ˜¯æ–°å¢çš„å…ƒç´ </span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨observeå‡½æ•°å°†æ–°å¢çš„å…ƒç´ è½¬åŒ–æˆå“åº”å¼</span>
    <span class="token comment">// é€šçŸ¥å˜åŒ–</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è°ƒç”¨åŸç”Ÿæ–¹æ³•</li><li>ä¸ºæ–°å¢å…ƒç´ æ·»åŠ å“åº”å¼</li><li>é€šçŸ¥ä¾èµ–æ›´æ–°</li></ul><p><strong>ä½¿ç”¨</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre js="" class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">value</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å®ä¾‹åŒ–ä¸€ä¸ªä¾èµ–ç®¡ç†å™¨ï¼Œç”¨æ¥æ”¶é›†æ•°ç»„ä¾èµ–</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">&quot;__ob__&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é™„åŠ Observerå®ä¾‹ï¼Œæ ‡è®°å·²ç»è½¬ä¸ºå“åº”å¼</span>

        <span class="token comment">// è®©è‡ªå®šä¹‰çš„æ•°ç»„æ–¹æ³•æ›¿ä»£åŸç”Ÿæ–¹æ³•æ‰§è¡Œ(æŠŠå®ƒæŒ‚è½½åˆ°æ•°ç»„å®ä¾‹ä¸Array.prototypeä¹‹é—´)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasProto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">protoAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">copyAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½è½¬åŒ–ä¸ºå¯è¢«ä¾¦æµ‹çš„å“åº”å¼</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">obj</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">observeArray</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">items</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>arrå®ä¾‹ ==&gt; æ”¹å†™åçš„æ–¹æ³•å¯¹è±¡ ==&gt; Arrayçš„åŸå‹å¯¹è±¡</li></ul><p><strong>æ”¶é›†ä¾èµ–</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// ...çœç•¥å…¶ä»–ä»£ç </span>
<span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ”¶é›†ä¾èµ–</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>

<span class="token keyword">function</span> <span class="token function">dependArray</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">value</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> e<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e <span class="token operator">=</span> value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    e <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>__ob__ <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>__ob__<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">dependArray</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨è®¿é—®æ•°ç»„å†…å…ƒç´ æ—¶ï¼Œæ— æ³•åƒå±æ€§<code>getter</code>é‚£æ ·æ‹¦æˆªï¼Œæ‰€ä»¥é€šè¿‡é€’å½’éå†æ•°ç»„å…ƒç´ ï¼Œæ‰‹åŠ¨è°ƒç”¨<code>dep.depend()</code>æ¥æ”¶é›†ä¾èµ–ã€‚</li></ul><h3 id="_3-ç›¸å…³api" tabindex="-1"><a class="header-anchor" href="#_3-ç›¸å…³api"><span>3. ç›¸å…³api</span></a></h3><p>å¯¹äºå¯¹è±¡æ¥è¯´ï¼Œé€šè¿‡<code>Object.defineProperty</code>æ–¹æ³•å®ç°çš„å¯¹<code>object</code>æ•°æ®çš„è§‚æµ‹ä»…ä»…åªèƒ½è§‚æµ‹åˆ°<code>object</code>æ•°æ®çš„å–å€¼åŠè®¾ç½®å€¼ï¼Œå½“æˆ‘ä»¬å‘<code>object</code>æ•°æ®é‡Œæ·»åŠ ä¸€å¯¹æ–°çš„<code>key/value</code>æˆ–åˆ é™¤ä¸€å¯¹å·²æœ‰çš„<code>key/value</code>æ—¶ï¼Œå®ƒæ˜¯æ— æ³•è§‚æµ‹åˆ°çš„ã€‚</p><p>è€Œå¯¹äºæ•°ç»„æ¥è¯´ï¼Œå“åº”å¼éƒ½å¿…é¡»å€Ÿç”±æ”¹å†™åçš„æ–¹æ³•æ¥å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä½¿ç”¨æ•°ç»„ä¸‹æ ‡<code>arr[0]=2</code>çš„æ–¹å¼æ¥æ›´æ”¹æ•°æ®æ˜¯ç›‘æµ‹ä¸åˆ°çš„ã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œ<code>Vue</code>å¢åŠ äº†ä¸¤ä¸ªå…¨å±€API:<code>Vue.set</code>å’Œ<code>Vue.delete</code>ã€‚</p><blockquote><p><code>Vue.set(target, propertyName / index, value)</code><span id="set"></span></p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> Object<span class="token punctuation">,</span> <span class="token literal-property property">key</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">val</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// targetä¸ºundefinedã€nullã€åŸå§‹å€¼ </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isPrimitive</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot set reactive property on undefined, null, or primitive value: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ•°ç»„</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isValidArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>length<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// spliceå·²ç»è¢«é‡å†™</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¯¹è±¡ï¼ˆéæ–°å¢ï¼‰</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> target <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> ob <span class="token operator">=</span> target<span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœtragteæ˜¯ Vue å®ä¾‹ï¼Œæˆ–è€…æ˜¯ Vue å®ä¾‹çš„æ ¹æ•°æ®å¯¹è±¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>_isVue <span class="token operator">||</span> <span class="token punctuation">(</span>ob <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">.</span>vmCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Avoid adding reactive properties to a Vue instance or its root $data &quot;</span> <span class="token operator">+</span>
          <span class="token string">&quot;at runtime - declare it upfront in the data option.&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// éå“åº”å¼å¯¹è±¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">defineReactive</span><span class="token punctuation">(</span>ob<span class="token punctuation">.</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ›´æ–°ä¾èµ– </span>
  ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ•°ç»„ï¼šå€Ÿç”¨å·²é‡å†™çš„<code>splice</code>æ–¹æ³•å®Œæˆå“åº”å¼</li><li>å¯¹è±¡ï¼ˆéæ–°å¢ | éå“åº”å¼ï¼‰ï¼šç›´æ¥ä¿®æ”¹å¯¹åº”å±æ€§çš„å€¼</li><li>å¯¹è±¡ï¼ˆæ–°å¢ï¼‰ï¼šè°ƒç”¨<code>defineReactive</code>å‡½æ•°æ·»åŠ å“åº”å¼</li><li>é€šçŸ¥æ›´æ–°</li></ul><blockquote><p><code>Vue.delete(target, propertyName / index)</code><span id="del"></span></p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// targetä¸ºundefinedã€nullã€åŸå§‹å€¼ </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isPrimitive</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot delete reactive property on undefined, null, or primitive value: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ•°ç»„ </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isValidArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> ob <span class="token operator">=</span> target<span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœtragteæ˜¯ Vue å®ä¾‹ï¼Œæˆ–è€…æ˜¯ Vue å®ä¾‹çš„æ ¹æ•°æ®å¯¹è±¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>_isVue <span class="token operator">||</span> <span class="token punctuation">(</span>ob <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">.</span>vmCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Avoid deleting properties on a Vue instance or its root $data &quot;</span> <span class="token operator">+</span>
          <span class="token string">&quot;- just set it to null.&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">delete</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="äºŒã€diffç®—æ³•" tabindex="-1"><a class="header-anchor" href="#äºŒã€diffç®—æ³•"><span>äºŒã€Diffç®—æ³•</span></a></h2><h3 id="_1-è™šæ‹Ÿdom" tabindex="-1"><a class="header-anchor" href="#_1-è™šæ‹Ÿdom"><span>1. è™šæ‹ŸDOM</span></a></h3><p>æ‰€è°“è™šæ‹ŸDOMï¼Œå°±æ˜¯ç”¨ä¸€ä¸ª<code>JS</code>å¯¹è±¡æ¥æè¿°ä¸€ä¸ª<code>DOM</code>èŠ‚ç‚¹ï¼Œåƒå¦‚ä¸‹ç¤ºä¾‹ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// &lt;div class=&quot;a&quot; id=&quot;b&quot;&gt;æˆ‘æ˜¯å†…å®¹&lt;/div&gt;</span>
<span class="token punctuation">{</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>        <span class="token comment">// å…ƒç´ æ ‡ç­¾</span>
  <span class="token literal-property property">attrs</span><span class="token operator">:</span><span class="token punctuation">{</span>           <span class="token comment">// å±æ€§</span>
    <span class="token keyword">class</span><span class="token operator">:</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span><span class="token string">&#39;b&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">text</span><span class="token operator">:</span><span class="token string">&#39;æˆ‘æ˜¯å†…å®¹&#39;</span><span class="token punctuation">,</span>  <span class="token comment">// æ–‡æœ¬å†…å®¹</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>       <span class="token comment">// å­å…ƒç´ </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬æŠŠç»„æˆä¸€ä¸ª<code>DOM</code>èŠ‚ç‚¹çš„å¿…è¦ä¸œè¥¿é€šè¿‡ä¸€ä¸ª<code>JS</code>å¯¹è±¡è¡¨ç¤ºå‡ºæ¥ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>JS</code>å¯¹è±¡å°±å¯ä»¥ç”¨æ¥æè¿°è¿™ä¸ª<code>DOM</code>èŠ‚ç‚¹ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ª<code>JS</code>å¯¹è±¡å°±ç§°ä¸ºæ˜¯è¿™ä¸ªçœŸå®<code>DOM</code>èŠ‚ç‚¹çš„è™šæ‹Ÿ<code>DOM</code>èŠ‚ç‚¹ã€‚</p><p><strong>VNodeèŠ‚ç‚¹</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VNode</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span>
    <span class="token parameter">tag<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
    data<span class="token operator">?</span><span class="token operator">:</span> VNodeData<span class="token punctuation">,</span>
    children<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    text<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
    elm<span class="token operator">?</span><span class="token operator">:</span> Node<span class="token punctuation">,</span>
    context<span class="token operator">?</span><span class="token operator">:</span> Component<span class="token punctuation">,</span>
    componentOptions<span class="token operator">?</span><span class="token operator">:</span> VNodeComponentOptions<span class="token punctuation">,</span>
    asyncFactory<span class="token operator">?</span><span class="token operator">:</span> Function</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag                                <span class="token comment">/*å½“å‰èŠ‚ç‚¹çš„æ ‡ç­¾å*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data        <span class="token comment">/*å½“å‰èŠ‚ç‚¹å¯¹åº”çš„å¯¹è±¡ï¼ŒåŒ…å«äº†å…·ä½“çš„ä¸€äº›æ•°æ®ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ªVNodeDataç±»å‹ï¼Œå¯ä»¥å‚è€ƒVNodeDataç±»å‹ä¸­çš„æ•°æ®ä¿¡æ¯*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> children  <span class="token comment">/*å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text     <span class="token comment">/*å½“å‰èŠ‚ç‚¹çš„æ–‡æœ¬*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>elm <span class="token operator">=</span> elm       <span class="token comment">/*å½“å‰è™šæ‹ŸèŠ‚ç‚¹å¯¹åº”çš„çœŸå®domèŠ‚ç‚¹*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ns <span class="token operator">=</span> <span class="token keyword">undefined</span>            <span class="token comment">/*å½“å‰èŠ‚ç‚¹çš„åå­—ç©ºé—´*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context          <span class="token comment">/*å½“å‰ç»„ä»¶èŠ‚ç‚¹å¯¹åº”çš„Vueå®ä¾‹*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fnContext <span class="token operator">=</span> <span class="token keyword">undefined</span>       <span class="token comment">/*å‡½æ•°å¼ç»„ä»¶å¯¹åº”çš„Vueå®ä¾‹*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fnOptions <span class="token operator">=</span> <span class="token keyword">undefined</span>		<span class="token comment">/*å‡½æ•°å¼ç»„ä»¶å¯¹åº”çš„é…ç½®é¡¹*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fnScopeId <span class="token operator">=</span> <span class="token keyword">undefined</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>key           <span class="token comment">/*èŠ‚ç‚¹çš„keyå±æ€§ï¼Œè¢«å½“ä½œèŠ‚ç‚¹çš„æ ‡å¿—ï¼Œç”¨ä»¥ä¼˜åŒ–*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>componentOptions <span class="token operator">=</span> componentOptions   <span class="token comment">/*ç»„ä»¶çš„optioné€‰é¡¹*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> <span class="token keyword">undefined</span>       <span class="token comment">/*å½“å‰èŠ‚ç‚¹å¯¹åº”çš„ç»„ä»¶çš„å®ä¾‹*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">undefined</span>           <span class="token comment">/*å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">false</span>         <span class="token comment">/*ç®€è€Œè¨€ä¹‹å°±æ˜¯æ˜¯å¦ä¸ºåŸç”ŸHTMLæˆ–åªæ˜¯æ™®é€šæ–‡æœ¬ï¼ŒinnerHTMLçš„æ—¶å€™ä¸ºtrueï¼ŒtextContentçš„æ—¶å€™ä¸ºfalse*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isStatic <span class="token operator">=</span> <span class="token boolean">false</span>         <span class="token comment">/*é™æ€èŠ‚ç‚¹æ ‡å¿—*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isRootInsert <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token comment">/*æ˜¯å¦ä½œä¸ºè·ŸèŠ‚ç‚¹æ’å…¥*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isComment <span class="token operator">=</span> <span class="token boolean">false</span>             <span class="token comment">/*æ˜¯å¦ä¸ºæ³¨é‡ŠèŠ‚ç‚¹*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isCloned <span class="token operator">=</span> <span class="token boolean">false</span>           <span class="token comment">/*æ˜¯å¦ä¸ºå…‹éš†èŠ‚ç‚¹*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isOnce <span class="token operator">=</span> <span class="token boolean">false</span>                <span class="token comment">/*æ˜¯å¦æœ‰v-onceæŒ‡ä»¤*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>asyncFactory <span class="token operator">=</span> asyncFactory
    <span class="token keyword">this</span><span class="token punctuation">.</span>asyncMeta <span class="token operator">=</span> <span class="token keyword">undefined</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isAsyncPlaceholder <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">child</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentInstance
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>VNode</code>ç±»ä¸­åŒ…å«äº†æè¿°ä¸€ä¸ªçœŸå®<code>DOM</code>èŠ‚ç‚¹æ‰€éœ€è¦çš„ä¸€ç³»åˆ—å±æ€§ï¼Œå¦‚<code>tag</code>è¡¨ç¤ºèŠ‚ç‚¹çš„æ ‡ç­¾åï¼Œ<code>text</code>è¡¨ç¤ºèŠ‚ç‚¹ä¸­åŒ…å«çš„æ–‡æœ¬ï¼Œ<code>children</code>è¡¨ç¤ºè¯¥èŠ‚ç‚¹åŒ…å«çš„å­èŠ‚ç‚¹ç­‰ã€‚é€šè¿‡ <mark>å±æ€§ä¹‹é—´ä¸åŒçš„æ­é…</mark> ï¼Œå°±å¯ä»¥æè¿°å‡ºå„ç§ç±»å‹çš„çœŸå®<code>DOM</code>èŠ‚ç‚¹ã€‚åŒ…æ‹¬ <mark>æ³¨é‡ŠèŠ‚ç‚¹ã€æ–‡æœ¬èŠ‚ç‚¹ã€å…ƒç´ èŠ‚ç‚¹ã€ç»„ä»¶èŠ‚ç‚¹ã€å‡½æ•°å¼ç»„ä»¶èŠ‚ç‚¹ã€å…‹éš†èŠ‚ç‚¹</mark> ã€‚</li><li>æˆ‘ä»¬åœ¨è§†å›¾æ¸²æŸ“ä¹‹å‰ï¼ŒæŠŠå†™å¥½çš„<code>template</code>æ¨¡æ¿å…ˆç¼–è¯‘æˆ<code>VNode</code>å¹¶ç¼“å­˜ä¸‹æ¥ï¼Œç­‰åˆ°æ•°æ®å‘ç”Ÿå˜åŒ–é¡µé¢éœ€è¦é‡æ–°æ¸²æŸ“çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠæ•°æ®å‘ç”Ÿå˜åŒ–åç”Ÿæˆçš„<code>VNode</code>ä¸å‰ä¸€æ¬¡ç¼“å­˜ä¸‹æ¥çš„<code>VNode</code>è¿›è¡Œå¯¹æ¯”ï¼Œæ‰¾å‡ºå·®å¼‚ï¼Œç„¶åæœ‰å·®å¼‚çš„<code>VNode</code>å¯¹åº”çš„çœŸå®<code>DOM</code>èŠ‚ç‚¹å°±æ˜¯éœ€è¦é‡æ–°æ¸²æŸ“çš„èŠ‚ç‚¹ï¼Œæœ€åæ ¹æ®æœ‰å·®å¼‚çš„<code>VNode</code>åˆ›å»ºå‡ºçœŸå®çš„<code>DOM</code>èŠ‚ç‚¹å†æ’å…¥åˆ°è§†å›¾ä¸­ï¼Œæœ€ç»ˆå®Œæˆä¸€æ¬¡è§†å›¾æ›´æ–°ã€‚</li></ul><h3 id="_2-diffç®—æ³•" tabindex="-1"><a class="header-anchor" href="#_2-diffç®—æ³•"><span>2. Diffç®—æ³•</span></a></h3><p>æ“ä½œçœŸå®DOMæ˜¯éå¸¸æ¶ˆè€—æ€§èƒ½çš„ï¼ŒVueé€šè¿‡è¿›è¡Œæ•°æ®å˜åŒ–å‰åçš„è™šæ‹Ÿ<code>DOM-Diff</code>ï¼Œæœ€ç»ˆåšåˆ°åªæ›´æ–°æœ‰å·®å¼‚çš„è§†å›¾ï¼Œä»è€Œè¾¾åˆ°å°½å¯èƒ½å°‘çš„æ“ä½œçœŸå®<code>DOM</code>çš„ç›®çš„ï¼Œä»¥èŠ‚çœæ€§èƒ½ã€‚</p><p><code>DOM-Diff</code>çš„è¿‡ç¨‹ä¹Ÿå«<code>patch</code>è¿‡ç¨‹ï¼Œå³æ‰“è¡¥ä¸ï¼Œæœ¬è´¨ä¸Šæ˜¯<strong>ä»¥æ–°çš„VNodeä¸ºåŸºå‡†ï¼Œæ”¹é€ æ—§çš„oldVNodeä½¿ä¹‹æˆä¸ºè·Ÿæ–°çš„VNodeä¸€æ ·ï¼Œè¿™å°±æ˜¯patchè¿‡ç¨‹è¦å¹²çš„äº‹</strong>ã€‚</p><ul><li>åˆ›å»ºèŠ‚ç‚¹ï¼šæ–°çš„<code>VNode</code>ä¸­æœ‰è€Œæ—§çš„<code>oldVNode</code>ä¸­æ²¡æœ‰ï¼Œå°±åœ¨æ—§çš„<code>oldVNode</code>ä¸­åˆ›å»ºã€‚</li><li>åˆ é™¤èŠ‚ç‚¹ï¼šæ–°çš„<code>VNode</code>ä¸­æ²¡æœ‰è€Œæ—§çš„<code>oldVNode</code>ä¸­æœ‰ï¼Œå°±ä»æ—§çš„<code>oldVNode</code>ä¸­åˆ é™¤ã€‚</li><li>æ›´æ–°èŠ‚ç‚¹ï¼šæ–°çš„<code>VNode</code>å’Œæ—§çš„<code>oldVNode</code>ä¸­éƒ½æœ‰ï¼Œå°±ä»¥æ–°çš„<code>VNode</code>ä¸ºå‡†ï¼Œæ›´æ–°æ—§çš„<code>oldVNode</code>ã€‚</li></ul><p><code>Vue</code>åœ¨æ¨¡æ¿ç¼–è¯‘åï¼Œ<code>vnode</code>ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œè€Œ<code>vnode.children</code>ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥<code>vnode</code>èŠ‚ç‚¹ä¹‹é—´çš„<code>patch</code>å’Œ<code>vnode</code>å­èŠ‚ç‚¹ä¹‹é—´çš„<code>patch</code>æ˜¯å­˜åœ¨åŒºåˆ«çš„ï¼ˆä¼šå¤šä¸€ä¸ªå¾ªç¯çš„è¿‡ç¨‹å’Œä¸€äº›ç‰¹æ®Šæƒ…å†µå¤„ç†ï¼‰ã€‚</p><blockquote><p>åˆ›å»ºå…ƒç´ èŠ‚ç‚¹</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// åˆ›å»ºå…ƒç´ èŠ‚ç‚¹</span>
<span class="token keyword">function</span> <span class="token function">createElm</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
    <span class="token keyword">const</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
    <span class="token keyword">const</span> tag <span class="token operator">=</span> vnode<span class="token punctuation">.</span>tag
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>   <span class="token comment">// åˆ›å»ºå…ƒç´ èŠ‚ç‚¹</span>
        <span class="token function">createChildren</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> children<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºå…ƒç´ èŠ‚ç‚¹çš„å­èŠ‚ç‚¹</span>
        <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>       <span class="token comment">// æ’å…¥åˆ°DOMä¸­</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isComment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>  <span class="token comment">// åˆ›å»ºæ³¨é‡ŠèŠ‚ç‚¹</span>
        <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>           <span class="token comment">// æ’å…¥åˆ°DOMä¸­</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>  <span class="token comment">// åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹</span>
        <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>           <span class="token comment">// æ’å…¥åˆ°DOMä¸­</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ›å»ºå…ƒç´ å­èŠ‚ç‚¹</span>
<span class="token keyword">function</span> <span class="token function">createChildren</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> children<span class="token punctuation">,</span> insertedVnodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkDuplicateKeys</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">createElm</span><span class="token punctuation">(</span>
                children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                insertedVnodeQueue<span class="token punctuation">,</span>
                vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>
                <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token boolean">true</span><span class="token punctuation">,</span>
                children<span class="token punctuation">,</span>
                i
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nodeOps<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>
            vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>
            nodeOps<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å­˜åœ¨tagå±æ€§ï¼Œä¸ºå…ƒç´ èŠ‚ç‚¹</li><li>isCommentä¸ºtrueï¼Œä¸ºæ³¨é‡ŠèŠ‚ç‚¹</li><li>å¦‚æœæ—¢ä¸æ˜¯å…ƒç´ èŠ‚ç‚¹ï¼Œä¹Ÿä¸æ˜¯æ³¨é‡ŠèŠ‚ç‚¹ï¼Œé‚£å°±è®¤ä¸ºæ˜¯æ–‡æœ¬èŠ‚ç‚¹</li></ul><figure><img src="/dcBlog/assets/createElm-BkdC__sV.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><blockquote><p>åˆ é™¤èŠ‚ç‚¹</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">removeNode</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> parent <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>  <span class="token comment">// è·å–çˆ¶èŠ‚ç‚¹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nodeOps<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> el<span class="token punctuation">)</span>  <span class="token comment">// è°ƒç”¨çˆ¶èŠ‚ç‚¹çš„removeChildæ–¹æ³•</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>æ›´æ–°èŠ‚ç‚¹</p></blockquote><p><strong>æ–°æ—§vndoeä¹‹é—´çš„patch</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">patchVnode</span><span class="token punctuation">(</span>
 <span class="token parameter">oldVnode<span class="token punctuation">,</span>
 vnode<span class="token punctuation">,</span>
 insertedVnodeQueue<span class="token punctuation">,</span>
 ownerArray<span class="token punctuation">,</span>
 index<span class="token punctuation">,</span>
 removeOnly</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// vnodeä¸oldVnodeæ˜¯å¦å®Œå…¨ä¸€æ ·ï¼Ÿè‹¥æ˜¯ï¼Œé€€å‡ºç¨‹åº</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ownerArray<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å…‹éš†é‡å¤ä½¿ç”¨çš„èŠ‚ç‚¹</span>
        vnode <span class="token operator">=</span> ownerArray<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneVNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> elm <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ—§èŠ‚ç‚¹å¯¹åº”çš„domå…ƒç´ </span>

    <span class="token comment">// å¼‚æ­¥å ä½èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isAsyncPlaceholder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>asyncFactory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hydrate</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            vnode<span class="token punctuation">.</span>isAsyncPlaceholder <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

 	<span class="token comment">// åœ¨æ¨¡æ¿ç¼–è¯‘çš„ä¼˜åŒ–é˜¶æ®µä¼šæ ‡è®°é™æ€èŠ‚ç‚¹</span>
    <span class="token comment">// vnodeä¸oldVnodeæ˜¯å¦éƒ½æ˜¯é™æ€èŠ‚ç‚¹ï¼Ÿè‹¥æ˜¯ï¼Œé€€å‡ºç¨‹åº</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        vnode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVnode<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isCloned<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isOnce<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ä¸€äº›é’©å­å‡½æ•°</span>
    <span class="token keyword">let</span> i<span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// vnode.textæœªå®šä¹‰</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// vnodeçš„å­èŠ‚ç‚¹ä¸oldVnodeçš„å­èŠ‚ç‚¹æ˜¯å¦éƒ½å­˜åœ¨ï¼Ÿ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è‹¥éƒ½å­˜åœ¨ï¼Œåˆ¤æ–­å­èŠ‚ç‚¹æ˜¯å¦ç›¸åŒï¼Œä¸åŒåˆ™æ›´æ–°å­èŠ‚ç‚¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span>
                <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è‹¥åªæœ‰vnodeçš„å­èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ™æ­¤èŠ‚ç‚¹ä¸ºæ–°å¢èŠ‚ç‚¹</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">checkDuplicateKeys</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token doc-comment comment">/**
         	 * åˆ¤æ–­oldVnodeæ˜¯å¦æœ‰æ–‡æœ¬ï¼Ÿ
         	 * è‹¥æ²¡æœ‰ï¼Œåˆ™æŠŠvnodeçš„å­èŠ‚ç‚¹æ·»åŠ åˆ°çœŸå®DOMä¸­
         	 * è‹¥æœ‰ï¼Œåˆ™æ¸…ç©ºDomä¸­çš„æ–‡æœ¬ï¼Œå†æŠŠvnodeçš„å­èŠ‚ç‚¹æ·»åŠ åˆ°çœŸå®DOMä¸­
         	 */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// éå†chï¼Œä¸ºæ¯ä¸ªå…ƒç´ åˆ›å»ºdomï¼Œç„¶åæ’å…¥åˆ°elmä¸­</span>
            <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è‹¥åªæœ‰oldnodeçš„å­èŠ‚ç‚¹å­˜åœ¨ï¼Œæ­¤èŠ‚ç‚¹ä¸ºéœ€è¦åˆ é™¤çš„èŠ‚ç‚¹</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¸…ç©ºDOMä¸­çš„å­èŠ‚ç‚¹</span>
            <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è‹¥vnodeå’Œoldnodeéƒ½æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œä½†æ˜¯oldnodeä¸­æœ‰æ–‡æœ¬</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¸…ç©ºoldnodeæ–‡æœ¬</span>
            nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// vnode.textå·²å®šä¹‰ï¼Œvnodeçš„textå±æ€§ä¸oldVnodeçš„textå±æ€§æ˜¯å¦ç›¸åŒï¼Ÿ</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è‹¥ä¸ç›¸åŒï¼šåˆ™ç”¨vnodeçš„textæ›¿æ¢çœŸå®DOMçš„æ–‡æœ¬</span>
        nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>postpatch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/dcBlog/assets/update-CmmBos82.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>æ–°æ—§vnode.childrenä¹‹é—´ï¼ˆæ•°ç»„ï¼‰çš„patch</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>
    <span class="token parameter">parentElm<span class="token punctuation">,</span>
    oldCh<span class="token punctuation">,</span>
    newCh<span class="token punctuation">,</span>
    insertedVnodeQueue<span class="token punctuation">,</span>
    removeOnly</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// oldChildrenå¼€å§‹ç´¢å¼•</span>
    <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// oldChildrenç»“æŸç´¢å¼•</span>
    <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// oldChildrenä¸­æ‰€æœ‰æœªå¤„ç†èŠ‚ç‚¹ä¸­çš„ç¬¬ä¸€ä¸ª</span>
    <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// oldChildrenä¸­æ‰€æœ‰æœªå¤„ç†èŠ‚ç‚¹ä¸­çš„æœ€åä¸€ä¸ª</span>

    <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// newChildrenå¼€å§‹ç´¢å¼•</span>
    <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// newChildrenç»“æŸç´¢å¼•</span>
    <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// newChildrenä¸­æ‰€æœ‰æœªå¤„ç†èŠ‚ç‚¹ä¸­çš„ç¬¬ä¸€ä¸ª</span>
    <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// newChildrenä¸­æ‰€æœ‰æœªå¤„ç†èŠ‚ç‚¹ä¸­çš„æœ€åä¸€ä¸ª</span>

    <span class="token keyword">let</span> oldKeyToIdx<span class="token punctuation">,</span> idxInOld<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">,</span> refElm<span class="token punctuation">;</span>

    <span class="token keyword">const</span> canMove <span class="token operator">=</span> <span class="token operator">!</span>removeOnly<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkDuplicateKeys</span><span class="token punctuation">(</span>newCh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ä»¥&quot;æ–°å‰&quot;ã€&quot;æ–°å&quot;ã€&quot;æ—§å‰&quot;ã€&quot;æ—§å&quot;çš„æ–¹å¼å¼€å§‹æ¯”å¯¹èŠ‚ç‚¹</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// å¦‚æœoldStartVnodeä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è·³è¿‡ï¼Œæ¯”å¯¹ä¸‹ä¸€ä¸ª</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// å¦‚æœoldEndVnodeä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è·³è¿‡ï¼Œå°†oldEndIdxå‡1ï¼Œæ¯”å¯¹å‰ä¸€ä¸ª</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ–°å‰ä¸æ—§å‰èŠ‚ç‚¹ç›¸åŒï¼Œå°±æŠŠä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œpatchæ›´æ–°</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>
          oldStartVnode<span class="token punctuation">,</span>
          newStartVnode<span class="token punctuation">,</span>
          insertedVnodeQueue<span class="token punctuation">,</span>
          newCh<span class="token punctuation">,</span>
          newStartIdx
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°†æ–°æ—§èŠ‚ç‚¹çš†ç§»å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ–°åä¸æ—§åèŠ‚ç‚¹ç›¸åŒï¼Œå°±æŠŠä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œpatchæ›´æ–°</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>
          oldEndVnode<span class="token punctuation">,</span>
          newEndVnode<span class="token punctuation">,</span>
          insertedVnodeQueue<span class="token punctuation">,</span>
          newCh<span class="token punctuation">,</span>
          newEndIdx
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ–°åä¸æ—§å‰èŠ‚ç‚¹ç›¸åŒï¼Œå…ˆæŠŠä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œpatchæ›´æ–°ï¼Œç„¶åæŠŠæ—§å‰èŠ‚ç‚¹ç§»åŠ¨åˆ°oldChilrenä¸­æ‰€æœ‰æœªå¤„ç†èŠ‚ç‚¹ä¹‹å</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>
          oldStartVnode<span class="token punctuation">,</span>
          newEndVnode<span class="token punctuation">,</span>
          insertedVnodeQueue<span class="token punctuation">,</span>
          newCh<span class="token punctuation">,</span>
          newEndIdx
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        canMove <span class="token operator">&amp;&amp;</span>
          nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>
            parentElm<span class="token punctuation">,</span>
            oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>
            nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ–°å‰ä¸æ—§åèŠ‚ç‚¹ç›¸åŒï¼Œå…ˆæŠŠä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œpatchæ›´æ–°ï¼Œç„¶åæŠŠæ—§åèŠ‚ç‚¹ç§»åŠ¨åˆ°oldChilrenä¸­æ‰€æœ‰æœªå¤„ç†èŠ‚ç‚¹ä¹‹å‰</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>
          oldEndVnode<span class="token punctuation">,</span>
          newStartVnode<span class="token punctuation">,</span>
          insertedVnodeQueue<span class="token punctuation">,</span>
          newCh<span class="token punctuation">,</span>
          newStartIdx
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        canMove <span class="token operator">&amp;&amp;</span>
          nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœä¸å±äºä»¥ä¸Šå››ç§æƒ…å†µï¼Œå°±è¿›è¡Œå¸¸è§„çš„å¾ªç¯æ¯”å¯¹patch</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span>
          oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
          <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span>
          <span class="token operator">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœåœ¨oldChildrené‡Œæ‰¾ä¸åˆ°å½“å‰å¾ªç¯çš„newChildrené‡Œçš„å­èŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// æ–°å¢èŠ‚ç‚¹å¹¶æ’å…¥åˆ°åˆé€‚ä½ç½®</span>
          <span class="token function">createElm</span><span class="token punctuation">(</span>
            newStartVnode<span class="token punctuation">,</span>
            insertedVnodeQueue<span class="token punctuation">,</span>
            parentElm<span class="token punctuation">,</span>
            oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>
            <span class="token boolean">false</span><span class="token punctuation">,</span>
            newCh<span class="token punctuation">,</span>
            newStartIdx
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// å¦‚æœåœ¨oldChildrené‡Œæ‰¾åˆ°äº†å½“å‰å¾ªç¯çš„newChildrené‡Œçš„å­èŠ‚ç‚¹</span>
          vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">// å¦‚æœä¸¤ä¸ªèŠ‚ç‚¹ç›¸åŒ</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è°ƒç”¨patchVnodeæ›´æ–°èŠ‚ç‚¹</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>
              vnodeToMove<span class="token punctuation">,</span>
              newStartVnode<span class="token punctuation">,</span>
              insertedVnodeQueue<span class="token punctuation">,</span>
              newCh<span class="token punctuation">,</span>
              newStartIdx
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
            <span class="token comment">// canmoveè¡¨ç¤ºæ˜¯å¦éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ï¼Œå¦‚æœä¸ºtrueè¡¨ç¤ºéœ€è¦ç§»åŠ¨ï¼Œåˆ™ç§»åŠ¨èŠ‚ç‚¹ï¼Œå¦‚æœä¸ºfalseåˆ™ä¸ç”¨ç§»åŠ¨</span>
            canMove <span class="token operator">&amp;&amp;</span>
              nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>
                parentElm<span class="token punctuation">,</span>
                vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>
                oldStartVnode<span class="token punctuation">.</span>elm
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// same key but different element. treat as new element</span>
            <span class="token function">createElm</span><span class="token punctuation">(</span>
              newStartVnode<span class="token punctuation">,</span>
              insertedVnodeQueue<span class="token punctuation">,</span>
              parentElm<span class="token punctuation">,</span>
              oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>
              <span class="token boolean">false</span><span class="token punctuation">,</span>
              newCh<span class="token punctuation">,</span>
              newStartIdx
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token doc-comment comment">/**
       * å¦‚æœoldChildrenæ¯”newChildrenå…ˆå¾ªç¯å®Œæ¯•ï¼Œ
       * é‚£ä¹ˆnewChildrené‡Œé¢å‰©ä½™çš„èŠ‚ç‚¹éƒ½æ˜¯éœ€è¦æ–°å¢çš„èŠ‚ç‚¹ï¼Œ
       * æŠŠ[newStartIdx, newEndIdx]ä¹‹é—´çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æ’å…¥åˆ°DOMä¸­
       */</span>
      refElm <span class="token operator">=</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
      <span class="token function">addVnodes</span><span class="token punctuation">(</span>
        parentElm<span class="token punctuation">,</span>
        refElm<span class="token punctuation">,</span>
        newCh<span class="token punctuation">,</span>
        newStartIdx<span class="token punctuation">,</span>
        newEndIdx<span class="token punctuation">,</span>
        insertedVnodeQueue
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">&gt;</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token doc-comment comment">/**
       * å¦‚æœnewChildrenæ¯”oldChildrenå…ˆå¾ªç¯å®Œæ¯•ï¼Œ
       * é‚£ä¹ˆoldChildrené‡Œé¢å‰©ä½™çš„èŠ‚ç‚¹éƒ½æ˜¯éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œ
       * æŠŠ[oldStartIdx, oldEndIdx]ä¹‹é—´çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½åˆ é™¤
       */</span>
      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/dcBlog/assets/optimization-CB85rsjX.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="/dcBlog/assets/2-CccbEzVq.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h2 id="ä¸‰ã€æ¨¡æ¿ç¼–è¯‘" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€æ¨¡æ¿ç¼–è¯‘"><span>ä¸‰ã€æ¨¡æ¿ç¼–è¯‘</span></a></h2><figure><img src="/dcBlog/assets/1.f0570125-BOWWoLcf.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>æ¨¡æ¿ç¼–è¯‘è¿‡ç¨‹å°±æ˜¯æŠŠç”¨æˆ·å†™çš„æ¨¡æ¿ç»è¿‡ä¸€ç³»åˆ—å¤„ç†æœ€ç»ˆç”Ÿæˆ<code>render</code>å‡½æ•°çš„è¿‡ç¨‹ã€‚å…¶å…·ä½“æµç¨‹å¯å¤§è‡´åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>æ¨¡æ¿è§£æé˜¶æ®µï¼šå°†ä¸€å †æ¨¡æ¿å­—ç¬¦ä¸²ç”¨æ­£åˆ™ç­‰æ–¹å¼è§£ææˆæŠ½è±¡è¯­æ³•æ ‘<code>AST</code>ï¼› è§£æå™¨ï¼ˆparseï¼‰</li><li>ä¼˜åŒ–é˜¶æ®µï¼šéå†<code>AST</code>ï¼Œæ‰¾å‡ºå…¶ä¸­çš„é™æ€èŠ‚ç‚¹ï¼Œå¹¶æ‰“ä¸Šæ ‡è®°ï¼› ä¼˜åŒ–å™¨ï¼ˆoptimizerï¼‰</li><li>ä»£ç ç”Ÿæˆé˜¶æ®µï¼šå°†<code>AST</code>è½¬æ¢æˆæ¸²æŸ“å‡½æ•°ï¼› ä»£ç ç”Ÿæˆå™¨ï¼ˆcodegenï¼‰</li></ol><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// æºç ä½ç½®: /src/complier/index.js</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">baseCompile</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">template</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> CompiledResult <span class="token punctuation">{</span>
  <span class="token comment">// æ¨¡æ¿è§£æé˜¶æ®µï¼šç”¨æ­£åˆ™ç­‰æ–¹å¼è§£æ template æ¨¡æ¿ä¸­çš„æŒ‡ä»¤ã€classã€styleç­‰æ•°æ®ï¼Œå½¢æˆAST</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¼˜åŒ–é˜¶æ®µï¼šéå†ASTï¼Œæ‰¾å‡ºå…¶ä¸­çš„é™æ€èŠ‚ç‚¹ï¼Œå¹¶æ‰“ä¸Šæ ‡è®°ï¼›</span>
    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ä»£ç ç”Ÿæˆé˜¶æ®µï¼šå°†ASTè½¬æ¢æˆæ¸²æŸ“å‡½æ•°ï¼›</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    ast<span class="token punctuation">,</span>
    <span class="token literal-property property">render</span><span class="token operator">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
    <span class="token literal-property property">staticRenderFns</span><span class="token operator">:</span> code<span class="token punctuation">.</span>staticRenderFns
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/dcBlog/assets/3.15d9566b-Cbj25mJ0.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h3 id="_1-æ¨¡æ¿è§£æ" tabindex="-1"><a class="header-anchor" href="#_1-æ¨¡æ¿è§£æ"><span>1. æ¨¡æ¿è§£æ</span></a></h3><p>åœ¨<code>&lt;template&gt;&lt;/template&gt;</code>æ¨¡æ¿å†…ï¼Œé™¤äº†æœ‰å¸¸è§„çš„<code>HTML</code>æ ‡ç­¾å¤–ï¼Œè¿˜ä¼šåŒ…å«ä¸€äº›æ–‡æœ¬ä¿¡æ¯ä»¥åŠåœ¨æ–‡æœ¬ä¿¡æ¯ä¸­åŒ…å«è¿‡æ»¤å™¨ã€‚è€Œè¿™äº›ä¸åŒçš„å†…å®¹åœ¨è§£æèµ·æ¥è‚¯å®šéœ€è¦ä¸åŒçš„è§£æè§„åˆ™ï¼Œæ‰€ä»¥è§£æå™¨ä¸å¯èƒ½åªæœ‰ä¸€ä¸ªï¼Œå®ƒåº”è¯¥é™¤äº†æœ‰è§£æå¸¸è§„<code>HTML</code>çš„HTMLè§£æå™¨ï¼Œè¿˜åº”è¯¥æœ‰è§£ææ–‡æœ¬çš„æ–‡æœ¬è§£æå™¨ä»¥åŠè§£ææ–‡æœ¬ä¸­å¦‚æœåŒ…å«è¿‡æ»¤å™¨çš„è¿‡æ»¤å™¨è§£æå™¨ã€‚</p><p>HTMLè§£æå™¨æ˜¯ä¸»çº¿ï¼Œ <mark>å…ˆç”¨HTMLè§£æå™¨è¿›è¡Œè§£ææ•´ä¸ªæ¨¡æ¿ï¼Œåœ¨è§£æè¿‡ç¨‹ä¸­å¦‚æœç¢°åˆ°æ–‡æœ¬å†…å®¹ï¼Œé‚£å°±è°ƒç”¨æ–‡æœ¬è§£æå™¨æ¥è§£ææ–‡æœ¬ï¼Œå¦‚æœç¢°åˆ°æ–‡æœ¬ä¸­åŒ…å«è¿‡æ»¤å™¨é‚£å°±è°ƒç”¨è¿‡æ»¤å™¨è§£æå™¨æ¥è§£æ</mark> ã€‚</p><img src="/dcBlog/assets/compiler-CDG0T8pP.png" style="zoom:33%;"><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
  <span class="token comment">// å‘parseHTMLä¸­ä¼ å…¥start|end|chars|commentå››ä¸ªé’©å­å‡½æ•°</span>
  <span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    warn<span class="token punctuation">,</span>
    <span class="token literal-property property">expectHTML</span><span class="token operator">:</span> options<span class="token punctuation">.</span>expectHTML<span class="token punctuation">,</span>
    <span class="token literal-property property">isUnaryTag</span><span class="token operator">:</span> options<span class="token punctuation">.</span>isUnaryTag<span class="token punctuation">,</span>
    <span class="token literal-property property">canBeLeftOpenTag</span><span class="token operator">:</span> options<span class="token punctuation">.</span>canBeLeftOpenTag<span class="token punctuation">,</span>
    <span class="token literal-property property">shouldDecodeNewlines</span><span class="token operator">:</span> options<span class="token punctuation">.</span>shouldDecodeNewlines<span class="token punctuation">,</span>
    <span class="token literal-property property">shouldDecodeNewlinesForHref</span><span class="token operator">:</span> options<span class="token punctuation">.</span>shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
    <span class="token literal-property property">shouldKeepComment</span><span class="token operator">:</span> options<span class="token punctuation">.</span>comments<span class="token punctuation">,</span>
    <span class="token comment">// å½“è§£æåˆ°å¼€å§‹æ ‡ç­¾æ—¶ï¼Œè°ƒç”¨è¯¥å‡½æ•°</span>
    <span class="token function">start</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// å½“è§£æåˆ°ç»“æŸæ ‡ç­¾æ—¶ï¼Œè°ƒç”¨è¯¥å‡½æ•°</span>
    <span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * å½“è§£æåˆ°æ–‡æœ¬æ—¶ï¼Œè°ƒç”¨è¯¥å‡½æ•°ï¼Œç”Ÿæˆæ–‡æœ¬ç±»å‹çš„ASTèŠ‚ç‚¹
     * é¦–å…ˆä¼šåˆ¤æ–­æ–‡æœ¬æ˜¯ä¸æ˜¯ä¸€ä¸ªå¸¦å˜é‡çš„åŠ¨æ€æ–‡æœ¬ï¼Œå¦‚â€œhello â€ã€‚
     * å¦‚æœæ˜¯åŠ¨æ€æ–‡æœ¬ï¼Œåˆ™åˆ›å»ºåŠ¨æ€æ–‡æœ¬ç±»å‹çš„ASTèŠ‚ç‚¹ï¼›
     * å¦‚æœä¸æ˜¯åŠ¨æ€æ–‡æœ¬ï¼Œåˆ™åˆ›å»ºçº¯é™æ€æ–‡æœ¬ç±»å‹çš„ASTèŠ‚ç‚¹ã€‚
     */</span>
    <span class="token function">chars</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// å½“è§£æåˆ°æ³¨é‡Šæ—¶ï¼Œè°ƒç”¨è¯¥å‡½æ•°ï¼Œè¯¥é’©å­å‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ªæ³¨é‡Šç±»å‹çš„ASTèŠ‚ç‚¹ã€‚</span>
    <span class="token function">comment</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> root
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è§£ææ•´ä¸ªHTMLçš„è¿‡ç¨‹ä¸­ï¼Œè¦å®Œæˆçš„ä»»åŠ¡åŒ…æ‹¬ï¼š</p><ul><li>éœ€è¦è¶Šè¿‡åˆæ³•ä½†æ— æ•ˆçš„ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼šDOCTYPEã€æ¡ä»¶æ³¨é‡Š</li><li>æå–å‡ºåˆæ³•ä¸”æœ‰æ•ˆçš„ä¿¡æ¯ï¼Œå¹¶å°†å…¶ä½œä¸ºå‚æ•°ï¼Œä¾æ®ä¿¡æ¯ç±»å‹ï¼Œè°ƒç”¨ç›¸åº”çš„é’©å­å‡½æ•°ç”ŸæˆAST</li></ul><p>å…¶ä¸­<code>AST</code>çš„ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">tag</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">attrs</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>ASTAttr<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">parent</span><span class="token operator">:</span> ASTElement <span class="token operator">|</span> <span class="token keyword">void</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> ASTElement <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>
    <span class="token literal-property property">attrsList</span><span class="token operator">:</span> attrs<span class="token punctuation">,</span>
    <span class="token literal-property property">attrsMap</span><span class="token operator">:</span> <span class="token function">makeAttrsMap</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">rawAttrsMap</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è°ƒç”¨<code>parseHTML</code>ä¼ å…¥çš„é…ç½®é¡¹ä¸­ï¼Œå®šä¹‰äº†å››ä¸ªé’©å­å‡½æ•°ï¼š<code>startã€endã€charsã€comment</code>ã€‚</p><table><thead><tr><th>é’©å­å‡½æ•°</th><th>å®ç°åŠŸèƒ½</th></tr></thead><tbody><tr><td>start</td><td>åˆ›å»ºå…ƒç´ ç±»å‹ï¼ˆ1ï¼‰çš„ASTèŠ‚ç‚¹ï¼Œè¿›è¡Œä¸€äº›é¢„å˜æ¢æ“ä½œï¼Œæ‰§è¡Œè§£ææ¨¡æ¿ä¸­çš„ç»“æ„åŒ–æŒ‡ä»¤ï¼ˆv-forã€v-ifã€v-onceï¼‰</td></tr><tr><td>end</td><td>å¼¹å‡ºè°ƒç”¨æ ˆæ ˆé¡¶çš„ASTèŠ‚ç‚¹ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å¤„ç†å…ƒç´ çš„å…³é—­æ“ä½œï¼Œå¹¶è¿›è¡Œç›¸åº”çš„æ ‘ç®¡ç†ï¼ˆASTèŠ‚ç‚¹ä¹‹é—´çš„å±‚çº§å…³ç³»ï¼‰</td></tr><tr><td>chars</td><td>å¤„ç†æ–‡æœ¬ä¹‹é—´çš„å›è½¦ç¬¦ã€ç©ºç™½ç¬¦å’Œç¼–è§£ç ï¼Œè°ƒç”¨parseTextè§£ææ–‡æœ¬ï¼Œæ ¹æ®è¿”å›çš„ç»“æœåˆ›å»ºå¸¦å˜é‡ï¼ˆ2ï¼‰çš„ASTèŠ‚ç‚¹æˆ–çº¯æ–‡æœ¬èŠ‚ç‚¹ï¼ˆ3ï¼‰</td></tr><tr><td>comment</td><td>åˆ›å»ºæ³¨é‡ŠèŠ‚ç‚¹ï¼ˆ3ä¸”isCommentä¸ºtrueï¼‰</td></tr></tbody></table><h4 id="htmlè§£æå™¨" tabindex="-1"><a class="header-anchor" href="#htmlè§£æå™¨"><span>HTMLè§£æå™¨</span></a></h4><ol><li>å½“å‰htmlå­—ç¬¦ä¸²æ²¡æœ‰çˆ¶èŠ‚ç‚¹æˆ–è€…çˆ¶èŠ‚ç‚¹ä¸æ˜¯çº¯æ–‡æœ¬æ ‡ç­¾(<code>script,style,textarea</code>) <ol><li>å¦‚æœhtmlå­—ç¬¦ä¸²æ˜¯ä»¥<code>&lt;</code>å¼€å¤´,åˆ™æœ‰ä»¥ä¸‹äº”ç§å¯èƒ½ï¼Œä¸€ä¸€å»åŒ¹é…å°è¯• <ul><li>å¼€å§‹æ ‡ç­¾:<code>&lt;div&gt;</code>ï¼Œæå–ç»„ç»‡æ•°æ®æ ¼å¼ï¼Œè°ƒç”¨<code>start(tagName, attrs, unary, match.start, match.end)</code></li><li>ç»“æŸæ ‡ç­¾:<code>&lt;/div&gt;</code>ï¼Œè°ƒç”¨<code>end(stack[i].tag, start, end)</code></li><li>æ³¨é‡Š:<code>&lt;!-- æˆ‘æ˜¯æ³¨é‡Š --&gt;</code>ï¼Œè°ƒç”¨<code>comment(&#39;æˆ‘æ˜¯æ³¨é‡Š&#39;,start,end)</code>åˆ›å»ºæ³¨é‡ŠAST</li><li>æ¡ä»¶æ³¨é‡Š:<code>&lt;!-- [if !IE] --&gt; &lt;!-- [endif] --&gt;</code>ï¼Œç›´æ¥è¶Šè¿‡</li><li>DOCTYPE:<code>&lt;!DOCTYPE html&gt;</code>ï¼Œç›´æ¥è¶Šè¿‡</li></ul></li><li><code>&lt;</code> ä¸åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œè¯´æ˜htmlå­—ç¬¦ä¸²ä»¥æ–‡æœ¬å¼€å¤´,éœ€è¦æå–å‡ºè¿™æ®µæ–‡æœ¬ï¼Œç„¶åè¶Šè¿‡</li><li>æ•´ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²é‡Œæ²¡æœ‰æ‰¾åˆ°<code>&lt;</code>,è¯´æ˜æ•´ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²éƒ½æ˜¯æ–‡æœ¬</li><li>è¶Šè¿‡æ–‡æœ¬å†…å®¹ï¼Œç„¶åæŠŠæˆªå–å‡ºæ¥çš„<code>text</code>è½¬åŒ–æˆ<code>textAST</code>ï¼Œ<code>chars(text, start, end)</code></li></ol></li><li>çˆ¶å…ƒç´ ä¸º<code>scriptã€styleã€textarea</code>æ—¶ï¼Œå› ä¸ºåœ¨è¿™ä¸‰ä¸ªæ ‡ç­¾é‡Œçš„å†…å®¹è‚¯å®šä¸ä¼šæœ‰HTMLæ ‡ç­¾ï¼Œæ‰€ä»¥å…¶å†…éƒ¨çš„å†…å®¹å…¨éƒ¨å½“åšçº¯æ–‡æœ¬å¤„ç†</li></ol><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseHTML</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// ç»´æŠ¤ASTèŠ‚ç‚¹å±‚çº§çš„æ ˆ</span>
    <span class="token keyword">const</span> expectHTML <span class="token operator">=</span> options<span class="token punctuation">.</span>expectHTML<span class="token punctuation">;</span>
    <span class="token keyword">const</span> isUnaryTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isUnaryTag <span class="token operator">||</span> no<span class="token punctuation">;</span> <span class="token comment">// æ˜¯å¦è‡ªé—­å’Œ</span>
    <span class="token keyword">const</span> canBeLeftOpenTag <span class="token operator">=</span> options<span class="token punctuation">.</span>canBeLeftOpenTag <span class="token operator">||</span> no<span class="token punctuation">;</span> <span class="token comment">//ç”¨æ¥æ£€æµ‹ä¸€ä¸ªæ ‡ç­¾æ˜¯å¦æ˜¯å¯ä»¥çœç•¥é—­åˆæ ‡ç­¾çš„éè‡ªé—­åˆæ ‡ç­¾</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//è§£ææ¸¸æ ‡ï¼Œæ ‡è¯†å½“å‰ä»ä½•å¤„å¼€å§‹è§£ææ¨¡æ¿å­—ç¬¦ä¸²</span>
    <span class="token keyword">let</span> last<span class="token punctuation">,</span> <span class="token comment">// å­˜å‚¨å‰©ä½™è¿˜æœªè§£æçš„æ¨¡æ¿å­—ç¬¦ä¸²Â·</span>
        lastTag<span class="token punctuation">;</span> <span class="token comment">// å­˜å‚¨ç€ä½äº stack æ ˆé¡¶çš„å…ƒç´ </span>

    <span class="token comment">// å¼€å¯ä¸€ä¸ª while å¾ªç¯ï¼Œå¾ªç¯ç»“æŸçš„æ¡ä»¶æ˜¯ html ä¸ºç©ºï¼Œå³ html è¢« parse å®Œæ¯•</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        last <span class="token operator">=</span> html<span class="token punctuation">;</span>
        <span class="token comment">// ç¡®ä¿å³å°† parse çš„å†…å®¹ä¸æ˜¯åœ¨çº¯æ–‡æœ¬æ ‡ç­¾é‡Œ (script,style,textarea)</span>
        <span class="token comment">// !lastTagè¡¨ç¤ºå½“å‰htmlå­—ç¬¦ä¸²æ²¡æœ‰çˆ¶èŠ‚ç‚¹</span>
        <span class="token comment">// ä¹Ÿå°±æ˜¯è¯´å½“å‰htmlå­—ç¬¦ä¸²è¦ä¹ˆæ²¡æœ‰çˆ¶èŠ‚ç‚¹è¦ä¹ˆçˆ¶èŠ‚ç‚¹ä¸æ˜¯çº¯æ–‡æœ¬æ ‡ç­¾</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastTag <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isPlainTextElement</span><span class="token punctuation">(</span>lastTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token doc-comment comment">/**
       * å¦‚æœhtmlå­—ç¬¦ä¸²æ˜¯ä»¥&#39;&lt;&#39;å¼€å¤´,åˆ™æœ‰ä»¥ä¸‹äº”ç§å¯èƒ½
       * 1. å¼€å§‹æ ‡ç­¾:&lt;div&gt;
       * 2. ç»“æŸæ ‡ç­¾:&lt;/div&gt;
       * 3. æ³¨é‡Š:&lt;!-- æˆ‘æ˜¯æ³¨é‡Š --&gt;
       * 4. æ¡ä»¶æ³¨é‡Š:&lt;!-- [if !IE] --&gt; &lt;!-- [endif] --&gt;
       * 5. DOCTYPE:&lt;!DOCTYPE html&gt;
       * éœ€è¦ä¸€ä¸€å»åŒ¹é…å°è¯•
       */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è‹¥ä¸ºæ³¨é‡Šï¼Œåˆ™ç»§ç»­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨&#39;--&gt;&#39;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> commentEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;--&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>commentEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// è‹¥å­˜åœ¨ &#39;--&gt;&#39;,ç»§ç»­åˆ¤æ–­optionsä¸­æ˜¯å¦ä¿ç•™æ³¨é‡Š</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>shouldKeepComment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// è‹¥ä¿ç•™æ³¨é‡Šï¼Œåˆ™æŠŠæ³¨é‡Šæˆªå–å‡ºæ¥ä¼ ç»™options.commentï¼Œåˆ›å»ºæ³¨é‡Šç±»å‹çš„ASTèŠ‚ç‚¹</span>
                            options<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span>
                                html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> commentEnd<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                index<span class="token punctuation">,</span>
                                index <span class="token operator">+</span> commentEnd <span class="token operator">+</span> <span class="token number">3</span>
                            <span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// è‹¥ä¸ä¿ç•™æ³¨é‡Šï¼Œåˆ™å°†æ¸¸æ ‡ç§»åŠ¨åˆ°&#39;--&gt;&#39;ä¹‹åï¼Œç»§ç»­å‘åè§£æ</span>
                        <span class="token function">advance</span><span class="token punctuation">(</span>commentEnd <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// è§£ææ˜¯å¦æ˜¯æ¡ä»¶æ³¨é‡Š</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionalComment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è‹¥ä¸ºæ¡ä»¶æ³¨é‡Šï¼Œåˆ™ç»§ç»­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨&#39;]&gt;&#39;</span>
                    <span class="token keyword">const</span> conditionalEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;]&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// è‹¥å­˜åœ¨ &#39;]&gt;&#39;,åˆ™ä»åŸæœ¬çš„htmlå­—ç¬¦ä¸²ä¸­æŠŠæ¡ä»¶æ³¨é‡Šæˆªæ‰ï¼Œ</span>
                    <span class="token comment">// æŠŠå‰©ä¸‹çš„å†…å®¹é‡æ–°èµ‹ç»™htmlï¼Œç»§ç»­å‘ååŒ¹é…</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionalEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">advance</span><span class="token punctuation">(</span>conditionalEnd <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// è§£ææ˜¯å¦æ˜¯DOCTYPE</span>
                <span class="token keyword">const</span> doctypeMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>doctype<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">advance</span><span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// è§£ææ˜¯å¦æ˜¯ç»“æŸæ ‡ç­¾</span>
                <span class="token keyword">const</span> endTagMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>endTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> curIndex <span class="token operator">=</span> index<span class="token punctuation">;</span>
                    <span class="token function">advance</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">parseEndTag</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> curIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// è§£ææ˜¯å¦æ˜¯å¼€å§‹æ ‡ç­¾</span>
                <span class="token keyword">const</span> startTagMatch <span class="token operator">=</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// match{tagName,attrs,start}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">handleStartTag</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldIgnoreFirstNewline</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">advance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">let</span> text<span class="token punctuation">,</span> rest<span class="token punctuation">,</span> next<span class="token punctuation">;</span>
            <span class="token comment">// &#39;&lt;&#39; ä¸åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œè¯´æ˜htmlå­—ç¬¦ä¸²ä»¥æ–‡æœ¬å¼€å¤´,éœ€è¦æå–å‡ºè¿™æ®µæ–‡æœ¬</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœhtmlå­—ç¬¦ä¸²ä¸æ˜¯ä»¥&#39;&lt;&#39;å¼€å¤´,è¯´æ˜&#39;&lt;&#39;å‰é¢çš„éƒ½æ˜¯çº¯æ–‡æœ¬ï¼Œæ— éœ€å¤„ç†</span>
                <span class="token comment">// é‚£å°±æŠŠ&#39;&lt;&#39;ä»¥åçš„å†…å®¹æ‹¿å‡ºæ¥èµ‹ç»™rest</span>
                rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>textEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>
                    <span class="token operator">!</span>endTag<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">!</span>startTagOpen<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">!</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">!</span>conditionalComment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span>
                <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token doc-comment comment">/**
           * ç”¨&#39;&lt;&#39;ä»¥åçš„å†…å®¹restå»åŒ¹é…endTagã€startTagOpenã€commentã€conditionalComment
           * å¦‚æœéƒ½åŒ¹é…ä¸ä¸Šï¼Œè¡¨ç¤º&#39;&lt;&#39;æ˜¯å±äºæ–‡æœ¬æœ¬èº«çš„å†…å®¹
           */</span>
                    <span class="token comment">// åœ¨&#39;&lt;&#39;ä¹‹åæŸ¥æ‰¾æ˜¯å¦è¿˜æœ‰&#39;&lt;&#39;</span>
                    next <span class="token operator">=</span> rest<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// å¦‚æœæ²¡æœ‰äº†ï¼Œè¡¨ç¤º&#39;&lt;&#39;åé¢ä¹Ÿæ˜¯æ–‡æœ¬</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token comment">// å¦‚æœè¿˜æœ‰ï¼Œè¡¨ç¤º&#39;&lt;&#39;æ˜¯æ–‡æœ¬ä¸­çš„ä¸€ä¸ªå­—ç¬¦</span>
                    textEnd <span class="token operator">+=</span> next<span class="token punctuation">;</span>
                    <span class="token comment">// é‚£å°±æŠŠnextä¹‹åçš„å†…å®¹æˆªå‡ºæ¥ç»§ç»­ä¸‹ä¸€è½®å¾ªç¯åŒ¹é…</span>
                    rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>textEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// &#39;&lt;&#39;æ˜¯ç»“æŸæ ‡ç­¾çš„å¼€å§‹ ,è¯´æ˜ä»å¼€å§‹åˆ°&#39;&lt;&#39;éƒ½æ˜¯æ–‡æœ¬ï¼Œæˆªå–å‡ºæ¥</span>
                text <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> textEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// æ•´ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²é‡Œæ²¡æœ‰æ‰¾åˆ°`&lt;`,è¯´æ˜æ•´ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²éƒ½æ˜¯æ–‡æœ¬</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                text <span class="token operator">=</span> html<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">advance</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// æŠŠæˆªå–å‡ºæ¥çš„textè½¬åŒ–æˆtextAST</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>chars <span class="token operator">&amp;&amp;</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> index <span class="token operator">-</span> text<span class="token punctuation">.</span>length<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// çˆ¶å…ƒç´ ä¸ºscriptã€styleã€textareaæ—¶ï¼Œå…¶å†…éƒ¨çš„å†…å®¹å…¨éƒ¨å½“åšçº¯æ–‡æœ¬å¤„ç†</span>
        <span class="token comment">// å› ä¸ºåœ¨è¿™ä¸‰ä¸ªæ ‡ç­¾é‡Œçš„å†…å®¹è‚¯å®šä¸ä¼šæœ‰HTMLæ ‡ç­¾</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> endTagLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> stackedTag <span class="token operator">=</span> lastTag<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å½“å‰æ­£åœ¨å¤„ç†çš„æ ‡ç­¾å</span>
            <span class="token keyword">const</span> reStackedTag <span class="token operator">=</span>
                  reCache<span class="token punctuation">[</span>stackedTag<span class="token punctuation">]</span> <span class="token operator">||</span>
                  <span class="token punctuation">(</span>reCache<span class="token punctuation">[</span>stackedTag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>
                      <span class="token string">&quot;([\\s\\S]*?)(&lt;/&quot;</span> <span class="token operator">+</span> stackedTag <span class="token operator">+</span> <span class="token string">&quot;[^&gt;]*&gt;)&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;i&quot;</span>
                  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å›è°ƒå‡½æ•°ä¼šåœ¨æ¯æ¬¡åŒ¹é…åˆ°é—­åˆæ ‡ç­¾æ—¶è¢«è°ƒç”¨</span>
            <span class="token keyword">const</span> rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reStackedTag<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">all<span class="token punctuation">,</span> text<span class="token punctuation">,</span> endTag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                endTagLength <span class="token operator">=</span> endTag<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainTextElement</span><span class="token punctuation">(</span>stackedTag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> stackedTag <span class="token operator">!==</span> <span class="token string">&quot;noscript&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    text <span class="token operator">=</span> text
                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;!\--([\s\S]*?)--&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// #7298</span>
                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;!\[CDATA\[([\s\S]*?)]]&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldIgnoreFirstNewline</span><span class="token punctuation">(</span>stackedTag<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>chars<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            index <span class="token operator">+=</span> html<span class="token punctuation">.</span>length <span class="token operator">-</span> rest<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            html <span class="token operator">=</span> rest<span class="token punctuation">;</span>
            <span class="token function">parseEndTag</span><span class="token punctuation">(</span>stackedTag<span class="token punctuation">,</span> index <span class="token operator">-</span> endTagLength<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ç»è¿‡ä¸Šè¿°æ‰€æœ‰å¤„ç†é€»è¾‘å¤„ç†è¿‡åï¼Œhtmlå­—ç¬¦ä¸²æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œè¡¨ç¤ºhtmlå­—ç¬¦ä¸²æ²¡æœ‰åŒ¹é…ä¸Šä»»ä½•ä¸€æ¡è§„åˆ™ï¼Œé‚£ä¹ˆå°±æŠŠhtmlå­—ç¬¦ä¸²å½“ä½œçº¯æ–‡æœ¬å¯¹å¾…</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>html <span class="token operator">===</span> last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            options<span class="token punctuation">.</span>chars <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span>stack<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span>
                options<span class="token punctuation">.</span>warn
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Mal-formatted tag at end of template: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">start</span><span class="token operator">:</span> index <span class="token operator">+</span> html<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Clean up any remaining tags</span>
    <span class="token comment">// è°ƒç”¨parseEndTagå‡½æ•°å¹¶ä¸ä¼ é€’ä»»ä½•å‚æ•°</span>
    <span class="token comment">// ç”¨äºå¤„ç†æ ˆä¸­å‰©ä½™æœªå¤„ç†çš„æ ‡ç­¾</span>
    <span class="token function">parseEndTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
   * ç§»åŠ¨è§£ææ¸¸æ ‡
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">n</span> å­—ç¬¦ä¸²å‘å³ç§»åŠ¨çš„ç´¢å¼•æ•°
   */</span>
    <span class="token keyword">function</span> <span class="token function">advance</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        index <span class="token operator">+=</span> n<span class="token punctuation">;</span>
        html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * è§£æå¼€å§‹æ ‡ç­¾
   * <span class="token keyword">@example</span>
   <span class="token example">* <span class="token code language-javascript">match<span class="token punctuation">{</span></span>
   *  <span class="token code language-javascript"><span class="token literal-property property">tagName</span><span class="token operator">:</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span></span>
   *  <span class="token code language-javascript"><span class="token literal-property property">start</span><span class="token operator">:</span><span class="token punctuation">,</span></span>
   *  <span class="token code language-javascript"><span class="token literal-property property">end</span><span class="token operator">:</span><span class="token punctuation">,</span></span>
   *  <span class="token code language-javascript"><span class="token literal-property property">attrs</span><span class="token operator">:</span><span class="token punctuation">[</span></span>
   *    <span class="token code language-javascript"><span class="token punctuation">[</span><span class="token string">&quot;class=&quot;</span>a<span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">&quot;class=&quot;</span>a<span class="token string">&quot; id=&quot;</span>b<span class="token string">&quot;&gt;&lt;/div&gt;&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">groups</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
   *    <span class="token code language-javascript"><span class="token operator">...</span></span>
   *  <span class="token code language-javascript"><span class="token punctuation">]</span></span>
   * <span class="token code language-javascript"><span class="token punctuation">}</span></span></span>
   */</span>
    <span class="token keyword">function</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è§£æå¼€å§‹æ ‡ç­¾  // &#39;&lt;div&gt;&lt;/div&gt;&#39;.match(startTagOpen)  =&gt; [&#39;&lt;div&#39;,&#39;div&#39;,index:0,input:&#39;&lt;div&gt;&lt;/div&gt;&#39;]</span>
        <span class="token keyword">const</span> start <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">tagName</span><span class="token operator">:</span> start<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">attrs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">start</span><span class="token operator">:</span> index<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token function">advance</span><span class="token punctuation">(</span>start<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> end<span class="token punctuation">,</span> attr<span class="token punctuation">;</span>
            <span class="token doc-comment comment">/**
       * &lt;div a=1 b=2 c=3&gt;&lt;/div&gt;
       * ä»&lt;divä¹‹ååˆ°å¼€å§‹æ ‡ç­¾çš„ç»“æŸç¬¦å·&#39;&gt;&#39;ä¹‹å‰ï¼Œä¸€ç›´åŒ¹é…å±æ€§attrs
       * æ‰€æœ‰å±æ€§åŒ¹é…å®Œä¹‹åï¼Œhtmlå­—ç¬¦ä¸²è¿˜å‰©ä¸‹
       * è‡ªé—­åˆæ ‡ç­¾å‰©ä¸‹ï¼š&#39;/&gt;&#39;
       * éè‡ªé—­åˆæ ‡ç­¾å‰©ä¸‹ï¼š&#39;&gt;&lt;/div&gt;&#39;
       */</span>
            <span class="token comment">// è§£ææ ‡ç­¾å±æ€§</span>
            <span class="token comment">// ä¸ç¬¦åˆå¼€å§‹æ ‡ç­¾çš„ç»“æŸç‰¹å¾ï¼ˆstartTagCloseï¼‰å¹¶ä¸”ç¬¦åˆæ ‡ç­¾å±æ€§çš„ç‰¹å¾ï¼Œè¯´æ˜è¿˜æœ‰æœªæå–å‡ºçš„æ ‡ç­¾å±æ€§</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>
                <span class="token operator">!</span><span class="token punctuation">(</span>end <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>attr <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>dynamicArgAttribute<span class="token punctuation">)</span> <span class="token operator">||</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                attr<span class="token punctuation">.</span>start <span class="token operator">=</span> index<span class="token punctuation">;</span>
                <span class="token function">advance</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                attr<span class="token punctuation">.</span>end <span class="token operator">=</span> index<span class="token punctuation">;</span>
                match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token doc-comment comment">/**
       * è¿™é‡Œåˆ¤æ–­äº†è¯¥æ ‡ç­¾æ˜¯å¦ä¸ºè‡ªé—­åˆæ ‡ç­¾
       * è‡ªé—­åˆæ ‡ç­¾å¦‚:&lt;input type=&#39;text&#39; /&gt;
       * éè‡ªé—­åˆæ ‡ç­¾å¦‚:&lt;div&gt;&lt;/div&gt;
       * &#39;&gt;&lt;/div&gt;&#39;.match(startTagClose) =&gt; [&quot;&gt;&quot;, &quot;&quot;, index: 0, input: &quot;&gt;&lt;/div&gt;&quot;, groups: undefined]
       * &#39;/&gt;&lt;div&gt;&lt;/div&gt;&#39;.match(startTagClose) =&gt; [&quot;/&gt;&quot;, &quot;/&quot;, index: 0, input: &quot;/&gt;&lt;div&gt;&lt;/div&gt;&quot;, groups: undefined]
       * å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡end[1]æ˜¯å¦æ˜¯&quot;/&quot;æ¥åˆ¤æ–­è¯¥æ ‡ç­¾æ˜¯å¦æ˜¯è‡ªé—­åˆæ ‡ç­¾
       */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                match<span class="token punctuation">.</span>unarySlash <span class="token operator">=</span> end<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token function">advance</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                match<span class="token punctuation">.</span>end <span class="token operator">=</span> index<span class="token punctuation">;</span>
                <span class="token keyword">return</span> match<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
   * å¤„ç†æå–å‡ºçš„ä¿¡æ¯(attrs),
   * ç»„è£…å¥½æ•°æ®ä¹‹ååˆ›å»ºastèŠ‚ç‚¹
   * <span class="token keyword">@example</span>
   <span class="token example">* <span class="token code language-javascript"><span class="token literal-property property">attrs</span><span class="token operator">:</span><span class="token punctuation">[</span></span>
   *  <span class="token code language-javascript"><span class="token punctuation">{</span></span>
   *    <span class="token code language-javascript"><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">&#39;class&#39;</span><span class="token punctuation">,</span></span>
   *    <span class="token code language-javascript"><span class="token literal-property property">value</span><span class="token operator">:</span><span class="token string">&#39;a&#39;</span></span>
   *  <span class="token code language-javascript"><span class="token punctuation">}</span></span>
   * <span class="token code language-javascript"><span class="token punctuation">]</span></span></span>
   *
   */</span>
    <span class="token keyword">function</span> <span class="token function">handleStartTag</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> tagName <span class="token operator">=</span> match<span class="token punctuation">.</span>tagName<span class="token punctuation">;</span> <span class="token comment">// å¼€å§‹æ ‡ç­¾çš„æ ‡ç­¾å</span>
        <span class="token keyword">const</span> unarySlash <span class="token operator">=</span> match<span class="token punctuation">.</span>unarySlash<span class="token punctuation">;</span> <span class="token comment">// æ˜¯å¦ä¸ºè‡ªé—­åˆæ ‡ç­¾çš„æ ‡å¿—ï¼Œè‡ªé—­åˆä¸º&quot;&quot;,éè‡ªé—­åˆä¸º&quot;/&quot;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>expectHTML<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTag <span class="token operator">===</span> <span class="token string">&quot;p&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNonPhrasingTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">parseEndTag</span><span class="token punctuation">(</span>lastTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canBeLeftOpenTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lastTag <span class="token operator">===</span> tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">parseEndTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> unary <span class="token operator">=</span> <span class="token function">isUnaryTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>unarySlash<span class="token punctuation">;</span> <span class="token comment">// å¸ƒå°”å€¼ï¼Œæ ‡å¿—æ˜¯å¦ä¸ºè‡ªé—­åˆæ ‡ç­¾</span>
        <span class="token keyword">const</span> l <span class="token operator">=</span> match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// match.attrs æ•°ç»„çš„é•¿åº¦</span>
        <span class="token keyword">const</span> attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¸€ä¸ªä¸match.attrsæ•°ç»„é•¿åº¦ç›¸ç­‰çš„æ•°ç»„</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// [&quot;class=&quot;a&quot;&quot;, &quot;class&quot;, &quot;=&quot;, &quot;a&quot;, undefined, undefined, index: 0, input: &quot;class=&quot;a&quot; id=&quot;b&quot;&gt;&lt;/div&gt;&quot;, groups: undefined]</span>
            <span class="token keyword">const</span> args <span class="token operator">=</span> match<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> args<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">||</span> args<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">// åšä¸€äº›å…¼å®¹æ€§å¤„ç†ï¼Œ å¦‚æœ shouldDecodeNewlines ä¸º trueï¼Œæ„å‘³ç€ Vue åœ¨ç¼–è¯‘æ¨¡æ¿çš„æ—¶å€™ï¼Œè¦å¯¹å±æ€§å€¼ä¸­çš„æ¢è¡Œç¬¦æˆ–åˆ¶è¡¨ç¬¦åšå…¼å®¹å¤„ç†ã€‚</span>
            <span class="token comment">// shouldDecodeNewlinesForHrefä¸ºtrue æ„å‘³ç€Vueåœ¨ç¼–è¯‘æ¨¡æ¿çš„æ—¶å€™ï¼Œè¦å¯¹aæ ‡ç­¾çš„ hrefå±æ€§å€¼ä¸­çš„æ¢è¡Œç¬¦æˆ–åˆ¶è¡¨ç¬¦åšå…¼å®¹å¤„ç†</span>
            <span class="token keyword">const</span> shouldDecodeNewlines <span class="token operator">=</span>
                  tagName <span class="token operator">===</span> <span class="token string">&quot;a&quot;</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;href&quot;</span>
            <span class="token operator">?</span> options<span class="token punctuation">.</span>shouldDecodeNewlinesForHref
            <span class="token operator">:</span> options<span class="token punctuation">.</span>shouldDecodeNewlines<span class="token punctuation">;</span>
            attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">name</span><span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// æ ‡ç­¾å±æ€§çš„å±æ€§åï¼Œå¦‚class</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">decodeAttr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> shouldDecodeNewlines<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// æ ‡ç­¾å±æ€§çš„å±æ€§å€¼ï¼Œå¦‚classå¯¹åº”çš„a</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>outputSourceRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>start <span class="token operator">=</span> args<span class="token punctuation">.</span>start <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> args<span class="token punctuation">.</span>end<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å¦‚æœè¯¥æ ‡ç­¾æ˜¯éè‡ªé—­åˆæ ‡ç­¾ï¼Œåˆ™å°†æ ‡ç­¾æ¨å…¥æ ˆä¸­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>unary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">tag</span><span class="token operator">:</span> tagName<span class="token punctuation">,</span>
                <span class="token literal-property property">lowerCasedTag</span><span class="token operator">:</span> tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token literal-property property">attrs</span><span class="token operator">:</span> attrs<span class="token punctuation">,</span>
                <span class="token literal-property property">start</span><span class="token operator">:</span> match<span class="token punctuation">.</span>start<span class="token punctuation">,</span>
                <span class="token literal-property property">end</span><span class="token operator">:</span> match<span class="token punctuation">.</span>end<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lastTag <span class="token operator">=</span> tagName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å¦‚æœè¯¥æ ‡ç­¾æ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œè°ƒç”¨starté’©å­å‡½æ•°å¹¶ä¼ å…¥å¤„ç†å¥½çš„å‚æ•°æ¥åˆ›å»ºASTèŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            options<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> match<span class="token punctuation">.</span>start<span class="token punctuation">,</span> match<span class="token punctuation">.</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/** è§£æç»“æŸæ ‡ç­¾ï¼Œä»æ ‡ç­¾æ ˆä¸­åŒ¹é…æ­£ç¡®çš„æ ‡ç­¾ */</span>
    <span class="token keyword">function</span> <span class="token function">parseEndTag</span><span class="token punctuation">(</span><span class="token parameter">tagName<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> pos<span class="token punctuation">,</span> lowerCasedTagName<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> start <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> end <span class="token operator">=</span> index<span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
     * å¦‚æœtagNameå­˜åœ¨ï¼Œé‚£ä¹ˆå°±ä»åå¾€å‰éå†æ ˆï¼Œ
     * åœ¨æ ˆä¸­å¯»æ‰¾ä¸tagNameç›¸åŒçš„æ ‡ç­¾å¹¶è®°å½•å…¶æ‰€åœ¨çš„ä½ç½®posï¼Œ
     * å¦‚æœtagNameä¸å­˜åœ¨ï¼Œåˆ™å°†posç½®ä¸º0
     */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lowerCasedTagName <span class="token operator">=</span> tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>pos <span class="token operator">=</span> stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> pos <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> pos<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">.</span>lowerCasedTag <span class="token operator">===</span> lowerCasedTagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// If no tag name is provided, clean shop</span>
            pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// pos&gt;=0ï¼Œè¯´æ˜æ ˆä¸­å­˜åœ¨ä¸ä¹‹å¯¹åº”çš„å¼€å§‹æ ‡ç­¾</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
       * æ­£å¸¸çš„posåº”è¯¥æ˜¯æ ˆé¡¶ä½ç½®ï¼Œåé¢ä¸åº”è¯¥å†æœ‰å…ƒç´ ï¼Œ
       * å¦‚æœåé¢è¿˜æœ‰å…ƒç´ ï¼Œé‚£ä¹ˆåé¢çš„å…ƒç´ å°±éƒ½ç¼ºå°‘é—­åˆæ ‡ç­¾
       */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> pos<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>
                    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> pos <span class="token operator">||</span> <span class="token operator">!</span>tagName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    options<span class="token punctuation">.</span>warn
                <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    options<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">tag &lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt; has no matching end tag.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">start</span><span class="token operator">:</span> stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    options<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// æŠŠposä½ç½®ä»¥åçš„å…ƒç´ éƒ½ä»stackæ ˆä¸­å¼¹å‡ºï¼Œä»¥åŠæŠŠlastTagæ›´æ–°ä¸ºæ ˆé¡¶å…ƒç´ :</span>
            stack<span class="token punctuation">.</span>length <span class="token operator">=</span> pos<span class="token punctuation">;</span>
            lastTag <span class="token operator">=</span> pos <span class="token operator">&amp;&amp;</span> stack<span class="token punctuation">[</span>pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// pos&lt;0,åœ¨ stack æ ˆä¸­æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å¼€å§‹æ ‡ç­¾</span>
        <span class="token comment">// åˆ¤æ–­ tagName æ˜¯å¦ä¸ºbr æˆ–pæ ‡ç­¾</span>
        <span class="token comment">// æµè§ˆå™¨ä¼šè‡ªåŠ¨æŠŠ&lt;/br&gt;æ ‡ç­¾è§£æä¸ºæ­£å¸¸çš„ &lt;br&gt;æ ‡ç­¾ï¼Œè€Œå¯¹äº&lt;/p&gt;æµè§ˆå™¨åˆ™è‡ªåŠ¨å°†å…¶è¡¥å…¨ä¸º&lt;p&gt;&lt;/p&gt;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lowerCasedTagName <span class="token operator">===</span> <span class="token string">&quot;br&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆ›å»º&lt;br&gt;ASTèŠ‚ç‚¹</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lowerCasedTagName <span class="token operator">===</span> <span class="token string">&quot;p&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¡¥å…¨pæ ‡ç­¾å¹¶åˆ›å»ºASTèŠ‚ç‚¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ–‡æœ¬è§£æå™¨" tabindex="-1"><a class="header-anchor" href="#æ–‡æœ¬è§£æå™¨"><span>æ–‡æœ¬è§£æå™¨</span></a></h4><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseText</span><span class="token punctuation">(</span>
  <span class="token literal-property property">text</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token comment">//ä¼ å…¥çš„æ–‡æœ¬</span>
  delimiters<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">,</span> string<span class="token punctuation">]</span> <span class="token comment">//å¯é€‰å‚æ•°ï¼Œè‡ªå®šä¹‰åŒ…è£¹å˜é‡æ‰€ç”¨ç¬¦å·</span>
<span class="token punctuation">)</span><span class="token operator">:</span> TextParseResult <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tagRE <span class="token operator">=</span> delimiters <span class="token operator">?</span> <span class="token function">buildRegex</span><span class="token punctuation">(</span>delimiters<span class="token punctuation">)</span> <span class="token operator">:</span> defaultTagRE<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tagRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> rawTokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token punctuation">(</span>tagRE<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// tagRE.lastIndexè¡¨ç¤ºä¸‹ä¸€æ¬¡å¼€å§‹æœç´¢çš„ç´¢å¼•å€¼</span>
  <span class="token keyword">let</span> match<span class="token punctuation">,</span> index<span class="token punctuation">,</span> tokenValue<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>match <span class="token operator">=</span> tagRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// [&#39;{{name}}&#39;, &#39;name&#39;, index: 0, input: &#39;{{name}}&#39;, groups: undefined]</span>
    index <span class="token operator">=</span> match<span class="token punctuation">.</span>index<span class="token punctuation">;</span> <span class="token comment">// ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹çš„èµ·å§‹ä½ç½®</span>
    <span class="token comment">// push text token</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å…ˆæŠŠ&#39;{{&#39;å‰é¢çš„æ–‡æœ¬æ”¾å…¥tokensä¸­</span>
      rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tokenValue <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœindexä¸å¤§äºlastIndexï¼Œé‚£è¯´æ˜indexä¹Ÿä¸º0ï¼Œå³è¯¥æ–‡æœ¬ä¸€å¼€å§‹å°±æ˜¯å˜é‡</span>
    <span class="token comment">// å–å‡º&#39;{{ }}&#39;ä¸­é—´çš„å˜é‡exp</span>
    <span class="token keyword">const</span> exp <span class="token operator">=</span> <span class="token function">parseFilters</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æŠŠå˜é‡expæ”¹æˆ_s(exp)å½¢å¼ä¹Ÿæ”¾å…¥tokensä¸­</span>
    tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_s(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">&quot;@binding&quot;</span><span class="token operator">:</span> exp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ›´æ–°lastIndex</span>
    lastIndex <span class="token operator">=</span> index <span class="token operator">+</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å½“å‰©ä¸‹çš„textä¸å†è¢«æ­£åˆ™åŒ¹é…ä¸Šæ—¶ï¼Œè¡¨ç¤ºæ‰€æœ‰å˜é‡å·²ç»å¤„ç†å®Œæ¯•</span>
  <span class="token comment">// æ­¤æ—¶å¦‚æœlastIndex &lt; text.lengthï¼Œè¡¨ç¤ºåœ¨æœ€åä¸€ä¸ªå˜é‡åé¢è¿˜æœ‰æ–‡æœ¬</span>
  <span class="token comment">// æœ€åå°†åé¢çš„æ–‡æœ¬å†åŠ å…¥åˆ°tokensä¸­</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastIndex <span class="token operator">&lt;</span> text<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tokenValue <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">expression</span><span class="token operator">:</span> tokens<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tokens</span><span class="token operator">:</span> rawTokens<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åˆ¤æ–­ä¼ å…¥çš„æ–‡æœ¬æ˜¯å¦åŒ…å«å˜é‡</li><li>æ„é€ <code>expression</code></li><li>æ„é€ <code>tokens</code></li></ul><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">//&quot;æˆ‘å«{{name}}ï¼Œæˆ‘ä»Šå¹´{{age}}å²äº†&quot;</span>
res <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">expression</span><span class="token operator">:</span><span class="token string">&quot;æˆ‘å«&quot;</span><span class="token operator">+</span><span class="token function">_s</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;ï¼Œæˆ‘ä»Šå¹´&quot;</span><span class="token operator">+</span><span class="token function">_s</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;å²äº†&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tokens</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token string">&quot;æˆ‘å«&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string-property property">&#39;@binding&#39;</span><span class="token operator">:</span> name <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;ï¼Œæˆ‘ä»Šå¹´&quot;</span>
        <span class="token punctuation">{</span><span class="token string-property property">&#39;@binding&#39;</span><span class="token operator">:</span> age <span class="token punctuation">}</span><span class="token punctuation">,</span>
    	<span class="token string">&quot;å²äº†&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è¿‡æ»¤å™¨è§£æå™¨" tabindex="-1"><a class="header-anchor" href="#è¿‡æ»¤å™¨è§£æå™¨"><span>è¿‡æ»¤å™¨è§£æå™¨<span id="filter"></span></span></a></h4><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseFilters</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">exp</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">let</span> inSingle <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// expæ˜¯å¦åœ¨ &#39;&#39; ä¸­</span>
  <span class="token keyword">let</span> inDouble <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// expæ˜¯å¦åœ¨ &quot;&quot; ä¸­</span>
  <span class="token keyword">let</span> inTemplateString <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// expæ˜¯å¦åœ¨ `` ä¸­</span>
  <span class="token keyword">let</span> inRegex <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// expæ˜¯å¦åœ¨ \\ ä¸­</span>
  <span class="token keyword">let</span> curly <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// åœ¨expä¸­å‘ç°ä¸€ä¸ª { åˆ™curlyåŠ 1ï¼Œå‘ç°ä¸€ä¸ª } åˆ™curlyå‡1ï¼Œç›´åˆ°culyä¸º0 è¯´æ˜ { ... }é—­åˆ</span>
  <span class="token keyword">let</span> square <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// åœ¨expä¸­å‘ç°ä¸€ä¸ª [ åˆ™curlyåŠ 1ï¼Œå‘ç°ä¸€ä¸ª ] åˆ™curlyå‡1ï¼Œç›´åˆ°culyä¸º0 è¯´æ˜ [ ... ]é—­åˆ</span>
  <span class="token keyword">let</span> paren <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// åœ¨expä¸­å‘ç°ä¸€ä¸ª ( åˆ™curlyåŠ 1ï¼Œå‘ç°ä¸€ä¸ª ) åˆ™curlyå‡1ï¼Œç›´åˆ°culyä¸º0 è¯´æ˜ ( ... )é—­åˆ</span>
  <span class="token keyword">let</span> lastFilterIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> c<span class="token punctuation">,</span> prev<span class="token punctuation">,</span> i<span class="token punctuation">,</span> expression<span class="token punctuation">,</span> filters<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> exp<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    prev <span class="token operator">=</span> c<span class="token punctuation">;</span>
    c <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// \&#39;ã€\&quot;ã€\`ã€\/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inSingle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token number">0x27</span> <span class="token operator">&amp;&amp;</span> prev <span class="token operator">!==</span> <span class="token number">0x5c</span><span class="token punctuation">)</span> inSingle <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inDouble<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token number">0x22</span> <span class="token operator">&amp;&amp;</span> prev <span class="token operator">!==</span> <span class="token number">0x5c</span><span class="token punctuation">)</span> inDouble <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inTemplateString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token number">0x60</span> <span class="token operator">&amp;&amp;</span> prev <span class="token operator">!==</span> <span class="token number">0x5c</span><span class="token punctuation">)</span> inTemplateString <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inRegex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token number">0x2f</span> <span class="token operator">&amp;&amp;</span> prev <span class="token operator">!==</span> <span class="token number">0x5c</span><span class="token punctuation">)</span> inRegex <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å•ä¸ª | ç¬¦å·ä¸”æ‹¬å·é—­åˆ</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      c <span class="token operator">===</span> <span class="token number">0x7c</span> <span class="token operator">&amp;&amp;</span>
      exp<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0x7c</span> <span class="token operator">&amp;&amp;</span>
      exp<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0x7c</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>curly <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>square <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>paren
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>expression <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// first filter, end of expression</span>
        lastFilterIndex <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        expression <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å­˜å‚¨å¾…å¤„ç†çš„è¡¨è¾¾å¼</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// å­˜åœ¨å¤šä¸ªâ€˜|â€™ç¬¦ï¼Œå°†ä¸­é—´çš„filteræ”¾å…¥filtersæ•°ç»„</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">pushFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">0x22</span><span class="token operator">:</span>
          inDouble <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// &quot;</span>
        <span class="token keyword">case</span> <span class="token number">0x27</span><span class="token operator">:</span>
          inSingle <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// &#39;</span>
        <span class="token keyword">case</span> <span class="token number">0x60</span><span class="token operator">:</span>
          inTemplateString <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// `</span>
        <span class="token keyword">case</span> <span class="token number">0x28</span><span class="token operator">:</span>
          paren<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// (</span>
        <span class="token keyword">case</span> <span class="token number">0x29</span><span class="token operator">:</span>
          paren<span class="token operator">--</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// )</span>
        <span class="token keyword">case</span> <span class="token number">0x5b</span><span class="token operator">:</span>
          square<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// [</span>
        <span class="token keyword">case</span> <span class="token number">0x5d</span><span class="token operator">:</span>
          square<span class="token operator">--</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// ]</span>
        <span class="token keyword">case</span> <span class="token number">0x7b</span><span class="token operator">:</span>
          curly<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// {</span>
        <span class="token keyword">case</span> <span class="token number">0x7d</span><span class="token operator">:</span>
          curly<span class="token operator">--</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// }</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token number">0x2f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// /</span>
        <span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> p<span class="token punctuation">;</span>
        <span class="token comment">// find first non-whitespace prev char</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> j <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          p <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!==</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p <span class="token operator">||</span> <span class="token operator">!</span>validDivisionCharRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          inRegex <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ä¸å­˜åœ¨ | è¿‡æ»¤ç¬¦ï¼Œå…¨éƒ¨ä¸ºè¡¨è¾¾å¼</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>expression <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    expression <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å°†æœ€åä¸€ä¸ª|è¿‡æ»¤ç¬¦åé¢çš„åŠ å…¥fiters</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lastFilterIndex <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pushFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">pushFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>filters <span class="token operator">||</span> <span class="token punctuation">(</span>filters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastFilterIndex<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lastFilterIndex <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>filters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> filters<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      expression <span class="token operator">=</span> <span class="token function">wrapFilter</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> filters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> expression<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¤ºä¾‹</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// input:</span>
message <span class="token operator">|</span> filter1 <span class="token operator">|</span> <span class="token function">filter2</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
<span class="token comment">// wrapFilterè°ƒç”¨å‰</span>
expression <span class="token operator">=</span> <span class="token string">&#39;message&#39;</span>
filters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;filter1&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;filter2(arg)&#39;</span><span class="token punctuation">]</span>
<span class="token comment">// wrapFilterè°ƒç”¨å</span>
<span class="token function">_f</span><span class="token punctuation">(</span><span class="token string">&quot;filter2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">_f</span><span class="token punctuation">(</span><span class="token string">&quot;filter1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-ä¼˜åŒ–é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#_2-ä¼˜åŒ–é˜¶æ®µ"><span>2. ä¼˜åŒ–é˜¶æ®µ</span></a></h3><p>æœ‰ä¸€ç§èŠ‚ç‚¹ä¸€æ—¦é¦–æ¬¡æ¸²æŸ“ä¹‹åä¸ç®¡çŠ¶æ€å†æ€ä¹ˆå˜åŒ–å®ƒéƒ½ä¸ä¼šå˜äº†ï¼Œè¿™ç§èŠ‚ç‚¹å«åšé™æ€èŠ‚ç‚¹ã€‚ä¼˜åŒ–èŠ‚ç‚¹çš„ç›®æ ‡å°±æ˜¯ï¼š</p><ul><li>åœ¨<code>AST</code>ä¸­æ‰¾å‡ºæ‰€æœ‰é™æ€èŠ‚ç‚¹å¹¶æ‰“ä¸Šæ ‡è®°ï¼›</li><li>åœ¨<code>AST</code>ä¸­æ‰¾å‡ºæ‰€æœ‰é™æ€æ ¹èŠ‚ç‚¹å¹¶æ‰“ä¸Šæ ‡è®°ï¼›</li></ul><blockquote><p>åˆ¤æ–­ä¸€ä¸ªastèŠ‚ç‚¹æœ¬èº«æ˜¯å¦ä¸ºé™æ€èŠ‚ç‚¹</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> ASTNode</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åŒ…å«å˜é‡çš„åŠ¨æ€æ–‡æœ¬èŠ‚ç‚¹</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸åŒ…å«å˜é‡çš„çº¯æ–‡æœ¬èŠ‚ç‚¹</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ­¤æ—¶ä¸ºå…ƒç´ èŠ‚ç‚¹ï¼Œè¿›ä¸€æ­¥åˆ¤æ–­</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>
      node<span class="token punctuation">.</span>pre <span class="token operator">||</span> <span class="token comment">//ä½¿ç”¨äº†v-preæŒ‡ä»¤</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span>hasBindings <span class="token operator">&amp;&amp;</span> <span class="token comment">// ä¸èƒ½ä½¿ç”¨åŠ¨æ€ç»‘å®šè¯­æ³•ï¼Œå³æ ‡ç­¾ä¸Šä¸èƒ½æœ‰v-ã€@ã€:å¼€å¤´çš„å±æ€§ï¼›</span>
        <span class="token operator">!</span>node<span class="token punctuation">.</span>if <span class="token operator">&amp;&amp;</span> <span class="token comment">// ä¸èƒ½ä½¿ç”¨v-ifã€v-elseã€v-foræŒ‡ä»¤</span>
        <span class="token operator">!</span>node<span class="token punctuation">.</span>for <span class="token operator">&amp;&amp;</span> <span class="token comment">// not v-if or v-for or v-else</span>
        <span class="token operator">!</span><span class="token function">isBuiltInTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// ä¸èƒ½æ˜¯å†…ç½®ç»„ä»¶ï¼Œå³æ ‡ç­¾åä¸èƒ½æ˜¯slotå’Œcomponentï¼›</span>
        <span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// æ ‡ç­¾åå¿…é¡»æ˜¯å¹³å°ä¿ç•™æ ‡ç­¾ï¼Œå³ä¸èƒ½æ˜¯ç»„ä»¶</span>
        <span class="token operator">!</span><span class="token function">isDirectChildOfTemplateFor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">//å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸èƒ½æ˜¯å¸¦æœ‰ v-for çš„ template æ ‡ç­¾ï¼›</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>isStaticKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token comment">//èŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§çš„ key éƒ½å¿…é¡»æ˜¯é™æ€èŠ‚ç‚¹æ‰æœ‰çš„ keyï¼›</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>æ ‡è®°é™æ€èŠ‚ç‚¹</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">markStatic</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> ASTNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// ä¸å¤„ç†slotå‡½æ•°å†…éƒ¨çš„ç»„ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">&quot;slot&quot;</span> <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">&quot;inline-template&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// é€’å½’æ ‡è®°å­èŠ‚ç‚¹ï¼Œæœ‰ä¸€ä¸ªä¸ºfalseå³ä¸ºfalse</span>
      <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * å¾ªç¯node.childrenåè¿˜ä¸ç®—æŠŠæ‰€æœ‰å­èŠ‚ç‚¹éƒ½éå†å®Œï¼Œ
     * å› ä¸ºå¦‚æœå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸­æœ‰æ ‡ç­¾å¸¦æœ‰v-ifã€v-else-ifã€v-elseç­‰æŒ‡ä»¤æ—¶ï¼Œ
     * è¿™äº›å­èŠ‚ç‚¹åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½åªæ¸²æŸ“ä¸€ä¸ªï¼Œæ‰€ä»¥å…¶ä½™æ²¡æœ‰è¢«æ¸²æŸ“çš„è‚¯å®šä¸åœ¨node.childrenä¸­ï¼Œ
     * è€Œæ˜¯å­˜åœ¨äºnode.ifConditionsï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦æŠŠnode.ifConditionså¾ªç¯ä¸€é
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> block <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">;</span>
        <span class="token function">markStatic</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>æ ‡è®°é™æ€æ ¹èŠ‚ç‚¹</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">markStaticRoots</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> ASTNode<span class="token punctuation">,</span> <span class="token literal-property property">isInFor</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//å·²ç»æ˜¯ static çš„èŠ‚ç‚¹æˆ–è€…æ˜¯ v-once æŒ‡ä»¤çš„èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">||</span> node<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>staticInFor <span class="token operator">=</span> isInFor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
     * ä¸ºäº†ä½¿èŠ‚ç‚¹æœ‰èµ„æ ¼ä½œä¸ºé™æ€æ ¹èŠ‚ç‚¹ï¼Œå®ƒåº”å…·æœ‰ä¸åªæ˜¯é™æ€æ–‡æœ¬çš„å­èŠ‚ç‚¹ã€‚ å¦åˆ™ï¼Œä¼˜åŒ–çš„æˆæœ¬å°†è¶…è¿‡æ”¶ç›Šï¼Œæœ€å¥½	 * å§‹ç»ˆå°†å…¶æ›´æ–°ã€‚
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      node<span class="token punctuation">.</span>static <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœå½“å‰èŠ‚ç‚¹ä¸æ˜¯é™æ€æ ¹èŠ‚ç‚¹ï¼Œé‚£å°±ç»§ç»­é€’å½’éå†å®ƒçš„å­èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isInFor <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>node<span class="token punctuation">.</span>for<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">,</span> isInFor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é™æ€æ ¹èŠ‚ç‚¹å¿…é¡»æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼Œå¦åˆ™çš„è¯ï¼Œå¯¹å®ƒçš„ä¼˜åŒ–æˆæœ¬å°†å¤§äºä¼˜åŒ–åå¸¦æ¥çš„æ”¶ç›Šã€‚</p><ul><li>èŠ‚ç‚¹æœ¬èº«å¿…é¡»æ˜¯é™æ€èŠ‚ç‚¹ï¼›</li><li>å¿…é¡»æ‹¥æœ‰å­èŠ‚ç‚¹ childrenï¼›</li><li>å­èŠ‚ç‚¹ä¸èƒ½åªæ˜¯åªæœ‰ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼›</li></ul><h3 id="_3-ä»£ç ç”Ÿæˆ" tabindex="-1"><a class="header-anchor" href="#_3-ä»£ç ç”Ÿæˆ"><span>3.ä»£ç ç”Ÿæˆ</span></a></h3><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">generate</span> <span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span>option</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodegenState</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> ast <span class="token operator">?</span> <span class="token function">genElement</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&#39;_c(&quot;div&quot;)&#39;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">render</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">with(this){return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">staticRenderFns</span><span class="token operator">:</span> state<span class="token punctuation">.</span>staticRenderFns
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>genElement</code>å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genElement</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span> <span class="token literal-property property">state</span><span class="token operator">:</span> CodegenState</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>staticRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>staticProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genStatic</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>once <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>onceProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genOnce</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>for <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>forProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genFor</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>if <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>ifProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genIf</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&#39;template&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>slotTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;void 0&#39;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&#39;slot&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genSlot</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// component or element</span>
    <span class="token keyword">let</span> code
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      code <span class="token operator">=</span> <span class="token function">genComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">,</span> el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> el<span class="token punctuation">.</span>plain <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">genData</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>

      <span class="token keyword">const</span> children <span class="token operator">=</span> el<span class="token punctuation">.</span>inlineTemplate <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_c(&#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        data <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span> <span class="token comment">// data</span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        children <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span> <span class="token comment">// children</span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
    <span class="token comment">// module transforms</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      code <span class="token operator">=</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> code
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ¹æ®å½“å‰ <code>AST</code> å…ƒç´ èŠ‚ç‚¹å±æ€§çš„ä¸åŒä»è€Œæ‰§è¡Œä¸åŒçš„ä»£ç ç”Ÿæˆå‡½æ•°ï¼š</p><ul><li><p>å…ƒç´ èŠ‚ç‚¹ï¼š<code>_c(tagName,data,children)</code></p></li><li><p>æ–‡æœ¬èŠ‚ç‚¹ï¼š<code>_v(text.expression)</code>æˆ–<code>_v(text)</code></p></li><li><p>æ³¨é‡ŠèŠ‚ç‚¹ï¼š<code>_e(comment.text)</code></p></li><li><p>slotï¼š<code>_t(slotName,children,attrs)</code></p></li><li><p>......</p></li></ul><h4 id="ä¸¾ä¾‹" tabindex="-1"><a class="header-anchor" href="#ä¸¾ä¾‹"><span>ä¸¾ä¾‹</span></a></h4><blockquote><p><code>template</code></p></blockquote><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>NLRX<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Hello {{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>æ¨¡æ¿ç¼–è¯‘ä¼˜åŒ–åçš„<code>AST</code></p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>ast <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&#39;type&#39;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">&#39;tag&#39;</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&#39;attrsList&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string-property property">&#39;name&#39;</span><span class="token operator">:</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&#39;value&#39;</span><span class="token operator">:</span><span class="token string">&#39;NLRX&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&#39;attrsMap&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&#39;id&#39;</span><span class="token operator">:</span> <span class="token string">&#39;NLRX&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&#39;static&#39;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string-property property">&#39;parent&#39;</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token string-property property">&#39;plain&#39;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string-property property">&#39;children&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token string-property property">&#39;type&#39;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">&#39;tag&#39;</span><span class="token operator">:</span> <span class="token string">&#39;p&#39;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&#39;plain&#39;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token string-property property">&#39;static&#39;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token string-property property">&#39;children&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string-property property">&#39;type&#39;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token string-property property">&#39;expression&#39;</span><span class="token operator">:</span> <span class="token string">&#39;&quot;Hello &quot;+_s(name)&#39;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&#39;text&#39;</span><span class="token operator">:</span> <span class="token string">&#39;Hello {{name}}&#39;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&#39;static&#39;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ç”Ÿæˆçš„renderä»£ç </p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">render</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> 
    with(this){
       return _c(
         &#39;div&#39;,
         {
           attrs:{&quot;id&quot;:&quot;NLRX&quot;},
         },
         [
           _c(
             &#39;p&#39;,
             {
               attrs:{}
             },
             [
               _v(&quot;Hello &quot;+_s(name))
             ]
           )
         ]
       )
     }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">staticRenderFns</span><span class="token operator">:</span> state<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>_cã€_vã€_e </code>ä»£è¡¨äº†ä¸åŒçš„è¾…åŠ©å‡½æ•°ï¼Œåˆ©ç”¨å…¶æ‹¬å·å†…ä¼ å…¥çš„å‚æ•°ï¼Œç”Ÿæˆä¸åŒçš„<code>VNode</code>èŠ‚ç‚¹ã€‚</p><ul><li><p><code>_c</code>ï¼š<code>_c</code> æ˜¯ <code>createElement</code> å‡½æ•°çš„åˆ«åï¼Œç”¨äºåˆ›å»º VNodeï¼Œå³åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿ DOM å…ƒç´ ã€‚å®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯æ ‡ç­¾åã€å…ƒç´ å±æ€§å¯¹è±¡å’Œå­å…ƒç´ æ•°ç»„ã€‚</p></li><li><p><code>_v</code>ï¼š<code>_v</code> æ˜¯ <code>createTextVNode</code> å‡½æ•°çš„åˆ«åï¼Œç”¨äºåˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹çš„ VNodeï¼Œå³åˆ›å»ºä¸€ä¸ªåªåŒ…å«æ–‡æœ¬å†…å®¹çš„è™šæ‹Ÿ DOM å…ƒç´ ã€‚å®ƒæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³è¦æ˜¾ç¤ºçš„æ–‡æœ¬å†…å®¹ã€‚</p></li><li><p><code>_s</code>ï¼š<code>_s</code> æ˜¯ <code>toString</code> å‡½æ•°çš„åˆ«åï¼Œç”¨äºå°† JavaScript è¡¨è¾¾å¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚å®ƒæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„è¡¨è¾¾å¼ã€‚</p></li><li><p><code>_e</code>ï¼š<code>_e</code> æ˜¯ <code>createEmptyVNode</code> å‡½æ•°çš„åˆ«åï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªç©ºçš„ VNodeã€‚å®ƒå¯ä»¥ç”¨ä½œå ä½ç¬¦ï¼Œæˆ–è€…åœ¨æŸäº›æ— å†…å®¹çš„æƒ…å†µä¸‹ä½œä¸ºé»˜è®¤ VNodeï¼ˆæ³¨é‡ŠèŠ‚ç‚¹ï¼‰</p></li></ul><p><strong>å…¶ä»–è¾…åŠ©å‡½æ•°</strong></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">installRenderHelpers</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span>_o <span class="token operator">=</span> markOnce <span class="token comment">//v-once</span>
  target<span class="token punctuation">.</span>_n <span class="token operator">=</span> toNumber
  target<span class="token punctuation">.</span>_s <span class="token operator">=</span> toString
  target<span class="token punctuation">.</span>_l <span class="token operator">=</span> renderList <span class="token comment">//v-for</span>
  target<span class="token punctuation">.</span>_t <span class="token operator">=</span> renderSlot
  target<span class="token punctuation">.</span>_q <span class="token operator">=</span> looseEqual
  target<span class="token punctuation">.</span>_i <span class="token operator">=</span> looseIndexOf
  target<span class="token punctuation">.</span>_m <span class="token operator">=</span> renderStatic
  target<span class="token punctuation">.</span>_f <span class="token operator">=</span> resolveFilter <span class="token comment">//filter</span>
  target<span class="token punctuation">.</span>_k <span class="token operator">=</span> checkKeyCodes
  target<span class="token punctuation">.</span>_b <span class="token operator">=</span> bindObjectProps
  target<span class="token punctuation">.</span>_v <span class="token operator">=</span> createTextVNode
  target<span class="token punctuation">.</span>_e <span class="token operator">=</span> createEmptyVNode
  target<span class="token punctuation">.</span>_u <span class="token operator">=</span> resolveScopedSlots
  target<span class="token punctuation">.</span>_g <span class="token operator">=</span> bindObjectListeners
  target<span class="token punctuation">.</span>_d <span class="token operator">=</span> bindDynamicKeys
  target<span class="token punctuation">.</span>_p <span class="token operator">=</span> prependModifier
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å››ã€ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#å››ã€ç”Ÿå‘½å‘¨æœŸ"><span>å››ã€ç”Ÿå‘½å‘¨æœŸ</span></a></h2><figure><img src="/dcBlog/assets/life-cycle-OVtLHVPB.png" alt="å£°æ˜å‘¨æœŸ" tabindex="0" loading="lazy"><figcaption>å£°æ˜å‘¨æœŸ</figcaption></figure><h3 id="_1-åˆå§‹åŒ–æ•´ä½“æµç¨‹" tabindex="-1"><a class="header-anchor" href="#_1-åˆå§‹åŒ–æ•´ä½“æµç¨‹"><span>1. åˆå§‹åŒ–æ•´ä½“æµç¨‹</span></a></h3><p>åœ¨åˆå§‹åŒ–é˜¶æ®µçš„å·¥ä½œä¸»è¦æ˜¯ï¼š</p><ul><li>åˆå§‹åŒ–é…ç½®é¡¹ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–ç»„ä»¶çš„é…ç½®é¡¹å’Œåˆå¹¶é…ç½®é¡¹</li><li>åˆå§‹åŒ–ä»£ç†ï¼Œåœ¨è®¿é—®vmå±æ€§å‡ºé”™æ—¶æç¤ºé”™è¯¯</li><li>åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸã€åˆå§‹åŒ–äº‹ä»¶ã€åˆå§‹åŒ–æ¸²æŸ“</li><li>è°ƒç”¨<code>beforeCreate</code>ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°</li><li>åˆå§‹åŒ–injectionsã€åˆå§‹åŒ–State(<code>props,methods,data,computed,watch</code>)ã€åˆå§‹åŒ–provide</li><li>è°ƒç”¨<code>created</code>ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°</li><li>å¦‚æœelå­˜åœ¨ï¼Œè°ƒç”¨$mountæŒ‚è½½</li></ul><blockquote><p>æ•´ä¸ªåˆå§‹åŒ–é˜¶æ®µå°±æ˜¯åœ¨ç»™vmæŒ‚è½½å„ç§çš„å±æ€§å¯¹è±¡ã€‚</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Vue</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Vue is a constructor and should be called with the `new` keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Vue</span><span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">?</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// a uid</span>
    vm<span class="token punctuation">.</span>_uid <span class="token operator">=</span>       <span class="token operator">++</span>

    <span class="token keyword">let</span> startTag<span class="token punctuation">,</span> endTag
    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      startTag <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue-perf-start:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      endTag <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue-perf-end:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token function">mark</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// a flag to avoid this being observed</span>
    vm<span class="token punctuation">.</span>_isVue <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// åˆå¹¶é…ç½®é¡¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// optimize internal component instantiation</span>
      <span class="token comment">// since dynamic options merging is pretty slow, and none of the</span>
      <span class="token comment">// internal component options needs special treatment.</span>
      <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆå¹¶é…ç½®é¡¹ï¼ˆå…¶ä¸­è§„èŒƒåŒ–äº†propsã€injectã€directivesï¼‰</span>
      vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
        <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
        options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        vm
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* istanbul ignore else */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åœ¨è®¿é—®vmå±æ€§å‡ºé”™æ—¶æç¤ºé”™è¯¯</span>
      <span class="token function">initProxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_renderProxy <span class="token operator">=</span> vm
    <span class="token punctuation">}</span>
    <span class="token comment">// expose real self</span>
    vm<span class="token punctuation">.</span>_self <span class="token operator">=</span> vm
    <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸ</span>
    <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// åˆå§‹åŒ–äº‹ä»¶</span>
    <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// åˆå§‹åŒ–æ¸²æŸ“</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&#39;beforeCreate&#39;</span><span class="token punctuation">)</span> <span class="token comment">// è°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°</span>
    <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// åˆå§‹åŒ–injections</span>
    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// åˆå§‹åŒ–props,methods,data,computed,watch</span>
    <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// åˆå§‹åŒ– provide</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&#39;created&#39;</span><span class="token punctuation">)</span> <span class="token comment">// è°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°</span>

    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token comment">// è¡¡é‡æ€§èƒ½</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_name <span class="token operator">=</span> <span class="token function">formatComponentName</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token function">mark</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
      <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> init</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ç”Ÿå‘½å‘¨æœŸå¼€å§‹å‰å…ˆ <mark>åˆå¹¶é…ç½®é¡¹</mark> ï¼Œç¡®å®š<code>vm.$options</code>çš„å–å€¼ã€‚</p><h3 id="_2-åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#_2-åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸ"><span>2. åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸ</span></a></h3><blockquote><p><mark>ç¡®å®šçˆ¶å­å…³ç³»</mark> ï¼Œåˆå§‹åŒ–éƒ¨åˆ†å±æ€§</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initLifecycle</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span>

  <span class="token comment">// å¯»æ‰¾ç¬¬ä¸€ä¸ªéæŠ½è±¡ç±»å‹çš„çˆ¶çº§</span>
  <span class="token keyword">let</span> parent <span class="token operator">=</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>abstract<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>abstract <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>$parent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    parent<span class="token punctuation">.</span>$children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  vm<span class="token punctuation">.</span>$parent <span class="token operator">=</span> parent<span class="token punctuation">;</span> <span class="token comment">// çˆ¶ç»„ä»¶å®ä¾‹</span>
  vm<span class="token punctuation">.</span>$root <span class="token operator">=</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>$root <span class="token operator">:</span> vm<span class="token punctuation">;</span> <span class="token comment">// æ ¹ç»„ä»¶å®ä¾‹</span>
  vm<span class="token punctuation">.</span>$children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
  vm<span class="token punctuation">.</span>$refs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// ç”¨æ¥æŒ‚è½½æ¸²æŸ“watcher</span>
  vm<span class="token punctuation">.</span>_inactive <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// æŒ‡ç¤ºç»„ä»¶æ˜¯å¦å¤„äºæ¿€æ´»çŠ¶æ€</span>
  vm<span class="token punctuation">.</span>_directInactive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
  vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  vm<span class="token punctuation">.</span>_isDestroyed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  vm<span class="token punctuation">.</span>_isBeingDestroyed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æŠ½è±¡ç»„ä»¶æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç»„ä»¶ï¼Œåœ¨Vueä¸­ä¸ä¼šè¢«æ¸²æŸ“æˆçœŸå®çš„DOMå…ƒç´ ï¼Œè€Œæ˜¯è¢«ç”¨ä½œå…¶ä»–ç»„ä»¶çš„æ¨¡æ¿æˆ–å ä½ç¬¦ã€‚å®ƒä»¬é€šå¸¸ç”¨äºå°è£…é€šç”¨çš„é€»è¾‘æˆ–è¡Œä¸ºï¼Œå¹¶å¯ä»¥é€šè¿‡ç»§æ‰¿æˆ–æ··å…¥æ¥å¤ç”¨ç¡®å®šçˆ¶å­å…³ç³»ã€‚ï¼ˆ<code>&lt;transition&gt;å’Œ&lt;keep-alive&gt;</code>ï¼‰</p><div class="language-vue line-numbers-mode" data-ext="vue" data-title="vue"><pre class="language-vue"><code>Vue.component(&#39;my-component&#39;, {
  abstract: true, // è®¾ç½®ä¸ºæŠ½è±¡ç»„ä»¶
  // å…¶ä»–ç»„ä»¶é€‰é¡¹
});
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>ç»™å®ä¾‹åˆå§‹åŒ–äº†ä¸€äº›å±æ€§ï¼ŒåŒ…æ‹¬ä»¥<code>$</code>å¼€å¤´çš„ä¾›ç”¨æˆ·ä½¿ç”¨çš„å¤–éƒ¨å±æ€§ï¼Œä¹ŸåŒ…æ‹¬ä»¥<code>_</code>å¼€å¤´çš„ä¾›å†…éƒ¨ä½¿ç”¨çš„å†…éƒ¨å±æ€§</p></li><li><p>ç¡®å®šçˆ¶å­å…³ç³»ï¼š<code>vm.$parent</code>ï¼Œ<code>vm.$children</code>ï¼Œ<code>vm.$root</code></p></li></ul><h3 id="_3-åˆå§‹åŒ–äº‹ä»¶" tabindex="-1"><a class="header-anchor" href="#_3-åˆå§‹åŒ–äº‹ä»¶"><span>3. åˆå§‹åŒ–äº‹ä»¶</span></a></h3><blockquote><p>å°†çˆ¶ç»„ä»¶åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨v-onæˆ–@æ³¨å†Œçš„ç›‘å¬å­ç»„ä»¶å†…è§¦å‘çš„äº‹ä»¶ ï¼ŒæŒ‚è½½åˆ°<code>vm._events</code>(é€šè¿‡è°ƒç”¨<code>$on</code>)</p></blockquote><p>åœ¨æ¨¡æ¿ç¼–è¯‘æ—¶ï¼Œé‡åˆ°é—­åˆæ ‡ç­¾ï¼Œä¼šè°ƒç”¨<code>end</code>é’©å­å‡½æ•°ï¼Œå…¶å†…éƒ¨è°ƒç”¨äº†<code>closeElement</code>å‡½æ•°å¤„ç†å…ƒç´ çš„å…³é—­æ“ä½œï¼Œå¹¶è¿›è¡Œç›¸åº”çš„domç»“æ„ç®¡ç†ï¼ˆ<code>start</code>é’©å­å‡½æ•°ä¸­é‡åˆ°è‡ªé—­å’Œä¹Ÿä¼šè°ƒç”¨ï¼‰</p><figure><img src="/dcBlog/assets/event-CqRBJYY7.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="ä¸¾ä¾‹è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#ä¸¾ä¾‹è¯´æ˜"><span>ä¸¾ä¾‹è¯´æ˜</span></a></h4><p>åœ¨ç¼–è¯‘é˜¶æ®µ <mark>æ¨¡æ¿è§£æ</mark> ç”Ÿæˆå¦‚ä¸‹çš„ASTèŠ‚ç‚¹å±æ€§</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>el<span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">select</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;selectHandler&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

el<span class="token punctuation">.</span>nativeEvents <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">click</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;clickHandler&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ç¼–è¯‘é˜¶æ®µ <mark>ä»£ç ç”Ÿæˆ</mark> åä¼šç”Ÿæˆå¦‚ä¸‹çš„<code>data</code>æ•°æ®ä¼ å…¥<code>_c(tagName,data,children)</code>:</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;select&quot;</span><span class="token operator">:</span> selectHandler<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">nativeOn</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;click&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">$event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">clickHandler</span><span class="token punctuation">(</span>$event<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><mark>è°ƒç”¨renderå‡½æ•°</mark> ç”Ÿæˆè™šæ‹Ÿdomä¸­ï¼Œä¼šè°ƒç”¨<code>createComponent</code>å‡½æ•°åˆ›å»ºVNodeèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„<code>_c</code>ï¼Œå…¶ä¸­æŠŠè‡ªå®šä¹‰äº‹ä»¶<code>data.on</code> èµ‹å€¼ç»™äº† <code>listeners</code>ï¼ŒæŠŠæµè§ˆå™¨åŸç”Ÿäº‹ä»¶ <code>data.nativeOn</code> èµ‹å€¼ç»™äº† <code>data.on</code>ï¼Œè¿™è¯´æ˜ <mark>æ‰€æœ‰çš„åŸç”Ÿæµè§ˆå™¨äº‹ä»¶å¤„ç†æ˜¯åœ¨å½“å‰çˆ¶ç»„ä»¶ç¯å¢ƒä¸­å¤„ç†çš„</mark> ã€‚</p><p>è€Œå¯¹äºè‡ªå®šä¹‰äº‹ä»¶ï¼Œä¼šæŠŠ <code>listeners</code> ä½œä¸º <code>vnode</code> çš„ <code>componentOptions</code> ä¼ å…¥ï¼Œæ”¾åœ¨ <mark>å­ç»„ä»¶åˆå§‹åŒ–é˜¶æ®µ</mark> ä¸­å¤„ç†ï¼Œ åœ¨å­ç»„ä»¶åˆå§‹åŒ–çš„æ—¶å€™ï¼Œ æ‹¿åˆ°çˆ¶ç»„ä»¶ä¼ å…¥çš„ <code>listeners</code>ï¼Œç„¶ååœ¨æ‰§è¡Œ <code>initEvents</code> çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå¤„ç†è¿™ä¸ª <code>listeners</code>ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">Ctor</span><span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span> <span class="token operator">|</span> Function <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token operator">?</span>VNodeData<span class="token punctuation">,</span>
  <span class="token literal-property property">context</span><span class="token operator">:</span> Component<span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  tag<span class="token operator">?</span><span class="token operator">:</span> string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token operator">|</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> listeners <span class="token operator">=</span> data<span class="token punctuation">.</span>on
  data<span class="token punctuation">.</span>on <span class="token operator">=</span> data<span class="token punctuation">.</span>nativeOn
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> Ctor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>name <span class="token operator">||</span> tag
  <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue-component-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Ctor<span class="token punctuation">.</span>cid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
    <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    context<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> Ctor<span class="token punctuation">,</span> propsData<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> children <span class="token punctuation">}</span><span class="token punctuation">,</span>
    asyncFactory
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="initeventå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#initeventå‡½æ•°"><span>initEventå‡½æ•°</span></a></h4><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre js="" class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initEvents</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>_events <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vm<span class="token punctuation">.</span>_hasHookEvent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// init parent attached events</span>
  <span class="token keyword">const</span> listeners <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentListeners<span class="token punctuation">;</span> <span class="token comment">// çˆ¶ç»„ä»¶æ³¨å†Œçš„äº‹ä»¶</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateComponentListeners</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> listeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateComponentListeners</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span>
  <span class="token literal-property property">listeners</span><span class="token operator">:</span> Object<span class="token punctuation">,</span>
  <span class="token literal-property property">oldListeners</span><span class="token operator">:</span> <span class="token operator">?</span>Object</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target <span class="token operator">=</span> vm<span class="token punctuation">;</span>
  <span class="token function">updateListeners</span><span class="token punctuation">(</span>
    listeners<span class="token punctuation">,</span>
    oldListeners <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    add<span class="token punctuation">,</span> <span class="token comment">// $on</span>
    remove<span class="token punctuation">,</span> <span class="token comment">// $off</span>
    createOnceHandler<span class="token punctuation">,</span>
    vm
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  target <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateListeners</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">on</span><span class="token operator">:</span> Object<span class="token punctuation">,</span>
  <span class="token literal-property property">oldOn</span><span class="token operator">:</span> Object<span class="token punctuation">,</span>
  <span class="token literal-property property">add</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
  <span class="token literal-property property">remove</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
  <span class="token literal-property property">createOnceHandler</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
  <span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> name<span class="token punctuation">,</span> def<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> old<span class="token punctuation">,</span> event<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> on<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    def <span class="token operator">=</span> cur <span class="token operator">=</span> on<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    old <span class="token operator">=</span> oldOn<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    event <span class="token operator">=</span> <span class="token function">normalizeEvent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__WEEX__ <span class="token operator">&amp;&amp;</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>def<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cur <span class="token operator">=</span> def<span class="token punctuation">.</span>handler<span class="token punctuation">;</span>
      event<span class="token punctuation">.</span>params <span class="token operator">=</span> def<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid handler for event &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;: got </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>fns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cur <span class="token operator">=</span> on<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createFnInvoker</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>once<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cur <span class="token operator">=</span> on<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createOnceHandler</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>name<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> event<span class="token punctuation">.</span>capture<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>name<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> event<span class="token punctuation">.</span>capture<span class="token punctuation">,</span> event<span class="token punctuation">.</span>passive<span class="token punctuation">,</span> event<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">!==</span> old<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      old<span class="token punctuation">.</span>fns <span class="token operator">=</span> cur<span class="token punctuation">;</span>
      on<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> old<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> oldOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>on<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      event <span class="token operator">=</span> <span class="token function">normalizeEvent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">remove</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>name<span class="token punctuation">,</span> oldOn<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>capture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><div class="highlight-line">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çˆ¶ç»„ä»¶ç»™å­ç»„ä»¶çš„æ³¨å†Œäº‹ä»¶ä¸­ï¼ŒæŠŠè‡ªå®šä¹‰äº‹ä»¶ä¼ ç»™å­ç»„ä»¶ï¼Œåœ¨å­ç»„ä»¶å®ä¾‹åŒ–çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–ï¼›è€Œæµè§ˆå™¨åŸç”Ÿäº‹ä»¶æ˜¯åœ¨çˆ¶ç»„ä»¶ä¸­å¤„ç†ã€‚</p><p>åˆå§‹åŒ–äº‹ä»¶å‡½æ•°<code>initEvents</code>å®é™…ä¸Šåˆå§‹åŒ–çš„æ˜¯ <mark>çˆ¶ç»„ä»¶åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨v-onæˆ–@æ³¨å†Œçš„ç›‘å¬å­ç»„ä»¶å†…è§¦å‘çš„äº‹ä»¶</mark> ï¼ŒæŒ‚è½½åˆ°<code>vm._events</code>(é€šè¿‡è°ƒç”¨<code>$on</code>)ã€‚</p><h3 id="_4-åˆå§‹åŒ–inject" tabindex="-1"><a class="header-anchor" href="#_4-åˆå§‹åŒ–inject"><span>4. åˆå§‹åŒ–inject</span></a></h3><p>çˆ¶ç»„ä»¶å¯ä»¥ä½¿ç”¨<code>provide</code>é€‰é¡¹ç»™è‡ªå·±çš„ä¸‹æ¸¸å­å­™ç»„ä»¶å†…æ³¨å…¥ä¸€äº›æ•°æ®ï¼Œåœ¨ä¸‹æ¸¸å­å­™ç»„ä»¶ä¸­å¯ä»¥ä½¿ç”¨<code>inject</code>é€‰é¡¹æ¥æ¥æ”¶è¿™äº›æ•°æ®ä»¥ä¾¿ä¸ºè‡ªå·±æ‰€ç”¨ã€‚å¦å¤–ï¼Œè¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ul><li><code>provide</code> å’Œ <code>inject</code> é€‰é¡¹ç»‘å®šçš„æ•°æ®ä¸æ˜¯å“åº”å¼çš„ã€‚</li></ul><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initProvide</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> provide <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>provide<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>provide<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_provided <span class="token operator">=</span> <span class="token keyword">typeof</span> provide <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> <span class="token function">provide</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">:</span> provide<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/** å°†æ³¨å…¥ï¼ˆinjectï¼‰çš„å±æ€§æ·»åŠ åˆ°vmå®ä¾‹ä¸Š */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initInjections</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">resolveInject</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>inject<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å‘Šè¯‰defineReactiveå‡½æ•°ä»…ä»…æ˜¯æŠŠé”®å€¼æ·»åŠ åˆ°å½“å‰å®ä¾‹ä¸Šè€Œä¸éœ€è¦å°†å…¶è½¬æ¢æˆå“åº”å¼</span>
    <span class="token function">toggleObserving</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// shouldObserve = false</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore else */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">defineReactive</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Avoid mutating an injected value directly since the changes will be </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">overwritten whenever the provided component re-renders. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">injection being mutated: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            vm
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">defineReactive</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">toggleObserving</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/** å°†injectå¯¹è±¡è½¬ä¸ºkey-valueå€¼çš„å½¢å¼ */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveInject</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">inject</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>Object <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// inject is :any because flow is not smart enough to figure out cached</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> hasSymbol <span class="token operator">?</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>inject<span class="token punctuation">)</span> <span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>inject<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// #6574 in case the inject object is observed...</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&quot;__ob__&quot;</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> provideKey <span class="token operator">=</span> inject<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>from<span class="token punctuation">;</span>
      <span class="token keyword">let</span> source <span class="token operator">=</span> vm<span class="token punctuation">;</span>
      <span class="token comment">// æŒ‰çˆ¶ç»„ä»¶å±‚çº§ä¾æ¬¡å‘ä¸Šæ‰¾åˆ°provide</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span>_provided <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span>_provided<span class="token punctuation">,</span> provideKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">.</span>_provided<span class="token punctuation">[</span>provideKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        source <span class="token operator">=</span> source<span class="token punctuation">.</span>$parent<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// çˆ¶ç»„ä»¶ä¸­æ²¡æ‰¾åˆ°provide</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span> <span class="token keyword">in</span> inject<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> provideDefault <span class="token operator">=</span> inject<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
          result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span>
            <span class="token keyword">typeof</span> provideDefault <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span>
              <span class="token operator">?</span> <span class="token function">provideDefault</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
              <span class="token operator">:</span> provideDefault<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Injection &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åˆå§‹åŒ–injectåœ¨åˆå§‹åŒ–provideä¹‹å‰ï¼Ÿ <ul><li>å› ä¸º<code>initInjections</code>æ˜¯å°†å½“å‰ç»„ä»¶å®ä¾‹ç”¨åˆ°çš„<code>inject</code>æŒ‚è½½ä¸ºå…¶è‡ªèº«å±æ€§ï¼Œå®ƒç”¨åˆ°çš„<code>provide</code>æ³¨å…¥çš„å¯¹è±¡åœ¨çˆ¶ç»„ä»¶åˆå§‹åŒ–æ—¶å·²ç»æŒ‚è½½åˆ°äº†<code>vm.__provided</code>ï¼Œè€Œ<code>initProvide</code>æ˜¯å°†å½“å‰ç»„ä»¶å®ä¾‹æ³¨å…¥çš„å±æ€§æŒ‚è½½ï¼Œåœ¨å­å­™ç»„ä»¶ä¸­ä½¿ç”¨ã€‚</li></ul></li><li>åˆå§‹åŒ–injectåœ¨åˆå§‹åŒ–Stateä¹‹å‰ï¼Ÿ <ul><li>å› ä¸ºåœ¨åˆå§‹åŒ–Stateä¸­ï¼Œ<code>props,methods,data,computed,watch</code>ä¸­æœ‰å¯èƒ½ä¼šç”¨åˆ°<code>inject</code>çš„æ•°æ®</li></ul></li></ul><h3 id="_5-åˆå§‹åŒ–state" tabindex="-1"><a class="header-anchor" href="#_5-åˆå§‹åŒ–state"><span>5. åˆå§‹åŒ–State</span></a></h3><p>åˆå§‹åŒ–Stateçš„æ•´ä½“æµç¨‹å¾ˆç®€å•ï¼Œåœ¨optionsä¸­ä¼ äº†å“ªäº›é…ç½®å°±è°ƒç”¨å¯¹åº”çš„åˆå§‹åŒ–å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// ç”¨æ¥å­˜å‚¨å½“å‰å®ä¾‹ä¸­æ‰€æœ‰çš„watcherå®ä¾‹</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>vm._watchers</code>å±æ€§ï¼Œç”¨æ¥å­˜æ”¾è¿™ä¸ªç»„ä»¶å†…ç”¨åˆ°çš„æ‰€æœ‰çŠ¶æ€çš„ä¾èµ–ï¼Œå½“å…¶ä¸­ä¸€ä¸ªçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šé€šçŸ¥åˆ°ç»„ä»¶ï¼Œç„¶åç”±ç»„ä»¶å†…éƒ¨ä½¿ç”¨è™šæ‹Ÿ<code>DOM</code>è¿›è¡Œæ•°æ®æ¯”å¯¹ï¼Œä»è€Œé™ä½å†…å­˜å¼€é”€ï¼Œæé«˜æ€§èƒ½ã€‚</li></ul><blockquote><p><code>initProps</code></p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initProps</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span> <span class="token literal-property property">propsOptions</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> propsData <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>propsData <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//çˆ¶ç»„ä»¶ä¼ å…¥çš„çœŸå®propsæ•°æ®</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æŒ‡å‘vm._propsçš„æŒ‡é’ˆï¼Œæ‰€æœ‰è®¾ç½®åˆ°propså˜é‡ä¸­çš„å±æ€§éƒ½ä¼šä¿å­˜åˆ°vm._propsä¸­</span>

  <span class="token comment">// æŒ‡å‘vm.$options._propKeysçš„æŒ‡é’ˆï¼Œç¼“å­˜propså¯¹è±¡ä¸­çš„keyï¼Œ</span>
  <span class="token comment">// å°†æ¥æ›´æ–°propsæ—¶åªéœ€éå†vm.$options._propKeysæ•°ç»„å³å¯å¾—åˆ°æ‰€æœ‰propsçš„keyã€‚</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_propKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isRoot <span class="token operator">=</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>$parent<span class="token punctuation">;</span> <span class="token comment">// å½“å‰ç»„ä»¶æ˜¯å¦ä¸ºæ ¹ç»„ä»¶ã€‚</span>
  <span class="token comment">// root instance props should be converted</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">toggleObserving</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> propsOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">validateProp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> propsOptions<span class="token punctuation">,</span> propsData<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ ¡éªŒæ•°æ®ç±»å‹æ˜¯å¦åŒ¹é…</span>
    <span class="token comment">/* istanbul ignore else */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hyphenatedKey <span class="token operator">=</span> <span class="token function">hyphenate</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">isReservedAttribute</span><span class="token punctuation">(</span>hyphenatedKey<span class="token punctuation">)</span> <span class="token operator">||</span>
        config<span class="token punctuation">.</span><span class="token function">isReservedAttr</span><span class="token punctuation">(</span>hyphenatedKey<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hyphenatedKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is a reserved attribute and cannot be used as component prop.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">defineReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isUpdatingChildComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Avoid mutating a prop directly since the value will be </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">overwritten whenever the parent component re-renders. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Instead, use a data or computed property based on the prop&#39;s </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">value. Prop being mutated: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            vm
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">defineReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// static props are already proxied on the component&#39;s prototype</span>
    <span class="token comment">// during Vue.extend(). We only need to proxy props defined at</span>
    <span class="token comment">// instantiation here.</span>
    <span class="token comment">// å½“ä½¿ç”¨vm[key]è®¿é—®æ•°æ®æ—¶ï¼Œå…¶å®è®¿é—®çš„æ˜¯vm._props[key]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_props</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">toggleObserving</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>å°†propsä¼ é€’çš„å±æ€§æ·»åŠ åˆ°ç»„ä»¶å®ä¾‹ä¸­(<code>vm._props:{key,value}</code>)</p></li><li><p>ç±»å‹éªŒè¯ã€ é»˜è®¤å€¼å¤„ç†ã€ æ·»åŠ å“åº”å¼</p></li><li><p>å½“ä½¿ç”¨<code>vm[key]</code>è®¿é—®æ•°æ®æ—¶ï¼Œå…¶å®è®¿é—®çš„æ˜¯<code>vm._props[key]</code>ï¼Œè§¦å‘å“åº”å¼</p></li></ul><blockquote><p><code>initMethods </code></p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initMethods</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span> <span class="token literal-property property">methods</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has type &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> methods<span class="token punctuation">[</span>
            key
          <span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; in the component definition. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Did you reference the function correctly?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// propså’Œmethodsé‡å</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has already been defined as a prop.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//æç¤ºç”¨æˆ·æ–¹æ³•åå‘½åä¸è§„èŒƒï¼ˆä»¥$ | _ å¼€å¤´ï¼‰</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> vm <span class="token operator">&amp;&amp;</span> <span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; conflicts with an existing Vue instance method. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Avoid defining component methods that start with _ or $.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    vm<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span>
      <span class="token keyword">typeof</span> methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> noop <span class="token operator">:</span> <span class="token function">bind</span><span class="token punctuation">(</span>methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ç±»å‹æ£€æŸ¥</li><li>å°†<code>methods</code>ä¸­å®šä¹‰çš„æ–¹æ³•æ·»åŠ åˆ°ç»„ä»¶å®ä¾‹ä¸Šï¼ˆ<code>vm[method.name]</code>ï¼‰</li></ul><blockquote><p><code>initData</code></p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&quot;data functions should return an object:\n&quot;</span> <span class="token operator">+</span>
          <span class="token string">&quot;https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&quot;</span><span class="token punctuation">,</span>
        vm
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// proxy data on instance</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods<span class="token punctuation">;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¸èƒ½é‡å</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>methods<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has already been defined as a data property.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The data property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is already declared as a prop. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Use prop default value instead.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å°†dataå¯¹è±¡ä¸­keyä¸ä»¥_æˆ–$å¼€å¤´çš„å±æ€§ä»£ç†åˆ°å®ä¾‹vmä¸Šï¼Œ</span>
      <span class="token comment">// è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡this.xxxæ¥è®¿é—®dataé€‰é¡¹ä¸­çš„xxxæ•°æ®</span>
      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_data</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ·»åŠ å“åº”å¼</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">data</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
  <span class="token comment">// æš‚åœä¾èµ–æ”¶é›†</span>
  <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">data</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ç±»å‹æ£€æŸ¥ã€é‡åæ£€æŸ¥</li><li>ä»£ç†vmå±æ€§ï¼Œè®¿é—®<code>this.xxx</code>å®é™…è®¿é—®çš„æ˜¯<code>this._data.xxx</code></li><li>ä¸ºdataæ·»åŠ å“åº”å¼</li></ul><blockquote><p><code>initComputed</code></p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre js="" class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initComputed</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span> <span class="token literal-property property">computed</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> watchers <span class="token operator">=</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_computedWatchers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isSSR <span class="token operator">=</span> <span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userDef <span class="token operator">=</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> userDef <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> userDef <span class="token operator">:</span> userDef<span class="token punctuation">.</span>get<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> getter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Getter is missing for computed property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSSR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// create internal watcher for the computed property.</span>
      watchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>
        vm<span class="token punctuation">,</span>
        getter <span class="token operator">||</span> noop<span class="token punctuation">,</span>
        noop<span class="token punctuation">,</span>
        computedWatcherOptions <span class="token comment">// lazy</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">defineComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> userDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// é‡åé—®é¢˜</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The computed property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is already defined in data.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The computed property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is already defined as a prop.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// æè¿°å™¨æ¨¡æ¿</span>
<span class="token keyword">const</span> sharedPropertyDefinition <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">get</span><span class="token operator">:</span> noop<span class="token punctuation">,</span>
  <span class="token literal-property property">set</span><span class="token operator">:</span> noop
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineComputed</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">userDef</span><span class="token operator">:</span> Object <span class="token operator">|</span> Function</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> shouldCache <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//éæœåŠ¡ç«¯æ¸²æŸ“æ—¶åº”ç¼“å­˜</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> userDef <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»…è¯»å–</span>
    sharedPropertyDefinition<span class="token punctuation">.</span>get <span class="token operator">=</span> shouldCache
      <span class="token operator">?</span> <span class="token function">createComputedGetter</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">createGetterInvoker</span><span class="token punctuation">(</span>userDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sharedPropertyDefinition<span class="token punctuation">.</span>set <span class="token operator">=</span> noop<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¯»å–å’Œè®¾ç½®</span>
    sharedPropertyDefinition<span class="token punctuation">.</span>get <span class="token operator">=</span> userDef<span class="token punctuation">.</span>get
      <span class="token operator">?</span> shouldCache <span class="token operator">&amp;&amp;</span> userDef<span class="token punctuation">.</span>cache <span class="token operator">!==</span> <span class="token boolean">false</span>
        <span class="token operator">?</span> <span class="token function">createComputedGetter</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">createGetterInvoker</span><span class="token punctuation">(</span>userDef<span class="token punctuation">.</span>get<span class="token punctuation">)</span>
      <span class="token operator">:</span> noop<span class="token punctuation">;</span>
    sharedPropertyDefinition<span class="token punctuation">.</span>set <span class="token operator">=</span> userDef<span class="token punctuation">.</span>set <span class="token operator">||</span> noop<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
    sharedPropertyDefinition<span class="token punctuation">.</span>set <span class="token operator">===</span> noop
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Computed property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was assigned to but it has no setter.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å°†è®¡ç®—å±æ€§æ·»åŠ åˆ°vmä¸Š </span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sharedPropertyDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/** å®Œæˆè®¡ç®—å±æ€§çš„ç¼“å­˜åŠŸèƒ½ */</span>
<span class="token keyword">function</span> <span class="token function">createComputedGetter</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">computedGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        watcher<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡æ–°æ”¶é›†ä¾èµ–å¹¶å°†watcherçš„dirtyå˜ä¸ºfalse</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        watcher<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> watcher<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createGetterInvoker</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">computedGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é‡åæ£€æŸ¥</li><li>ä¸ºè®¡ç®—å±æ€§çš„<code>getter</code>åˆ›å»º<code>watcher</code></li><li>å°†è®¡ç®—å±æ€§æ·»åŠ åˆ°vmä¸Š</li><li>å®Œæˆè®¡ç®—å±æ€§çš„ç¼“å­˜åŠŸèƒ½</li></ul><blockquote><p><code>initWatch </code></p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initWatch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span> <span class="token literal-property property">watch</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> watch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> handler <span class="token operator">=</span> watch<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> handler<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span>
  <span class="token literal-property property">expOrFn</span><span class="token operator">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
  <span class="token literal-property property">handler</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> Object</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¯¹è±¡å†™æ³•</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    handler <span class="token operator">=</span> handler<span class="token punctuation">.</span>handler<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å­—ç¬¦ä¸²å†™æ³•</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handler <span class="token operator">=</span> vm<span class="token punctuation">[</span>handler<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>è¿™5ä¸ªé€‰é¡¹ä¸­çš„æ‰€æœ‰å±æ€§æœ€ç»ˆéƒ½ä¼šè¢«ç»‘å®šåˆ°å®ä¾‹ä¸Šï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨<code>this.xxx</code>æ¥è®¿é—®ä»»æ„å±æ€§ã€‚</p><p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰<code>this._propsã€this._dataã€this._watchers</code></p></blockquote><h3 id="_6-æ¨¡æ¿ç¼–è¯‘" tabindex="-1"><a class="header-anchor" href="#_6-æ¨¡æ¿ç¼–è¯‘"><span>6. æ¨¡æ¿ç¼–è¯‘</span></a></h3><figure><img src="/dcBlog/assets/3.8d0dc6f5-Cp9WURi5.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><code>Vue</code>æºç æ„å»ºæœ‰ä¸¤ç§ç‰ˆæœ¬ï¼šå®Œæ•´ç‰ˆæœ¬å’ŒåªåŒ…å«è¿è¡Œæ—¶ç‰ˆæœ¬ã€‚æ¨¡æ¿ç¼–è¯‘é˜¶æ®µåªå­˜åœ¨äºå®Œæ•´ç‰ˆä¸­ï¼Œåœ¨åªåŒ…å«è¿è¡Œæ—¶ç‰ˆæœ¬ä¸­ä¸å­˜åœ¨è¯¥é˜¶æ®µï¼Œè¿™æ˜¯å› ä¸ºåœ¨åªåŒ…å«è¿è¡Œæ—¶ç‰ˆæœ¬ä¸­ï¼Œå½“ä½¿ç”¨<code>vue-loader</code>æˆ–<code>vueify</code>æ—¶ï¼Œ<code>*.vue</code>æ–‡ä»¶å†…éƒ¨çš„æ¨¡æ¿ä¼šåœ¨æ„å»ºæ—¶é¢„ç¼–è¯‘æˆæ¸²æŸ“å‡½æ•°ï¼Œæ‰€ä»¥æ˜¯ä¸éœ€è¦ç¼–è¯‘çš„ï¼Œä»è€Œä¸å­˜åœ¨æ¨¡æ¿ç¼–è¯‘é˜¶æ®µã€‚</p><p>æ¨¡æ¿ç¼–è¯‘å‘ç”Ÿåœ¨ <mark>å®Œæ•´ç‰ˆæœ¬</mark> ä¸­è°ƒç”¨<code>$mount</code>æ—¶ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount<span class="token punctuation">;</span> <span class="token comment">// åŸ$mountçš„å¤‡ä»½</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token parameter">el<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>
  hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
  <span class="token comment">// æ ¹æ®ä¼ å…¥çš„elå‚æ•°è·å–DOMå…ƒç´ </span>
  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">===</span> document<span class="token punctuation">.</span>body <span class="token operator">||</span> el <span class="token operator">===</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åœ¨ç”¨æˆ·æ²¡æœ‰æ‰‹å†™renderå‡½æ•°çš„æƒ…å†µä¸‹è·å–ä¼ å…¥çš„æ¨¡æ¿template</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">;</span>
  <span class="token comment">// resolve template/el and convert to render function</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¯ä»¥ä½¿ç”¨idé€‰æ‹©å™¨å°†é¡µé¢ä¸­å·²å­˜åœ¨çš„ä¸€ä¸ªDOMå…ƒç´ ä½œä¸ºæ¨¡æ¿</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> template <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// idé€‰æ‹©å™¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          template <span class="token operator">=</span> <span class="token function">idToTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/* istanbul ignore if */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Template element not found or is empty: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
              <span class="token keyword">this</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// domå…ƒç´ </span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        template <span class="token operator">=</span> template<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;invalid template option:&quot;</span> <span class="token operator">+</span> template<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      template <span class="token operator">=</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">&quot;compile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// å°†è·å–åˆ°çš„templateç¼–è¯‘æˆrenderå‡½æ•°</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>
        template<span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">outputSourceRange</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
          shouldDecodeNewlines<span class="token punctuation">,</span>
          shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
          <span class="token literal-property property">delimiters</span><span class="token operator">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>
          <span class="token literal-property property">comments</span><span class="token operator">:</span> options<span class="token punctuation">.</span>comments<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      options<span class="token punctuation">.</span>render <span class="token operator">=</span> render<span class="token punctuation">;</span>
      options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> staticRenderFns<span class="token punctuation">;</span>

      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">&quot;compile end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> compile</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">&quot;compile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;compile end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è°ƒç”¨åŸmount </span>
  <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è°ƒç”¨<code>compileToFunctions</code>å°†é…ç½®é¡¹ä¸­çš„<code>template</code>ç¼–è¯‘æˆ<code>render</code>å‡½æ•°</li><li>å°†<code>render</code>æŒ‚è½½åˆ°<code>options.render</code>ï¼Œè°ƒç”¨åŸ<code>mount</code></li></ul><h3 id="_7-æ¨¡æ¿æŒ‚è½½" tabindex="-1"><a class="header-anchor" href="#_7-æ¨¡æ¿æŒ‚è½½"><span>7. æ¨¡æ¿æŒ‚è½½</span></a></h3><p>æ¨¡æ¿ç¼–è¯‘é˜¶æ®µå®Œæˆä¹‹åï¼Œæ¥ä¸‹æ¥å°±è¿›å…¥äº†æŒ‚è½½é˜¶æ®µï¼Œä»å®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‚è½½é˜¶æ®µæ‰€åšçš„ä¸»è¦å·¥ä½œæ˜¯åˆ›å»º<code>Vue</code>å®ä¾‹å¹¶ç”¨å…¶æ›¿æ¢<code>el</code>é€‰é¡¹å¯¹åº”çš„<code>DOM</code>å…ƒç´ ï¼ŒåŒæ—¶è¿˜è¦å¼€å¯å¯¹æ¨¡æ¿ä¸­æ•°æ®ï¼ˆçŠ¶æ€ï¼‰çš„ç›‘æ§ï¼Œå½“æ•°æ®ï¼ˆçŠ¶æ€ï¼‰å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥å…¶ä¾èµ–è¿›è¡Œè§†å›¾æ›´æ–°ã€‚</p><figure><img src="/dcBlog/assets/4.6a76bb54-DyjoL4L8.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>$mount</strong><span id="mount"></span></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre js="" class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span>hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrowser <span class="token operator">?</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mountComponent</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>el<span class="token punctuation">,</span>hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render <span class="token operator">=</span> createEmptyVNode <span class="token comment">// åˆ›å»ºä¸€ä¸ªæ³¨é‡Šç±»å‹çš„VNodeèŠ‚ç‚¹</span>
    <span class="token punctuation">}</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&#39;beforeMount&#39;</span><span class="token punctuation">)</span> <span class="token comment">// è§¦å‘beforeMountç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°</span>

    <span class="token keyword">let</span> updateComponent

    <span class="token comment">// å°†æœ€æ–°çš„æ¨¡æ¿å†…å®¹æ¸²æŸ“åˆ°è§†å›¾é¡µé¢ï¼ˆdomæ›´æ–°ï¼‰</span>
    <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function">before</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&#39;beforeUpdate&#39;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* isRenderWatcher */</span><span class="token punctuation">)</span>
    hydrating <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&#39;mounted&#39;</span><span class="token punctuation">)</span> <span class="token comment">// è°ƒç”¨æŒ‚è½½å®Œæˆçš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°mounted</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vm
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>vm._render()</code>ä¼šè°ƒç”¨<code>render</code>å‡½æ•°ç”Ÿæˆæœ€æ–°çš„<code>VNode</code>ï¼Œè€Œ<code>vm._update</code>ä¸­ä¼šè°ƒç”¨<code>vm.__patch__</code>å®ç°æ–°æ—§VNodeçš„å¯¹æ¯”å¹¶æ›´æ–°DOMèŠ‚ç‚¹ï¼Œå®Œæˆä¸€æ¬¡æ¸²æŸ“ã€‚ï¼ˆ <mark>åˆ›å»ºvm.$elå¹¶ç”¨å…¶æ›¿æ¢el</mark> ï¼‰</li><li>åˆ›å»ºä¸€ä¸ª<code>Watcher</code>å®ä¾‹ï¼Œå°†å®šä¹‰å¥½çš„<code>updateComponent</code>å‡½æ•°ä¼ å…¥ã€‚åˆ›å»ºæ—¶ä¼šæ‰§è¡Œå‡½æ•°ï¼Œä»è€Œè§¦å‘å‡½æ•°å†…æ•°æ®çš„<code>getter</code>æ–¹æ³•ï¼Œè€Œåœ¨<code>getter</code>æ–¹æ³•ä¸­ä¼šå°†<code>watcher</code>å®ä¾‹æ·»åŠ åˆ°è¯¥æ•°æ®çš„ä¾èµ–åˆ—è¡¨ä¸­ï¼Œå½“è¯¥æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶å°±ä¼šé€šçŸ¥ä¾èµ–åˆ—è¡¨ä¸­æ‰€æœ‰çš„ä¾èµ–ï¼ˆåŒ…æ‹¬æ­¤<code>watcher</code>å®ä¾‹ï¼‰ï¼Œä¾èµ–æ¥æ”¶åˆ°é€šçŸ¥åå°±ä¼šé‡æ–°æ‰§è¡Œ<code>updateComponent</code>å‡½æ•°å®Œæˆæ–°ä¸€è½®æ¸²æŸ“ã€‚</li></ul><blockquote><p><code>isRenderWatcher</code>ä¸ºtrueï¼Œè¿™ä¼šå°†æ­¤<code>watcher</code>èµ‹å€¼ç»™<code>vm._watcher_</code></p></blockquote><h3 id="_8-é”€æ¯é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#_8-é”€æ¯é˜¶æ®µ"><span>8. é”€æ¯é˜¶æ®µ</span></a></h3><p>æ¥ä¸‹æ¥åˆ°äº†ç”Ÿå‘½å‘¨æœŸæµç¨‹çš„æœ€åä¸€ä¸ªé˜¶æ®µâ€”â€”é”€æ¯é˜¶æ®µã€‚ä»å®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“è°ƒç”¨äº†<code>vm.$destroy</code>æ–¹æ³•ï¼Œ<code>Vue</code>å®ä¾‹å°±è¿›å…¥äº†é”€æ¯é˜¶æ®µï¼Œè¯¥é˜¶æ®µæ‰€åšçš„ä¸»è¦å·¥ä½œæ˜¯ <mark>å°†å½“å‰çš„Vueå®ä¾‹ä»å…¶çˆ¶çº§å®ä¾‹ä¸­åˆ é™¤ï¼Œå–æ¶ˆå½“å‰å®ä¾‹ä¸Šçš„æ‰€æœ‰ä¾èµ–è¿½è¸ªå¹¶ä¸”ç§»é™¤å®ä¾‹ä¸Šçš„æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨</mark> ã€‚</p><figure><img src="/dcBlog/assets/7.810540a5-CANmnjKy.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>$destroy</strong><span id="destroy"></span></p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$destroy</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isBeingDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&quot;beforeDestroy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨beforeDestroyçš„é’©å­å‡½æ•°</span>
    vm<span class="token punctuation">.</span>_isBeingDestroyed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†å½“å‰çš„Vueå®ä¾‹ä»å…¶çˆ¶çº§å®ä¾‹ä¸­åˆ é™¤</span>
    <span class="token keyword">const</span> parent <span class="token operator">=</span> vm<span class="token punctuation">.</span>$parent<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parent<span class="token punctuation">.</span>_isBeingDestroyed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>abstract<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">remove</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>$children<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// teardown watchers</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†æ¸²æŸ“å®ä¾‹ä»å…¶ä»–æ•°æ®çš„ä¾èµ–åˆ—è¡¨ä¸­åˆ é™¤</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç§»é™¤å®ä¾‹å†…æ•°æ®å¯¹å…¶ä»–æ•°æ®çš„ä¾èµ–</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// remove reference from data ob</span>
    <span class="token comment">// frozen object may not have observer.</span>
    <span class="token comment">// ç»„ä»¶å®ä¾‹çš„æ•°é‡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>__ob__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>__ob__<span class="token punctuation">.</span>vmCount<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// call the last hook...</span>
    vm<span class="token punctuation">.</span>_isDestroyed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†å®ä¾‹çš„VNodeæ ‘è®¾ç½®ä¸ºnull</span>
    vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_vnode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è°ƒç”¨destroyedçš„é’©å­å‡½æ•°</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&quot;destroyed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç§»é™¤å®ä¾‹ä¸Šçš„æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨</span>
    vm<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// remove __vue__ reference</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// release circular reference (#6759)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="äº”ã€å®ä¾‹æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#äº”ã€å®ä¾‹æ–¹æ³•"><span>äº”ã€å®ä¾‹æ–¹æ³•</span></a></h2><p>å®ä¾‹æ–¹æ³•æ˜¯å°†å„ç§è‡ªå®šä¹‰æ–¹æ³•æŒ‚è½½åˆ°<code>Vue</code>çš„åŸå‹å¯¹è±¡ä¸Šï¼Œ<code>Vue..prototype.$xxx = xxx</code></p><h3 id="_1-æ•°æ®ç›¸å…³" tabindex="-1"><a class="header-anchor" href="#_1-æ•°æ®ç›¸å…³"><span>1. æ•°æ®ç›¸å…³</span></a></h3><p>ä¸æ•°æ®ç›¸å…³çš„å®ä¾‹æ–¹æ³•æœ‰ 3 ä¸ªï¼Œåˆ†åˆ«æ˜¯<code>vm.$set</code>ã€<code>vm.$delete</code>å’Œ<code>vm.$watch</code>ã€‚å®ƒä»¬æ˜¯åœ¨<code>stateMixin</code>å‡½æ•°ä¸­æŒ‚è½½åˆ°<code>Vue</code>åŸå‹ä¸Šçš„ã€‚</p><h4 id="vm-watch" tabindex="-1"><a class="header-anchor" href="#vm-watch"><span>vm.$watch</span></a></h4><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$watch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cbä¸­åŒ…å«å›è°ƒå’Œé…ç½®ï¼Œæ‹†åˆ†å‡ºæ¥å†è°ƒç”¨$watch</span>
    <span class="token keyword">return</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> watcher<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unwatchFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ç»Ÿä¸€ä¸åŒçš„ä¼ å‚æƒ…å†µï¼Œè§£æå‡ºå›è°ƒå’Œé…ç½®ï¼Œå®ä¾‹åŒ–<code>watcher</code></li><li>ä¼ å…¥<code>immediate</code>é…ç½®ï¼Œç«‹å³è°ƒç”¨</li><li>è¿”å›<code>watcher</code>çš„å¸è½½å‡½æ•°</li></ul><h4 id="vm-set" tabindex="-1"><a class="header-anchor" href="#vm-set"><span><a href="#set">vm.$set</a></span></a></h4><h4 id="vm-delete" tabindex="-1"><a class="header-anchor" href="#vm-delete"><span><a href="#del">vm.$delete</a></span></a></h4><h3 id="_2-äº‹ä»¶ç›¸å…³" tabindex="-1"><a class="header-anchor" href="#_2-äº‹ä»¶ç›¸å…³"><span>2. äº‹ä»¶ç›¸å…³</span></a></h3><p>ä¸äº‹ä»¶ç›¸å…³çš„å®ä¾‹æ–¹æ³•æœ‰4ä¸ªï¼Œåˆ†åˆ«æ˜¯<code>vm.$on</code>ã€<code>vm.$emit</code>ã€<code>vm.$off</code>å’Œ<code>vm.$once</code>ã€‚å®ƒä»¬æ˜¯åœ¨<code>eventsMixin</code>å‡½æ•°ä¸­æŒ‚è½½åˆ°<code>Vue</code>åŸå‹ä¸Šçš„ã€‚</p><blockquote><p>æ‰€æœ‰çš„æ–¹æ³•éƒ½å›´ç»•ç€<code>vm._events</code></p></blockquote><h4 id="vm-on" tabindex="-1"><a class="header-anchor" href="#vm-on"><span>vm.$on</span></a></h4><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$on</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> event<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>event<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vm
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å°†å®šä¹‰çš„äº‹ä»¶å’Œå›è°ƒå­˜å…¥<code>vm._events</code></li></ul><h4 id="vm-emit" tabindex="-1"><a class="header-anchor" href="#vm-emit"><span>vm.$emit</span></a></h4><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$emit</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">let</span> cbs <span class="token operator">=</span> vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cbs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cbs <span class="token operator">=</span> cbs<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token function">toArray</span><span class="token punctuation">(</span>cbs<span class="token punctuation">)</span> <span class="token operator">:</span> cbs
      <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> cbs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          cbs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">event handler for &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vm
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å–å‡º<code>vm._event</code>ä¸­å¯¹åº”äº‹ä»¶åçš„å›è°ƒå‡½æ•°å¹¶æ‰§è¡Œ</li></ul><h4 id="vm-off" tabindex="-1"><a class="header-anchor" href="#vm-off"><span>vm.$off</span></a></h4><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$off</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// ä¸ä¼ å‚ç§»é™¤æ‰€æœ‰äº‹ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arguments<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>_events <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> vm
    <span class="token punctuation">}</span>
    <span class="token comment">// array of events</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> event<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>event<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> vm
    <span class="token punctuation">}</span>
    <span class="token comment">// specific event</span>
    <span class="token keyword">const</span> cbs <span class="token operator">=</span> vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cbs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> vm
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">return</span> vm
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// specific handler</span>
        <span class="token keyword">let</span> cb
        <span class="token keyword">let</span> i <span class="token operator">=</span> cbs<span class="token punctuation">.</span>length
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cb <span class="token operator">=</span> cbs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cb <span class="token operator">===</span> fn <span class="token operator">||</span> cb<span class="token punctuation">.</span>fn <span class="token operator">===</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cbs<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vm
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ¹æ®ä¼ å‚çš„ä¸åŒä½œä¸åŒçš„å¤„ç†ï¼š</p><ul><li>ä¸ä¼ å‚ï¼Œç§»é™¤æ‰€æœ‰äº‹ä»¶</li></ul><h4 id="vm-once" tabindex="-1"><a class="header-anchor" href="#vm-once"><span>vm.$once</span></a></h4><p>ç›‘å¬ä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶ï¼Œä½†æ˜¯åªè§¦å‘ä¸€æ¬¡ã€‚ä¸€æ—¦è§¦å‘ä¹‹åï¼Œç›‘å¬å™¨å°±ä¼šè¢«ç§»é™¤ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$once</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">function</span> <span class="token function">on</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> on<span class="token punctuation">)</span>
        <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    on<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn
    vm<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> on<span class="token punctuation">)</span>
    <span class="token keyword">return</span> vm
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ³¨å†Œä¸€ä¸ªäº‹ä»¶ï¼Œåœ¨äº‹ä»¶å›è°ƒä¸­å¸è½½äº‹ä»¶å¹¶æ‰§è¡Œå›è°ƒå‡½æ•°</li></ul><h3 id="_3-ç”Ÿå‘½å‘¨æœŸç›¸å…³" tabindex="-1"><a class="header-anchor" href="#_3-ç”Ÿå‘½å‘¨æœŸç›¸å…³"><span>3. ç”Ÿå‘½å‘¨æœŸç›¸å…³</span></a></h3><p>ä¸ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„å®ä¾‹æ–¹æ³•æœ‰4ä¸ªï¼Œåˆ†åˆ«æ˜¯<code>vm.$mount</code>ã€<code>vm.$forceUpdate</code>ã€<code>vm.$nextTick</code>å’Œ<code>vm.$destory</code>ã€‚å…¶ä¸­ï¼Œ<code>$forceUpdate</code>å’Œ<code>$destroy</code>æ–¹æ³•æ˜¯åœ¨<code>lifecycleMixin</code>å‡½æ•°ä¸­æŒ‚è½½åˆ°<code>Vue</code>åŸå‹ä¸Šçš„ï¼Œ<code>$nextTick</code>æ–¹æ³•æ˜¯åœ¨<code>renderMixin</code>å‡½æ•°ä¸­æŒ‚è½½åˆ°<code>Vue</code>åŸå‹ä¸Šçš„ï¼Œè€Œ<code>$mount</code>æ–¹æ³•æ˜¯åœ¨è·¨å¹³å°çš„ä»£ç ä¸­æŒ‚è½½åˆ°<code>Vue</code>åŸå‹ä¸Šçš„ã€‚</p><h4 id="vm-mount" tabindex="-1"><a class="header-anchor" href="#vm-mount"><span><a href="#mount">vm.$mount</a></span></a></h4><h4 id="vm-destory" tabindex="-1"><a class="header-anchor" href="#vm-destory"><span><a href="#destroy">vm.$destory</a></span></a></h4><h4 id="vm-forceupdate" tabindex="-1"><a class="header-anchor" href="#vm-forceupdate"><span>vm.$forceUpdate</span></a></h4><p>è¿«ä½¿ <code>Vue</code> å®ä¾‹é‡æ–°æ¸²æŸ“ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è°ƒç”¨äº†è¯¥æ–¹æ³•ï¼Œå½“å‰å®ä¾‹ä¼šç«‹å³ <mark>é‡æ–°æ¸²æŸ“</mark> ã€‚æ³¨æ„å®ƒä»…ä»…å½±å“å®ä¾‹æœ¬èº«å’Œæ’å…¥æ’æ§½å†…å®¹çš„å­ç»„ä»¶ï¼Œè€Œä¸æ˜¯æ‰€æœ‰å­ç»„ä»¶ã€‚</p><blockquote><p>è°ˆåˆ°é‡æ–°æ¸²æŸ“ï¼Œç†æ‰€å½“ç„¶ä¼šæƒ³åˆ°<code>watcher</code>æ¸²æŸ“å®ä¾‹çš„<code>update</code>å‡½æ•°ï¼Œå…¶è°ƒç”¨æ—¶ä¼šé‡æ–°æ¸²æŸ“ç»„ä»¶</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$forceUpdate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="vm-nexttick" tabindex="-1"><a class="header-anchor" href="#vm-nexttick"><span>vm.$nextTick</span></a></h4><p>å°†å›è°ƒå»¶è¿Ÿåˆ°ä¸‹æ¬¡ DOM æ›´æ–°å¾ªç¯ä¹‹åæ‰§è¡Œã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// æ£€æµ‹æµè§ˆå™¨æ˜¯å¦åŸç”Ÿæ”¯æŒ Promise</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>Promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isIOS<span class="token punctuation">)</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    isUsingMicroTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// æ˜¯å¦ä¸ºå¾®ä»»åŠ¡</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ£€æµ‹æµè§ˆå™¨æ˜¯å¦åŸç”Ÿæ”¯æŒMutationObserver</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>isIE <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> MutationObserver <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token function">isNative</span><span class="token punctuation">(</span>MutationObserver<span class="token punctuation">)</span> <span class="token operator">||</span> MutationObserver<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;[object MutationObserverConstructor]&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> textNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>textNode<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">characterData</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        counter <span class="token operator">=</span> <span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span>
        textNode<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    isUsingMicroTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ£€æµ‹æ˜¯å¦æ”¯æŒåŸç”Ÿ setImmediate(é«˜ç‰ˆæœ¬ IE å’Œ Edge æ”¯æŒ)</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setImmediate <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>setImmediate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setImmediate</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// éƒ½ä¸æ”¯æŒç›´æ¥ä½¿ç”¨setTimeout</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ ¹æ®ä¸åŒçš„ç¯å¢ƒä»¥ä¸åŒçš„æ–¹å¼æ‰§è¡Œå›è°ƒ</li></ul><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token parameter">cb<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> ctx<span class="token operator">?</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> _resolve<span class="token punctuation">;</span>
  <span class="token comment">// å°†å›è°ƒå‡½æ•°æ¨å…¥å›è°ƒé˜Ÿåˆ—</span>
  callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> <span class="token string">&quot;nextTick&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_resolve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœå¼‚æ­¥é”æœªé”ä¸Šï¼Œé”ä¸Šå¼‚æ­¥é”ï¼Œè°ƒç”¨å¼‚æ­¥å‡½æ•°ï¼Œå‡†å¤‡ç­‰åŒæ­¥å‡½æ•°æ‰§è¡Œå®Œåï¼Œå°±å¼€å§‹æ‰§è¡Œå›è°ƒå‡½æ•°é˜Ÿåˆ—</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">timerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å¦‚æœæ²¡æœ‰æä¾›å›è°ƒï¼Œå¹¶ä¸”æ”¯æŒPromiseï¼Œè¿”å›ä¸€ä¸ªPromise</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      _resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">flushCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// é‡ç½®å¼‚æ­¥é”</span>
  <span class="token keyword">const</span> copies <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  callbacks<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æ¸…ç©ºå›è°ƒé˜Ÿåˆ—</span>
  <span class="token comment">// æ‰§è¡Œå›è°ƒå‡½æ•°é˜Ÿåˆ—</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> copies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    copies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å¼‚æ­¥é”æ˜¯ä¸ºäº†æ¯æ¬¡äº‹ä»¶å¾ªç¯ä¸­åªæ‰§è¡Œä¸€æ¬¡<code>flushCallbacks</code>æ¥æ¸…ç©ºå›è°ƒé˜Ÿåˆ—</li></ul><h2 id="å…­ã€å…¨å±€api" tabindex="-1"><a class="header-anchor" href="#å…­ã€å…¨å±€api"><span>å…­ã€å…¨å±€API</span></a></h2><h3 id="_1-vue-use" tabindex="-1"><a class="header-anchor" href="#_1-vue-use"><span>1. vue.use</span></a></h3><ul><li><p><strong>å‚æ•°</strong>ï¼š</p><ul><li><code>{Object | Function} plugin</code></li></ul></li><li><p><strong>ç”¨æ³•</strong>ï¼š</p><p>å®‰è£… Vue.js æ’ä»¶ã€‚å¦‚æœæ’ä»¶æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¿…é¡»æä¾› <code>install</code> æ–¹æ³•ã€‚å¦‚æœæ’ä»¶æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¼šè¢«ä½œä¸º <code>install</code> æ–¹æ³•ã€‚<code>install</code> æ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šå°† <code>Vue</code> ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</p><p>è¯¥æ–¹æ³•éœ€è¦åœ¨è°ƒç”¨ <code>new Vue()</code> ä¹‹å‰è¢«è°ƒç”¨ã€‚</p><p><mark>å½“ install æ–¹æ³•è¢«åŒä¸€ä¸ªæ’ä»¶å¤šæ¬¡è°ƒç”¨ï¼Œæ’ä»¶å°†åªä¼šè¢«å®‰è£…ä¸€æ¬¡</mark> ã€‚</p></li></ul><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token doc-comment comment">/**  æ·»åŠ Vue.useå…¨å±€api */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initUse</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Vue</span><span class="token operator">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">plugin</span><span class="token operator">:</span> Function <span class="token operator">|</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å·²å®‰è£…è¿‡æ­¤æ’ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// vue.useé™¤æ’ä»¶åå¤–çš„å…¶ä»–å‚æ•°å°†ä½œä¸ºæ’ä»¶è¿è¡Œçš„å‚æ•°</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†Vueä½œä¸ºä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token punctuation">.</span>install <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugin<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    installedPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-vue-extend" tabindex="-1"><a class="header-anchor" href="#_2-vue-extend"><span>2. vue.extend</span></a></h3><ul><li><p><strong>å‚æ•°</strong>ï¼š</p><ul><li><code>{Object} options</code></li></ul></li><li><p><strong>ç”¨æ³•</strong>ï¼š</p><p>ä½¿ç”¨åŸºç¡€ Vue æ„é€ å™¨ï¼Œåˆ›å»ºä¸€ä¸ªâ€œå­ç±»â€ã€‚å‚æ•°æ˜¯ä¸€ä¸ªåŒ…å«ç»„ä»¶é€‰é¡¹çš„å¯¹è±¡ã€‚</p><p><code>data</code> é€‰é¡¹æ˜¯ç‰¹ä¾‹ï¼Œéœ€è¦æ³¨æ„ - åœ¨ <code>Vue.extend()</code> ä¸­å®ƒå¿…é¡»æ˜¯å‡½æ•°</p></li></ul><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// åˆ›å»ºæ„é€ å™¨</span>
<span class="token keyword">var</span> Profile <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">&#39;&lt;p&gt;{{firstName}} {{lastName}} aka {{alias}}&lt;/p&gt;&#39;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">&#39;Walter&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">&#39;White&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token string">&#39;Heisenberg&#39;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// åˆ›å»º Profile å®ä¾‹ï¼Œå¹¶æŒ‚è½½åˆ°ä¸€ä¸ªå…ƒç´ ä¸Šã€‚</span>
<span class="token keyword">new</span> <span class="token class-name">Profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">&#39;#mount-point&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre js="" class="language-javascript"><code><span class="token doc-comment comment">/**
 * ä½¿ç”¨åŸºç¡€ Vue æ„é€ å™¨ï¼Œåˆ›å»ºä¸€ä¸ªâ€œå­ç±»â€ï¼Œä½œä¸ºç»„ä»¶å®ä¾‹çš„æ„é€ å‡½æ•°
 */</span>
Vue<span class="token punctuation">.</span><span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">extendOptions</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
    extendOptions <span class="token operator">=</span> extendOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> Super <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> SuperId <span class="token operator">=</span> Super<span class="token punctuation">.</span>cid<span class="token punctuation">;</span>
    <span class="token comment">// ç¼“å­˜æ± ï¼Œç”¨äºç¼“å­˜åˆ›å»ºå‡ºæ¥çš„ç±»</span>
    <span class="token keyword">const</span> cachedCtors <span class="token operator">=</span> extendOptions<span class="token punctuation">.</span>_Ctor <span class="token operator">||</span> <span class="token punctuation">(</span>extendOptions<span class="token punctuation">.</span>_Ctor <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedCtors<span class="token punctuation">[</span>SuperId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> cachedCtors<span class="token punctuation">[</span>SuperId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å–åˆ°ä¼ å…¥çš„é€‰é¡¹å‚æ•°ä¸­çš„nameå­—æ®µï¼Œå¹¶ä¸”åœ¨å¼€å‘ç¯å¢ƒä¸‹æ ¡éªŒnameå­—æ®µæ˜¯å¦åˆæ³•</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> extendOptions<span class="token punctuation">.</span>name <span class="token operator">||</span> Super<span class="token punctuation">.</span>options<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">validateComponentName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å°†è¦ç»§æ‰¿åŸºç¡€Vueç±»çš„å­ç±»</span>
    <span class="token keyword">const</span> <span class="token function-variable function">Sub</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">VueComponent</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Sub</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Super</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å­ç±»çš„åŸå‹æŒ‡å‘vueçš„åŸå‹å¯¹è±¡</span>
    <span class="token class-name">Sub</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Sub<span class="token punctuation">;</span>
    Sub<span class="token punctuation">.</span>cid <span class="token operator">=</span> cid<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//å”¯ä¸€æ ‡è¯†</span>

    Sub<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>Super<span class="token punctuation">.</span>options<span class="token punctuation">,</span> extendOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Sub<span class="token punctuation">[</span><span class="token string">&quot;super&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> Super<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Sub<span class="token punctuation">.</span>options<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initProps</span><span class="token punctuation">(</span>Sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Sub<span class="token punctuation">.</span>options<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initComputed</span><span class="token punctuation">(</span>Sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å°†çˆ¶ç±»ä¸­çš„ä¸€äº›å±æ€§å¤åˆ¶åˆ°å­ç±»ä¸­</span>
    Sub<span class="token punctuation">.</span>extend <span class="token operator">=</span> Super<span class="token punctuation">.</span>extend<span class="token punctuation">;</span>
    Sub<span class="token punctuation">.</span>mixin <span class="token operator">=</span> Super<span class="token punctuation">.</span>mixin<span class="token punctuation">;</span>
    Sub<span class="token punctuation">.</span>use <span class="token operator">=</span> Super<span class="token punctuation">.</span>use<span class="token punctuation">;</span>

    <span class="token comment">//&#39;component&#39;,&#39;directive&#39;,&#39;filter&#39;</span>
    <span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Sub<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> Super<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// enable recursive self-lookup</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Sub<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> Sub<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç»™å­ç±»æ–°å¢ä¸‰ä¸ªç‹¬æœ‰çš„å±æ€§</span>
    Sub<span class="token punctuation">.</span>superOptions <span class="token operator">=</span> Super<span class="token punctuation">.</span>options<span class="token punctuation">;</span> <span class="token comment">// çˆ¶ç±»Vueçš„é…ç½®é¡¹</span>
    Sub<span class="token punctuation">.</span>extendOptions <span class="token operator">=</span> extendOptions<span class="token punctuation">;</span> <span class="token comment">// å­ç±»çš„é…ç½®é¡¹</span>
    Sub<span class="token punctuation">.</span>sealedOptions <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Sub<span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆå¹¶ä¹‹åçš„é…ç½®é¡¹</span>

    <span class="token comment">// ç¼“å­˜æ„é€ å™¨</span>
    cachedCtors<span class="token punctuation">[</span>SuperId<span class="token punctuation">]</span> <span class="token operator">=</span> Sub<span class="token punctuation">;</span>
    <span class="token keyword">return</span> Sub<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>initComputed</code>å°†ç»„ä»¶å®šä¹‰çš„è®¡ç®—å±æ€§æŒ‚è½½åˆ°ç»„ä»¶æ„é€ å‡½æ•°çš„ <mark>åŸå‹å¯¹è±¡</mark> ä¸Šï¼ˆ<mark>ç”Ÿæˆå­ç±»é˜¶æ®µï¼Œæœªå®ä¾‹åŒ–</mark>ï¼‰</p><ul><li>å¯ä»¥é€šè¿‡<code>vm[computedName]</code>è®¿é—®è®¡ç®—å±æ€§</li></ul><p>æˆ‘ä»¬ç¼–å†™çš„æ‰€æœ‰é…ç½®æ–‡ä»¶ï¼ˆdataã€propsç­‰ï¼‰çš†ç”¨äºåˆ›å»ºç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œå³ä½œä¸º<code>Vue.extend</code>è°ƒç”¨çš„å‚æ•°ï¼Œè€Œç”Ÿæˆç»„ä»¶å®ä¾‹æ˜¯åœ¨æ¨¡æ¿æŒ‚è½½æ—¶å‘ç”Ÿçš„ï¼Œ<code>VueComponent(options)</code>ä¸­ä¼ å…¥çš„<code>options</code>æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token keyword">const</span> options<span class="token operator">:</span> InternalComponentOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    _isComponent<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//æ˜¯å¦ä¸ºç»„ä»¶</span>
    _parentVnode<span class="token operator">:</span> vnode<span class="token punctuation">,</span> <span class="token comment">// ç»„ä»¶å ä½ç¬¦ VNode</span>
    parent<span class="token punctuation">,</span> <span class="token comment">// çˆ¶ç»„ä»¶å®ä¾‹</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-vue-mixin" tabindex="-1"><a class="header-anchor" href="#_3-vue-mixin"><span>3. vue.mixin</span></a></h3><ul><li><p><strong>å‚æ•°</strong>ï¼š</p><ul><li><code>{Object} mixin</code></li></ul></li><li><p><strong>ç”¨æ³•</strong>ï¼š</p><p>å…¨å±€æ³¨å†Œä¸€ä¸ªæ··å…¥ï¼Œå½±å“æ³¨å†Œä¹‹åæ‰€æœ‰åˆ›å»ºçš„æ¯ä¸ª Vue å®ä¾‹ã€‚æ’ä»¶ä½œè€…å¯ä»¥ä½¿ç”¨æ··å…¥ï¼Œå‘ç»„ä»¶æ³¨å…¥è‡ªå®šä¹‰çš„è¡Œä¸ºã€‚<strong>ä¸æ¨èåœ¨åº”ç”¨ä»£ç ä¸­ä½¿ç”¨</strong>ã€‚</p></li></ul><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">mixin</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span> mixin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-vue-observable-object" tabindex="-1"><a class="header-anchor" href="#_4-vue-observable-object"><span>4. Vue.observable( object )</span></a></h3><ul><li><p><strong>å‚æ•°</strong>ï¼š</p><ul><li><code>{Object} object</code></li></ul></li><li><p><strong>ç”¨æ³•</strong>ï¼š</p><p>è®©ä¸€ä¸ªå¯¹è±¡å¯å“åº”ã€‚Vue å†…éƒ¨ä¼šç”¨å®ƒæ¥å¤„ç† <code>data</code> å‡½æ•°è¿”å›çš„å¯¹è±¡ã€‚</p><p>è¿”å›çš„å¯¹è±¡å¯ä»¥ç›´æ¥ç”¨äºæ¸²æŸ“å‡½æ•°å’Œè®¡ç®—å±æ€§å†…ï¼Œå¹¶ä¸”ä¼šåœ¨å‘ç”Ÿå˜æ›´æ—¶è§¦å‘ç›¸åº”çš„æ›´æ–°ã€‚ä¹Ÿå¯ä»¥ä½œä¸ºæœ€å°åŒ–çš„è·¨ç»„ä»¶çŠ¶æ€å­˜å‚¨å™¨ï¼Œç”¨äºç®€å•çš„åœºæ™¯ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">const</span> state <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">observable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> Demo <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;button&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> state<span class="token punctuation">.</span>count<span class="token operator">++</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">count is: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  Vue<span class="token punctuation">.</span><span class="token function-variable function">observable</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-directiveã€filterã€component" tabindex="-1"><a class="header-anchor" href="#_5-directiveã€filterã€component"><span>5. directiveã€filterã€component</span></a></h3><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ASSET_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&#39;component&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;directive&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;filter&#39;</span>
<span class="token punctuation">]</span>

Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">&#39;s&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Vue<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span>definition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">&#39;s&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">===</span> <span class="token string">&#39;component&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">validateComponentName</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&#39;component&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                definition<span class="token punctuation">.</span>name <span class="token operator">=</span> definition<span class="token punctuation">.</span>name <span class="token operator">||</span> id
                definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&#39;directive&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> definition <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                definition <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">bind</span><span class="token operator">:</span> definition<span class="token punctuation">,</span> <span class="token literal-property property">update</span><span class="token operator">:</span> definition <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">&#39;s&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> definition
            <span class="token keyword">return</span> definition
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨<code>Vue</code>ç±»ä¸Šåˆ›å»ºäº†<code>options</code>å±æ€§ï¼Œå…¶å±æ€§å€¼ä¸ºä¸€ä¸ªç©ºå¯¹è±¡ï¼Œå¹¶ä¸”åœ¨<code>options</code>å±æ€§ä¸­æ·»åŠ äº†<code>directivesã€filtersã€components</code>å±æ€§ï¼Œå…¶å€¼ä¹Ÿæ˜¯ç©ºå¯¹è±¡ï¼Œåˆ†åˆ«ç”¨æ¥å­˜æ”¾æŒ‡ä»¤ã€è¿‡æ»¤å™¨å’Œæ³¨å†Œçš„ç»„ä»¶ã€‚</p><ul><li>å¦‚æœæ²¡æœ‰ä¼ å…¥<code>definition</code>å‚æ•°ï¼Œè¡¨ç¤ºä¸ºè·å–æ“ä½œï¼Œæ ¹æ®<code>id</code>æ¥è¯»å–ç›¸åº”çš„å¯¹è±¡ã€‚</li><li>å¦‚æœä¼ å…¥äº†<code>definition</code>å‚æ•°ï¼Œè¡¨ç¤ºä¸ºæ³¨å†Œæ“ä½œï¼Œå¯¹<code>definition</code>å¤„ç†ä¹‹åä¿å­˜åœ¨<code>this.options[type]</code>ä¸­ã€‚</li></ul></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/dcbestwords/dcBlog/edit/main/src/source_code/vue2/vuejs2.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 1114686398@qq.com">dachao</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/dcBlog/source_code/vue2/vuejs2_1.html" aria-label="Vue2æºç ï¼ˆåŠŸèƒ½ç¯‡ï¼‰"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Vue2æºç ï¼ˆåŠŸèƒ½ç¯‡ï¼‰</div></a><!----></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">é»˜è®¤é¡µè„š</div><div class="vp-copyright">Copyright Â© 2024 Dachao </div></footer></div><!--]--><!--[--><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/dcBlog/assets/app-DDDGjlek.js" defer></script>
  </body>
</html>
