<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.8" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.31" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://github.com/dcblog/source_code/vue_related/vue-router4.x.html"><meta property="og:site_name" content="dcBlog"><meta property="og:title" content="æ–°ç‰ˆvue-RouteråŸç†è§£æ"><meta property="og:description" content="æ–°ç‰ˆvue-RouteråŸç†è§£æ æœ¬æ–‡ç« å†…å®¹vue-Routerçš„ç‰ˆæœ¬ä¸º4.xï¼Œ3.xçš„åŸºæœ¬åŸç†å¯ä»¥å‚è€ƒ ä¸€ã€createRouterç»“æ„è§£æ 1. å‡†å¤‡å·¥ä½œ åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬è‚¯å®šæ˜¯éœ€è¦å»çœ‹ä¸€ä¸‹ vue-router å¯¹åº”çš„æºç ï¼Œæºç å¯ä»¥åœ¨ github ä¸Šé¢æ‰¾åˆ°ï¼Œåœ°å€å¦‚ä¸‹ï¼š https://github.com/vuejs/router vue-ro..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-08-29T16:36:49.000Z"><meta property="article:author" content="Dachao"><meta property="article:modified_time" content="2024-08-29T16:36:49.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"æ–°ç‰ˆvue-RouteråŸç†è§£æ","image":[""],"dateModified":"2024-08-29T16:36:49.000Z","author":[{"@type":"Person","name":"Dachao","email":"wyc168hard@163.com"}]}</script><link rel="icon" href="/dcblog/favicon.ico"><link rel="icon" href="/dcblog/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/dcblog/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/dcblog/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/dcblog/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/dcblog/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/dcblog/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/dcblog/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><title>æ–°ç‰ˆvue-RouteråŸç†è§£æ | dcBlog</title><meta name="description" content="æ–°ç‰ˆvue-RouteråŸç†è§£æ æœ¬æ–‡ç« å†…å®¹vue-Routerçš„ç‰ˆæœ¬ä¸º4.xï¼Œ3.xçš„åŸºæœ¬åŸç†å¯ä»¥å‚è€ƒ ä¸€ã€createRouterç»“æ„è§£æ 1. å‡†å¤‡å·¥ä½œ åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬è‚¯å®šæ˜¯éœ€è¦å»çœ‹ä¸€ä¸‹ vue-router å¯¹åº”çš„æºç ï¼Œæºç å¯ä»¥åœ¨ github ä¸Šé¢æ‰¾åˆ°ï¼Œåœ°å€å¦‚ä¸‹ï¼š https://github.com/vuejs/router vue-ro...">
    <link rel="preload" href="/dcblog/assets/style-2JG01pdU.css" as="style"><link rel="stylesheet" href="/dcblog/assets/style-2JG01pdU.css">
    <link rel="modulepreload" href="/dcblog/assets/app-DX_yn-pD.js"><link rel="modulepreload" href="/dcblog/assets/vue-router4.x.html-BruzD0Fw.js"><link rel="modulepreload" href="/dcblog/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/dcblog/"><img class="vp-nav-logo" src="/dcblog/logo.png" alt><!----><span class="vp-site-name hide-in-pad">dcBlog</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcblog/" aria-label="ä¸»é¡µ"><span class="font-icon icon iconfont icon-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcblog/basic_language/" aria-label="è¯­è¨€åŸºç¡€"><span class="font-icon icon iconfont icon-code" style=""></span>è¯­è¨€åŸºç¡€<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link active" href="/dcblog/source_code/" aria-label="æºç è§£æ"><span class="font-icon icon iconfont icon-read" style=""></span>æºç è§£æ<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcblog/Server/" aria-label="æœåŠ¡ç«¯"><span class="font-icon icon iconfont icon-back-stage" style=""></span>æœåŠ¡ç«¯<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcblog/Efficiency/" aria-label="æ•ˆç‡åä½œ"><span class="font-icon icon iconfont icon-group" style=""></span>æ•ˆç‡åä½œ<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcblog/browser_internet/" aria-label="æµè§ˆå™¨é€šä¿¡"><span class="font-icon icon iconfont icon-network" style=""></span>æµè§ˆå™¨é€šä¿¡<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcblog/algorithm/" aria-label="ç®—æ³•"><span class="font-icon icon iconfont icon-edit" style=""></span>ç®—æ³•<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcblog/Project_50/" aria-label="é¡µé¢ç»ƒä¹ "><span class="font-icon icon iconfont icon-page" style=""></span>é¡µé¢ç»ƒä¹ <!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcblog/paper/" aria-label="è¯¾é¢˜å…¬è€ƒ"><span class="font-icon icon iconfont icon-study" style=""></span>è¯¾é¢˜å…¬è€ƒ<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/dcblog/reference/" aria-label="æ–‡æ¡£æ•™ç¨‹"><span class="font-icon icon iconfont icon-article" style=""></span>æ–‡æ¡£æ•™ç¨‹<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/dcbestwords/dcBlog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><span class="font-icon icon iconfont icon-lodash" style=""></span><a class="route-link nav-link vp-sidebar-title" href="/dcblog/source_code/lodash/" aria-label="Lodash"><!---->Lodash<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/lodash/mock_get.html" aria-label="_.get() å‡½æ•°"><!---->_.get() å‡½æ•°<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><!----><a class="route-link nav-link vp-sidebar-title" href="/dcblog/source_code/promise/" aria-label="promise"><!---->promise<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/promise/async.html" aria-label="asyncçš„å®ç°åŸç†"><!---->asyncçš„å®ç°åŸç†<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/promise/promise.html" aria-label="æ‰‹å†™promise"><!---->æ‰‹å†™promise<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><span class="font-icon icon iconfont icon-vue" style=""></span><a class="route-link nav-link vp-sidebar-title" href="/dcblog/source_code/vue2/" aria-label="vue2"><!---->vue2<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue2/vuejs2_1.html" aria-label="Vue2æºç ï¼ˆåŠŸèƒ½ç¯‡ï¼‰"><!---->Vue2æºç ï¼ˆåŠŸèƒ½ç¯‡ï¼‰<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue2/vuejs2.html" aria-label="vue2æºç ç†è§£ï¼ˆæ€»è§ˆç¯‡ï¼‰"><!---->vue2æºç ç†è§£ï¼ˆæ€»è§ˆç¯‡ï¼‰<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><span class="font-icon icon iconfont icon-vue" style=""></span><a class="route-link nav-link vp-sidebar-title" href="/dcblog/source_code/vue3/" aria-label="vue3"><!---->vue3<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue3/01.vue3%E6%95%B4%E4%BD%93%E5%A4%A7%E7%BA%B2.html" aria-label="1. vue3æ•´ä½“å¤§çº²"><!---->1. vue3æ•´ä½“å¤§çº²<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue3/02.%E5%9F%BA%E7%A1%80%E5%93%8D%E5%BA%94%E5%BC%8F.html" aria-label="2. åŸºç¡€å“åº”ç³»ç»Ÿçš„å®ç°"><!---->2. åŸºç¡€å“åº”ç³»ç»Ÿçš„å®ç°<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue3/03.%E9%9D%9E%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F.html" aria-label="3. éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ"><!---->3. éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue3/04.%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F.html" aria-label="4. åŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ"><!---->4. åŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue3/05.%E6%B8%B2%E6%9F%93%E5%99%A8.html" aria-label="5. æ¸²æŸ“å™¨"><!---->5. æ¸²æŸ“å™¨<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue3/06.Diff%E7%AE%97%E6%B3%95.html" aria-label="6. Diffç®—æ³•"><!---->6. Diffç®—æ³•<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue3/07.%E7%BC%96%E8%AF%91%E5%99%A8.html" aria-label="7. ç¼–è¯‘å™¨"><!---->7. ç¼–è¯‘å™¨<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue3/vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E6%80%BB%E7%BB%93.html" aria-label="vue3å“åº”å¼æ€»ç»“"><!---->vue3å“åº”å¼æ€»ç»“<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue3/vue3%E6%8C%82%E8%BD%BD%E6%B5%81%E7%A8%8B.html" aria-label="vue3æŒ‚è½½æµç¨‹"><!---->vue3æŒ‚è½½æµç¨‹<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable active"><span class="font-icon icon iconfont icon-vue" style=""></span><a class="route-link nav-link active vp-sidebar-title" href="/dcblog/source_code/vue_related/" aria-label="vueç”Ÿæ€"><!---->vueç”Ÿæ€<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue_related/vue-router.html" aria-label="vue-router åŸç†è§£æ"><!---->vue-router åŸç†è§£æ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/dcblog/source_code/vue_related/mini-pinia.html" aria-label="å®ç°mini-Pinia"><!---->å®ç°mini-Pinia<!----></a></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/dcblog/source_code/vue_related/vue-router4.x.html" aria-label="æ–°ç‰ˆvue-RouteråŸç†è§£æ"><!---->æ–°ç‰ˆvue-RouteråŸç†è§£æ<!----></a></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->æ–°ç‰ˆvue-RouteråŸç†è§£æ</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Dachao</span></span><span property="author" content="Dachao"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-08-29T16:36:49.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 68 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT68M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcblog/#ä¸€ã€createrouterç»“æ„è§£æ">ä¸€ã€createRouterç»“æ„è§£æ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_1-å‡†å¤‡å·¥ä½œ">1. å‡†å¤‡å·¥ä½œ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_2-æ•´ä½“ç»“æ„åˆ†æ">2. æ•´ä½“ç»“æ„åˆ†æ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_3-åˆ›å»º-matcher">3. åˆ›å»º matcher</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_4-å¤„ç†å¯¼èˆªå®ˆå«">4. å¤„ç†å¯¼èˆªå®ˆå«</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_5-currentrouteå£°æ˜">5. currentRouteå£°æ˜</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_6-å¤„ç†-params">6. å¤„ç† params</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_7-å®šä¹‰å„ç§æ–¹æ³•">7. å®šä¹‰å„ç§æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_8-routerå¯¹è±¡">8. routerå¯¹è±¡</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcblog/#äºŒã€history-åŸºç¡€çŸ¥è¯†">äºŒã€history åŸºç¡€çŸ¥è¯†</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_1-hashæ¨¡å¼">1. hashæ¨¡å¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_2-html5æ¨¡å¼">2. html5æ¨¡å¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_3-location-å¯¹è±¡">3. location å¯¹è±¡</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcblog/#ä¸‰ã€createwebhistoryç»“æ„æ‹†è§£">ä¸‰ã€createWebHistoryç»“æ„æ‹†è§£</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_1-æ•´ä½“ç»“æ„åˆ†æ">1. æ•´ä½“ç»“æ„åˆ†æ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_2-æ ‡å‡†åŒ–base">2. æ ‡å‡†åŒ–base</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_3-åç»­æ“ä½œ">3. åç»­æ“ä½œ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcblog/#å››ã€usehistorystatenavigationç»“æ„è§£æ">å››ã€useHistoryStateNavigationç»“æ„è§£æ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_1-æ•´ä½“ç»“æ„">1. æ•´ä½“ç»“æ„</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_2-ä»£ç æ‹†è§£">2. ä»£ç æ‹†è§£</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcblog/#äº”ã€usehistorylistenersç»“æ„è§£æ">äº”ã€useHistoryListenersç»“æ„è§£æ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_1-æ•´ä½“ç»“æ„-1">1. æ•´ä½“ç»“æ„</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_2-ä»£ç æ‹†è§£-1">2. ä»£ç æ‹†è§£</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcblog/#å…­ã€routerlinkç»„ä»¶è§£æ">å…­ã€RouterLinkç»„ä»¶è§£æ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_1-compatconfig">1. compatConfig</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_2-props">2. props</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_3-uselink">3. useLink</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_4-setup">4. setup</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcblog/#ä¸ƒã€routerviewæºç è§£æ">ä¸ƒã€RouterViewæºç è§£æ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_1-depth-æ·±åº¦">1. depth æ·±åº¦</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_2-watch">2. watch</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_3-return">3. return</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/dcblog/#å…«ã€å¯¼èˆªå®ˆå«æµç¨‹è§£æ">å…«ã€å¯¼èˆªå®ˆå«æµç¨‹è§£æ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_1-å¯¼èˆªå®ˆå«ç›¸å…³æºç ">1. å¯¼èˆªå®ˆå«ç›¸å…³æºç </a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/dcblog/#_2-å¯¼èˆªå®ˆå«æ‰§è¡Œæµç¨‹">2. å¯¼èˆªå®ˆå«æ‰§è¡Œæµç¨‹</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="æ–°ç‰ˆvue-routeråŸç†è§£æ" tabindex="-1"><a class="header-anchor" href="#æ–°ç‰ˆvue-routeråŸç†è§£æ"><span>æ–°ç‰ˆvue-RouteråŸç†è§£æ</span></a></h1><blockquote><p>æœ¬æ–‡ç« å†…å®¹vue-Routerçš„ç‰ˆæœ¬ä¸º4.xï¼Œ3.xçš„åŸºæœ¬åŸç†å¯ä»¥å‚è€ƒ<a class="route-link" href="/dcblog/source_code/vue_related/vue-router.html">vue-routeråŸç†è§£æ</a></p></blockquote><h2 id="ä¸€ã€createrouterç»“æ„è§£æ" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€createrouterç»“æ„è§£æ"><span>ä¸€ã€createRouterç»“æ„è§£æ</span></a></h2><h3 id="_1-å‡†å¤‡å·¥ä½œ" tabindex="-1"><a class="header-anchor" href="#_1-å‡†å¤‡å·¥ä½œ"><span>1. å‡†å¤‡å·¥ä½œ</span></a></h3><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬è‚¯å®šæ˜¯éœ€è¦å»çœ‹ä¸€ä¸‹ vue-router å¯¹åº”çš„æºç ï¼Œæºç å¯ä»¥åœ¨ github ä¸Šé¢æ‰¾åˆ°ï¼Œåœ°å€å¦‚ä¸‹ï¼š</p><p>https://github.com/vuejs/router</p><p>vue-router æ•´ä½“é¡¹ç›®é‡‡ç”¨çš„æ˜¯ monorepo çš„ä»£ç ç®¡ç†é£æ ¼ï¼Œä½¿ç”¨ pnpm + workspace çš„æ–¹å¼æ¥æ­å»ºçš„ monorepo é¡¹ç›®ï¼Œæºç ç›®å½•å¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>â”œâ”€â”€ .github
â”œâ”€â”€ .vscode
â”œâ”€â”€ packages             // é¡¹ç›®åˆ†åŒ…
â”‚   â”œâ”€â”€ docs             // vue router APIæ–‡æ¡£
â”‚   â”œâ”€â”€ playground       // æœ¬åœ°é¡¹ç›®æ•ˆæœé¢„è§ˆ
â”‚   â””â”€â”€ router           // vue routeræºç 
â”œâ”€â”€ scripts              // å·¥ç¨‹è„šæœ¬
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .npmrc               // é¡¹ç›®çš„é…ç½®æ–‡ä»¶
â”œâ”€â”€ .prettierignore
â”œâ”€â”€ .prettierrc
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ netlify.toml
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml       // ä¾èµ–ç‰ˆæœ¬æ§åˆ¶
â””â”€â”€ pnpm-workspace.yaml  // å·¥ä½œç©ºé—´æ ¹ç›®å½•
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­å…³äº router çš„æºç ä½äº packages/router/srcï¼Œç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>â”œâ”€â”€ history
â”œâ”€â”€ matcher
â”œâ”€â”€ types
â”œâ”€â”€ utils
â”œâ”€â”€ RouterLink.ts
â”œâ”€â”€ RouterView.ts
â”œâ”€â”€ config.ts
â”œâ”€â”€ devtools.ts
â”œâ”€â”€ encoding.ts
â”œâ”€â”€ errors.ts
â”œâ”€â”€ global.d.ts
â”œâ”€â”€ globalExtensions.ts
â”œâ”€â”€ index.ts
â”œâ”€â”€ injectionSymbols.ts
â”œâ”€â”€ location.ts
â”œâ”€â”€ navigationGuards.ts
â”œâ”€â”€ query.ts
â”œâ”€â”€ router.ts
â”œâ”€â”€ scrollBehavior.ts
â”œâ”€â”€ useApi.ts
â””â”€â”€ warning.ts
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½œä¸ºä¸€ä¸ªé¡¹ç›®çš„å…¥å£ï¼Œæˆ‘ä»¬è‡ªç„¶ä¼šå» index.tsï¼Œè¿™ä¸ª index.ts æ•´ä½“æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å•çº¯çš„å°†å…¶ä»–æ–‡ä»¶çš„å·¥å…·æ–¹æ³•æˆ–è€…ç±»å‹å¯¼å‡ºè€Œå·²ï¼Œå…¶ä¸­å°±åŒ…å«äº†éå¸¸é‡è¦çš„ä¸€ä¸ªæ–¹æ³• <code>createRouter</code>ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token punctuation">{</span> createRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./router&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥é¡ºè—¤æ‘¸ç“œï¼Œåˆ° router.ts é‡Œé¢å»æŸ¥çœ‹ createRouter çš„æºç ã€‚</p><h3 id="_2-æ•´ä½“ç»“æ„åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_2-æ•´ä½“ç»“æ„åˆ†æ"><span>2. æ•´ä½“ç»“æ„åˆ†æ</span></a></h3><p>åœ¨åˆ†æ createRouter æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å›å¿†ä¸€ä¸‹ï¼Œæ•´ä¸ª createRouter æ˜¯å¦‚ä½•ä½¿ç”¨çš„</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue-router&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// è°ƒç”¨ createRouter æ–¹æ³•çš„æ—¶å€™ï¼Œä¼ å…¥ä¸€ä¸ªé…ç½®å¯¹è±¡</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  history<span class="token operator">:</span> <span class="token function">createWebHistory</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">BASE_URL</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&#39;home&#39;</span><span class="token punctuation">,</span>
      component<span class="token operator">:</span> HomeView
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">&#39;/about&#39;</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&#39;about&#39;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;../views/AboutView.vue&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å…³äºä¼ å…¥ createRouter æ–¹æ³•çš„é…ç½®å¯¹è±¡æ‰€æ”¯æŒçš„é…ç½®é¡¹å¯ä»¥å‚é˜…ï¼š<a href="https://router.vuejs.org/zh/api/interfaces/RouterOptions.html" target="_blank" rel="noopener noreferrer">https://router.vuejs.org/zh/api/interfaces/RouterOptions.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>æ³¨æ„ï¼šè¯¥é…ç½®å¯¹è±¡åœ¨å®˜æ–¹ä¸­å¯¹åº”çš„ç±»å‹ RouterOptions</li><li>è¿”å›å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯¹åº”çš„ç±»å‹å°±æ˜¯ Routerï¼Œæ—¢ç„¶æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆä¸Šé¢ä¼šæœ‰ä¸€äº›å±æ€§ä»¥åŠæ–¹æ³• <ul><li>å±æ€§ï¼šcurrentRouteã€listeningã€options</li><li>æ–¹æ³•ï¼šaddRouteã€getRoutesã€pushã€repalceã€goã€beforeEach...</li></ul></li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šåœ¨é¡¹ç›®ä¸­çš„ main.ts ä¸­å¼•å…¥è¿™ä¸ªå¯¹è±¡ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">&quot;./router&quot;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span> <span class="token comment">// æ³¨å†Œæ’ä»¶</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ° packages/router/src/router.ts ä¸­ï¼Œæ‰¾åˆ° createRouter æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„æ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouter</span><span class="token punctuation">(</span>options<span class="token operator">:</span> RouterOptions<span class="token punctuation">)</span><span class="token operator">:</span> Router <span class="token punctuation">{</span>
    <span class="token comment">/*
     * 1. å„ç§å˜é‡çš„å®šä¹‰
     */</span>
    <span class="token keyword">const</span> matcher <span class="token operator">=</span> <span class="token operator">...</span>
    <span class="token keyword">const</span> parseQuery <span class="token operator">=</span> <span class="token operator">...</span>
    <span class="token keyword">const</span> stringifyQuery <span class="token operator">=</span> <span class="token operator">...</span>
    <span class="token keyword">const</span> routerHistory <span class="token operator">=</span> <span class="token operator">...</span>
    
    <span class="token comment">/*
     * 2. å¯¼èˆªå®ˆå«
     */</span>
    <span class="token keyword">const</span> beforeGuards <span class="token operator">=</span> <span class="token operator">...</span>
    <span class="token keyword">const</span> beforeResolveGuards <span class="token operator">=</span> <span class="token operator">...</span>
    <span class="token keyword">const</span> afterGuards <span class="token operator">=</span> <span class="token operator">...</span>
    
    <span class="token comment">/*
     * 3. å½“å‰è·¯ç”±åˆå§‹åŒ–
     */</span>
    <span class="token keyword">const</span> currentRoute <span class="token operator">=</span> <span class="token operator">...</span>
    <span class="token keyword">let</span> pendingLocation<span class="token operator">:</span> RouteLocation <span class="token operator">=</span> <span class="token operator">...</span>
    
    <span class="token comment">/*
     * 4. params ç›¸å…³å¤„ç†
     */</span>
    <span class="token keyword">const</span> normalizeParams <span class="token operator">=</span> <span class="token operator">...</span>
    <span class="token keyword">const</span> encodeParams <span class="token operator">=</span> <span class="token operator">...</span>
    <span class="token keyword">const</span> decodeParams <span class="token operator">=</span> <span class="token operator">...</span>
    
    <span class="token comment">/*
     * 5. å„ç§æ–¹æ³•çš„å®šä¹‰
     * è¿™äº›æ–¹æ³•é‡Œé¢æœ‰ä¾›å†…éƒ¨ä½¿ç”¨çš„æ–¹æ³•ï¼Œä¹Ÿæœ‰æš´éœ²å‡ºå»ç»™å¤–éƒ¨ä½¿ç”¨çš„æ–¹æ³•
     */</span>
    <span class="token keyword">function</span> <span class="token function">addRoute</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">removeRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">hasRoute</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">locationAsObject</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">checkCanceledNavigation</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">handleRedirectRecord</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>   
    <span class="token keyword">function</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">checkCanceledNavigationAndReject</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">runWithContext</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">setupListeners</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">triggerError</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">isReady</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">markAsReady</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">handleScroll</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    
    
    <span class="token comment">/*
     * 6. å‘å¤–éƒ¨è¿”å›çš„å¯¹è±¡
     * è¯¥å¯¹è±¡ä¼šåŒ…å«éƒ¨åˆ†ä¸Šé¢æ‰€å®šä¹‰çš„æ–¹æ³•ï¼Œå¿…é¡»è¦æœ‰ä¸€ä¸ª install æ–¹æ³•
     */</span>
    <span class="token keyword">const</span> router<span class="token operator">:</span> Router <span class="token operator">=</span> <span class="token punctuation">{</span>
      currentRoute<span class="token punctuation">,</span>
      listening<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  
      addRoute<span class="token punctuation">,</span>
      removeRoute<span class="token punctuation">,</span>
      hasRoute<span class="token punctuation">,</span>
      getRoutes<span class="token punctuation">,</span>
      resolve<span class="token punctuation">,</span>
      options<span class="token punctuation">,</span>
  
      push<span class="token punctuation">,</span>
      replace<span class="token punctuation">,</span>
      go<span class="token punctuation">,</span>
      <span class="token function-variable function">back</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">forward</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  
      beforeEach<span class="token operator">:</span> beforeGuards<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
      beforeResolve<span class="token operator">:</span> beforeResolveGuards<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
      afterEach<span class="token operator">:</span> afterGuards<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
  
      onError<span class="token operator">:</span> errorListeners<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
      isReady<span class="token punctuation">,</span>
      
      <span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> router<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°† <code>createRouter</code> è¿™ä¸ªæ ¸å¿ƒæ–¹æ³•çš„æ•´ä½“ç»“æ„ææ¸…æ¥šï¼Œå†…éƒ¨å£°æ˜äº†ä¸€äº›å˜é‡ä»¥åŠæ–¹æ³•ï¼Œæœ€ç»ˆä¼šå¯¼å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡èº«ä¸Šä¼šåŒ…å«ä¸€éƒ¨åˆ†ä¸Šé¢æ‰€å£°æ˜çš„å˜é‡ä»¥åŠæ–¹æ³•ã€‚</p><p><code>createRouter</code> æ•´ä½“å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/dcblog/assets/createRouter-CAZ2ipjy.png" style="zoom:50%;"><h3 id="_3-åˆ›å»º-matcher" tabindex="-1"><a class="header-anchor" href="#_3-åˆ›å»º-matcher"><span>3. åˆ›å»º matcher</span></a></h3><p>createRouter æ–¹æ³•å†…éƒ¨çš„ç¬¬ä¸€å¥ä»£ç å°±æ˜¯åˆ›å»º matcher</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> matcher <span class="token operator">=</span> <span class="token function">createRouterMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>createRouterMatcher</code> æ–¹æ³•ä½äº matcher ç›®å½•ä¸‹é¢çš„ index.tsï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„æ–¹æ³•ç­¾åï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouterMatcher</span><span class="token punctuation">(</span>
  <span class="token comment">// routes æ˜¯ä¸€ä¸ªåªè¯»æ•°ç»„ï¼Œé‡Œé¢å­˜æ”¾çš„å°±æ˜¯å¼€å‘è€…æ‰€å†™çš„ä¸€æ¡ä¸€æ¡çš„è·¯ç”±è®°å½•</span>
  <span class="token comment">// æ¯ä¸€æ¡è·¯ç”±è®°å½•æ˜¯ä¸€ä¸ªå¯¹è±¡ [{ path: &#39;/&#39;,name: &#39;home&#39;, component: HomeView }, {...}]</span>
  routes<span class="token operator">:</span> Readonly<span class="token operator">&lt;</span>RouteRecordRaw<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token comment">// globalOptions å°±æ˜¯ç”¨æˆ·è°ƒç”¨ createRouter æ–¹æ³•æ—¶ä¼ å…¥çš„ä¸€æ•´ä¸ªé…ç½®å¯¹è±¡ {history: ..., routes : [...]} </span>
  globalOptions<span class="token operator">:</span> PathParserOptions
<span class="token punctuation">)</span><span class="token operator">:</span> RouterMatcher
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ•´ä¸ª <code>createRouterMathcer</code> æ–¹æ³•ç©¶ç«Ÿåœ¨å¹²ä»€ä¹ˆï¼Ÿ</p><p>ä¸‹é¢æ˜¯æ•´ä¸ª <code>creatRouterMatcher</code> æ–¹æ³•çš„æ•´ä½“ç»“æ„ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouterMatcher</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> globalOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*
   * åšä¸€äº›åˆå§‹åŒ–å·¥ä½œ
   */</span>
  <span class="token operator">...</span>
  
  <span class="token comment">/*
   * å†…éƒ¨å®šä¹‰çš„æ–¹æ³•
   */</span>
  <span class="token keyword">function</span> <span class="token function">getRecordMatcher</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">addRoute</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">removeRoute</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">getRoutes</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">insertMatcher</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
  
  <span class="token comment">/*
   * éå† routes æ•°ç»„
   * åˆ©ç”¨å†…éƒ¨çš„ addRoute æ–¹æ³•æ¥æ·»åŠ è·¯ç”±
   * ä¹Ÿå°±æ˜¯ï¼Œæ•´ä¸ªè·¯ç”±çš„åˆå§‹åŒ–æ·»åŠ å·¥ä½œæ˜¯åœ¨ createRouterMatcher æ–¹æ³•é‡Œé¢å®Œæˆçš„
   */</span>
  routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>route <span class="token operator">=&gt;</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">)</span>
 
  <span class="token comment">/*
   * å‘å¤–éƒ¨è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¹Ÿå°±æ˜¯ createRouter æ–¹æ³•ä¸­çš„ matcher å¯¹è±¡    
   * æ˜¯ä¸€ä¸ªåŒ…å«äº†å†…éƒ¨æ–¹æ³•çš„å¯¹è±¡   
   */</span>                        
  <span class="token keyword">return</span> <span class="token punctuation">{</span> addRoute<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> removeRoute<span class="token punctuation">,</span> getRoutes<span class="token punctuation">,</span> getRecordMatcher <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç›®å‰é€šè¿‡é˜…è¯» <code>createRouter</code> ä»¥åŠ <code>createRouterMatcher</code> æ–¹æ³•ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå‘ç°è¿™æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„æ¨¡å¼ã€‚ä¸€ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡é‡Œé¢ä¼šåŒ…å«éƒ¨åˆ†æ–¹æ³•å†…éƒ¨æ‰€å®šä¹‰çš„æ–¹æ³•ï¼Œè¿™é‡Œå…¶å®å°±ç”¨åˆ°äº†é—­åŒ…ã€‚</p><p>æœ€ç»ˆå¤–éƒ¨ï¼ˆ <code>createRouter</code> è°ƒç”¨çš„åœ°æ–¹ï¼‰ä¼šæ‹¿åˆ°è¿™ä¸ªå¯¹è±¡ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> mathcer <span class="token operator">=</span> <span class="token punctuation">{</span> addRoute<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> removeRoute<span class="token punctuation">,</span> getRoutes<span class="token punctuation">,</span> getRecordMatcher <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ createRouter å†…éƒ¨åŒæ ·å®šä¹‰äº†è¯¸å¦‚ addRouteã€removeRoute ä»¥åŠ getRoutes ç­‰æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾ˆè‡ªç„¶çš„æƒ³åˆ°ï¼Œè¿™äº›æ–¹æ³•çš„å†…éƒ¨ï¼Œè‚¯å®šæ˜¯è°ƒç”¨äº†è¿”å›çš„ matcher å¯¹è±¡çš„åŒåæ–¹æ³•ã€‚</p><h3 id="_4-å¤„ç†å¯¼èˆªå®ˆå«" tabindex="-1"><a class="header-anchor" href="#_4-å¤„ç†å¯¼èˆªå®ˆå«"><span>4. å¤„ç†å¯¼èˆªå®ˆå«</span></a></h3><p>æ¥ä¸‹æ¥æœ‰ä¸€æ®µä»£ç æ˜¯å¤„ç†å¯¼èˆªå®ˆå«ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> beforeGuards <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useCallbacks</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationGuardWithThis<span class="token operator">&lt;</span><span class="token keyword">undefined</span><span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> beforeResolveGuards <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useCallbacks</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationGuardWithThis<span class="token operator">&lt;</span><span class="token keyword">undefined</span><span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> afterGuards <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useCallbacks</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationHookAfter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆå›å¿†ä¸€ä¸‹ï¼Œå¯¼èˆªå®ˆå«æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        
router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æºç ä¸­ï¼ŒæŒ‚åœ¨ router å¯¹è±¡çš„ beforeEach æ–¹æ³•å¯¹åº”å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>beforeEach<span class="token operator">:</span> beforeGuards<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå®é™…ä¸Šåœ¨è°ƒç”¨ beforeGuards çš„ add æ–¹æ³•ï¼Œè€Œè¿™ä¸ª beforeGuards åˆæ˜¯é€šè¿‡è°ƒç”¨ <code>useCallbacks( )</code> æ–¹æ³•æ‰€å¾—åˆ°çš„</p><p>useCallBack æ–¹æ³•ä½äº utils ç›®å½•ä¸‹é¢çš„ callback.tsï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">useCallbacks</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™é‡Œå£°æ˜äº†ä¸€ä¸ª handlers çš„åˆ—è¡¨</span>
  <span class="token keyword">let</span> handlers<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// æ¥æ”¶å®ˆå«å›è°ƒå‡½æ•°</span>
  <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ”¾å…¥åˆ° handlers åˆ—è¡¨é‡Œé¢</span>
    handlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
    <span class="token comment">// å‘å¤–éƒ¨è¿”å›ä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†æ·»åŠ åˆ° handlers åˆ—è¡¨é‡Œé¢å¯¹åº”çš„å®ˆå«å›è°ƒåˆ é™¤æ‰</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> i <span class="token operator">=</span> handlers<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> handlers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ¸…ç©º handlers åˆ—è¡¨</span>
  <span class="token keyword">function</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å‘å¤–éƒ¨è¿”å›ä¸€ä¸ªå¯¹è±¡</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    add<span class="token punctuation">,</span>
    <span class="token function-variable function">list</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> handlers<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    reset<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹æ¥å…³å¿ƒä¸€ä¸‹ add æ–¹æ³•ä¼šè¿”å›çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å°†æ·»åŠ è¿›å»çš„å®ˆå«å›è°ƒåˆ é™¤ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Ÿå®é™…ä¸Šè¿™ä¸ªæ˜¯æˆ‘ä»¬ JS ä¸­éå¸¸å¸¸è§çš„ä¸€ç§æ¨¡å¼</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> callbacks <span class="token operator">=</span> <span class="token function">useCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> remove <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ç§æ¨¡å¼éå¸¸çš„å¸¸è§ï¼Œç‰¹åˆ«æ˜¯åœ¨ JS ä¸­å¤„ç†äº‹ä»¶ç›‘å¬å™¨æˆ–è€…éœ€è¦æ¸…æ™°èµ„æºçš„æ—¶å€™ï¼Œä½ å¯ä»¥ä¸€æ¬¡æ€§çš„æä¾›æ·»åŠ å’Œå–æ¶ˆæ“ä½œï¼Œä½¿ä»£ç æ›´åŠ ä¾¿äºç®¡ç†ã€‚</p><h3 id="_5-currentrouteå£°æ˜" tabindex="-1"><a class="header-anchor" href="#_5-currentrouteå£°æ˜"><span>5. currentRouteå£°æ˜</span></a></h3><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> currentRoute <span class="token operator">=</span> <span class="token generic-function"><span class="token function">shallowRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>RouteLocationNormalizedLoaded<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™ä¸ª <code>currentRoute</code> æœ€ç»ˆæ˜¯è¦æš´éœ²ç»™å¤–éƒ¨ä½¿ç”¨çš„ã€‚</p><p>é¦–å…ˆå…³äº START_LOCATION_NORMALIZEDï¼Œè¿™æ˜¯ vue-router é‡Œé¢çš„ä¸€ä¸ªå¸¸é‡ï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token operator">:</span> RouteLocationNormalizedLoaded <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  query<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  hash<span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  fullPath<span class="token operator">:</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span>
  matched<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  meta<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªå¸¸é‡é‡Œé¢ï¼Œå°±å¯¹ pathã€nameã€paramsã€query... è¿›è¡Œäº†ä¸€ä¸ªåˆå§‹åŒ–æ“ä½œã€‚</p><p>å¦å¤–éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œé¦–å…ˆ currentRoute æ˜¯ä¸€ä¸ªå“åº”å¼çš„å˜é‡ï¼Œä½†æ˜¯è¿™é‡Œåœ¨åˆ›å»ºè¿™ä¸ªå“åº”å¼å˜é‡çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯ shallowRefï¼Œè€Œé refã€‚</p><ul><li>refï¼šåˆ›å»ºä¸€ä¸ªæ·±åº¦å“åº”å¼çš„å˜é‡</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span>count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
obj<span class="token punctuation">.</span>value<span class="token punctuation">.</span>count<span class="token operator">++</span> <span class="token comment">// å­˜åœ¨å“åº”å¼çš„ï¼Œä¾èµ–äº obj çš„ç»„ä»¶ä¼šé‡æ–°æ¸²æŸ“</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>shallowRefï¼šæ˜¯åˆ›å»ºä¸€ä¸ªä¸ä¼šè¿›è¡Œæ·±åº¦è½¬æ¢çš„å“åº”å˜é‡</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
obj<span class="token punctuation">.</span>value<span class="token punctuation">.</span>count<span class="token operator">++</span> <span class="token comment">// è¿™é‡Œä¸å­˜åœ¨å“åº”å¼ï¼Œè¿™é‡Œçš„å˜åŒ–ä¸ä¼šå¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“</span>
obj<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">{</span>count<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// è¿™æ ·å­æ‰ä¼šè§¦å‘å“åº”å¼</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› ä¸º START_LOCATION_NORMALIZED å†…éƒ¨ä¼šå­˜åœ¨ä¸€äº›æ·±å±‚æ¬¡çš„åµŒå¥—ï¼Œå¦‚æœä½¿ç”¨ ref çš„è¯ï¼Œé‚£ä¹ˆè¿™äº›æ·±å±‚æ¬¡çš„åµŒå¥—ä¹Ÿä¼šå˜ä¸ºå“åº”å¼ï¼Œä½†æ˜¯è¿™æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ shallowRefä¼šèŠ‚çº¦ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ã€‚</p><h3 id="_6-å¤„ç†-params" tabindex="-1"><a class="header-anchor" href="#_6-å¤„ç†-params"><span>6. å¤„ç† params</span></a></h3><p>æ¥ä¸‹æ¥æ˜¯å…³äº params çš„å¤„ç†ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> normalizeParams <span class="token operator">=</span> <span class="token function">applyToParams</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> paramValue <span class="token operator">=&gt;</span> <span class="token string">&#39;&#39;</span> <span class="token operator">+</span> paramValue<span class="token punctuation">)</span>
<span class="token keyword">const</span> encodeParams <span class="token operator">=</span> <span class="token function">applyToParams</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> encodeParam<span class="token punctuation">)</span>
<span class="token keyword">const</span> decodeParams <span class="token operator">=</span> <span class="token function">applyToParams</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> decode<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œå…¶å®è¿™ä¸‰è¡Œæ˜¯ä¸‰ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«è´Ÿè´£ï¼š</p><ul><li>æ ‡å‡†åŒ–å‚æ•°</li><li>ç¼–ç å‚æ•°</li><li>è§£ç å‚æ•°</li></ul><p>è¿™é‡Œä¸‰ä¸ªå‡½æ•°éƒ½ç”¨åˆ°äº† <code>applyToParams</code>ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬è‡ªç„¶ä¼šå»è¿½ applyToParams çš„æºç ï¼Œè¯¥æ–¹æ³•çš„æºç ä½äº utils/index.ts é‡Œé¢ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">applyToParams</span><span class="token punctuation">(</span>
  <span class="token comment">// å‡½æ•°</span>
  <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token comment">// è¦å¤„ç†çš„å‚æ•°</span>
  params<span class="token operator">:</span> RouteParamsRaw <span class="token operator">|</span> <span class="token keyword">undefined</span>
<span class="token punctuation">)</span><span class="token operator">:</span> RouteParams <span class="token punctuation">{</span>
  
  <span class="token comment">// åˆå§‹åŒ–äº†ä¸€ä¸ªæ–°çš„å‚æ•°å¯¹è±¡</span>
  <span class="token keyword">const</span> newParams<span class="token operator">:</span> RouteParams <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// å»éå†ä¼ é€’è¿‡æ¥çš„å‚æ•°</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‹¿åˆ°å‚æ•°æ¯ä¸€é¡¹çš„å€¼</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> params<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token comment">// å¦‚æœå€¼ä¸ºæ•°ç»„é€šè¿‡ map éå†åç”¨ fn æ¥å¤„ç†</span>
    <span class="token comment">// å¦‚æœä¸æ˜¯æ•°ç»„ï¼Œé‚£ä¹ˆç›´æ¥ç”¨ fn æ¥å¤„ç†</span>
    newParams<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token operator">?</span> value<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">fn</span><span class="token punctuation">(</span>value <span class="token keyword">as</span> Exclude<span class="token operator">&lt;</span>RouteParamValueRaw<span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newParams
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¹ˆé€šè¿‡é˜…è¯» <code>applyToParams</code> æºç ï¼Œæˆ‘ä»¬å°±çŸ¥é“ä¸Šé¢çš„ä¸‰ä¸ªæ–¹æ³•æ˜¯å¹²å˜›çš„äº†ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// å‡è®¾è¿™æ˜¯æˆ‘ä»¬çš„ params</span>
<span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;Alice&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Bob&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>

<span class="token comment">// é€šè¿‡ applyToParams æ–¹æ³•å°†æ‰€æœ‰çš„å‚æ•°è½¬ä¸ºå¤§å†™</span>
<span class="token keyword">const</span> newParams <span class="token operator">=</span> <span class="token function">applyToParams</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>v<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token comment">// { id: &#39;123&#39;, name: [&#39;ALICE&#39;, &#39;BOB&#39;] }</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸Šé¢çš„ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li><strong>æ ‡å‡†åŒ–å‚æ•°</strong>ï¼šè´Ÿè´£å°†å‚æ•°å€¼è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå‡è®¾æœ‰ä¸€ä¸ªå‚æ•°å¯¹è±¡ <code>{id: 123}</code> ï¼Œé€šè¿‡ normalizeParams æ–¹æ³•å¤„ç†ä¹‹åå°±ä¼šå˜ä¸º <code>{id: &#39;123&#39; }</code></li><li><strong>ç¼–ç å‚æ•°</strong>ï¼šè´Ÿè´£å¯¹å‚æ•°é‡Œé¢çš„ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼ˆç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ï¼‰è¿›è¡Œç¼–ç  <ul><li><code>{id: &#39;hello world&#39;}</code> é€šè¿‡ encodeParam è¿›è¡Œç¼–ç æ“ä½œï¼Œæœ€ç»ˆå¾—åˆ°çš„æ˜¯ <code>{ id: &#39;hello%20world&#39;}</code></li></ul></li><li><strong>è§£ç å‚æ•°</strong>ï¼šå°±æ˜¯ä¸Šé¢ç¼–ç çš„é€†æ“ä½œ</li></ul><h3 id="_7-å®šä¹‰å„ç§æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_7-å®šä¹‰å„ç§æ–¹æ³•"><span>7. å®šä¹‰å„ç§æ–¹æ³•</span></a></h3><p>ä¹‹åå°±æ˜¯å„ç§æ–¹æ³•çš„å®šä¹‰äº†ï¼Œè¿™äº›æ–¹æ³•æœ‰ä¸€äº›æ˜¯å†…éƒ¨æ–¹æ³•ï¼Œæœ‰ä¸€äº›æ˜¯ä¼šéšç€ router å¯¹è±¡æš´éœ²å‡ºå»ç»™å¼€å‘è€…ä½¿ç”¨çš„æ–¹æ³•ã€‚</p><p>æ•´ä½“çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œåé¢æ¶‰åŠå“ªä¸ªå†æ¥åˆ†æå“ªä¸ªã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">addRoute</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">removeRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">hasRoute</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">locationAsObject</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">checkCanceledNavigation</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">handleRedirectRecord</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>   
<span class="token keyword">function</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">checkCanceledNavigationAndReject</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">runWithContext</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">setupListeners</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">triggerError</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isReady</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">markAsReady</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">handleScroll</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-routerå¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_8-routerå¯¹è±¡"><span>8. routerå¯¹è±¡</span></a></h3><p>è¿™ä¸ª router å¯¹è±¡ï¼Œæœ€ç»ˆæ˜¯è¦æš´éœ²ç»™å¼€å‘è€…ä½¿ç”¨çš„ï¼Œé‡Œé¢æœ‰ä¸€å †æ–¹æ³•ï¼Œæ˜¯åœ¨ <code>createRouter</code> å†…éƒ¨æ‰€å®šä¹‰çš„ã€‚</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªæ–¹æ³•ä¾‹å¤–ï¼Œé‚£å°±æ˜¯ <code>install</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯å±äº router å¯¹è±¡å†…éƒ¨æ‰€å®šä¹‰çš„æ–¹æ³•</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> router<span class="token operator">:</span> Router <span class="token operator">=</span> <span class="token punctuation">{</span>
      currentRoute<span class="token punctuation">,</span>
      listening<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  
      addRoute<span class="token punctuation">,</span>
      removeRoute<span class="token punctuation">,</span>
      hasRoute<span class="token punctuation">,</span>
      getRoutes<span class="token punctuation">,</span>
      
      <span class="token comment">// ...</span>
      
      <span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ¹æ® vue å®˜æ–¹çš„è®¾è®¡ï¼Œå¦‚æœè¦æ³¨å†Œä¸€ä¸ªæ’ä»¶åˆ° vue åº”ç”¨é‡Œé¢ï¼Œéœ€è¦æœ‰è¿™ä¹ˆä¸€ä¸ª install æ–¹æ³•ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>myPlugin<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¼–å†™æ’ä»¶ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> myPlugin <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">install</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// ä¸€äº›é…ç½®</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰å…³ vue åº”ç”¨ä¸­å¦‚ä½•æ‰©å±•æ’ä»¶ï¼Œå¯ä»¥å‚é˜…ï¼š<a href="https://cn.vuejs.org/guide/reusability/plugins.html#introduction" target="_blank" rel="noopener noreferrer">https://cn.vuejs.org/guide/reusability/plugins.html#introduction<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹ router å†…éƒ¨çš„ install æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œinstall æ–¹æ³•çš„æ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token function">install</span><span class="token punctuation">(</span>app<span class="token operator">:</span> App<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span>
    app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;RouterLink&#39;</span><span class="token punctuation">,</span> RouterLink<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;RouterView&#39;</span><span class="token punctuation">,</span> RouterView<span class="token punctuation">)</span>

    app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$router <span class="token operator">=</span> router
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">,</span> <span class="token string">&#39;$route&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unref</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
   
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      isBrowser <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>started <span class="token operator">&amp;&amp;</span>
      currentRoute<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      started <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">push</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&#39;Unexpected error when starting the router:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> reactiveRoute <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> RouteLocationNormalizedLoaded
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">[</span>key <span class="token keyword">as</span> <span class="token keyword">keyof</span> RouteLocationNormalized<span class="token punctuation">]</span><span class="token punctuation">,</span>
        enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">,</span> router<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">,</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">)</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">,</span> currentRoute<span class="token punctuation">)</span>

    <span class="token keyword">const</span> unmountApp <span class="token operator">=</span> app<span class="token punctuation">.</span>unmount
    installedApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function-variable function">unmount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      installedApps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>installedApps<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pendingLocation <span class="token operator">=</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
        removeHistoryListener <span class="token operator">&amp;&amp;</span> <span class="token function">removeHistoryListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        removeHistoryListener <span class="token operator">=</span> <span class="token keyword">null</span>
        currentRoute<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
        started <span class="token operator">=</span> <span class="token boolean">false</span>
        ready <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
      <span class="token function">unmountApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€å¥ä¸€å¥è¿›è¡Œè§£æï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå˜é‡ routerï¼ŒæŠŠ this çš„å€¼èµ‹ç»™å®ƒï¼Œæ³¨æ„ this çš„æŒ‡å‘ï¼Œè¿™é‡Œçš„ this æŒ‡å‘åŒ…å« install æ–¹æ³•çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨æ‰€å®šä¹‰çš„ router å¯¹è±¡ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;RouterLink&#39;</span><span class="token punctuation">,</span> RouterLink<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;RouterView&#39;</span><span class="token punctuation">,</span> RouterView<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸¤å¥éå¸¸ç®€å•ï¼Œå°±æ˜¯åœ¨è°ƒç”¨ app.component æ–¹æ³•æ¥æ³¨å†Œç»„ä»¶åœ¨æ•´ä¸ªåº”ç”¨é‡Œé¢ã€‚æ¯ä¸€ä¸ªç»„ä»¶æœ‰ä¸€ä¸ªä¸“é—¨çš„ ts æ–‡ä»¶æ‰€å¯¹åº”ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> RouterLink <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./RouterLink&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RouterView <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./RouterView&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$router <span class="token operator">=</span> router
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™ä¸€å¥å…¶å®å°±æ˜¯å°† router å¯¹è±¡èµ‹å€¼ç»™ <code>$router</code>ï¼Œå›å¤´åœ¨å¤–éƒ¨å°±å¯ä»¥é€šè¿‡ <code>this.$router</code> è·å–åˆ°æ•´ä¸ª router å¯¹è±¡</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">,</span> <span class="token string">&#39;$route&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unref</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸º <code>app.config.globalProperties</code> è¿™ä¸ªå¯¹è±¡æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å±æ€§å«åš <code>$route</code>ï¼Œå¤–éƒ¨å°±å¯ä»¥é€šè¿‡ <code>this.$route</code> è·å–å½“å‰çš„è·¯ç”±ä½ç½®</p><p>å½“å¤–éƒ¨è·å–çš„æ—¶å€™ï¼Œå†…éƒ¨ä¼šè§¦å‘ä¸€ä¸ª getterï¼Œè¿”å› <code>currentRoute</code> å¯¹åº”çš„å€¼ã€‚</p><p>éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œä½¿ç”¨åˆ°äº† unrefï¼Œvue3 é‡Œé¢æä¾›äº†ä¸€ä¸ªåä¸º unref çš„è¾…åŠ©å‡½æ•°ï¼Œè¯¥è¾…åŠ©å‡½æ•°ç”¨äºå¤„ç†å¯èƒ½æ˜¯ ref çš„å€¼ã€‚</p><ul><li>å¦‚æœä½ çš„å‚æ•°æ˜¯ä¸€ä¸ªå“åº”å¼çš„å€¼ï¼ˆrefï¼‰ï¼Œåˆ™è¿”å›å¯¹åº”çš„å€¼</li><li>å¦‚æœä½ çš„å‚æ•°ä¸æ˜¯ä¸€ä¸ª refï¼Œé‚£ä¹ˆåˆ™è¿”å›åŸæœ¬çš„å‚æ•°</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
  isBrowser <span class="token operator">&amp;&amp;</span>
  <span class="token operator">!</span>started <span class="token operator">&amp;&amp;</span>
  currentRoute<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™é‡Œæ•´ä¸ª if å…¶å®å°±æ˜¯åœ¨åˆ¤æ–­åº”ç”¨æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨</span>
  <span class="token comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œé‚£ä¹ˆå°† started ä¿®æ”¹ä¸º trueï¼Œä¸‹ä¸€æ¬¡å°±ä¸ä¼šè¿›æ¥äº†</span>
  <span class="token comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ®µä»£ç åªä¼šåœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œ</span>
  started <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// å°† routerHistory.location è¿›è¡Œä¸€ä¸ª push æ“ä½œ</span>
  <span class="token comment">// è‡³äº routerHistory.location æ˜¯ä»€ä¹ˆï¼Ÿpush åˆæ˜¯å¦‚ä½•æ“ä½œçš„ï¼Ÿ</span>
  <span class="token comment">// åé¢å†æ¥è¿½</span>
  <span class="token function">push</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&#39;Unexpected error when starting the router:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆè¦åšè¿™ä¹ˆä¸€ä¸ªåˆ¤æ–­ï¼Ÿ</p><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„å•é¡µåº”ç”¨å°±åªæœ‰ä¸€ä¸ª vue-router å®ä¾‹ï¼Œä½†æ˜¯åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¸€ä¸ªé¡µé¢é‡Œé¢æœ‰å¤šä¸ª vue åº”ç”¨ï¼Œæ¯ä¸ª vue åº”ç”¨å¯¹åº”ä¸€ä¸ª vue-router</p><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ—¢ç„¶æœ‰å¤šä¸ª vue åº”ç”¨ï¼Œé‚£ä¹ˆä¸åŒçš„ vue åº”ç”¨å¯ä»¥éƒ½æŒ‚è½½ vue-router å®ä¾‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createRouter<span class="token punctuation">,</span> createWebHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue-router&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  history<span class="token operator">:</span> <span class="token function">createWebHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// routes...</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app1 <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App1<span class="token punctuation">)</span><span class="token punctuation">;</span>
app1<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">;</span>
app1<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app2 <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App2<span class="token punctuation">)</span><span class="token punctuation">;</span>
app2<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">;</span>
app2<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è™½ç„¶æŒ‚è½½ vue-router æŒ‚äº†å¤šæ¬¡ï¼Œä½†æ˜¯ <code>push(routerHistory.location)</code> è¿™ä¸ªæ“ä½œåªä¼šåœ¨ç¬¬ä¸€æ¬¡æŒ‚è½½ vue-router å¯¹è±¡çš„æ—¶å€™æ‰§è¡Œï¼Œå› æ­¤éœ€è¦è¿™ä¹ˆä¸€ä¸ªåˆ¤æ–­çš„ä»£ç ï¼Œåˆ¤æ–­å…¶æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨åº”ç”¨ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> reactiveRoute <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> RouteLocationNormalizedLoaded
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">[</span>key <span class="token keyword">as</span> <span class="token keyword">keyof</span> RouteLocationNormalized<span class="token punctuation">]</span><span class="token punctuation">,</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™è¾¹é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œæ³¨æ„è¿™ä¸ªå¯¹è±¡çš„ç±»å‹ä¸º <code>RouteLocationNormalizedLoaded</code> è¿™ä¸ªç±»å‹ï¼Œè¿™é‡Œå’Œ START_LOCATION_NORMALIZED è¿™ä¸ªå¸¸é‡çš„ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚</p><p>ä¸‹é¢çš„ for å¾ªç¯å°±æ˜¯åœ¨éå† START_LOCATION_NORMALIZED è¿™ä¸ªå¸¸é‡å¯¹è±¡ï¼Œå–å‡ºæ¥æ¯ä¸€ä¸ªå€¼èµ‹å€¼ç»™ reactiveRoute å¯¹è±¡ï¼Œä½†æ˜¯è¿™é‡Œä¸æ˜¯ç®€å•çš„èµ‹å€¼ï¼Œè€Œæ˜¯å°†æ¯ä¸ªå€¼å˜ä¸ºäº†ä¸€ä¸ª getter è¿”å›çš„å€¼ï¼Œgetter æ‰€è¿”å›çš„å€¼åˆå’Œ currentRoute è¿›è¡Œäº†å…³è”ã€‚ç®€å•æ¥è®²ï¼Œå°±æ˜¯ currentRoute å¯¹åº”çš„å€¼å‘ç”Ÿæ”¹å˜çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ª reactiveRoute ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// å‡è®¾ currentRoute å¯¹åº”äº†å¦‚ä¸‹çš„å€¼</span>
<span class="token keyword">let</span> currentRoute <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">&#39;/user/123&#39;</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">&#39;123&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ¥ä¸‹æ¥æ‰§è¡Œäº†æºç ä¸­å¯¹åº”éƒ¨åˆ†çš„ä»£ç ï¼š</span>
<span class="token keyword">const</span> reactiveRoute <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> RouteLocationNormalizedLoaded
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">[</span>key <span class="token keyword">as</span> <span class="token keyword">keyof</span> RouteLocationNormalized<span class="token punctuation">]</span><span class="token punctuation">,</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¹‹åä¿®æ”¹ currentRouteï¼ŒreactiveRoute ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜</span>
currentRoute<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">&#39;/user/123/profile&#39;</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">&#39;123&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token comment">// &#39;/user/123/profile&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">,</span> router<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">,</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">,</span> currentRoute<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸‰è¡Œä»£ç æ˜¯ä½¿ç”¨åˆ°äº† vue é‡Œé¢çš„ä¾èµ–æ³¨å…¥åŠŸèƒ½ï¼Œè¿™é‡Œé’ˆå¯¹è·¯ç”±å¯¹è±¡ã€å“åº”å¼çš„è·¯ç”±å€¼ã€å½“å‰è·¯ç”±è¿›è¡Œæ³¨å†Œï¼Œå›å¤´åœ¨å­ç»„ä»¶ä¸­å°±å¯ä»¥é€šè¿‡ inject æ¥è®¿é—®è¿™äº›æ³¨å†Œçš„å€¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// router/index.ts</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> router
<span class="token comment">// main.ts</span>
<span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">&quot;router&quot;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token comment">// è¿™é‡Œå°±æ˜¯åœ¨ä½¿ç”¨ provide æ¥æ³¨å†Œæ•´ä¸ª router å¯¹è±¡</span>
  	 <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&#39;router&#39;</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>                        
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨å†Œä¹‹åï¼Œå¯ä»¥åœ¨å…¶ä»–æ–‡ä»¶æˆ–è€…ç»„ä»¶é‡Œé¢é€šè¿‡ inject å¾ˆè½»æ¾çš„æ‹¿åˆ°è¿™ä¸ª router å¯¹è±¡ï¼Œ ä»è€Œé¿å…äº†å±‚å±‚ä¼ é€’å€¼ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>inject<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// é€šè¿‡ inject æ‹¿åˆ°æ‰€æ³¨å…¥çš„ router å¯¹è±¡</span>
    <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&#39;router&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®é™…ä¸Šåœ¨æºç çš„ <code>useApi.ts</code> é‡Œé¢ï¼Œæä¾›äº† <code>useRouter</code> ä»¥åŠ <code>useRoute</code> è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Router <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RouteLocationNormalizedLoaded <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">inject</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„åé¢çš„ ï¼æ˜¯å±äº ts é‡Œé¢çš„è¯­æ³•ï¼Œè¡¨ç¤ºä¸€ä¸ªä¸œè¥¿ä¸€å®šå­˜åœ¨ï¼Œç±»ä¼¼äºæ–­è¨€ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> unmountApp <span class="token operator">=</span> app<span class="token punctuation">.</span>unmount
installedApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function-variable function">unmount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  installedApps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedApps<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pendingLocation <span class="token operator">=</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
    removeHistoryListener <span class="token operator">&amp;&amp;</span> <span class="token function">removeHistoryListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    removeHistoryListener <span class="token operator">=</span> <span class="token keyword">null</span>
    currentRoute<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
    started <span class="token operator">=</span> <span class="token boolean">false</span>
    ready <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token function">unmountApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œé‡å†™äº† vue çš„ unmount å¸è½½æ–¹æ³•ï¼Œé¦–å…ˆå°† vue åŸæœ¬çš„ unmount å¸è½½æ–¹æ³•å­˜å‚¨åˆ° unmountApp é‡Œé¢ï¼ˆåé¢è¦ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œæš‚æ—¶å­˜ä¸€ä»½ï¼‰ï¼Œç„¶å app.unmount = function(){ ... } è¿™ä¸€å—ä»£ç å°±æ˜¯åœ¨é‡å†™ unmount æ–¹æ³•äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ vue åº”ç”¨è¿›è¡Œå¸è½½çš„æ—¶å€™ï¼Œä¼šå…ˆæ‰§è¡Œé‡å†™çš„æ–¹æ³•ï¼Œä½†æ˜¯ vue å¸è½½çš„æ—¶å€™ï¼Œæœ¬èº«çš„å¸è½½æ–¹æ³•ä¹Ÿæ˜¯éœ€è¦æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æœ€åæœ‰ä¸€å¥ unmountApp( ) è¡¨ç¤ºæ‰§è¡ŒåŸæœ¬ vue åº”ç”¨çš„å¸è½½æ–¹æ³•ã€‚</p><h2 id="äºŒã€history-åŸºç¡€çŸ¥è¯†" tabindex="-1"><a class="header-anchor" href="#äºŒã€history-åŸºç¡€çŸ¥è¯†"><span>äºŒã€history åŸºç¡€çŸ¥è¯†</span></a></h2><p>history æ˜¯æµè§ˆå™¨ç¯å¢ƒä¸­æ‰€æ”¯æŒçš„ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºç®¡ç†å½“å‰åˆ›å»ºæœ€è¿‘è®¿é—®è¿‡çš„ URL å†å²è®°å½•ï¼Œæ‰€æœ‰çš„ URL ä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º histroy çš„å¯¹è±¡é‡Œé¢ï¼Œå›å¤´å°±å¯ä»¥é€šè¿‡ JS è„šæœ¬è°ƒç”¨ history å¯¹è±¡çš„æ–¹æ³•ä»è€Œæ§åˆ¶æµè§ˆå™¨å‰è¿›æˆ–è€…åé€€ã€‚</p><p>ä¾‹å¦‚æ‰“å¼€æµè§ˆå™¨ï¼Œæ–°åˆ›å»ºä¸€ä¸ªæ ‡ç­¾é¡µä¼šè¯ï¼Œç„¶ååœ¨æ§åˆ¶å°è¾“å…¥ historyï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿçœ‹åˆ°è¿™ä¸ªå¯¹è±¡</p><img src="/dcblog/assets/history-BkbO5FB1.jpg" style="zoom:67%;"><ul><li><p>lengthï¼šè¡¨ç¤ºå†å²è®°å½•å †æ ˆä¸­ URL çš„æ•°é‡ï¼Œè¿™åŒ…æ‹¬äº†å½“å‰é¡µé¢ä»¥åŠä¹‹å‰è®¿é—®è¿‡çš„é¡µé¢çš„è®°å½•ã€‚éœ€è¦æ³¨æ„ï¼Œè¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªåªè¯»å±æ€§ï¼Œä¸èƒ½å¤Ÿé€šè¿‡ä»£ç å»ä¿®æ”¹çš„ã€‚</p></li><li><p>scrollRestorationï¼šå¯¹åº”çš„å€¼æœ‰ä¸¤ä¸ª</p><ul><li>autoï¼šé»˜è®¤å€¼ï¼Œå›åˆ°ä¸Šä¸€ä¸ªå†å²è®°å½•çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šå°è¯•è‡ªåŠ¨æ»šåŠ¨åˆ°ä¸Šä¸€æ¬¡æ‰€æ»šåŠ¨çš„åœ°æ–¹</li><li>manualï¼šéœ€è¦å¼€å‘è€…è‡ªå·±æ¥å¤„ç†è¿™ä¸ªæ»šåŠ¨æ¢å¤</li></ul></li><li><p>stateï¼šè¿™ä¸ªå±æ€§è¡¨ç¤ºå½“å‰å†å²è®°å½•æ¡ç›®çš„ state çŠ¶æ€å¯¹è±¡ï¼Œè¿™ä¸ªçŠ¶æ€å¯¹è±¡çš„å€¼å¯ä»¥ç”± pushState æˆ–è€… replaceState æ¥åˆ›å»ºï¼Œå¦‚æœæ²¡æœ‰é€šè¿‡è¿™ä¸¤ä¸ªæ–¹æ³•è¿›è¡Œåˆ›å»ºçš„è¯ï¼Œé‚£ä¹ˆé»˜è®¤å€¼ä¸º null</p></li></ul><p>ä¹‹æ‰€ä»¥è¦å¤ä¹ è¿™ä¸ª history å¯¹è±¡ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬çš„å•é¡µåº”ç”¨ä¸»è¦å°±æ˜¯å’Œè¿™ä¸ª history å¯¹è±¡æ‰“äº¤é“ã€‚</p><p>æ‰€è°“å•é¡µåº”ç”¨ï¼Œæœ¬è´¨ä¸Šåªæœ‰ä¸€å¼  html é¡µé¢ï¼Œè¦åšåˆ°è§†å›¾çš„å˜åŒ–ï¼Œå°±éœ€è¦éœ€è¦å‰ç«¯è·¯ç”±å»æ˜ å°„ä¸åŒçš„æ¨¡å—ã€‚</p><p>ç›®å‰æ¯”è¾ƒæµè¡Œçš„å•é¡µæ–¹å¼æœ‰ä¸¤ç§ï¼š</p><ul><li>hash æ¨¡å¼</li><li>html5 æ¨¡å¼</li></ul><h3 id="_1-hashæ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_1-hashæ¨¡å¼"><span>1. hashæ¨¡å¼</span></a></h3><p>hash æ¨¡å¼çš„åŸç†åœ¨äºä¸€ä¸ª URL çš„ hash éƒ¨åˆ†çš„å˜åŒ–ï¼Œä¸ä¼šå¼•èµ·å’ŒæœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®© hash éƒ¨åˆ†çš„å€¼å’Œè§†å›¾æ¨¡å—ç›¸å¯¹åº”ï¼š</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>example.com/#/index  // é¦–é¡µè§†å›¾
example.com/#/list   // åˆ—è¡¨è§†å›¾
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>hash å€¼çš„æ”¹å˜ä¸ä¼šå¯¼è‡´å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä½†æ˜¯ history åˆ—è¡¨æ˜¯ä¼šå‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆç”¨æˆ·å°±å¯ä»¥é€šè¿‡æµè§ˆå™¨çš„å‰è¿›å’Œåé€€å»æ§åˆ¶è§†å›¾çš„å˜åŒ–ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥é€šè¿‡ history æä¾›çš„ç›¸å…³æ–¹æ³• forwardã€backã€go æ¥è¿›è¡Œä¸åŒè§†å›¾ä¹‹é—´çš„è·³è½¬ã€‚</p><p>hash æ”¹å˜ä¹‹åï¼Œä¼šè§¦å‘ <code>hashchange</code> çš„äº‹ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¼šå»ç›‘å¬è¿™ä¸ªäº‹ä»¶ï¼Œä»è€Œæ ¹æ® hash å€¼çš„å˜åŒ–æ¥è¿›è¡Œè§†å›¾çš„åˆ‡æ¢ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;hashchange&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–æ–°çš„å“ˆå¸Œå€¼</span>
  <span class="token keyword">const</span> hash <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>

  <span class="token comment">// æ ¹æ®æ–°çš„å“ˆå¸Œå€¼æ¥æ›´æ–°é¡µé¢å†…å®¹</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&#39;#/page1&#39;</span><span class="token operator">:</span>
      <span class="token comment">// åŠ è½½ page1 çš„å†…å®¹</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&#39;#/page2&#39;</span><span class="token operator">:</span>
      <span class="token comment">// åŠ è½½ page2 çš„å†…å®¹</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment">// æ›´å¤šçš„æƒ…å†µ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-html5æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_2-html5æ¨¡å¼"><span>2. html5æ¨¡å¼</span></a></h3><p>html5æ¨¡å¼ç”¨åˆ° history ç›¸å…³çš„ API æ¥é€šè¿‡å¦å¤–ä¸€ç§æ–¹å¼å®ç°è¿™ä¸ªå•é¡µåº”ç”¨ï¼š</p><p><code>pushState</code>ï¼šç”¨äºåœ¨æµè§ˆå™¨å †æ ˆé‡Œé¢æ·»åŠ ä¸€ä¸ªæ–°çš„çŠ¶æ€ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶ 3 ä¸ªå‚æ•°</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>stateï¼šè¦æ¨å…¥çš„çŠ¶æ€å¯¹è±¡ï¼Œä¸€èˆ¬è¦æ±‚è¿™ä¸ªå¯¹è±¡å°±æ˜¯ä¸€ä¸ªçº¯ç²¹çš„æ•°æ®å¯¹è±¡ï¼ˆèƒ½å¤Ÿè¢« JSON.stringify è½¬ä¸ºå­—ç¬¦ä¸²çš„å¯¹è±¡ï¼‰</li><li>titleï¼šæ–°é¡µé¢çš„æ ‡é¢˜ï¼Œä¸€èˆ¬æµè§ˆå™¨éƒ½ä¼šå¿½ç•¥è¿™ä¸ªå‚æ•°ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼ é€’ä¸€ä¸ªç©ºå­—ç¬¦ä¸²æˆ–è€… null å³å¯</li><li>urlï¼šæ–°çš„å†å²è®°å½•çš„ url</li></ul><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨æ§åˆ¶å°è¾“å…¥å¦‚ä¸‹çš„ä»£ç ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>history.pushState<span class="token punctuation">(</span><span class="token punctuation">{</span>page:<span class="token string">&#39;page1&#39;</span><span class="token punctuation">}</span>, <span class="token string">&#39;&#39;</span>, <span class="token string">&#39;/page1&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å‡è®¾æµè§ˆå™¨çš„ url åŸæœ¬æ˜¯ www.test.com çš„è¯ï¼Œé‚£ä¹ˆæ‰§è¡Œäº†ä¸Šé¢çš„ä»£ç ä¹‹åï¼Œå°±ä¼šå˜åŒ– www.test.com/page1 ï¼Œå¹¶ä¸”ä¸ä¼šå’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œä½†æ˜¯ history å †æ ˆä¼šå‘ç”Ÿå“åº”çš„å˜åŒ–ï¼Œè¿™å°±ä¸ºæˆ‘ä»¬é€šè¿‡è¿™ç§æ–¹å¼æ¥å®ç°å•é¡µåº”ç”¨åˆ›å»ºäº†è‰¯å¥½çš„æ¡ä»¶ã€‚</p><p><code>replaceState</code>ï¼šè¯¥æ–¹æ³•å’Œ pushState æ–¹æ³•æ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯ä¸ä¼šæ¨å…¥æ–°çš„çŠ¶æ€ï¼Œè€Œæ˜¯æ›¿æ¢ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>history<span class="token punctuation">.</span><span class="token function">repalceState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">page</span><span class="token operator">:</span><span class="token string">&#39;page1&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/page1&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>popState</code>ï¼šå½“æµè§ˆå™¨é¡µé¢è¿›è¡Œå‰è¿›åé€€çš„æ—¶å€™ï¼Œä¼šè§¦å‘ popState äº‹ä»¶ï¼Œä½ å¯ä»¥ç›‘å¬è¿™ä¸ªäº‹ä»¶ï¼Œç„¶åä»äº‹ä»¶å¯¹è±¡ä¸­è·å–ä¹‹å‰ä¼ é€’ç»™ pushState æˆ–è€… repalceState çš„ state çŠ¶æ€å¯¹è±¡ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;popstate&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;state: &#39;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æˆ‘ä»¬æ¥ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä¸‹é¢æ˜¯åŸºäº html5 history api æ‰€å®ç°çš„ä¸€ä¸ªç®€å•å•é¡µåº”ç”¨ï¼š</p><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>My Single Page App<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">navigate</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> |
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/about<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">navigate</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">&#39;/about&#39;</span><span class="token punctuation">)</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>About<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token comment">// æ¸²æŸ“å‡½æ•°</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;content&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&#39;/&#39;</span><span class="token operator">:</span>
      content<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;&lt;h2&gt;Welcome to Home Page&lt;/h2&gt;&#39;</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&#39;/about&#39;</span><span class="token operator">:</span>
      content<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;&lt;h2&gt;About Page&lt;/h2&gt;&#39;</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      content<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;&lt;h2&gt;Page Not Found&lt;/h2&gt;&#39;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// å¯¼èˆªå‡½æ•°ï¼šä¿è¯ç”¨æˆ·ç‚¹å‡»é¡µé¢ä¸­çš„ a æ ‡ç­¾çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè¿›è¡Œæ­£å¸¸è·³è½¬</span>
<span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> route</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é˜»æ­¢é»˜è®¤äº‹ä»¶</span>
  history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¨å…¥æ–°çš„çŠ¶æ€</span>
  <span class="token function">render</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¸²æŸ“å¯¹åº”çš„è§†å›¾</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç›‘å¬ popstate äº‹ä»¶</span>
<span class="token comment">// ä¿è¯ç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨æœ¬èº«çš„å‰è¿›åé€€æŒ‰é’®çš„æ—¶å€™ï¼Œè§†å›¾èƒ½å¤Ÿè¿›è¡Œåˆ‡æ¢</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;popstate&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// åˆå§‹åŒ–</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;DOMContentLoaded&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
  history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>html5 æ¨¡å¼ç›¸æ¯” hash æ¨¡å¼ï¼Œå¤–è§‚ä¸Šæ›´åŠ çš„ç®€æ´ç¾è§‚ï¼Œæ²¡æœ‰ # å·äº†ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯å½“ä½ åˆ·æ–°é¡µé¢çš„æ—¶å€™ï¼Œä¼šå‘ç°æœåŠ¡å™¨ä¼šè¿”å› 404ï¼ŒåŸå› å¾ˆç®€å•ï¼Œä¾‹å¦‚å‰é¢æˆ‘ä»¬æ‰€ä¸¾çš„ä¾‹å­ï¼ŒURL å˜ä¸ºäº† www.test.com/page1 ï¼Œåˆ·æ–°çš„æ—¶å€™ä¼šå°†æ•´ä¸ªè¿™ä¸ª URL æäº¤ç»™æœåŠ¡å™¨ï¼Œä½†æ˜¯æœåŠ¡å™¨åç«¯æ— æ³•æ‰¾åˆ°å¯¹åº”çš„èµ„æºï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±éœ€è¦æˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šé¢åšä¸€äº›é…ç½®ï¼Œä½¿å¾—é’ˆå¯¹æ‰€æœ‰çš„è·¯ç”±è¯·æ±‚ï¼ŒæœåŠ¡å™¨éƒ½è¿”å›ä¸€ä»½ç›¸åŒçš„ html æ–‡ä»¶ï¼ˆé€šå¸¸å°±æ˜¯ index.htmlï¼‰ï¼Œå› æ­¤å¯¹äºè¿™ä¸ª URL www.test.com/page1 ï¼Œå“ªæ€•æœåŠ¡å™¨æ‰¾ä¸åˆ°ï¼Œä¹Ÿç»™ä½ è¿”å› index.htmlï¼Œä¹‹åå†ä½¿ç”¨å‰ç«¯è·¯ç”±æ¥æ¥ç®¡æ¸²æŸ“ç›¸åº”çš„å†…å®¹ã€‚</p><p>å…·ä½“çš„é…ç½®æ–¹æ³•å–å†³äºä½ çš„æœåŠ¡å™¨è½¯ä»¶ã€‚</p><p>ä¾‹å¦‚ä½ ä½¿ç”¨çš„ express.jsï¼Œé‚£ä¹ˆä½ å¯ä»¥æ·»åŠ å¦‚ä¸‹çš„é…ç½®ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;*&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;public&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;index.html&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ nginxï¼Œé‚£ä¹ˆä½ éœ€è¦æ·»åŠ å¦‚ä¸‹çš„é…ç½®ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>location <span class="token operator">/</span> <span class="token punctuation">{</span>
  try_files $uri <span class="token operator">/</span>index<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-location-å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_3-location-å¯¹è±¡"><span>3. location å¯¹è±¡</span></a></h3><p>location å¯¹è±¡ä¹Ÿæ˜¯æµè§ˆå™¨ç¯å¢ƒä¸­çš„ä¸€ä¸ªåŸç”Ÿå¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡å¯ä»¥è·å–åˆ°å’Œ location ç›¸å…³çš„ä¼—å¤šä¿¡æ¯ã€‚</p><p>ä¾‹å¦‚ï¼š</p><ul><li><p><em>hash</em>ï¼šå¦‚æœ <em>URL</em> ä¸­åŒ…å«æœ‰ #ï¼Œè¯¥æ–¹æ³•å°†è¿”å›è¯¥ç¬¦å·ä¹‹åçš„å†…å®¹ã€‚ ä¾‹å¦‚ï¼š<em>http://www.example.com/index.html#welcome</em> çš„ <em>hash</em> æ˜¯ #welcomeã€‚</p></li><li><p><em>host</em>ï¼šæœåŠ¡å™¨çš„åå­—ï¼Œä¾‹å¦‚ <em>www.example.com</em> ã€‚</p></li><li><p><em>hostname</em>ï¼šé€šå¸¸ç­‰äº <em>host</em>ï¼Œæœ‰æ—¶ä¼šçœç•¥å‰é¢çš„ <em>www</em>ã€‚</p></li><li><p><em>href</em>ï¼šå½“å‰é¡µé¢è½½å…¥çš„å®Œæ•´ <em>URL</em>ã€‚</p></li><li><p><em>pathname</em>ï¼š<em>URL</em> ä¸­ä¸»æœºåä¹‹åçš„éƒ¨åˆ†ã€‚ ä¾‹å¦‚ï¼š<em>http://www.example.com/html/js/jsbasic/2010/0319/88.html</em> çš„ <em>pathname</em> æ˜¯ <em>/html/js/jsbasic/2010/0319/88.html</em>ã€‚</p></li><li><p><em>port</em>ï¼š<em>URL</em> ä¸­å£°æ˜çš„è¯·æ±‚ç«¯å£ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¤§å¤šæ•° <em>URL</em> æ²¡æœ‰ç«¯å£ä¿¡æ¯ï¼ˆé»˜è®¤ä¸º <em>80</em> ç«¯å£ï¼‰ï¼Œæ‰€ä»¥è¯¥å±æ€§é€šå¸¸æ˜¯ç©ºç™½çš„ã€‚ ä¾‹å¦‚ <em>http://www.example.com:8080/index.html</em> è¿™æ ·çš„ <em>URL</em> çš„ <em>port</em> å±æ€§ä¸º &#39;<em>8080</em>&#39;ã€‚</p></li><li><p><em>protocol</em>ï¼š<em>URL</em> ä¸­ä½¿ç”¨çš„åè®®ï¼Œå³åŒæ–œæ  // ä¹‹å‰çš„éƒ¨åˆ†ã€‚ ä¾‹å¦‚ <em>http://www.example.com</em> ä¸­çš„ <em>protocol</em> å±æ€§ç­‰äº &#39;http:&#39;ï¼Œ<em>ftp://www.example.com</em> çš„ <em>protocol</em> å±æ€§ç­‰äº&#39;ftp:&#39;ã€‚</p></li><li><p><em>search</em>ï¼šæ‰§è¡Œ <em>GET</em> è¯·æ±‚çš„ <em>URL</em> ä¸­çš„é—®å· ? åçš„éƒ¨åˆ†ï¼Œåˆç§°æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚ ä¾‹å¦‚ <em>http://www.example.com/search.html?tern=sunchis</em> ä¸­ <em>search</em> å±æ€§ä¸º <em>?term=sunchis</em>ã€‚</p></li></ul><p>é™¤äº†ä¸Šé¢çš„å±æ€§ä»¥å¤–ï¼Œè¯¥å¯¹è±¡è¿˜æ”¯æŒä¸€äº›æ–¹æ³•ï¼š</p><ul><li>assign æ–¹æ³•ï¼šè½½å…¥ä¸€ä¸ªæ–°çš„æ–‡æ¡£</li><li>reloadæ–¹æ³•ï¼šé‡æ–°è½½å…¥å½“å‰æ–‡æ¡£</li><li>replace æ–¹æ³•ï¼šç”¨æ–°çš„æ–‡æ¡£æ›¿æ¢å½“å‰æ–‡æ¡£</li></ul><p>ä¸è¿‡å¯¹äºå¼€å‘å•é¡µåº”ç”¨æ¥è®²ï¼Œä¸Šé¢çš„æ–¹æ³•ä¸€èˆ¬ä¸ä¼šç”¨åˆ°ï¼Œå› ä¸ºå•é¡µåº”ç”¨çš„ç‰¹ç‚¹å°±æ˜¯ä¸€ä¸ªé¡µé¢ï¼Œæ²¡æœ‰åˆ·æ–°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è‡³æ­¤è‡³ç»ˆéƒ½æ˜¯ä¸€ä¸ªæ–‡æ¡£ï¼Œä¸ä¼šè½½å…¥æ–°çš„æ–‡æ¡£ã€‚</p><h2 id="ä¸‰ã€createwebhistoryç»“æ„æ‹†è§£" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€createwebhistoryç»“æ„æ‹†è§£"><span>ä¸‰ã€createWebHistoryç»“æ„æ‹†è§£</span></a></h2><p>é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯æ¥å›å¿†ä¸€ä¸‹ <code>createWebHistory</code> æ–¹æ³•æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  history<span class="token operator">:</span> <span class="token function">createWebHistroy</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">BASE_URL</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ•´ä¸ª <code>createWebHistroy(import.meta.env.BASE_URL)</code> æ–¹æ³•è°ƒç”¨ä¹‹åï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åæŠŠè¿™ä¸ªå¯¹è±¡ä½œä¸ºä¼ å…¥åˆ° createRouter é‡Œé¢çš„é…ç½®å¯¹è±¡çš„ history å¯¹åº”çš„é”®å€¼ã€‚</p><p><code>createWebHistroy</code> æ–¹æ³•æ‰€å¯¹åº”çš„æºç ä½äº history/html5.ts æ–‡ä»¶é‡Œé¢ã€‚</p><h3 id="_1-æ•´ä½“ç»“æ„åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_1-æ•´ä½“ç»“æ„åˆ†æ"><span>1. æ•´ä½“ç»“æ„åˆ†æ</span></a></h3><p>æ•´ä½“æ–¹æ³•çš„ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createWebHistory</span><span class="token punctuation">(</span>base<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> RouterHistory <span class="token punctuation">{</span>
  <span class="token comment">// 1. é’ˆå¯¹ base åšä¸€ä¸ªæ ‡å‡†åŒ–æ“ä½œ</span>
  <span class="token comment">// å‰åŠ /ï¼Œåå»æ‰/</span>
  base <span class="token operator">=</span> <span class="token function">normalizeBase</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>

  <span class="token comment">// 2. åˆ›å»ºå¯¼èˆªå¯¹è±¡</span>
  <span class="token comment">// {</span>
  <span class="token comment">//   location: currentLocation,</span>
  <span class="token comment">//   state: historyState,</span>
  <span class="token comment">//   push,</span>
  <span class="token comment">//   replace</span>
  <span class="token comment">// }</span>
  <span class="token keyword">const</span> historyNavigation <span class="token operator">=</span> <span class="token function">useHistoryStateNavigation</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
  
  <span class="token comment">// 3. åˆ›å»ºç›‘å¬å¯¹è±¡</span>
  <span class="token keyword">const</span> historyListeners <span class="token operator">=</span> <span class="token function">useHistoryListeners</span><span class="token punctuation">(</span>
    base<span class="token punctuation">,</span>
    historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
    historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">,</span>
    historyNavigation<span class="token punctuation">.</span>replace
  <span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> triggerListeners <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>triggerListeners<span class="token punctuation">)</span> historyListeners<span class="token punctuation">.</span><span class="token function">pauseListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 4. å°†ä¸Šé¢çš„å¯¹è±¡åˆå¹¶åˆ° routerHistory çš„å¯¹è±¡é‡Œé¢</span>
  <span class="token keyword">const</span> routerHistory<span class="token operator">:</span> RouterHistory <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// it&#39;s overridden right after</span>
      location<span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
      base<span class="token punctuation">,</span>
      go<span class="token punctuation">,</span>
      createHref<span class="token operator">:</span> <span class="token function">createHref</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    historyNavigation<span class="token punctuation">,</span>
    historyListeners
  <span class="token punctuation">)</span>

  <span class="token comment">// 5. ä¸º routerHistory æ·»åŠ  location å’Œ state å±æ€§</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">&#39;location&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">&#39;state&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 6. è¿”å› routerHistory</span>
  <span class="token keyword">return</span> routerHistory
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå¯é€‰çš„ base å‚æ•°ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ <code>import.meta.env.BASE_URL</code></p><ul><li><code>import.meta</code>ï¼šè¡¨ç¤º JS çš„å…ƒç´ è¡Œï¼Œå®ƒåŒ…å«äº†å’Œå½“å‰ JS æ¨¡å—ç›¸å…³çš„å…ƒæ•°æ®ã€‚åœ¨ vite é¡¹ç›®ä¸­ï¼Œ<code>import.meta.env</code> ç”¨äºè®¿é—®é¡¹ç›®çš„ç¯å¢ƒå˜é‡</li><li><code>BASE_URL</code>ï¼šè¿™æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„ç¯å¢ƒå˜é‡ï¼Œå®ƒé€šå¸¸ç”¨äºè¡¨ç¤ºä¸€ä¸ªåº”ç”¨ç¨‹åºçš„åŸºç¡€ URLã€‚</li></ul><p>ä¾‹å¦‚ä½ å°†æ•´ä¸ªåº”ç”¨éƒ¨ç½²åˆ° /app/ ç›®å½•ä¸‹é¢ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥å°† BASE_URL è®¾ç½®ä¸º /app/ï¼Œä¹‹åå½“ä½ åˆ›å»ºä¸€ä¸ª /home çš„è·¯ç”±çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿™ä¸ªè·¯ç”±çš„å®Œæ•´è·¯å¾„å°±ä¼šè¢«æ˜ å°„ä¸º /app/homeã€‚</p><p>å…³äºè¿™ä¸ª BASE_URL é»˜è®¤æ˜¯å¯ä»¥åœ¨ vite.config.ts é‡Œé¢è¿›è¡Œé…ç½®çš„ï¼Œå¦‚æœä½ æ²¡æœ‰é…ç½®ï¼Œé‚£ä¹ˆé»˜è®¤ä¼šæ˜¯ /</p><p>å¯ä»¥å‚è€ƒ vite å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://cn.vitejs.dev/config/shared-options.html#base" target="_blank" rel="noopener noreferrer">https://cn.vitejs.dev/config/shared-options.html#base<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_2-æ ‡å‡†åŒ–base" tabindex="-1"><a class="header-anchor" href="#_2-æ ‡å‡†åŒ–base"><span>2. æ ‡å‡†åŒ–base</span></a></h3><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>base <span class="token operator">=</span> <span class="token function">normalizeBase</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>normalizeBase</code> æ–¹æ³•ç©¶ç«Ÿåœ¨åšä»€ä¹ˆï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">normalizeBase</span><span class="token punctuation">(</span>base<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­æ˜¯å¦ä¼ å…¥äº† base</span>
  <span class="token comment">// å¦‚æœæ²¡æœ‰ä¼ é€’ï¼Œç»™ä¸€ä¸ªåˆå§‹å€¼ /</span>
  <span class="token comment">// å¦å¤–è¿˜å¯¹æµè§ˆå™¨ç¯å¢ƒä¸‹çš„ base æ ‡ç­¾è¿›è¡Œäº†åˆ¤æ–­</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// respect &lt;base&gt; tag</span>
      <span class="token keyword">const</span> baseEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;base&#39;</span><span class="token punctuation">)</span>
      base <span class="token operator">=</span> <span class="token punctuation">(</span>baseEl <span class="token operator">&amp;&amp;</span> baseEl<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;href&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;/&#39;</span>
      <span class="token comment">// strip full URL origin</span>
      base <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\w+:\/\/[^\/]+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      base <span class="token operator">=</span> <span class="token string">&#39;/&#39;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œç»å†ä¸Šé¢çš„ ifï¼Œbase ä¸€å®šæ˜¯æœ‰å€¼çš„</span>

  <span class="token comment">// å¦‚æœ base çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ä¸º / æˆ–è€… # </span>
  <span class="token comment">// é‚£ä¹ˆå°±æ‰‹åŠ¨çš„æ·»åŠ ä¸€ä¸ª /</span>
  <span class="token comment">// ä¾‹å¦‚ï¼Œä¼ å…¥çš„ base ä¸º app/ï¼Œç»è¿‡ä¸‹é¢è¿™è¡Œä»£ç å¤„ç†ä¹‹åï¼Œå°±ä¼šå˜ä¸º /app/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>base<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">&amp;&amp;</span> base<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span> base <span class="token operator">=</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> base

  <span class="token comment">// åˆä½¿ç”¨ removeTrailingSlash æ–¹æ³•å¯¹ base åšäº†æŸç§å¤„ç†</span>
  <span class="token comment">// ç„¶åè¿”å›å¤„ç†å€¼</span>
  <span class="token comment">// /app/ --&gt; removeTrailingSlash(base) --&gt; /app</span>
  <span class="token keyword">return</span> <span class="token function">removeTrailingSlash</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>removeTrailingSlash</code> æ–¹æ³•å¯¹åº”çš„æºç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token constant">TRAILING_SLASH_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/$</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">removeTrailingSlash</span> <span class="token operator">=</span> <span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">TRAILING_SLASH_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å°† <code>normalizeBase</code> æ–¹æ³•ææ¸…æ¥šäº†ï¼Œå°±æ˜¯å¯¹ä¼ å…¥çš„ base åšä¸€ä¸ªæ ‡å‡†åŒ–çš„åˆå§‹æ“ä½œï¼Œä¸ç®¡ä½ ä¼ å…¥çš„æ˜¯ä»€ä¹ˆç‰›é¬¼è›‡ç¥ï¼Œè¿™è¾¹éƒ½è¿›è¡Œä¸€ä¸ªç»Ÿä¸€å¤„ç†ï¼Œæ‹¿åˆ°ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒç»Ÿä¸€çš„å€¼ã€‚</p><h3 id="_3-åç»­æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#_3-åç»­æ“ä½œ"><span>3. åç»­æ“ä½œ</span></a></h3><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> historyNavigation <span class="token operator">=</span> <span class="token function">useHistoryStateNavigation</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
<span class="token keyword">const</span> historyListeners <span class="token operator">=</span> <span class="token function">useHistoryListeners</span><span class="token punctuation">(</span>
  base<span class="token punctuation">,</span>
  historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
  historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">,</span>
  historyNavigation<span class="token punctuation">.</span>replace
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç åˆ†åˆ«è°ƒç”¨äº† <code>useHistoryStateNavigation</code> å’Œ <code>useHistoryListeners</code> æ–¹æ³•ï¼Œè¿™ä¸ªå¯ä»¥è¯´æ˜¯æ•´ä¸ª createWebHistory æ–¹æ³•çš„æ ¸å¿ƒï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>historyNavigation</code> å’Œ <code>historyListeners</code> æ˜¯ä¸¤ä¸ªå¯¹è±¡ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡åˆ†åˆ«ä¼šè¢«åˆå¹¶åˆ° <code>routerHistory</code> å¯¹è±¡é‡Œé¢ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> routerHistory<span class="token operator">:</span> RouterHistory <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// è¦†ç›–å³è¾¹å¯¹è±¡çš„éƒ¨åˆ†å±æ€§</span>
    location<span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
    base<span class="token punctuation">,</span>
    go<span class="token punctuation">,</span>
    createHref<span class="token operator">:</span> <span class="token function">createHref</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  historyNavigation<span class="token punctuation">,</span>
  historyListeners
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆå¹¶åæœ€ç»ˆå¯¼å‡ºçš„å°±æ˜¯è¿™ä¸ª routerHistory å¯¹è±¡ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">return</span> routerHistory
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…³äº <code>useHistoryStateNavigation</code> å’Œ <code>useHistoryListeners</code> æ–¹æ³•å…·ä½“åšäº†ä»€ä¹ˆï¼Œæˆ‘ä»¬æ”¾åœ¨åé¢æ¥è§£æï¼Œè¿™é‡Œå…ˆæ”¾ä¸€æ”¾ã€‚</p><p>æ³¨æ„ä¸Šé¢åœ¨è¿›è¡Œå¯¹è±¡åˆå¹¶çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªå¯¹è±¡é‡Œé¢æœ‰ä¸€ä¸ª go æ–¹æ³•ï¼Œå¯¹åº”çš„æºç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> triggerListeners <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>triggerListeners<span class="token punctuation">)</span> historyListeners<span class="token punctuation">.</span><span class="token function">pauseListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„æºç ï¼Œç¬¬ä¸€å¥ if æˆ‘ä»¬å¯ä»¥å…ˆæ”¾ä¸€æ”¾ï¼Œæˆ‘ä»¬çœ‹ç¬¬äºŒå¥ï¼Œæˆ‘ä»¬å‘ç°ç¬¬äºŒå¥å…¶å®å°±æ˜¯åœ¨è°ƒç”¨åŸç”Ÿçš„ history å¯¹åº”çš„ go æ–¹æ³•ï¼Œç„¶åæŠŠ delta ä¼ è¿›å»ã€‚å¹¶ä¸”è¿™ä¸ªæ–¹æ³•ä¼šè¢«åˆå¹¶åˆ° routerHistory ä¸Šé¢éšç€ routerHistory æš´éœ²å‡ºå»ã€‚</p><p>æˆ‘ä»¬å›å¿†ä¸€ä¸‹ï¼ŒcreateRouter æ‰€åˆ›å»ºçš„ router å¯¹è±¡å°±æœ‰ go æ–¹æ³•</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">go</span> <span class="token operator">=</span> <span class="token punctuation">(</span>delta<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> routerHistory<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span>
<span class="token keyword">const</span> router<span class="token operator">:</span> Router <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  go<span class="token punctuation">,</span>
  <span class="token function-variable function">back</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">forward</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">&#39;location&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">&#39;state&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åä»ç„¶æ˜¯ç»™è¦æš´éœ²å‡ºå»çš„ routerHistory æ·»åŠ å±æ€§ï¼Œè¿™é‡Œæ·»åŠ äº†ä¸¤ä¸ªå±æ€§ï¼š</p><ul><li>locationï¼šå¯¹åº”çš„å€¼ä¸º historyNavigation.location.value</li><li>stateï¼šå¯¹åº”çš„å€¼æˆ‘å“¦ historyNavigation.state.value</li></ul><h2 id="å››ã€usehistorystatenavigationç»“æ„è§£æ" tabindex="-1"><a class="header-anchor" href="#å››ã€usehistorystatenavigationç»“æ„è§£æ"><span>å››ã€useHistoryStateNavigationç»“æ„è§£æ</span></a></h2><h3 id="_1-æ•´ä½“ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-æ•´ä½“ç»“æ„"><span>1. æ•´ä½“ç»“æ„</span></a></h3><p>è¯¥æ–¹æ³•çš„æ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">useHistoryStateNavigation</span><span class="token punctuation">(</span>base<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä»åŸç”Ÿçš„ window å¯¹è±¡é‡Œé¢è§£æ„å‡º history å’Œ location</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> history<span class="token punctuation">,</span> location <span class="token punctuation">}</span> <span class="token operator">=</span> window

  <span class="token comment">// ä¸¤ä¸ªç§æœ‰çš„å˜é‡ï¼Œä¹‹åä¼šéšç€è¿”å›çš„å¯¹è±¡æš´éœ²ç»™å¤–éƒ¨</span>
  <span class="token comment">// è¿™é‡Œå®é™…ä¸Šä¹Ÿæ˜¯ç”¨åˆ°äº†é—­åŒ…</span>
  <span class="token keyword">const</span> currentLocation<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>HistoryLocation<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>value<span class="token operator">:</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token comment">// åˆ›å»ºä¸€ä¸ªèˆå»baseçš„urlçš„å­—ç¬¦ä¸²</span>
  <span class="token keyword">const</span> historyState<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>StateEntry<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> history<span class="token punctuation">.</span>state <span class="token punctuation">}</span>
 
  <span class="token comment">// çœ‹ä½ æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥é¡µé¢ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œé‚£ä¹ˆæ­¤æ—¶æ˜¯æ²¡æœ‰ä»»ä½•çŠ¶æ€çš„</span>
  <span class="token comment">// é‚£ä¹ˆæˆ‘ä»¬å°±ç»´æŠ¤ä¸€ä¸ªåˆå§‹åŒ–çš„çŠ¶æ€</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>historyState<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å†…éƒ¨æ–¹æ³•ï¼Œä¾›å†…éƒ¨ä½¿ç”¨</span>
  <span class="token keyword">function</span> <span class="token function">changeLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æš´éœ²ç»™å¤–éƒ¨çš„æ–¹æ³•</span>
  <span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> HistoryState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æš´éœ²ç»™å¤–éƒ¨çš„æ–¹æ³•</span>
  <span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span>to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> HistoryState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    location<span class="token operator">:</span> currentLocation<span class="token punctuation">,</span>
    state<span class="token operator">:</span> historyState<span class="token punctuation">,</span>

    push<span class="token punctuation">,</span>
    replace<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥æ–¹æ³•ä¼šä¸ºæˆ‘ä»¬è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸»è¦æ˜¯è´Ÿè´£è·¯ç”±çš„å†å²çŠ¶æ€å’Œå½“å‰ä½ç½®çš„ç®¡ç†ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ª base ä½œä¸ºå‚æ•°ï¼Œè¿”å›çš„å¯¹è±¡ä¼šåŒ…å« stateã€locationã€push å’Œ repalce è¿™ä¹ˆå‡ ä¸ªæˆå‘˜ã€‚</p><h3 id="_2-ä»£ç æ‹†è§£" tabindex="-1"><a class="header-anchor" href="#_2-ä»£ç æ‹†è§£"><span>2. ä»£ç æ‹†è§£</span></a></h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥åˆ°ä»£ç æ‹†è§£ç¯èŠ‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> currentLocation<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>HistoryLocation<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>value<span class="token operator">:</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>currentLocation</code> æœ€ç»ˆå¯¹åº”çš„å€¼ä¸ºä¸€ä¸ªå¯¹è±¡ <code>{ value: xxx }</code> ï¼Œxxx è¿™ä¸ªå€¼æ¥æºäº <code>createCurrentLocation(base, location)</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¼šå»çœ‹è¿™ä¸ªæ–¹æ³•çš„æºç ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// æ¥æ”¶ä¸¤ä¸ªå‚æ•°</span>
<span class="token comment">// 1. base</span>
<span class="token comment">// 2. location æ³¨æ„è¿™ä¸ª location æ˜¯åŸç”Ÿçš„ location å¯¹è±¡</span>
<span class="token keyword">function</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>
  base<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  location<span class="token operator">:</span> Location
<span class="token punctuation">)</span><span class="token operator">:</span> HistoryLocation <span class="token punctuation">{</span>
  <span class="token comment">// ä»åŸç”Ÿlocaton å¯¹è±¡é‡Œé¢è§£æ„å‡ºæ¥ä¸€äº›å€¼</span>
  <span class="token comment">// å‡è®¾æˆ‘ä»¬çš„å®Œæ•´çš„ url ä¸º https://example.com/home/page?query=searchterm#section1</span>
  <span class="token comment">// pathname ---&gt; /home/page</span>
  <span class="token comment">// search ---&gt; ?query=searchterm</span>
  <span class="token comment">// hash ---&gt; #section1</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname<span class="token punctuation">,</span> search<span class="token punctuation">,</span> hash <span class="token punctuation">}</span> <span class="token operator">=</span> location
  
  <span class="token comment">// æ•´ä¸ªè¿™ä¸€æ®µæ˜¯åœ¨æŸ¥çœ‹ base é‡Œé¢æ˜¯å¦æœ‰ #</span>
  <span class="token comment">// å¦‚æœæœ‰ï¼Œé‚£ä¹ˆä¼šè¿›å…¥åˆ° if é‡Œé¢è¿›è¡Œå•ç‹¬çš„å¤„ç†</span>
  <span class="token keyword">const</span> hashPos <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hashPos <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> slicePos <span class="token operator">=</span> hash<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashPos<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">?</span> base<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashPos<span class="token punctuation">)</span><span class="token punctuation">.</span>length
      <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token keyword">let</span> pathFromHash <span class="token operator">=</span> hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>slicePos<span class="token punctuation">)</span>
    <span class="token comment">// prepend the starting slash to hash so the url starts with /#</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathFromHash<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> pathFromHash <span class="token operator">=</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> pathFromHash
    <span class="token keyword">return</span> <span class="token function">stripBase</span><span class="token punctuation">(</span>pathFromHash<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">stripBase</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> base<span class="token punctuation">)</span>
  <span class="token keyword">return</span> path <span class="token operator">+</span> search <span class="token operator">+</span> hash
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œæˆ‘ä»¬å…ˆå¿½ç•¥ ifï¼Œé‚£ä¹ˆè¿™æ®µä»£ç å°±å˜ä¸ºäº†ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// æ¥æ”¶ä¸¤ä¸ªå‚æ•°</span>
<span class="token comment">// 1. base</span>
<span class="token comment">// 2. location æ³¨æ„è¿™ä¸ª location æ˜¯åŸç”Ÿçš„ location å¯¹è±¡</span>
<span class="token keyword">function</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>base<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>location<span class="token operator">:</span> Location<span class="token punctuation">)</span><span class="token operator">:</span> HistoryLocation <span class="token punctuation">{</span>
  <span class="token comment">// ä»åŸç”Ÿlocaton å¯¹è±¡é‡Œé¢è§£æ„å‡ºæ¥ä¸€äº›å€¼</span>
  <span class="token comment">// å‡è®¾æˆ‘ä»¬çš„å®Œæ•´çš„ url ä¸º https://example.com/home/page?query=searchterm#section1</span>
  <span class="token comment">// pathname ---&gt; /home/page</span>
  <span class="token comment">// search ---&gt; ?query=searchterm</span>
  <span class="token comment">// hash ---&gt; #section1</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname<span class="token punctuation">,</span> search<span class="token punctuation">,</span> hash <span class="token punctuation">}</span> <span class="token operator">=</span> location
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">stripBase</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> base<span class="token punctuation">)</span>
  <span class="token keyword">return</span> path <span class="token operator">+</span> search <span class="token operator">+</span> hash
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥è°ƒç”¨äº† stripBase å¯¹ pathname è¿›è¡Œä¸€ä¸ªå¤„ç†ï¼Œè¿”å› <code>path + search + hash</code> çš„æ‹¼æ¥ï¼Œè¿”å›çš„å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œè€Œè¿™é‡Œæ ‡æ³¨çš„æ˜¯ HistoryLocationï¼Œè¿™ä¸ª HistoryLocation å…¶å®å°±æ˜¯ string çš„ä¸€ä¸ªåˆ«å</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">HistoryLocation</span> <span class="token operator">=</span> <span class="token builtin">string</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…³é”®ç‚¹å°±æ¥åˆ° stripBaseï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">stripBase</span><span class="token punctuation">(</span>pathname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> base<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token comment">// no base or base is not found at the beginning</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base <span class="token operator">||</span> <span class="token operator">!</span>pathname<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pathname
  <span class="token keyword">return</span> pathname<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;/&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥æ–¹æ³•ä¸»è¦è´Ÿè´£ä»ä¸€ä¸ªè·¯å¾„ä¸­ç§»é™¤ base éƒ¨åˆ†çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token string">&quot;/app&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pathname <span class="token operator">=</span> <span class="token string">&quot;/app/home&quot;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">stripBase</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /home</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ stripBase æ–¹æ³•ææ¸…æ¥šåï¼Œé‚£ä¹ˆ <code>createCurrentLocation</code> è¿™ä¸ªæ–¹æ³•ä¹Ÿå°±æ¸…æ™°ï¼Œå‡è®¾ base ä¸º / ï¼Œlocation å¯¹åº”çš„ url å‡è®¾ä¸º https://example.com/home/page?query=searchterm#section1 é‚£ä¹ˆæœ€ç»ˆé€šè¿‡ createCurrentLocation å¤„ç†ï¼Œå¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  pathname<span class="token operator">:</span> <span class="token string">&quot;/home/page&quot;</span><span class="token punctuation">,</span>
  search<span class="token operator">:</span> <span class="token string">&quot;?query=searchterm&quot;</span><span class="token punctuation">,</span>
  hash<span class="token operator">:</span> <span class="token string">&quot;#section1&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// home/page?query=searchterm#section1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡è®¾ base ä¸º /homeï¼Œlocation å¯¹åº”çš„ url ä¸å˜ï¼Œé‚£ä¹ˆæœ€ç»ˆé€šè¿‡ createCurrentLocation å¤„ç†ï¼Œå¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span><span class="token string">&quot;/home&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  pathname<span class="token operator">:</span> <span class="token string">&quot;/home/page&quot;</span><span class="token punctuation">,</span>
  search<span class="token operator">:</span> <span class="token string">&quot;?query=searchterm&quot;</span><span class="token punctuation">,</span>
  hash<span class="token operator">:</span> <span class="token string">&quot;#section1&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /page?query=searchterm#section1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°çš„çŸ¥é“è¿™ä¸ª createCurrentLocation æ˜¯åœ¨å¹²å˜›äº†ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ª url çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿™ä¸ª url å­—ç¬¦ä¸²æ˜¯å»é™¤äº† base éƒ¨åˆ†ã€‚</p><p>è‡³äº if é‡Œé¢çš„é€»è¾‘ï¼Œä¸»è¦æ˜¯æ£€æŸ¥ base é‡Œé¢æ˜¯å¦æœ‰ #ï¼Œ å¦‚æœæœ‰ # ï¼Œ é‚£ä¹ˆéœ€è¦å•ç‹¬å¤„ç†ï¼Œä¾‹å¦‚ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// å½“ä½ çš„ base é‡Œé¢è¿˜æœ‰ # çš„æ—¶å€™</span>
<span class="token comment">// é‚£ä¹ˆä» location é‡Œé¢è§£æ„å‡ºæ¥çš„ hash éƒ¨åˆ†çš„å€¼æ˜¯æœ‰é—®é¢˜</span>
<span class="token comment">// çœŸæ­£ hash éƒ¨åˆ†çš„å€¼åº”è¯¥ä¸º #section1ï¼Œä½†æ˜¯å¾—åˆ°çš„å´æ˜¯ #/home/page#section1</span>
<span class="token comment">// æ‰€ä»¥éœ€è¦æŠŠè¿™ä¸€å—è¿›è¡Œä¸€ä¸ªå¤„ç†</span>
<span class="token comment">// ç»è¿‡ if é‡Œé¢çš„å¤„ç†ï¼Œæœ€ç»ˆå¾—åˆ°çš„å­—ç¬¦ä¸²ä¸º /page#section1</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span><span class="token string">&quot;#/home&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  hash<span class="token operator">:</span> <span class="token string">&quot;#/home/page#section1&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /page#section1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ <code>createCurrentLocation</code> è°ƒç”¨çš„æ—¶å€™ï¼Œ <mark>ä¼ å…¥ base å’Œ url å¯¹åº”çš„ locationï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å§‹ç»ˆæ˜¯å»é™¤äº† base éƒ¨åˆ†çš„ã€‚</mark></p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> historyState<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>StateEntry<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> history<span class="token punctuation">.</span>state <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™å¥ä»£ç è¡¨ç¤ºä»åŸç”Ÿ history å¯¹è±¡ä¸Šé¢å»æ‹¿ state çŠ¶æ€å¯¹è±¡ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç¨å¾®ç ”ç©¶ä¸€ä¸‹ç±»å‹çš„å€¼ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// ValueContainer å°±æ˜¯ä¸€ä¸ªæ³›å‹å¯¹è±¡ï¼ŒT æ˜¯ä»€ä¹ˆç±»å‹å–å†³äºä½ ä¼ å…¥çš„å€¼</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ValueContainer<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// StateEntry</span>
<span class="token keyword">interface</span> <span class="token class-name">StateEntry</span> <span class="token keyword">extends</span> <span class="token class-name">HistoryState</span> <span class="token punctuation">{</span>
  back<span class="token operator">:</span> HistoryLocation <span class="token operator">|</span> <span class="token keyword">null</span>
  current<span class="token operator">:</span> HistoryLocation
  forward<span class="token operator">:</span> HistoryLocation <span class="token operator">|</span> <span class="token keyword">null</span>
  position<span class="token operator">:</span> <span class="token builtin">number</span>
  replaced<span class="token operator">:</span> <span class="token builtin">boolean</span>
  scroll<span class="token operator">:</span> _ScrollPositionNormalized <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// HistoryState</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">HistoryState</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">]</span><span class="token operator">:</span> HistoryStateValue
  <span class="token punctuation">[</span>x<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> HistoryStateValue
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// HistoryStateValue</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">HistoryStateValue</span> <span class="token operator">=</span>
  <span class="token operator">|</span> <span class="token builtin">string</span>
  <span class="token operator">|</span> <span class="token builtin">number</span>
  <span class="token operator">|</span> <span class="token builtin">boolean</span>
  <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token operator">|</span> <span class="token keyword">undefined</span>
  <span class="token operator">|</span> HistoryState
  <span class="token operator">|</span> HistoryStateArray
<span class="token comment">// HistoryStateArray</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">HistoryStateArray</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">Array</span><span class="token operator">&lt;</span>HistoryStateValue<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// åˆ¤æ–­ä½ æ˜¯å¦æ˜¯é¦–æ¬¡æ¸²æŸ“ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æ˜¯æ²¡æœ‰ historyState çŠ¶æ€å¯¹è±¡çš„</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>historyState<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">changeLocation</span><span class="token punctuation">(</span>
      currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        back<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        current<span class="token operator">:</span> currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        forward<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token comment">// the length is off by one, we need to decrease it</span>
        position<span class="token operator">:</span> history<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
        replaced<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// don&#39;t add a scroll as the user may have an anchor, and we want</span>
        <span class="token comment">// scrollBehavior to be triggered without a saved position</span>
        scroll<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token boolean">true</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// å†…éƒ¨æ–¹æ³•</span>
<span class="token keyword">function</span> <span class="token function">changeLocation</span><span class="token punctuation">(</span>to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span>state<span class="token operator">:</span> StateEntry<span class="token punctuation">,</span>replace<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...   </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>if ä¸»è¦æ˜¯åˆ¤æ–­æ˜¯å¦æ˜¯é¦–æ¬¡åˆ·æ–°ï¼Œå¦‚æœ historyState.value å€¼ä¸º nullï¼Œé‚£ä¹ˆè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨ <code>changeLocation</code> æ–¹æ³•ã€‚</p><p><code>changeLocation</code> æ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>toï¼šç¬¬ä¸€ä¸ªå‚æ•°åˆšæ‰æ‰€å¾—åˆ°çš„ä¸åŒ…å« base çš„ url åé¢çš„å­—ç¬¦ä¸²</li><li>stateï¼šç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡çš„ç±»å‹ä¸º stateEntry</li><li>repalceï¼šè¡¨ç¤ºæ˜¯å¦æ˜¯æ›¿æ¢æ¨¡å¼ï¼Œè¿™é‡Œé»˜è®¤ä¼ é€’äº† trueï¼Œè¡¨ç¤ºä½¿ç”¨æ›¿æ¢æ¨¡å¼</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦çœ‹ä¸€ä¸‹ <code>changeLocation</code> å†…éƒ¨åœ¨åšä»€ä¹ˆï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">changeLocation</span><span class="token punctuation">(</span>
  to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span>
  state<span class="token operator">:</span> StateEntry<span class="token punctuation">,</span>
  replace<span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­ base é‡Œé¢æ˜¯å¦åŒ…å« # å·</span>
  <span class="token keyword">const</span> hashIndex <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// æ‹¼æ¥ urlï¼Œæ‰€æ‹¼æ¥çš„è¿™ä¸ª url å›å¤´ä¼šä½œä¸º pushState æˆ–è€… repalceState æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span>
    hashIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
      <span class="token operator">?</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>host <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;base&#39;</span><span class="token punctuation">)</span>
          <span class="token operator">?</span> base
          <span class="token operator">:</span> base<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> to
      <span class="token operator">:</span> <span class="token function">createBaseLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> base <span class="token operator">+</span> to
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ ¹æ® replace æ˜¯ true è¿˜æ˜¯ false</span>
    <span class="token comment">// æ¥å†³å®šè°ƒç”¨ replaceState è¿˜æ˜¯ pushState</span>
    <span class="token comment">// ä¸ç®¡è°ƒç”¨å“ªä¸ªï¼Œæµè§ˆå™¨æœç´¢æ çš„ url éƒ½ä¼šå‘ç”Ÿå˜åŒ–</span>
    history<span class="token punctuation">[</span>replace <span class="token operator">?</span> <span class="token string">&#39;replaceState&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;pushState&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token comment">// å°† state çŠ¶æ€å¯¹è±¡çš„å€¼èµ‹å€¼ç»™ historyState.valueï¼Œä»è€Œè¿›è¡Œä¸€ä¸ªåˆå§‹åŒ–</span>
    historyState<span class="token punctuation">.</span>value <span class="token operator">=</span> state
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&#39;Error with push/replace State&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Force the navigation, this also resets the call count</span>
    location<span class="token punctuation">[</span>replace <span class="token operator">?</span> <span class="token string">&#39;replace&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;assign&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ï¼Œæ•´ä¸ª changeLocation æ–¹æ³•æ‰€åšçš„äº‹æƒ…ï¼Œå°±éå¸¸æ¸…æ™°äº†ï¼Œè¯¥æ–¹æ³•å°±æ˜¯æ ¹æ®ä¼ å…¥çš„ toï¼ˆurl å­—ç¬¦ä¸²ï¼Œä¸åŒ…å« base éƒ¨åˆ†ï¼‰ï¼Œä»¥åŠ state çŠ¶æ€å€¼ï¼Œæ¥ <mark>è°ƒç”¨åŸç”Ÿ history å¯¹è±¡çš„ pushState æˆ–è€… repalceState æ–¹æ³•æ¥ä¿®æ”¹ location</mark> ï¼Œæ‰§è¡Œè¯¥è¡Œä»£ç åï¼Œé¡µé¢æœç´¢æ çš„ url å°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¸”è¿™ä¸€æ¬¡å˜åŒ–æ˜¯ä¼šè¢«è®°å½•åˆ° history å †æ ˆé‡Œé¢çš„ã€‚</p><p>æœ€åè¿˜å‰©ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œrepalce ä»¥åŠ pushï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯ä¼šéšç€è¿”å›çš„å¯¹è±¡æš´éœ²å‡ºå»çš„ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ repalce æ–¹æ³•ï¼Œå¯¹åº”æºç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> HistoryState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºäº†ä¸€ä¸ªçŠ¶æ€å¯¹è±¡</span>
  <span class="token keyword">const</span> state<span class="token operator">:</span> StateEntry <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    history<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
    <span class="token function">buildState</span><span class="token punctuation">(</span>
      historyState<span class="token punctuation">.</span>value<span class="token punctuation">.</span>back<span class="token punctuation">,</span>
      <span class="token comment">// keep back and forward entries but override current position</span>
      to<span class="token punctuation">,</span>
      historyState<span class="token punctuation">.</span>value<span class="token punctuation">.</span>forward<span class="token punctuation">,</span>
      <span class="token boolean">true</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> position<span class="token operator">:</span> historyState<span class="token punctuation">.</span>value<span class="token punctuation">.</span>position <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// è°ƒç”¨ä¸Šé¢å†™å¥½çš„ changeLocation å»æ”¹å˜ location</span>
  <span class="token function">changeLocation</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token comment">// æ›´æ–°æ–°çš„ currentLocation å¯¹åº”çš„å€¼</span>
  currentLocation<span class="token punctuation">.</span>value <span class="token operator">=</span> to
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ª <code>buildState</code> æ–¹æ³•ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">buildState</span><span class="token punctuation">(</span>
  back<span class="token operator">:</span> HistoryLocation <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  current<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span>
  forward<span class="token operator">:</span> HistoryLocation <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  replaced<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  computeScroll<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token operator">:</span> StateEntry <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    back<span class="token punctuation">,</span>
    current<span class="token punctuation">,</span>
    forward<span class="token punctuation">,</span>
    replaced<span class="token punctuation">,</span>
    position<span class="token operator">:</span> window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    scroll<span class="token operator">:</span> computeScroll <span class="token operator">?</span> <span class="token function">computeScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ª buildState æ–¹æ³•å°±æ˜¯æ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ ‡å‡†çš„ StateEntry çš„çŠ¶æ€å¯¹è±¡</p><p>ä¸‹é¢æ˜¯ push æ–¹æ³•ç›¸å…³çš„æºç ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span>to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> HistoryState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// åˆ›å»ºä¸€ä¸ªçŠ¶æ€å¯¹è±¡</span>
  <span class="token keyword">const</span> currentState <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    historyState<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    history<span class="token punctuation">.</span>state <span class="token keyword">as</span> Partial<span class="token operator">&lt;</span>StateEntry<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      forward<span class="token operator">:</span> to<span class="token punctuation">,</span>
      scroll<span class="token operator">:</span> <span class="token function">computeScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// é€šè¿‡åˆšæ‰åˆ›å»ºçš„çŠ¶æ€å¯¹è±¡è°ƒç”¨ changeLocation æ¥ä¿®æ”¹ location</span>
  <span class="token function">changeLocation</span><span class="token punctuation">(</span>currentState<span class="token punctuation">.</span>current<span class="token punctuation">,</span> currentState<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

  <span class="token comment">// ç”±åˆ›å»ºä¸€ä¸ªçŠ¶æ€å¯¹è±¡</span>
  <span class="token keyword">const</span> state<span class="token operator">:</span> StateEntry <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">buildState</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span> to<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> position<span class="token operator">:</span> currentState<span class="token punctuation">.</span>position <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data
  <span class="token punctuation">)</span>

  <span class="token comment">// å†æ¬¡è°ƒç”¨ changeLocation æ–¹æ³•æ¥ä¿®æ”¹ location</span>
  <span class="token function">changeLocation</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token comment">// æ›´æ–°æ–°çš„ currentLocation å¯¹åº”çš„å€¼</span>
  currentLocation<span class="token punctuation">.</span>value <span class="token operator">=</span> to
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>é¢è¯•é¢˜ï¼šä¸ºä»€ä¹ˆuseHistoryStateNavigation å†…éƒ¨çš„ push æ–¹æ³•è¦è°ƒç”¨ä¸¤æ¬¡ changeLocation ï¼Ÿ</p></blockquote><p>ä»”ç»†è§‚å¯Ÿä¸¤æ¬¡æ‰€è°ƒç”¨çš„ <code>changeLocation</code>ï¼Œä½ ä¼šå‘ç°ä¸€ä¸ªäº‹æƒ…ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼Œç¬¬ä¸€æ¬¡æ˜¯ trueï¼Œç¬¬äºŒæ¬¡æ˜¯ falseï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€æ¬¡æ˜¯é€šè¿‡ repalce çš„æ–¹å¼ï¼ˆhistory.repalceStateï¼‰æ¥ä¿®æ”¹çš„ locationï¼Œç¬¬äºŒæ¬¡æ˜¯é€šè¿‡ push çš„æ–¹å¼ï¼ˆhistory.pushStateï¼‰æ¥ä¿®æ”¹çš„ lcoationã€‚</p><p>å› æ­¤è¿™ä¸ªé—®é¢˜å°±å˜æˆäº†ä¸ºä»€ä¹ˆåœ¨ push ä¹‹å‰è¦å…ˆ replace ä¸€æ¬¡ ï¼Ÿ</p><p>ä¸¤æ¬¡ <code>changeLocation</code> è°ƒç”¨çš„ç›®å½•æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">changeLocation</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> state<span class="token punctuation">,</span> replace</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>history<span class="token punctuation">[</span>replace <span class="token operator">?</span> <span class="token string">&#39;replaceState&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;pushState&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> to<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// å‡è®¾åœ¨è°ƒç”¨ push å‡½æ•°ä¹‹å‰ï¼Œæµè§ˆå™¨çš„å†å²è®°å½•æ ˆåªæœ‰ä¸€ä¸ªæ¡ç›®ï¼Œè¿™ä¸ªæ¡ç›®è¡¨ç¤ºçš„è·¯ç”±æ˜¯ &#39;/home&#39;ã€‚</span>
<span class="token comment">// [ &#39;/home&#39; ]  &lt;-- å½“å‰å†å²è®°å½•æ¡ç›®</span>
<span class="token comment">// å†å²è®°å½•æ¡ç›®çš„çŠ¶æ€å¯¹è±¡å¦‚ä¸‹</span>
<span class="token comment">// {</span>
<span class="token comment">//  current: &#39;/home&#39;,</span>
<span class="token comment">//  back: null,</span>
<span class="token comment">//  forward: null,</span>
<span class="token comment">//  // ...å…¶ä»–å±æ€§</span>
<span class="token comment">// }</span>
<span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentState <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">current</span><span class="token operator">:</span> <span class="token string">&#39;/home&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">forward</span><span class="token operator">:</span> to<span class="token punctuation">,</span>
    <span class="token literal-property property">scroll</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ç¬¬ä¸€æ¬¡æ„å»ºçŠ¶æ€å¯¹è±¡å’Œè°ƒç”¨ changeLocation,æ›´æ”¹forward</span>
  <span class="token comment">// [ &#39;/home&#39; ]  &lt;-- å½“å‰å†å²è®°å½•æ¡ç›®</span>
  <span class="token comment">// å†å²è®°å½•æ¡ç›®çš„çŠ¶æ€å¯¹è±¡å¦‚ä¸‹</span>
  <span class="token comment">// {</span>
  <span class="token comment">//  current: &#39;/home&#39;,</span>
  <span class="token comment">//  back: null,</span>
  <span class="token comment">//  forward: /about,</span>
  <span class="token comment">//  // ...å…¶ä»–å±æ€§</span>
  <span class="token comment">// }</span>
  <span class="token function">changeLocation</span><span class="token punctuation">(</span>currentState<span class="token punctuation">.</span>current<span class="token punctuation">,</span> currentState<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

  <span class="token comment">// ç¬¬äºŒæ¬¡æ„å»ºçŠ¶æ€å¯¹è±¡å’Œè°ƒç”¨ changeLocationï¼Œè·³è½¬è·¯ç”±</span>
  <span class="token comment">// [ &#39;/home&#39;, &#39;/about&#39; ]  &lt;-- å½“å‰å†å²è®°å½•æ¡ç›®</span>
  <span class="token comment">// å†å²è®°å½•æ¡ç›®çš„çŠ¶æ€å¯¹è±¡å¦‚ä¸‹</span>
  <span class="token comment">// {</span>
  <span class="token comment">//  current: &#39;/about&#39;,</span>
  <span class="token comment">//  back: /home,</span>
  <span class="token comment">//  forward: null,</span>
  <span class="token comment">//  // ...å…¶ä»–å±æ€§</span>
  <span class="token comment">// }</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">current</span><span class="token operator">:</span> to<span class="token punctuation">,</span>
    <span class="token literal-property property">back</span><span class="token operator">:</span> currentState<span class="token punctuation">.</span>current<span class="token punctuation">,</span>
    <span class="token literal-property property">forward</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token function">changeLocation</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;/about&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ changeLocation æ–¹æ³•å’Œ push æ–¹æ³•ã€‚push æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‚æ•° toï¼Œè¿™ä¸ªå‚æ•°è¡¨ç¤ºæˆ‘ä»¬å¸Œæœ›è·³è½¬åˆ°çš„æ–°çš„è·¯ç”±ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ä¸º /aboutã€‚</p><p>å½“æˆ‘ä»¬è°ƒç”¨ <code>push(&#39;/about&#39;)</code>æ—¶ï¼Œé¦–å…ˆä¼šæ„å»ºç¬¬ä¸€ä¸ªçŠ¶æ€å¯¹è±¡ currentStateï¼Œç„¶åè°ƒç”¨ changeLocation æ¥è¿›è¡Œ location çš„ä¿®æ”¹ï¼Œæ³¨æ„è¿™ä¸€æ¬¡ä¿®æ”¹ä½¿ç”¨çš„æ˜¯ repalce çš„æ¨¡å¼ï¼Œä¹‹æ‰€ä»¥æœ‰è¿™ä¹ˆä¸€æ¬¡ä¿®æ”¹ï¼Œå°±ä¸ºäº†è®©å½“å‰çš„è¿™ä¸ªçŠ¶æ€å¯¹è±¡çš„ forwardå¯¹åº”æ­£ç¡®çš„ç›®æ ‡è·¯ç”±ã€‚</p><p>ä¹‹åç¬¬äºŒæ¬¡æ„å»ºçŠ¶æ€å¯¹è±¡ stateï¼Œå†æ¬¡è°ƒç”¨ changeLocation æ¥ä¿®æ”¹ locationï¼Œè¿™ä¸€æ¬¡ä½¿ç”¨çš„å°±æ˜¯ push æ¨¡å¼ï¼Œæ­£å¸¸çš„æ¨å…¥æ–°çš„çŠ¶æ€å¯¹è±¡å³å¯ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¹‹æ‰€ä»¥ç¬¬ä¸€æ¬¡è°ƒç”¨ changeLocationï¼Œå°±æ˜¯ä¸ºäº†è®©ç”¨æˆ·ä» /about å›åˆ° /home ä¹‹åï¼Œforward é‡Œé¢æœ‰å€¼ï¼Œèƒ½å¤Ÿå†æ¬¡ç‚¹å‡»å‰è¿›æŒ‰é’®å›åˆ° /aboutã€‚æ¢ä¸ªè¯´æ³•ï¼Œä½ ä»æ–°è·¯ç”±ï¼ˆ2ï¼‰å›é€€åˆ°å½“å‰è·¯ç”±ï¼ˆ1ï¼‰çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ forward æ–¹æ³•é‡æ–°å‰è¿›åˆ°æ–°è·¯ç”±ï¼ˆå›åˆ°2ï¼‰ã€‚</p><h2 id="äº”ã€usehistorylistenersç»“æ„è§£æ" tabindex="-1"><a class="header-anchor" href="#äº”ã€usehistorylistenersç»“æ„è§£æ"><span>äº”ã€useHistoryListenersç»“æ„è§£æ</span></a></h2><p>é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„ä¸€ä¸ªè°ƒç”¨ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> historyListeners <span class="token operator">=</span> <span class="token function">useHistoryListeners</span><span class="token punctuation">(</span>
  base<span class="token punctuation">,</span>
  historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
  historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">,</span>
  historyNavigation<span class="token punctuation">.</span>replace
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è°ƒç”¨è¿™ä¸ª useHistoryListeners ä¼ å…¥äº† 4 ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ baseï¼Œè€Œåé¢ä¸‰ä¸ªå‚æ•°åˆ™æ˜¯ä½¿ç”¨çš„æ˜¯ä¸Šä¸€å¥ä»£ç æ‰€å¾—åˆ°çš„ historyNavigation è¿™ä¸ªå¯¹è±¡ä¸Šé¢çš„å±æ€§ã€‚</p><h3 id="_1-æ•´ä½“ç»“æ„-1" tabindex="-1"><a class="header-anchor" href="#_1-æ•´ä½“ç»“æ„-1"><span>1. æ•´ä½“ç»“æ„</span></a></h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ useHistoryListeners è¿™ä¸ªæ–¹æ³•å†…éƒ¨çš„æ•´ä½“ç»“æ„ï¼Œæºç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">useHistoryListeners</span><span class="token punctuation">(</span>
  base<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  historyState<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>StateEntry<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  currentLocation<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>HistoryLocation<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  replace<span class="token operator">:</span> RouterHistory<span class="token punctuation">[</span><span class="token string">&#39;replace&#39;</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸‰ä¸ªç§æœ‰å˜é‡</span>
  <span class="token keyword">let</span> listeners<span class="token operator">:</span> NavigationCallback<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> teardowns<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> pauseState<span class="token operator">:</span> HistoryLocation <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token comment">// popstate äº‹ä»¶çš„äº‹ä»¶å¤„ç†å‡½æ•°</span>
  <span class="token keyword">const</span> popStateHandler<span class="token operator">:</span> <span class="token function-variable function">PopStateListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>state<span class="token operator">:</span> StateEntry <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ä¼šæš´éœ²ç»™å¤–éƒ¨çš„æ–¹æ³•</span>
  <span class="token keyword">function</span> <span class="token function">pauseListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ä¼šæš´éœ²ç»™å¤–éƒ¨çš„æ–¹æ³•</span>
  <span class="token keyword">function</span> <span class="token function">listen</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> NavigationCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ˜¯ beforeunload äº‹ä»¶çš„äº‹ä»¶å¤„ç†å‡½æ•°</span>
  <span class="token keyword">function</span> <span class="token function">beforeUnloadListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ä¼šæš´éœ²ç»™å¤–éƒ¨çš„æ–¹æ³•</span>
  <span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ç»‘å®šäº†ä¸¤ä¸ªäº‹ä»¶ï¼špopstate å’Œ beforeunload</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;popstate&#39;</span><span class="token punctuation">,</span> popStateHandler<span class="token punctuation">)</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">,</span> beforeUnloadListener<span class="token punctuation">,</span> <span class="token punctuation">{</span>passive<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    pauseListeners<span class="token punctuation">,</span>
    listen<span class="token punctuation">,</span>
    destroy<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä½“çš„ç»“æ„ä¹Ÿæ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼ŒåŸºæœ¬ä¸Šå’Œå‰é¢æ˜¯ç±»ä¼¼çš„ï¼Œè°ƒç”¨æ–¹æ³•åï¼Œä¼šå‘å¤–éƒ¨è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸Šé¢ä¼šæœ‰æ–¹æ³•å†…éƒ¨çš„ä¸€äº›æ–°å®šä¹‰çš„æ–¹æ³•ã€‚</p><h3 id="_2-ä»£ç æ‹†è§£-1" tabindex="-1"><a class="header-anchor" href="#_2-ä»£ç æ‹†è§£-1"><span>2. ä»£ç æ‹†è§£</span></a></h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜æ˜¯æ¥é€è¡Œè¿›è¡Œæ‹†è§£ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">let</span> listeners<span class="token operator">:</span> NavigationCallback<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> teardowns<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> pauseState<span class="token operator">:</span> HistoryLocation <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œçš„ä¸‰å¥ä»£ç ï¼Œå°±æ˜¯å£°æ˜äº†ä¸‰ä¸ªå˜é‡ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹è¿™ä¸‰ä¸ªå˜é‡çš„ç±»å‹</p><ul><li>listenersï¼šå¯¹åº”çš„æ˜¯ NavigationCallback ç±»å‹çš„æ•°ç»„</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// NavigationCallback ç±»å‹ä¿¡æ¯å¦‚ä¸‹ï¼Œæ³¨æ„è¿™æ˜¯ä¸€ä¸ªå‡½æ•°</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">NavigationCallback</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span>
    to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span>
    from<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span>
    information<span class="token operator">:</span> NavigationInformation
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>listeners é€šå¸¸ä¼šå­˜æ”¾ä¸€ç»„åƒ NavigationCallback è¿™æ ·çš„å›è°ƒå‡½æ•°ï¼Œè¿™äº›å›è°ƒå‡½æ•°ä¼šåœ¨è·¯ç”±å‘ç”Ÿå˜åŒ–çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œè¿™äº›å›è°ƒå‡½æ•°å¾€å¾€æ˜¯ä¸ºäº†æ‰§è¡Œä¸€äº›å‰¯ä½œç”¨ã€‚</p><ul><li>teardownsï¼šä»ç„¶æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œé¢çš„æ¯ä¸€é¡¹çš„å…ƒç´ ç±»å‹ä¸º ( ) =&gt; voidï¼Œè¿™ä¸ªç±»å‹ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¡¨ç¤ºä¸€ä¸ªç©ºå‡½æ•°ã€‚</li><li>pauseStateï¼šè¿™ä¸ªå˜é‡æ‰€å¯¹åº”çš„ç±»å‹å°±æ˜¯ HistoryLocationï¼ˆstring çš„åˆ«åç±»å‹ï¼‰æˆ–è€… null</li></ul><p>æ¥ä¸‹æ¥ <em>popStateHandler</em> ä½œä¸º popstate äº‹ä»¶å¤„ç†æ–¹æ³•ï¼Œé‡Œé¢å…·ä½“çš„é€»è¾‘æˆ‘ä»¬å…ˆæ”¾ä¸€æ”¾ï¼Œå…ˆçœ‹åé¢çš„ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// è¯¥æ–¹æ³•æ˜¯æœ€ç»ˆä¼šæš´éœ²ç»™å¤–éƒ¨çš„æ–¹æ³•</span>
<span class="token keyword">function</span> <span class="token function">pauseListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pauseState <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>value
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> currentLocation<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>HistoryLocation<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>value<span class="token operator">:</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™ä¸ªæ–¹æ³•æœ¬èº«æ‰€åšçš„äº‹æƒ…ä¹Ÿéå¸¸çš„ç®€å•ï¼Œå°±æ˜¯å°†å½“å‰çš„è·¯ç”±å€¼ï¼ˆå»é™¤äº† base éƒ¨åˆ†çš„ url åé¢éƒ¨åˆ†ï¼‰èµ‹å€¼ç»™ pauseStateã€‚</p><p>åœ¨ vue-router ä¸­ï¼ŒpauseState ä¸»è¦æ˜¯ç”¨æ¥æš‚åœæˆ–è€…åœæ­¢å¤„ç†è·¯ç”±äº‹ä»¶çš„å˜é‡ï¼ˆç›¸å½“äºæ˜¯ä¸€ä¸ªå¼€å…³ï¼‰ï¼Œå› æ­¤è¿™ä¸ªå‡½æ•°å®é™…ä¸Šæ˜¯æ ‡è®°äº†ä¸€ä¸ªæš‚åœç‚¹ï¼Œè¿™ä¸ªæš‚åœç‚¹è¡¨ç¤ºåœ¨å½“å‰çš„è¿™ä¸ªè·¯ç”±ä½ç½®çš„æ—¶å€™ï¼Œæš‚åœå¤„ç†è·¯ç”±äº‹ä»¶ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">listen</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> NavigationCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// set up the listener and prepare teardown callbacks</span>
  listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">teardown</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> listeners<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  teardowns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>teardown<span class="token punctuation">)</span>
  <span class="token keyword">return</span> teardown
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ª NavigationCallback ç±»å‹çš„ callback å›è°ƒå‡½æ•°ï¼Œé¦–å…ˆå°†è¿™ä¸ª callback æ¨å…¥åˆ° listeners æ•°ç»„é‡Œé¢ã€‚</p><p>ç„¶åå£°æ˜äº†ä¸€ä¸ªåä¸º teardown çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä» listeners æ•°ç»„é‡Œé¢å‡†ç¡®çš„åˆ é™¤åˆšæ‰æ‰€æ¨å…¥çš„ callbackï¼Œè¿™ä¸ªå’Œæˆ‘ä»¬ä¹‹å‰è§£æçš„ useCallbacks æ˜¯ç›¸åŒçš„å¥—è·¯ã€‚</p><p>ä¸è¿‡è¿™ä¸ª teardown åˆ é™¤æ–¹æ³•è¿˜è¢«æ¨å…¥åˆ°äº† teardownsï¼Œå¹¶ä¸”å‘å¤–éƒ¨è¿”å› teardown åˆ é™¤å‡½æ•°ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">beforeUnloadListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> history <span class="token punctuation">}</span> <span class="token operator">=</span> window
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>history<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token keyword">return</span>
  history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>
    <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> history<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> scroll<span class="token operator">:</span> <span class="token function">computeScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&#39;&#39;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// ç»‘å®š beforeunload äº‹ä»¶</span>
<span class="token comment">// è¯¥äº‹ä»¶ä¼šåœ¨é¡µé¢å¸è½½ä¹‹å‰è§¦å‘</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">,</span> beforeUnloadListener<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  passive<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>beforeUnloadListener</code> æ˜¯é¡µé¢å¸è½½ä¹‹å‰ä¼šåšçš„äº‹æƒ…ã€‚é¦–å…ˆä¼šæ£€æŸ¥ <code>window.history.state</code> æ˜¯å¦å­˜åœ¨ã€‚</p><ul><li>å¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦åšä»»ä½•çš„å¤„ç†</li><li>æ²¡æœ‰è¿›å…¥åˆ°ä¸Šé¢çš„ ifï¼Œè¯´æ˜ state çŠ¶æ€å¯¹è±¡æ˜¯å­˜åœ¨ï¼Œé‚£ä¹ˆå°±åœ¨é¡µé¢å¸è½½ä¹‹å‰ä¿å­˜å½“å‰çš„æ»šåŠ¨ä½ç½®ï¼Œç„¶ååœ¨ç”¨æˆ·ä¸‹ä¸€æ¬¡è®¿é—®è¿™ä¸ªé¡µé¢çš„æ—¶å€™ï¼Œå¯ä»¥æ¢å¤åˆ°ä¹‹å‰çš„æ»šåŠ¨ä½ç½®ã€‚</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> teardown <span class="token keyword">of</span> teardowns<span class="token punctuation">)</span> <span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  teardowns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;popstate&#39;</span><span class="token punctuation">,</span> popStateHandler<span class="token punctuation">)</span>
  window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">,</span> beforeUnloadListener<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>destroy é¡¾åæ€ä¹‰æ˜¯é”€æ¯çš„æ„æ€ï¼Œå› æ­¤è¿™é‡Œæ˜¯ä¸€ä¸ªé”€æ¯å‡½æ•°ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæš´éœ²ç»™å¤–éƒ¨ï¼Œä¾›å¤–éƒ¨æ¥ä½¿ç”¨ã€‚</p><p>è¯¥æ–¹æ³•é¦–å…ˆä¼šéå† teardowns æ•°ç»„ï¼Œæ‹¿åˆ°æ¯ä¸€ä¸ª teardown å¹¶æ‰§è¡Œï¼Œæ‰§è¡Œæ¯ä¸€ä¸ª teardown åˆ é™¤æ–¹æ³•æ„å‘³ç€å°†ä¹‹å‰æ¨å…¥åˆ° listeners é‡Œé¢çš„ callback åˆ é™¤æ‰äº†ã€‚ä¹‹åå°† teardowns æ•°ç»„ä¹Ÿæ¸…ç©ºï¼Œæœ€åå¸è½½äº‹ä»¶ã€‚</p><p>ä¸Šé¢çš„ä»£ç çš„æ„æ€æå®šä¹‹åï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <code>popStateHandler</code>ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> popStateHandler<span class="token operator">:</span> <span class="token function-variable function">PopStateListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>state<span class="token operator">:</span> StateEntry <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> to <span class="token operator">=</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> location<span class="token punctuation">)</span>
  <span class="token keyword">const</span> from<span class="token operator">:</span> HistoryLocation <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>value
  <span class="token keyword">const</span> fromState<span class="token operator">:</span> StateEntry <span class="token operator">=</span> historyState<span class="token punctuation">.</span>value
  <span class="token keyword">let</span> delta <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentLocation<span class="token punctuation">.</span>value <span class="token operator">=</span> to
    historyState<span class="token punctuation">.</span>value <span class="token operator">=</span> state

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pauseState <span class="token operator">&amp;&amp;</span> pauseState <span class="token operator">===</span> from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pauseState <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    delta <span class="token operator">=</span> fromState <span class="token operator">?</span> state<span class="token punctuation">.</span>position <span class="token operator">-</span> fromState<span class="token punctuation">.</span>position <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>listener <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">listener</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      delta<span class="token punctuation">,</span>
      type<span class="token operator">:</span> NavigationType<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>
      direction<span class="token operator">:</span> delta
        <span class="token operator">?</span> delta <span class="token operator">&gt;</span> <span class="token number">0</span>
          <span class="token operator">?</span> NavigationDirection<span class="token punctuation">.</span>forward
          <span class="token operator">:</span> NavigationDirection<span class="token punctuation">.</span>back
        <span class="token operator">:</span> NavigationDirection<span class="token punctuation">.</span><span class="token builtin">unknown</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;popstate&#39;</span><span class="token punctuation">,</span> popStateHandler<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯æ¬¡ popstate äº‹ä»¶è§¦å‘ï¼Œåˆ™ä¼šæ‰§è¡Œ <code>popStateHandler</code>ã€‚</p><ul><li>popstate äº‹ä»¶ä»€ä¹ˆæ—¶å€™è§¦å‘ï¼Ÿ</li><li>è§¦å‘ä¹‹åä¼šæ‰§è¡Œ popStateHandlerï¼Œé‚£ä¹ˆè¿™ä¸ª popStateHandler ç©¶ç«Ÿåšäº†ä»€ä¹ˆï¼Ÿ</li></ul><blockquote><p>popstate äº‹ä»¶ä»€ä¹ˆæ—¶å€™è§¦å‘ï¼Ÿ</p></blockquote><p>popstate ä¼šåœ¨å½“å‰çš„å†å²æ¡ç›®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™è§¦å‘ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨çš„å‰è¿›æˆ–è€…åé€€ï¼Œæˆ–è€…ä½¿ç”¨ history ç›¸å…³çš„ backã€forwardã€go ä¹‹ç±»çš„æ–¹æ³•çš„æ—¶å€™ï¼Œpopstate å°±ä¼šè§¦å‘ã€‚ï¼ˆè€Œé€šè¿‡æ ‡ç­¾ã€pushStateæˆ–replaceStateå¹¶ä¸ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ï¼‰</p><p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä¿¡æ¯ï¼Œå½“ popstate äº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼Œäº‹ä»¶å¤„ç†å‡½æ•°ä¼šæ”¶åˆ°ä¸€ä¸ªäº‹ä»¶å¯¹è±¡ï¼Œè¿™ä¸ªäº‹ä»¶å¯¹è±¡ä¸Šé¢ä¼šæœ‰ä¸€ä¸ª state å±æ€§ï¼Œè¿™ä¸ª state å±æ€§å°±æ˜¯ä¹‹å‰åœ¨ä½¿ç”¨ history.pushState æˆ–è€… history.replaceState æ–¹æ³•æ—¶æ‰€æ¨å…¥çš„çŠ¶æ€ã€‚</p><p>ä¸‹é¢æ˜¯å…³äº popstate çš„ä¸€ä¸ªç®€å•ä½¿ç”¨æ¡ˆä¾‹ï¼š</p><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>page1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>page2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>page3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./temp.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;popstate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span>
    <span class="token string">&quot;location: &quot;</span> <span class="token operator">+</span> document<span class="token punctuation">.</span>location <span class="token operator">+</span> <span class="token string">&quot;, state: &quot;</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

btn1<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">page</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;title 1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/page=1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

btn2<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">page</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;title 2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/page=2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

btn3<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">page</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;title 3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/page=3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>è§¦å‘ä¹‹åä¼šæ‰§è¡Œ popStateHandlerï¼Œé‚£ä¹ˆè¿™ä¸ª popStateHandler ç©¶ç«Ÿåšäº†ä»€ä¹ˆï¼Ÿ</p></blockquote><p>ç›®å‰ popstate äº‹ä»¶è§¦å‘ä¹‹åï¼Œå¯¹åº”çš„å›è°ƒæ˜¯ popStateHandlerï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹è¿™ä¸ª popStateHandler ç©¶ç«Ÿåœ¨åšä»€ä¹ˆï¼Ÿ</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> to <span class="token operator">=</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> location<span class="token punctuation">)</span>
<span class="token keyword">const</span> from<span class="token operator">:</span> HistoryLocation <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>value
<span class="token keyword">const</span> fromState<span class="token operator">:</span> StateEntry <span class="token operator">=</span> historyState<span class="token punctuation">.</span>value
<span class="token keyword">let</span> delta <span class="token operator">=</span> <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œå®šä¹‰äº† 4 ä¸ªå˜é‡ï¼š</p><ul><li>toï¼šé€šè¿‡å‘ createCurrentLocation ä¼ å…¥ base ä»¥åŠ locationï¼Œæ‹¿åˆ°ä¸€ä¸ªæœ€æ–°çš„ urlï¼Œæ³¨æ„è¿™ä¸ª url æ˜¯å»é™¤äº† base éƒ¨åˆ†</li><li>formï¼šæ‹¿åˆ°ä¹‹å‰çš„ url</li><li>fromStateï¼šæ‹¿åˆ°ä¹‹å‰çš„çŠ¶æ€å¯¹è±¡</li><li>deltaï¼šä¸»è¦æ˜¯ç”¨æ¥è®¡ç®—è¦å‰è¿›è¿˜æ˜¯åé€€</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  currentLocation<span class="token punctuation">.</span>value <span class="token operator">=</span> to
  historyState<span class="token punctuation">.</span>value <span class="token operator">=</span> state

  <span class="token keyword">if</span> <span class="token punctuation">(</span>pauseState <span class="token operator">&amp;&amp;</span> pauseState <span class="token operator">===</span> from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pauseState <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  delta <span class="token operator">=</span> fromState <span class="token operator">?</span> state<span class="token punctuation">.</span>position <span class="token operator">-</span> fromState<span class="token punctuation">.</span>position <span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆä¼šåšä¸€ä¸ª state æ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­ï¼Œstate æ˜¯è§¦å‘ popstate äº‹ä»¶çš„æ—¶å€™éšç€äº‹ä»¶å¯¹è±¡ä¼ å…¥çš„ã€‚</p><ul><li>state å­˜åœ¨ <ul><li>é¦–å…ˆåšçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æ›´æ–°å½“å‰çš„ currentLocation å’Œ historyState è¿™ä¸¤ä¸ªå€¼</li><li>æ¥ä¸‹æ¥åˆ¤æ–­æš‚åœçŠ¶æ€æ˜¯å¦å­˜åœ¨å¹¶ä¸”æ˜¯å¦ç­‰äº from <ul><li>å¦‚æœå­˜åœ¨æš‚åœçŠ¶æ€å¹¶ä¸”æš‚åœçŠ¶æ€ç­‰äºä¹‹å‰çš„ urlï¼Œè¿™é‡Œå°±æ¸…ç©ºæš‚åœçŠ¶æ€ï¼Œç›´æ¥è¿”å›</li><li>å¦‚æœæ²¡æœ‰è¿›å…¥ä¸Šé¢çš„ ifï¼Œé‚£ä¹ˆå°±åš delta å€¼çš„è®¡ç®—ï¼Œå…³äºè¿™ä¸ªå€¼çš„è®¡ç®—åˆéœ€è¦åˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¹‹å‰çš„çŠ¶æ€å¯¹è±¡ <ul><li>å¦‚æœå­˜åœ¨ï¼Œé€šè¿‡ä¸¤ä¸ªçŠ¶æ€å¯¹è±¡ä¹‹é—´çš„ position æ’å€¼æ¥è®¡ç®— delta</li><li>å¦‚æœä¸å­˜åœ¨ä¹‹å‰çš„çŠ¶æ€å¯¹è±¡ï¼Œé‚£ä¹ˆå€¼è®¾ç½®ä¸º 0</li></ul></li></ul></li></ul></li><li>state ä¸å­˜åœ¨ï¼šä½¿ç”¨ replace ç›´æ¥è·³è½¬åˆ°æ–°çš„ url å³å¯</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>listener <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">listener</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    delta<span class="token punctuation">,</span>
    type<span class="token operator">:</span> NavigationType<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>
    direction<span class="token operator">:</span> delta
      <span class="token operator">?</span> delta <span class="token operator">&gt;</span> <span class="token number">0</span>
        <span class="token operator">?</span> NavigationDirection<span class="token punctuation">.</span>forward
        <span class="token operator">:</span> NavigationDirection<span class="token punctuation">.</span>back
      <span class="token operator">:</span> NavigationDirection<span class="token punctuation">.</span><span class="token builtin">unknown</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éå† listeners æ•°ç»„ï¼Œæ‹¿åˆ°å­˜å‚¨åœ¨é‡Œé¢çš„æ¯ä¸€ä¸ª callback å›è°ƒå‡½æ•°ï¼Œåªä¸è¿‡è¿™é‡Œå‘½åä¸ºäº† listenerï¼Œç„¶åæ‰§è¡Œè¿™äº›å›è°ƒå‡½æ•°ã€‚æ³¨æ„ä¹‹å‰è®¡ç®—å‡ºæ¥çš„ delta å€¼ä¼šä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°çš„å€¼çš„ä¸€éƒ¨åˆ†ä¼ å…¥ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
  pauseListeners<span class="token punctuation">,</span>
  listen<span class="token punctuation">,</span>
  destroy<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åå°±æ˜¯å‘å¤–éƒ¨è¿”å›è¿™ä¹ˆä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨æ‰€æ‹¿åˆ°çš„ historyListeners å¯¹è±¡ã€‚</p><h2 id="å…­ã€routerlinkç»„ä»¶è§£æ" tabindex="-1"><a class="header-anchor" href="#å…­ã€routerlinkç»„ä»¶è§£æ"><span>å…­ã€RouterLinkç»„ä»¶è§£æ</span></a></h2><p>é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯å›å¿†ä¸€ä¸‹ router-link è¿™ä¸ªç»„ä»¶æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼š</p><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/contact<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Contact<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">:to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ name: &#39;user&#39;, params: { username: &#39;erina&#39; }}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>User<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘ä»¬ä¼šä¼ é€’ä¸€ä¸ª to å±æ€§ï¼Œè¿™ä¸ª to å±æ€§å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡</p><p>routerlink å¯¹åº”çš„æºç æ–‡ä»¶æ˜¯ src/RouterLink.tsï¼Œæ ¸å¿ƒçš„å®ç°ä½äº <em>RouterLinkImpl</em> è¿™ä¸€æ®µä»£ç ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> RouterLinkImpl <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> RouterLink<span class="token operator">:</span> _RouterLinkI <span class="token operator">=</span> RouterLinkImpl <span class="token keyword">as</span> <span class="token builtin">any</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ RouterLinkImpl å…·ä½“çš„å®ç°ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> RouterLinkImpl <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&#39;RouterLink&#39;</span><span class="token punctuation">,</span>
  compatConfig<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">MODE</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  useLink<span class="token punctuation">,</span>

  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> slots <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œ RouterLinkImpl çš„æ•´ä½“ç»“æ„å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ vue3 ç»„ä»¶ã€‚</p><h3 id="_1-compatconfig" tabindex="-1"><a class="header-anchor" href="#_1-compatconfig"><span>1. compatConfig</span></a></h3><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>compatConfig<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">MODE</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>compatConfig æ˜¯ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œç”¨äºé…ç½® vue3 ç›¸å…³çš„å…¼å®¹æ€§é€‰é¡¹ã€‚</p><ul><li>MODEï¼šç”¨äºæŒ‡å®šå…¼å®¹æ¨¡å¼å¯¹åº”çš„å€¼ <ul><li>3: è¡¨ç¤ºå¯ç”¨å®Œå…¨çš„ Vue3 æ¨¡å¼ï¼Œä¸æ”¯æŒ Vue2 çš„ç‰¹æ€§å’Œè¯­æ³•</li><li>2 | 3 ï¼šVue2 å’Œ Vue3 çš„æ··åˆæ¨¡å¼ï¼ŒåŒæ—¶æ”¯æŒ Vue2 å’Œ Vue3 çš„è¯­æ³•</li><li>2: å¯ç”¨å®Œå…¨çš„ Vue2 æ¨¡å¼ï¼Œä¸æ”¯æŒ Vue3 çš„ç‰¹æ€§å’Œè¯­æ³•</li></ul></li><li><code>GLOBAL_MOUNT</code>ï¼šæŒ‡å®šå…¨å±€æŒ‚è½½çš„å€¼ã€‚å¯ä»¥æ˜¯ä»¥ä¸‹é€‰é¡¹ä¹‹ä¸€ï¼š <ul><li><code>true</code>ï¼šè¡¨ç¤ºåœ¨ Vue 3 ä¸­è‡ªåŠ¨å…¨å±€æŒ‚è½½ Vue 2 çš„å®ä¾‹ï¼Œä½¿ Vue 2 çš„ç»„ä»¶å¯ä»¥åœ¨ Vue 3 çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚</li><li><code>false</code>ï¼šè¡¨ç¤ºç¦ç”¨å…¨å±€æŒ‚è½½ï¼Œéœ€è¦æ‰‹åŠ¨æŒ‚è½½ Vue 2 çš„å®ä¾‹ã€‚</li></ul></li><li><code>COMPAT_UTILS</code>ï¼šæŒ‡å®šå…¼å®¹æ€§å·¥å…·çš„å€¼ã€‚å¯ä»¥æ˜¯ä»¥ä¸‹é€‰é¡¹ä¹‹ä¸€ï¼š <ul><li><code>&quot;auto&quot;</code>ï¼šè¡¨ç¤ºè‡ªåŠ¨æ£€æµ‹å¹¶æ ¹æ®éœ€è¦å¼•å…¥é€‚å½“çš„å…¼å®¹æ€§å·¥å…·ã€‚</li><li><code>true</code>ï¼šè¡¨ç¤ºå¼ºåˆ¶å¼•å…¥å…¼å®¹æ€§å·¥å…·ï¼Œæ— è®ºæ˜¯å¦éœ€è¦ã€‚</li><li><code>false</code>ï¼šè¡¨ç¤ºç¦ç”¨å…¼å®¹æ€§å·¥å…·ã€‚</li></ul></li><li><code>PRESERVE_ATTRIBUTE_CASE</code>ï¼šæŒ‡å®šä¿ç•™å±æ€§å¤§å°å†™çš„å€¼ã€‚å¯ä»¥æ˜¯ä»¥ä¸‹é€‰é¡¹ä¹‹ä¸€ï¼š <ul><li><code>true</code>ï¼šè¡¨ç¤ºåœ¨ Vue 3 ä¸­ç»´æŒå±æ€§çš„åŸå§‹å¤§å°å†™ã€‚</li><li><code>false</code>ï¼šè¡¨ç¤ºåœ¨ Vue 3 ä¸­å°†å±æ€§è½¬æ¢ä¸ºå°å†™ã€‚</li></ul></li></ul><p>å…³äºè¿™ç§å…¼å®¹æ€§çš„é…ç½®ï¼Œå¯ä»¥å‚é˜… <a href="https://v3-migration.vuejs.org/zh/migration-build.html#%E5%85%BC%E5%AE%B9%E6%80%A7%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><h3 id="_2-props" tabindex="-1"><a class="header-anchor" href="#_2-props"><span>2. props</span></a></h3><p>å®Œæ•´çš„ props åˆ—è¡¨å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>props<span class="token operator">:</span> <span class="token punctuation">{</span>
  to<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">]</span> <span class="token keyword">as</span> PropType<span class="token operator">&lt;</span>RouteLocationRaw<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  replace<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
  activeClass<span class="token operator">:</span> String<span class="token punctuation">,</span>
  exactActiveClass<span class="token operator">:</span> String<span class="token punctuation">,</span>
  custom<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
  ariaCurrentValue<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> String <span class="token keyword">as</span> PropType<span class="token operator">&lt;</span>RouterLinkProps<span class="token punctuation">[</span><span class="token string">&#39;ariaCurrentValue&#39;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">&#39;page&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢ç½—åˆ—å‡ºäº†å®Œæ•´çš„ props åˆ—è¡¨ï¼Œå…¶ä¸­ to æ˜¯å¿…é¡»è¦ä¼ é€’çš„ï¼Œå…¶ä»–çš„éƒ½æ˜¯å¯é€‰å±æ€§ã€‚</p><ul><li>toï¼šç›®æ ‡è·¯ç”±åœ°å€ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå…·æœ‰å¤šä¸ªå±æ€§çš„å¯¹è±¡ã€‚</li><li>repalceï¼šæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨äºæŒ‡å®šä½¿ç”¨å“ªä¸€ç§æ¨¡å¼æ¥è¿›è¡Œè·¯ç”±å¯¼èˆªï¼Œæœ‰ repalce æ¨¡å¼ ä»¥åŠ push æ¨¡å¼</li><li>activeClassï¼šå½“å‰æ¿€æ´»çŠ¶æ€ä¸‹æ‰€å¯¹åº”çš„æ ·å¼ç±»</li><li>exactActiveClassï¼šè¿™ä¸ªä¹Ÿæ˜¯æ¿€æ´»çŠ¶æ€ä¸‹æ‰€å¯¹åº”çš„æ ·å¼ç±»ï¼Œåªä¸è¿‡åˆ¤æ–­æ˜¯å¦æ¿€æ´»çš„æ¡ä»¶æ›´åŠ çš„ä¸¥æ ¼ï¼Œéœ€è¦å®Œå…¨åŒ¹é…ã€‚</li><li>customï¼šè¿™æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨äºæŒ‡å®šæ˜¯å¦è¦è‡ªå®šä¹‰ RouterLink çš„æ¸²æŸ“æ–¹å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ RouterLink æ˜¯ä¼šè¢«æ¸²æŸ“ä¸ºä¸€ä¸ª a æ ‡è®°ï¼Œä½†æ˜¯æ”¯æŒè‡ªå®šä¹‰æ¸²æŸ“æ–¹å¼</li><li>ariaCurrentValueï¼šä¸»è¦æ˜¯è®¾ç½® aria-current çš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯å’Œ web å¯è®¿é—®æ€§ç›¸å…³çš„å±æ€§å€¼ã€‚</li></ul><h3 id="_3-uselink" tabindex="-1"><a class="header-anchor" href="#_3-uselink"><span>3. useLink</span></a></h3><p>useLink æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œæ•´ä½“çš„ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useLink</span><span class="token punctuation">(</span>props<span class="token operator">:</span> UseLinkOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">)</span><span class="token operator">!</span>
  <span class="token keyword">const</span> currentRoute <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">)</span><span class="token operator">!</span>

  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> router<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> activeRecordIndex <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span>

  <span class="token keyword">const</span> isActive <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span>
  <span class="token keyword">const</span> isExactActive <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span>e<span class="token operator">:</span> MouseEvent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> MouseEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token operator">|</span> NavigationFailure<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">,</span>
    href<span class="token operator">:</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> route<span class="token punctuation">.</span>value<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">,</span>
    isActive<span class="token punctuation">,</span>
    isExactActive<span class="token punctuation">,</span>
    navigate<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€ä¸ªéƒ¨åˆ†ä¸€ä¸ªéƒ¨åˆ†æ¥è¿›è¡Œè§£æã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token keyword">const</span> currentRoute <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">)</span><span class="token operator">!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸¤å¥ä»£ç å°±æ˜¯é€šè¿‡ vue çš„ä¾èµ–æ³¨å…¥åŠŸèƒ½æ‹¿åˆ°å¯¹åº”çš„ router ä»¥åŠå½“å‰è·¯ç”±çš„ä¿¡æ¯ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> router<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>props.to æ˜¯ç”¨æˆ·è¦è·³è½¬çš„ç›®æ ‡è·¯ç”±ï¼Œå°†è¿™ä¸ªç›®æ ‡è·¯ç”±ä¼ é€’ç»™ router.resolve æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸€çœ‹å°±çŸ¥é“æ˜¯æ ¹æ®ç›®æ ‡è·¯ç”±æ¥åšä¿¡æ¯è§£æï¼Œè€Œä¸”å†…éƒ¨è‚¯å®šä¼šä½¿ç”¨ matcher.resolveï¼Œé™¤äº†ä½¿ç”¨ matcher.resolve æ¥è¿›è¡Œè§£æä»¥å¤–ï¼Œ router.resolve æ–¹æ³•æœ¬èº«ä¹Ÿä¼šåšä¸€å®šçš„ä¿¡æ¯è§£æå·¥ä½œï¼Œè¿™é‡Œæˆ‘ä»¬åªå…³æ³¨æœ€ç»ˆè¿”å›çš„å€¼ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> matchedRoute <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>matcherLocation<span class="token punctuation">,</span> currentLocation<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token function">assign</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    fullPath<span class="token punctuation">,</span>
    <span class="token comment">// keep the hash encoded so fullPath is effectively path + encodedQuery +</span>
    <span class="token comment">// hash</span>
    hash<span class="token punctuation">,</span>
    query<span class="token operator">:</span>
      <span class="token comment">// if the user is using a custom query lib like qs, we might have</span>
      <span class="token comment">// nested objects, so we keep the query as is, meaning it can contain</span>
      <span class="token comment">// numbers at `$route.query`, but at the point, the user will have to</span>
      <span class="token comment">// use their own type anyway.</span>
      <span class="token comment">// https://github.com/vuejs/router/issues/328#issuecomment-649481567</span>
      stringifyQuery <span class="token operator">===</span> originalStringifyQuery
        <span class="token operator">?</span> <span class="token function">normalizeQuery</span><span class="token punctuation">(</span>rawLocation<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rawLocation<span class="token punctuation">.</span>query <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> LocationQuery<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  matchedRoute<span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    redirectedFrom<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    href<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç´§æ¥ç€å£°æ˜äº†ä¸‰ä¸ªè®¡ç®—å±æ€§ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> activeRecordIndex <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span>
<span class="token keyword">const</span> isActive <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span>
<span class="token keyword">const</span> isExactActive <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>activeRecordIndex æ˜¯ä¸€ä¸ª number ç±»å‹çš„å€¼ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯å¸ƒå°”å€¼ã€‚</p><p>activeRecordIndex å¯¹åº”çš„æºç è¯´æ˜å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> activeRecordIndex <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä» route å¯¹è±¡ä¸­è·å– matched å±æ€§ï¼Œè¯¥å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«äº†å½“å‰è·¯ç”±åŒ¹é…çš„æ‰€æœ‰è·¯ç”±è®°å½•ã€‚</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> matched <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">.</span>value
  <span class="token comment">// è·å– matched æ•°ç»„çš„é•¿åº¦ã€‚</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> length <span class="token punctuation">}</span> <span class="token operator">=</span> matched
  <span class="token comment">// è·å– matched æ•°ç»„ä¸­æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå³å½“å‰è·¯ç”±åŒ¹é…çš„è·¯ç”±è®°å½•ã€‚</span>
  <span class="token keyword">const</span> routeMatched<span class="token operator">:</span> RouteRecord <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> matched<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token comment">// è·å–å½“å‰è·¯ç”± currentRoute çš„åŒ¹é…è·¯ç”±æ•°ç»„ã€‚</span>
  <span class="token keyword">const</span> currentMatched <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>matched
  <span class="token comment">// å¦‚æœ routeMatched ä¸å­˜åœ¨æˆ–è€… currentMatched æ•°ç»„ä¸ºç©ºï¼Œåˆ™è¿”å› -1ï¼Œè¡¨ç¤ºå½“å‰è·¯ç”±æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•è·¯ç”±è®°å½•ã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>routeMatched <span class="token operator">||</span> <span class="token operator">!</span>currentMatched<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token comment">// ä½¿ç”¨ findIndex æ–¹æ³•åœ¨ currentMatched æ•°ç»„ä¸­æŸ¥æ‰¾ä¸ routeMatched ç›¸åŒçš„è·¯ç”±è®°å½•ï¼Œå¹¶è¿”å›å…¶ç´¢å¼•ä½ç½®ã€‚</span>
  <span class="token comment">// isSameRouteRecord æ˜¯ä¸€ä¸ªç”¨äºæ¯”è¾ƒä¸¤ä¸ªè·¯ç”±è®°å½•æ˜¯å¦ç›¸åŒçš„å‡½æ•°ã€‚</span>
  <span class="token keyword">const</span> index <span class="token operator">=</span> currentMatched<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>
    <span class="token function">isSameRouteRecord</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> routeMatched<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// å¦‚æœæ‰¾åˆ°äº†ç›¸åŒçš„è·¯ç”±è®°å½•ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥ç´¢å¼•ä½ç½®ã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> index
  <span class="token comment">// è·å–åŒ¹é…è·¯ç”±æ•°ç»„ä¸­å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ çš„åŸå§‹è·¯å¾„ï¼Œä½œä¸ºå¯èƒ½çš„çˆ¶çº§è·¯ç”±è®°å½•è·¯å¾„ã€‚</span>
  <span class="token keyword">const</span> parentRecordPath <span class="token operator">=</span> <span class="token function">getOriginalPath</span><span class="token punctuation">(</span>
    matched<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">as</span> RouteRecord <span class="token operator">|</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// å¦‚æœ length å¤§äº 1ï¼Œè¡¨ç¤ºå­˜åœ¨åµŒå¥—è·¯ç”±ã€‚</span>
	<span class="token comment">// å¦‚æœ routeMatched çš„åŸå§‹è·¯å¾„ä¸ parentRecordPath ç›¸åŒï¼Œå¹¶ä¸”å½“å‰è·¯ç”±ä¸æ˜¯çˆ¶çº§è·¯ç”±çš„è·¯å¾„çš„æœ€åä¸€ä¸ªå­è·¯ç”±ã€‚</span>
	<span class="token comment">// åœ¨ä¸Šè¿°æƒ…å†µä¸‹ï¼Œè¿”å›åŒ¹é…è·¯ç”±æ•°ç»„ä¸­å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ï¼ˆå³çˆ¶çº§è·¯ç”±è®°å½•ï¼‰åœ¨ currentMatched æ•°ç»„ä¸­çš„ç´¢å¼•ä½ç½®ã€‚</span>
	<span class="token comment">// å¦åˆ™ï¼Œè¿”å›ä¹‹å‰è®¡ç®—çš„ indexã€‚</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getOriginalPath</span><span class="token punctuation">(</span>routeMatched<span class="token punctuation">)</span> <span class="token operator">===</span> parentRecordPath <span class="token operator">&amp;&amp;</span> currentMatched<span class="token punctuation">[</span>currentMatched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>path <span class="token operator">!==</span> parentRecordPath
      <span class="token operator">?</span> currentMatched<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>
          <span class="token function">isSameRouteRecord</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> matched<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token operator">:</span> index
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>activeRecordIndex æ˜¯å¾—åˆ°ä¸€ä¸ªç´¢å¼•å€¼ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“é“¾æ¥çš„æ—¶å€™è¿›è¡Œä¸€äº›ç‰¹å®šçš„å¤„ç†ï¼Œä¾‹å¦‚æ·»åŠ æ´»åŠ¨æ ·å¼ç±»ï¼Œè‡ªå®šä¹‰æ ·å¼ç±»ç­‰ï¼Œå®ƒè€ƒè™‘äº†åµŒå¥—è·¯ç”±çš„æƒ…å†µï¼Œå¹¶ä¸”æ ¹æ®ä¸€äº›æ¡ä»¶æ¥ç¡®å®šå½“å‰è·¯ç”±çš„ä½ç½®ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> isActive <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  <span class="token comment">// å¦‚æœå½“å‰è·¯ç”±çš„ç´¢å¼•ä½ç½®å¤§äº -1 å¹¶ä¸”å‚æ•°å¯¹è±¡ç›¸ç­‰ï¼Œåˆ™è¿”å› trueï¼Œè¡¨ç¤ºå½“å‰é“¾æ¥å¤„äºæ´»åŠ¨çŠ¶æ€ï¼›å¦åˆ™è¿”å› falseï¼Œè¡¨ç¤ºå½“å‰é“¾æ¥ä¸å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token comment">// åˆ¤æ–­å½“å‰è·¯ç”±çš„ç´¢å¼•ä½ç½®æ˜¯å¦å¤§äº -1ï¼Œè¡¨ç¤ºå½“å‰è·¯ç”±åŒ¹é…åˆ°äº†è·¯ç”±è®°å½•ã€‚</span>
    activeRecordIndex<span class="token punctuation">.</span>value <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
  	<span class="token comment">// è°ƒç”¨ includesParams å‡½æ•°ï¼Œæ¯”è¾ƒå½“å‰è·¯ç”±çš„å‚æ•°å¯¹è±¡å’Œç›®æ ‡è·¯ç”±çš„å‚æ•°å¯¹è±¡æ˜¯å¦ç›¸ç­‰ã€‚</span>
    <span class="token function">includesParams</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">,</span> route<span class="token punctuation">.</span>value<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯ä¸º router-link ç»„ä»¶æä¾›ä¸€ä¸ªè®¡ç®—å±æ€§ isActiveï¼Œç”¨äºåˆ¤æ–­å½“å‰é“¾æ¥æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå®ƒé€šè¿‡æ¯”è¾ƒå½“å‰è·¯ç”±çš„ç´¢å¼•ä½ç½®å’Œå‚æ•°å¯¹è±¡æ¥ç¡®å®šé“¾æ¥çš„æ´»åŠ¨çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“é“¾æ¥çš„æ—¶å€™æ·»åŠ æˆ–è€…ç§»é™¤æ´»åŠ¨çŠ¶æ€ç±»ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> isExactActive <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    activeRecordIndex<span class="token punctuation">.</span>value <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
  	<span class="token comment">// åˆ¤æ–­å½“å‰è·¯ç”±çš„ç´¢å¼•ä½ç½®æ˜¯å¦ç­‰äºå½“å‰è·¯ç”±çš„åŒ¹é…è·¯ç”±æ•°ç»„é•¿åº¦å‡ 1ï¼Œè¡¨ç¤ºå½“å‰è·¯ç”±æ˜¯åŒ¹é…è·¯ç”±æ•°ç»„ä¸­çš„æœ€åä¸€ä¸ªè·¯ç”±è®°å½•ã€‚</span>
    activeRecordIndex<span class="token punctuation">.</span>value <span class="token operator">===</span> currentRoute<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
  	<span class="token comment">// è°ƒç”¨ isSameRouteLocationParams å‡½æ•°ï¼Œæ¯”è¾ƒå½“å‰è·¯ç”±çš„å‚æ•°å¯¹è±¡å’Œç›®æ ‡è·¯ç”±çš„å‚æ•°å¯¹è±¡æ˜¯å¦å®Œå…¨ç›¸ç­‰ã€‚</span>
    <span class="token function">isSameRouteLocationParams</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">,</span> route<span class="token punctuation">.</span>value<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>isExactActive è®¡ç®—å±æ€§ç”¨äºåˆ¤æ–­å½“å‰é“¾æ¥æ˜¯å¦å¤„äºç²¾ç¡®çš„æ´»åŠ¨çŠ¶æ€ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ª navigate æ–¹æ³•ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span>
  e<span class="token operator">:</span> MouseEvent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> MouseEvent
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token operator">|</span> NavigationFailure<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">guardEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> router<span class="token punctuation">[</span><span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&#39;replace&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;push&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
      <span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span>
      <span class="token comment">// avoid uncaught errors are they are logged anyway</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ª navigate æ–¹æ³•å¯¹åº”çš„å°±æ˜¯ç”¨æˆ·ç‚¹å‡» a æ ‡ç­¾ä¹‹åæ‰€å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚</p><ul><li>é¦–å…ˆçœ‹ guardEvent(e) æ˜¯å¦æœ‰æ•ˆ <ul><li>å¦‚æœæœ‰æ•ˆï¼Œé‚£ä¹ˆå°±é€šè¿‡ router çš„ repalce æˆ–è€… push æ–¹æ³•è¿›è¡Œè·¯ç”±å¯¼èˆª</li></ul></li><li>å¦‚æœæ²¡æœ‰æ•ˆ <ul><li>ä¸æ‰§è¡Œå¯¼èˆªæ“ä½œï¼Œç›´æ¥è¿”å›ä¸€ä¸ªå·²ç»è§£æçš„ç©ºçš„ Promise å¯¹è±¡</li></ul></li></ul><p>guardEvent å…·ä½“æ‰€åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">guardEvent</span><span class="token punctuation">(</span>e<span class="token operator">:</span> MouseEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¦‚æœç”¨æˆ·åœ¨ç‚¹å‡»é“¾æ¥æ—¶æŒ‰ä½äº† meta é”®ã€alt é”®ã€ctrl é”®æˆ– shift é”®ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±ä¼šè¿”å› undefinedï¼Œä»è€Œä¸å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚</span>
  <span class="token comment">// è¿™æ˜¯å› ä¸ºåœ¨å¾ˆå¤šæµè§ˆå™¨ä¸­ï¼ŒæŒ‰ä½è¿™äº›é”®ç‚¹å‡»ä¸€ä¸ªé“¾æ¥ä¼šæœ‰ç‰¹æ®Šçš„è¡Œä¸ºï¼Œæ¯”å¦‚åœ¨æ–°çš„æ ‡ç­¾é¡µä¸­æ‰“å¼€é“¾æ¥ã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>metaKey <span class="token operator">||</span> e<span class="token punctuation">.</span>altKey <span class="token operator">||</span> e<span class="token punctuation">.</span>ctrlKey <span class="token operator">||</span> e<span class="token punctuation">.</span>shiftKey<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token comment">// å¦‚æœäº‹ä»¶çš„ defaultPrevented å±æ€§ä¸º trueï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¹Ÿä¼šè¿”å› undefinedã€‚</span>
  <span class="token comment">// è¿™è¡¨ç¤ºè¿™ä¸ªäº‹ä»¶å·²ç»è¢«å…¶ä»–çš„äº‹ä»¶å¤„ç†å™¨å¤„ç†è¿‡ï¼Œå¹¶ä¸”å·²ç»é˜»æ­¢äº†é»˜è®¤è¡Œä¸ºã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>defaultPrevented<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token comment">// å¦‚æœäº‹ä»¶çš„ button å±æ€§ä¸ç­‰äº 0ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°åŒæ ·ä¼šè¿”å› undefinedã€‚</span>
  <span class="token comment">// button å±æ€§è¡¨ç¤ºè§¦å‘äº‹ä»¶çš„é¼ æ ‡æŒ‰é’®ï¼Œ0 ä»£è¡¨å·¦é”®ï¼Œ1 ä»£è¡¨ä¸­é”®ï¼Œ2 ä»£è¡¨å³é”®ã€‚</span>
  <span class="token comment">// å› æ­¤ï¼Œè¿™ä¸€è¡Œä»£ç çš„æ•ˆæœæ˜¯ï¼Œå¦‚æœç”¨æˆ·ä½¿ç”¨ä¸­é”®æˆ–å³é”®ç‚¹å‡»é“¾æ¥ï¼Œé‚£ä¹ˆä¸å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>button <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>button <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token comment">// å¦‚æœç‚¹å‡»çš„å…ƒç´ æœ‰ target=&quot;_blank&quot; å±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¹Ÿä¼šè¿”å› undefinedã€‚</span>
  <span class="token comment">// è¿™æ˜¯å› ä¸º target=&quot;_blank&quot; è¡¨ç¤ºé“¾æ¥åº”è¯¥åœ¨æ–°çš„æ ‡ç­¾é¡µä¸­æ‰“å¼€ï¼Œæ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨ Vue Router æ¥å¤„ç†å¯¼èˆªã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>currentTarget <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>getAttribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;target&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\b_blank\b</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¦‚æœå‰é¢çš„æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªäº‹ä»¶åº”è¯¥è¢«å¤„ç†ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨ e.preventDefault() æ¥é˜»æ­¢äº‹ä»¶çš„é»˜è®¤è¡Œä¸ºï¼Œç„¶åè¿”å› trueã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>preventDefault<span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>guardEvent æ–¹æ³•ä¸»è¦æ˜¯ç¡®å®šæ˜¯å¦åº”è¯¥å¤„ç†ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹çš„ç‚¹å‡»äº‹ä»¶ä¸éœ€è¦è¢«å¤„ç†ï¼Œé‚£ç©¶ç«Ÿè¦ä¸è¦è¢«å¤„ç†ï¼Œåœ¨ guardEvent é‡Œé¢è¿›è¡Œå„ç§åˆ¤æ–­ã€‚</p><h3 id="_4-setup" tabindex="-1"><a class="header-anchor" href="#_4-setup"><span>4. setup</span></a></h3><p>æœ€åæ˜¯ setup æ–¹æ³•ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> slots <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è°ƒç”¨ useLinkï¼Œå¾—åˆ°ä¸€ä¸ªå¯¹è±¡ {route, href, isActive, isExactActive, navigate}</span>
  <span class="token keyword">const</span> link <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token function">useLink</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">)</span><span class="token operator">!</span>

  <span class="token comment">// è¿™é‡Œæ˜¯åœ¨è®¡ç®—å…·ä½“è¦æŒ‚ä¸Šå»çš„æ ·å¼ç±»</span>
  <span class="token keyword">const</span> elClass <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token function">getLinkClass</span><span class="token punctuation">(</span>
      props<span class="token punctuation">.</span>activeClass<span class="token punctuation">,</span>
      options<span class="token punctuation">.</span>linkActiveClass<span class="token punctuation">,</span>
      <span class="token string">&#39;router-link-active&#39;</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> link<span class="token punctuation">.</span>isActive<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token function">getLinkClass</span><span class="token punctuation">(</span>
      props<span class="token punctuation">.</span>exactActiveClass<span class="token punctuation">,</span>
      options<span class="token punctuation">.</span>linkExactActiveClass<span class="token punctuation">,</span>
      <span class="token string">&#39;router-link-exact-active&#39;</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> link<span class="token punctuation">.</span>isExactActive<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‹¿åˆ°æ’æ§½å†…å®¹</span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> slots<span class="token punctuation">.</span>default <span class="token operator">&amp;&amp;</span> slots<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span>
    <span class="token keyword">return</span> props<span class="token punctuation">.</span>custom
      <span class="token operator">?</span> children
      <span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span>
          <span class="token string">&#39;a&#39;</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token string-property property">&#39;aria-current&#39;</span><span class="token operator">:</span> link<span class="token punctuation">.</span>isExactActive
              <span class="token operator">?</span> props<span class="token punctuation">.</span>ariaCurrentValue
              <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            href<span class="token operator">:</span> link<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
            onClick<span class="token operator">:</span> link<span class="token punctuation">.</span>navigate<span class="token punctuation">,</span>
            <span class="token keyword">class</span><span class="token operator">:</span> elClass<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          children
        <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>getLinkClass æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> getLinkClass <span class="token operator">=</span> <span class="token punctuation">(</span>
  propClass<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  globalClass<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  defaultClass<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=&gt;</span>
  propClass <span class="token operator">!=</span> <span class="token keyword">null</span>
    <span class="token operator">?</span> propClass
    <span class="token operator">:</span> globalClass <span class="token operator">!=</span> <span class="token keyword">null</span>
    <span class="token operator">?</span> globalClass
    <span class="token operator">:</span> defaultClass
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ¹æ®ä¸€å®šçš„ä¼˜å…ˆçº§é¡ºåºæ¥è·å–ç±»åï¼Œé¦–å…ˆæ£€æŸ¥ propsClassï¼Œå¦‚æœå­˜åœ¨å°±ä½¿ç”¨å®ƒï¼Œå¦‚æœä¸å­˜åœ¨å°±æ£€æŸ¥ globalClassï¼Œå¦‚æœå­˜åœ¨å°±ä½¿ç”¨å®ƒï¼Œå¦åˆ™å°±ä½¿ç”¨ defaultClass</p><h2 id="ä¸ƒã€routerviewæºç è§£æ" tabindex="-1"><a class="header-anchor" href="#ä¸ƒã€routerviewæºç è§£æ"><span>ä¸ƒã€RouterViewæºç è§£æ</span></a></h2><p>RouterViewçš„æ ¸å¿ƒå®ç°ä½äº RouterViewImpl.ts æ–‡ä»¶ï¼Œæ•´ä½“çš„ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> RouterViewImpl <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&#39;RouterView&#39;</span><span class="token punctuation">,</span>
  inheritAttrs<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  compatConfig<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">MODE</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> attrs<span class="token punctuation">,</span> slots <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">watch</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹æ˜¯çœ‹ setup é‡Œé¢çš„ä»£ç ï¼Œæœ‰å…³ setup é‡Œé¢çš„ä»£ç ï¼Œæ ¸å¿ƒåˆå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>depth æ·±åº¦</li><li>watch</li><li>return</li></ul><h3 id="_1-depth-æ·±åº¦" tabindex="-1"><a class="header-anchor" href="#_1-depth-æ·±åº¦"><span>1. depth æ·±åº¦</span></a></h3><p>åœ¨ vue router ä¸­ï¼Œä¹‹æ‰€ä»¥è¦è®¡ç®—æ·±åº¦ï¼Œæ˜¯ä¸ºäº†å®ç°åµŒå¥—è·¯ç”±çš„åŠŸèƒ½ã€‚</p><p>æ‰€è°“åµŒå¥—è·¯ç”±ï¼ŒæŒ‡çš„æ˜¯ä¸€ä¸ªè·¯ç”±è§†å›¾å†…éƒ¨åˆå¯ä»¥åŒ…å«å¦ä¸€ä¸ªè·¯ç”±è§†å›¾ã€‚</p><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code><span class="token comment">&lt;!-- å¸ƒå±€ç»„ä»¶ --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- depth = 0 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- åœ¨å¸ƒå±€ç»„ä»¶çš„ router-view ä¸­ --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Some Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- depth = 1 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯ä¸€ä¸ª router-view éƒ½éœ€è¦çŸ¥é“å®ƒåœ¨æ•´ä¸ªè§†å›¾æ ‘é‡Œé¢çš„ä½ç½®ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ¸²æŸ“å‡ºæ­£ç¡®çš„æ‰€å¯¹åº”çš„è·¯ç”±ç»„ä»¶ï¼Œè¿™å°±æ˜¯æ·±åº¦çš„ä½œç”¨ï¼Œè¡¨ç¤ºå½“å‰çš„ router-view åœ¨æ•´ä¸ªåµŒå¥—çš„ router-view ä¸­çš„ä½ç½®ã€‚</p><p>æœ€é¡¶å±‚çš„ router-view é»˜è®¤æ·±åº¦ä¸º 0ï¼Œå­ router-viewå¯¹åº”çš„æ·±åº¦ä¸º 1ï¼Œä¾æ­¤ç±»æ¨ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ‰å…³æ·±åº¦çš„æ ¸å¿ƒä»£ç ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> attrs<span class="token punctuation">,</span> slots <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// è·å–ä»çˆ¶çº§æ‰€æ³¨å…¥çš„è·¯ç”±å¯¹è±¡</span>
  <span class="token comment">// è¿™é‡Œè·å–åˆ°çš„å°±æ˜¯ä¹‹å‰åœ¨ router.ts ä¸­æ‰€æ³¨å…¥çš„ app.provide(routerViewLocationKey, currentRoute)</span>
  <span class="token comment">// è¿™é‡Œçš„æ„Ÿå¹å·æ˜¯ TS é‡Œé¢é‡Œé¢çš„è¯­æ³•ï¼Œå«åšéç©ºæ–­è¨€æ“ä½œç¬¦ï¼Œç›¸å½“äºå‘Šè¯‰ TS è¿™é‡Œçš„ routerViewLocationKey ä¸€å®šä¸ä¸ºç©º</span>
  <span class="token keyword">const</span> injectedRoute <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">)</span><span class="token operator">!</span>
  <span class="token comment">// è¿™é‡Œ routeToDisplay æ˜¯ä¸€ä¸ªè®¡ç®—å±æ€§</span>
  <span class="token comment">// è¯¥è®¡ç®—å±æ€§ä¼šä¼˜å…ˆçš„ä½¿ç”¨ props.routeï¼Œå¦‚æœ props.route ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä½¿ç”¨ injectedRoute.value</span>
  <span class="token comment">// è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ props æ¥æ‰‹åŠ¨æŒ‡å®šä¸€ä¸ªè·¯ç”±å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ä»çˆ¶çº§æ³¨å…¥çš„è·¯ç”±å¯¹è±¡</span>
  <span class="token keyword">const</span> routeToDisplay <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span>RouteLocationNormalizedLoaded<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> props<span class="token punctuation">.</span>route <span class="token operator">||</span> injectedRoute<span class="token punctuation">.</span>value
  <span class="token punctuation">)</span>
  
  <span class="token comment">// è·å–ä»çˆ¶çº§çš„ router-view æ‰€æ³¨å…¥çš„æ·±åº¦</span>
  <span class="token comment">// å¦‚æœçˆ¶çº§çš„ router-view æ³¨å…¥äº†çš„è¯ï¼Œå°±èƒ½å¤Ÿè·å–åˆ°</span>
  <span class="token comment">// å¦‚æœæ²¡æœ‰çˆ¶çº§æ³¨å…¥ï¼ˆè¯´æ˜è¿™æ˜¯ä¸€ä¸ªæœ€é¡¶å±‚çš„ router-viewï¼‰ï¼Œé‚£ä¹ˆæ·±åº¦çš„é»˜è®¤å€¼ä¸º 0</span>
  <span class="token keyword">const</span> injectedDepth <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>viewDepthKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
 
  <span class="token comment">// è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªåä¸º depth çš„è®¡ç®—å±æ€§ï¼Œä¸»è¦ç”¨äºè®¡ç®—å½“å‰ router-view çš„æ·±åº¦</span>
  <span class="token keyword">const</span> depth <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// é¦–å…ˆè·å–åˆ°ä»çˆ¶çº§æ³¨å…¥çš„æ·±åº¦å€¼ï¼Œå¦‚æœæ˜¯æœ€é¡¶å±‚é‚£ä¹ˆè¿™ä¸ªå€¼ä¸º 0</span>
    <span class="token keyword">let</span> initialDepth <span class="token operator">=</span> <span class="token function">unref</span><span class="token punctuation">(</span>injectedDepth<span class="token punctuation">)</span>
    
    <span class="token comment">// å°†å½“å‰è·¯ç”±å¯¹è±¡çš„ matched å±æ€§è§£æ„å‡ºæ¥ï¼Œmatched æ•°ç»„é‡Œé¢åŒ…å«äº†æ‰€æœ‰åŒ¹é…çš„è·¯ç”±è®°å½•</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> matched <span class="token punctuation">}</span> <span class="token operator">=</span> routeToDisplay<span class="token punctuation">.</span>value
    
    <span class="token comment">// è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå˜é‡ matchedRouteï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œç”¨äºä¸´æ—¶å­˜å‚¨åŒ¹é…çš„è·¯ç”±è®°å½•</span>
    <span class="token keyword">let</span> matchedRoute<span class="token operator">:</span> RouteLocationMatched <span class="token operator">|</span> <span class="token keyword">undefined</span>
    
    <span class="token comment">// é¦–å…ˆ while çš„æ¡ä»¶æ˜¯å½“å‰æ·±åº¦æ‰€å¯¹åº”çš„è·¯ç”±è®°å½•å­˜åœ¨å¹¶ä¸”åŒ¹é…ä¸Šçš„è·¯ç”±æ²¡æœ‰ components</span>
    <span class="token comment">// è¿™é‡Œå°±ä¼šè¿›å…¥åˆ° while å¾ªç¯</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      <span class="token punctuation">(</span>matchedRoute <span class="token operator">=</span> matched<span class="token punctuation">[</span>initialDepth<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>matchedRoute<span class="token punctuation">.</span>components
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ·±åº¦åŠ ä¸€</span>
      <span class="token comment">// å› ä¸ºèƒ½å¤Ÿè¿›å…¥æ­¤å¾ªç¯ï¼Œè¯´æ˜å½“å‰æ‰¾ä¸åˆ°å¯¹åº”çš„ç»„ä»¶</span>
      <span class="token comment">// å› æ­¤æˆ‘ä»¬éœ€è¦å»æ£€æŸ¥ä¸‹ä¸€å±‚çš„è·¯ç”±è®°å½•</span>
      initialDepth<span class="token operator">++</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// è¿”å›è®¡ç®—åçš„æ·±åº¦</span>
    <span class="token keyword">return</span> initialDepth
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token comment">// è¿™é‡Œåˆæ˜¯ä¸€ä¸ªè®¡ç®—å±æ€§</span>
  <span class="token comment">// è¿™é‡Œå°±æ˜¯æ ¹æ®å‰é¢è®¡ç®—å‡ºæ¥çš„æ·±åº¦ï¼Œç„¶åä» matched é‡Œé¢è·å–å¯¹åº”æ·±åº¦çš„è·¯ç”±è®°å½•</span>
  <span class="token keyword">const</span> matchedRouteRef <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span>RouteLocationMatched <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> routeToDisplay<span class="token punctuation">.</span>value<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>depth<span class="token punctuation">.</span>value<span class="token punctuation">]</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// å‘ä¸‹ä¸€å±‚ router-view æ³¨å…¥æ·±åº¦</span>
  <span class="token comment">// æ³¨æ„è¿™é‡Œåœ¨æ³¨å…¥çš„æ—¶å€™ï¼Œæ·±åº¦ +1</span>
  <span class="token function">provide</span><span class="token punctuation">(</span>
    viewDepthKey<span class="token punctuation">,</span>
    <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> depth<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  
  <span class="token comment">// é™¤äº†æä¾›æ·±åº¦ä»¥å¤–ï¼Œè¿™é‡Œè¿˜æä¾›äº† matchedRouteRef ä»¥åŠ routeToDisplay</span>
  <span class="token function">provide</span><span class="token punctuation">(</span>matchedRouteKey<span class="token punctuation">,</span> matchedRouteRef<span class="token punctuation">)</span>
  <span class="token function">provide</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">,</span> routeToDisplay<span class="token punctuation">)</span>

  <span class="token keyword">const</span> viewRef <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>ComponentPublicInstance<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»ç»“ä¸€ä¸‹ï¼Œä¸Šé¢æœ‰å…³ depth çš„æ ¸å¿ƒä»£ç ï¼Œä¸»è¦å°±æ˜¯é’ˆå¯¹æ·±åº¦ depth åšäº†ä¸€ä¸ªè®¡ç®—ï¼Œè®¡ç®—å‡ºæ¥ä¹‹åéœ€è¦å°†è¿™ä¸ª depth æ·±åº¦å€¼æä¾›ç»™ä¸‹ä¸€å±‚ router-viewï¼Œé™¤æ­¤ä»¥å¤–ï¼Œè¿˜éœ€è¦æ ¹æ®è®¡ç®—å‡ºæ¥çš„ depth æ·±åº¦è·å–åˆ° matched æ•°ç»„é‡Œé¢å¯¹åº”æ·±åº¦çš„åŒ¹é…è·¯ç”±ã€‚</p><h3 id="_2-watch" tabindex="-1"><a class="header-anchor" href="#_2-watch"><span>2. watch</span></a></h3><p>å…³äº watch æˆ‘ä»¬é¦–å…ˆéœ€è¦å›å¿†ä¸€ä¸‹ vue é‡Œé¢ watch çš„ç”¨æ³•ï¼š</p><p>åœ¨ vue é‡Œé¢ watch æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>æºï¼ˆsourceï¼‰ï¼šè¿™æ˜¯æˆ‘ä»¬æƒ³è¦è§‚å¯Ÿçš„æ•°æ®æºï¼Œè¿™ä¸ªæ•°æ®æºå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¾‹å¦‚åœ¨ä¸‹é¢çš„æºç ä¸­ï¼š</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>viewRef<span class="token punctuation">.</span>value<span class="token punctuation">,</span> matchedRouteRef<span class="token punctuation">.</span>value<span class="token punctuation">,</span> props<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™é‡Œæ‰€è§‚å¯Ÿçš„æ•°æ®å°±æ˜¯ viewRef.valueï¼ˆç»„ä»¶å®ä¾‹ï¼‰ï¼Œ matchedRouteRef.valueï¼ˆå½“å‰åŒ¹é…çš„è·¯ç”±è®°å½•ï¼‰ï¼Œprops.nameï¼ˆè·¯ç”±åç§°ï¼‰</p><ul><li>äº‹ä»¶å¤„ç†ï¼ˆhandlerï¼‰ï¼šè¿™é‡Œè¡¨ç¤ºå½“ç›‘è§†çš„æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œè¿™é‡Œçš„ handlerï¼Œhandler å›è°ƒé€šå¸¸æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯å½“å‰æ–°çš„å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯ä¹‹å‰æ—§çš„å€¼ã€‚åœ¨ä¸‹é¢çš„æºç ä¸­ï¼š</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token punctuation">(</span><span class="token punctuation">[</span>instance<span class="token punctuation">,</span> to<span class="token punctuation">,</span> name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>oldInstance<span class="token punctuation">,</span> from<span class="token punctuation">,</span> oldName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>é€‰é¡¹ï¼ˆoptionsï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œç”¨äºæä¾›ä¸€äº›é…ç½®é€‰é¡¹ã€‚ <ul><li>deepï¼šç›‘è§†çš„æ·±åº¦</li><li>immediateï¼šç«‹å³æ‰§è¡Œ handler</li><li>flushï¼šæŒ‡å®šä½•æ—¶æ‰§è¡Œ handler</li></ul></li></ul><p>åœ¨ä¸‹é¢çš„æºç ä¸­ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token punctuation">{</span> flush<span class="token operator">:</span> <span class="token string">&#39;post&#39;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™ä¸ªé€‰é¡¹è¡¨ç¤º handler åº”è¯¥åœ¨ DOM æ›´æ–°ä¹‹åæ‰§è¡Œã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å¯¹ watch éƒ¨åˆ†ä»£ç è¿›è¡Œæ‹†è§£</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token function">watch</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>viewRef<span class="token punctuation">.</span>value<span class="token punctuation">,</span> matchedRouteRef<span class="token punctuation">.</span>value<span class="token punctuation">,</span> props<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">[</span>instance<span class="token punctuation">,</span> to<span class="token punctuation">,</span> name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>oldInstance<span class="token punctuation">,</span> from<span class="token punctuation">,</span> oldName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// é¦–å…ˆè·å–æ£€æŸ¥ to æ˜¯å¦å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿›æ¥ä¹‹åé¦–å…ˆå°† instance ä¿å­˜åˆ° to.instances[name]</span>
      <span class="token comment">// è¿™æ ·ä¹‹åå°±å¯ä»¥é€šè¿‡ to.instances[name] è®¿é—®åˆ°è¿™é‡Œçš„ instance</span>
      to<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> instance
      
      <span class="token comment">// æ¥ä¸‹æ¥ä¸‹é¢è¿™æ®µä»£ç ä¸»è¦ç›®çš„æ˜¯åœ¨ç»„ä»¶å®ä¾‹è¢«å¤ç”¨ï¼ˆè·¯ç”±å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ˜¯ç»„ä»¶å®ä¾‹æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼‰çš„æƒ…å†µä¸‹</span>
      <span class="token comment">// å¤åˆ¶æ—§çš„è·¯ç”±è®°å½•æ‰€å¯¹åº”çš„ç¦»å¼€å®ˆå«ä»¥åŠæ›´æ–°å®ˆå«åˆ°æ–°çš„è·¯ç”±è®°å½•é‡Œé¢</span>
      <span class="token comment">// åˆ¤æ–­æ¡ä»¶å¦‚ä¸‹ï¼š</span>
      <span class="token comment">// 1. æ—§çš„è·¯ç”±å­˜åœ¨</span>
      <span class="token comment">// 2. å¹¶ä¸”æ—§çš„è·¯ç”±è®°å½•å’Œæ–°çš„è·¯ç”±è®°å½•æ˜¯ä¸ç›¸åŒ</span>
      <span class="token comment">// 3. ç»„ä»¶å®ä¾‹å­˜åœ¨</span>
      <span class="token comment">// 4. å½“å‰çš„ç»„ä»¶å®ä¾‹å’Œä¹‹å‰å¯¹åº”çš„ç»„ä»¶å®ä¾‹ç›¸åŒ</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>from <span class="token operator">&amp;&amp;</span> from <span class="token operator">!==</span> to <span class="token operator">&amp;&amp;</span> instance <span class="token operator">&amp;&amp;</span> instance <span class="token operator">===</span> oldInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ£€æŸ¥æ–°çš„è·¯ç”±è®°å½• to çš„ç¦»å¼€å®ˆå«æ˜¯å¦ä¸ºç©º</span>
        <span class="token comment">// å¦‚æœä¸ºç©ºï¼Œå°±å°†æ—§çš„è·¯ç”±è®°å½• from æ‰€å¯¹åº”çš„ç¦»å¼€å®ˆå«ï¼ˆleaveGuardsï¼‰å¤åˆ¶åˆ°æ–°çš„è·¯ç”±è®°å½•é‡Œé¢ to.leaveGuards</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>to<span class="token punctuation">.</span>leaveGuards<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          to<span class="token punctuation">.</span>leaveGuards <span class="token operator">=</span> from<span class="token punctuation">.</span>leaveGuards
        <span class="token punctuation">}</span>
        <span class="token comment">// æ£€æŸ¥æ–°çš„è·¯ç”±è®°å½• to çš„æ›´æ–°å®ˆå«æ˜¯å¦ä¸ºç©º</span>
        <span class="token comment">// å¦‚æœä¸ºç©ºï¼Œå°±å°†æ—§çš„è·¯ç”±è®°å½• from æ‰€å¯¹åº”çš„æ›´æ–°å®ˆå«ï¼ˆupdateGuardsï¼‰å¤åˆ¶åˆ°æ–°çš„è·¯ç”±è®°å½•é‡Œé¢ to.updateGuards</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>to<span class="token punctuation">.</span>updateGuards<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          to<span class="token punctuation">.</span>updateGuards <span class="token operator">=</span> from<span class="token punctuation">.</span>updateGuards
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ€»ç»“ä¸€ä¸‹ï¼Œä¸Šé¢è¿™æ®µä»£ç ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†å¤„ç†ç»„ä»¶å®ä¾‹è¢«å¤ç”¨çš„æƒ…å†µä¸‹ï¼Œæ—§çš„è·¯ç”±å®ˆå«çš„å¤ç”¨é—®é¢˜</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">// æ¥ä¸‹æ¥ä¸‹é¢è¿™æ®µä»£ç ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è§¦å‘ beforeRouteEnter å®ˆå«ä¸­çš„ next å›è°ƒå‡½æ•°</span>
    <span class="token comment">// è¿™ä¸€è¡Œé¦–å…ˆéœ€è¦ç¡®è®¤å¦‚ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</span>
  	<span class="token comment">// 1. ç»„ä»¶å®ä¾‹ instance å­˜åœ¨</span>
  	<span class="token comment">// 2. å¹¶ä¸”æ–°çš„è·¯ç”±è®°å½• to å­˜åœ¨</span>
  	<span class="token comment">// 3. æ—§çš„è·¯ç”±è®°å½• from ä¸å­˜åœ¨æˆ–è€…æ–°çš„è·¯ç”±è®°å½• to å’Œæ—§çš„è·¯ç”±è®°å½• from ä¸æ˜¯åŒä¸€ä¸ªè®°å½•ï¼Œåˆæˆ–è€…æ—§çš„ç»„ä»¶å®ä¾‹ oldInstance ä¸å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      instance <span class="token operator">&amp;&amp;</span>
      to <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>from <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>oldInstance<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä¸‹é¢ä¸¤è¡Œä»£ç ä¸»è¦å°±æ˜¯åœ¨æ‰§è¡Œ beforeRouteEnter å®ˆå«ä¸­çš„ next å›è°ƒå‡½æ•°</span>
      <span class="token comment">// æœ‰å…³ beforeRouteEnter å®ˆå«æ‰€å¯¹åº”çš„å›è°ƒå‡½æ•°ï¼Œæ˜¯é€šè¿‡ next(callback) çš„æ–¹å¼æ¥æ³¨å†Œçš„</span>
      <span class="token comment">// è¿™äº›æ‰€æ³¨å†Œçš„å›è°ƒå‡½æ•°ä¼šä¿å­˜åœ¨ to.enterCallbacks[name] é‡Œé¢</span>
      <span class="token punctuation">;</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>enterCallbacks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callback <span class="token operator">=&gt;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// æ€»ç»“ä¸€ä¸‹ï¼Œè¿™æ®µä»£ç çš„ç›®çš„å°±æ˜¯ä¸ºäº†åœ¨è¿›å…¥æ–°çš„è·¯ç”±ä¹‹å‰ï¼Œæ‰§è¡Œä¸€äº›ç‰¹å®šçš„æ“ä½œ</span>
  	<span class="token comment">// è¿™äº›ç‰¹å®šçš„æ“ä½œæ˜¯å®šä¹‰åœ¨ beforeRouteEnter å®ˆå«çš„ next çš„å›è°ƒå‡½æ•°ä¸­çš„</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> flush<span class="token operator">:</span> <span class="token string">&#39;post&#39;</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-return" tabindex="-1"><a class="header-anchor" href="#_3-return"><span>3. return</span></a></h3><p>æœ€åæ˜¯å…³äº setup ä¸­çš„ return éƒ¨åˆ†çš„ä»£ç ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™ä¸€æ®µä»£ç ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è·å–ä¸€äº›è·¯ç”±ä¿¡æ¯ï¼Œä»¥åŠå‡†å¤‡æ¸²æŸ“çš„ç›¸åº”çš„ç»„ä»¶</span>
  <span class="token comment">// è¿™é‡Œå‰é¢ä¸‰ä¸ªå€¼æ˜¯å¯¹åº”çš„è·¯ç”±ä¿¡æ¯ï¼Œæœ€åä¸€ä¸ªæ˜¯å¯¹åº”çš„è¦æ¸²æŸ“çš„ç»„ä»¶</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> routeToDisplay<span class="token punctuation">.</span>value
  <span class="token keyword">const</span> currentName <span class="token operator">=</span> props<span class="token punctuation">.</span>name
  <span class="token keyword">const</span> matchedRoute <span class="token operator">=</span> matchedRouteRef<span class="token punctuation">.</span>value
  <span class="token comment">// è·å–è¦æ¸²æŸ“çš„ç»„ä»¶</span>
  <span class="token comment">// é¦–å…ˆçœ‹ matchedRoute æ˜¯å¦å­˜åœ¨ï¼ŒmatchedRoute å­˜åœ¨çš„æƒ…å†µä¸‹å¹¶ä¸” components å±æ€§ä¸­æœ‰å¯¹åº”çš„ currentName çš„ç»„ä»¶</span>
  <span class="token comment">// é‚£ä¹ˆè¿™ä¸ªç»„ä»¶å°±æ˜¯æˆ‘ä»¬è¦æ¸²æŸ“çš„ç»„ä»¶</span>
  <span class="token keyword">const</span> ViewComponent <span class="token operator">=</span>
    matchedRoute <span class="token operator">&amp;&amp;</span> matchedRoute<span class="token punctuation">.</span>components<span class="token operator">!</span><span class="token punctuation">[</span>currentName<span class="token punctuation">]</span>

  <span class="token comment">// æ¥ä¸‹æ¥ç´§æ¥ç€å°±å»çœ‹æœ‰æ²¡æœ‰æ‰¾åˆ°è¦æ¸²æŸ“çš„ç»„ä»¶</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ViewComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œé‚£ä¹ˆå°±æ¸²æŸ“é»˜è®¤æ’æ§½ï¼Œå¹¶å°†å¯¹åº”çš„ç»„ä»¶å’Œè·¯ç”±ä¿¡æ¯ä½œä¸ºæ’æ§½çš„å‚æ•°</span>
    <span class="token keyword">return</span> <span class="token function">normalizeSlot</span><span class="token punctuation">(</span>slots<span class="token punctuation">.</span>default<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component<span class="token operator">:</span> ViewComponent<span class="token punctuation">,</span> route <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ¥ä¸‹æ¥éœ€è¦å¤„ç† è·¯ç”±æ‰€å¯¹åº”çš„ props</span>
  <span class="token comment">// åœ¨ vue-routerï¼Œæ˜¯å¯ä»¥é€šè¿‡ props é€‰é¡¹å°†å½“å‰è·¯ç”±çš„å‚æ•°ä¼ é€’ç»™è·¯ç”±ç»„ä»¶</span>
  <span class="token comment">// è¿™ä¸ª props é€‰é¡¹å€¼å¯ä»¥æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ã€å¯¹è±¡æˆ–è€…æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™æ®µä»£ç çš„ä¸»è¦ç›®çš„å°±æ˜¯å¤„ç†ä¸åŒç±»å‹çš„ props </span>
  
  <span class="token comment">// è¿™è¡Œä»£ç å°±æ˜¯ä»åŒ¹é…çš„è·¯ç”±è®°å½•ä¸­è·å– props é€‰é¡¹</span>
  <span class="token keyword">const</span> routePropsOption <span class="token operator">=</span> matchedRoute<span class="token punctuation">.</span>props<span class="token punctuation">[</span>currentName<span class="token punctuation">]</span>
  <span class="token comment">// æ¥ä¸‹æ¥å¯¹ props è¿›è¡Œå„ç§åˆ¤æ–­</span>
  <span class="token comment">// é¦–å…ˆåˆ¤æ–­ props æ˜¯å¦å­˜åœ¨</span>
  <span class="token keyword">const</span> routeProps <span class="token operator">=</span> routePropsOption
  	<span class="token comment">// æ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦ä¸ºå¸ƒå°”å€¼ trueï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆ props å°±æ˜¯å½“å‰çš„è·¯ç”±å‚æ•° route.params</span>
    <span class="token operator">?</span> routePropsOption <span class="token operator">===</span> <span class="token boolean">true</span>
      <span class="token operator">?</span> route<span class="token punctuation">.</span>params
  		<span class="token comment">// æ¥ä¸‹æ¥çœ‹ props æ˜¯å¦ä¸ºå‡½æ•°ï¼Œå¦‚æœæ˜¯å‡½æ•°ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯æ‰§è¡Œè¯¥å‡½æ•°ï¼Œprops å°±æ˜¯å‡½æ•°æ‰§è¡Œåçš„è¿”å›å€¼</span>
      <span class="token operator">:</span> <span class="token keyword">typeof</span> routePropsOption <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span>
      <span class="token operator">?</span> <span class="token function">routePropsOption</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
  		<span class="token comment">// å¦‚æœä¸æ˜¯å‡½æ•°ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯æˆ‘çš„ props</span>
      <span class="token operator">:</span> routePropsOption
    <span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token comment">// å› æ­¤è¿™é‡Œæ€»ç»“ä¸€ä¸‹ï¼Œä¸Šé¢çš„è¿™æ®µä»£ç ä¸»è¦å°±æ˜¯æ ¹æ®è·¯ç”±é…ç½®ä¸­çš„ props é€‰é¡¹æ¥ç¡®å®šç»„ä»¶çš„ props</span>
  <span class="token comment">// ä½†æ˜¯ vue-router åœ¨è®¾è®¡çš„æ—¶å€™ï¼Œprops çš„å½¢å¼æ˜¯å¤šæ ·çš„ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®ä¸åŒçš„ç±»å‹æ¥å¤„ç† props</span>

  <span class="token comment">// è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ª onVnodeUnmounted çš„é’©å­å‡½æ•°ï¼Œè¯¥é’©å­å‡½æ•°ä¼šåœ¨ç»„ä»¶è¢«å¸è½½æ—¶è°ƒç”¨</span>
  <span class="token keyword">const</span> onVnodeUnmounted<span class="token operator">:</span> VNodeProps<span class="token punctuation">[</span><span class="token string">&#39;onVnodeUnmounted&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> vnode <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™è¡Œä»£ç ä¼šæ£€æŸ¥è™šæ‹ŸèŠ‚ç‚¹æ‰€å…³è”çš„ç»„ä»¶å®ä¾‹æ˜¯å¦å·²ç»è¢«å¸è½½</span>
    <span class="token comment">// åœ¨ vue ä¸­ï¼Œæ¯ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ vnode éƒ½å¯èƒ½å…³è”ä¸€ä¸ªç»„ä»¶å®ä¾‹ï¼Œè¿™ä¸ªç»„ä»¶å®ä¾‹å¯ä»¥é€šè¿‡ vnode.component è¿›è¡Œè®¿é—®</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>component<span class="token operator">!</span><span class="token punctuation">.</span>isUnmounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿›å…¥æ­¤ ifï¼Œè¯´æ˜æ‰€å¯¹åº”çš„ç»„ä»¶å®ä¾‹å·²ç»è¢«å¸è½½</span>
      <span class="token comment">// éœ€è¦å°†å¯¹åº”çš„ç»„ä»¶å®ä¾‹ä»è·¯ç”±è®°å½•ä¸­åˆ é™¤æ‰ï¼Œä»è€Œæ¸…é™¤å¯¹å·²å¸è½½çš„ç»„ä»¶çš„å¼•ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼</span>
      matchedRoute<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>currentName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ä¸‹é¢è¿™æ®µä»£ç ä¸»è¦æ˜¯åˆ›å»ºä¸€ä¸ªè¡¨ç¤º ViewComponent çš„è™šæ‹Ÿ DOMï¼Œå¹¶ä¸”è®¾ç½®äº†ç›¸å…³çš„ propsã€attrsã€äº‹ä»¶ç›‘å¬å™¨ä»¥åŠ ref</span>
  <span class="token comment">// è¿™ä¸ªè™šæ‹Ÿ DOM éšåä¼šè¢« Vue æ¸²æŸ“ä¸ºçœŸå®çš„ DOM</span>
  <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>
    ViewComponent<span class="token punctuation">,</span>
    <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> routeProps<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      onVnodeUnmounted<span class="token punctuation">,</span>
      ref<span class="token operator">:</span> viewRef<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

	<span class="token comment">// æœ€åå‘å¤–éƒ¨è¿”å›ä¸Šé¢æ‰€ç”Ÿæˆçš„è™šæ‹Ÿ DOM</span>
  <span class="token comment">// å› ä¸ºæˆ‘ä»¬æ˜¯å¯ä»¥æä¾›ä¸€ä¸ª default æ’æ§½ï¼Œæ‰€ä»¥å¦‚æœæœ‰æ’æ§½çš„æƒ…å†µï¼Œé€šè¿‡æ’æ§½æ¥å†³å®šå¦‚ä½•ä½¿ç”¨ component å’Œ route</span>
  <span class="token comment">// å¦‚æœæ²¡æœ‰æ’æ§½ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä½¿ç”¨ component</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token function">normalizeSlot</span><span class="token punctuation">(</span>slots<span class="token punctuation">.</span>default<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component<span class="token operator">:</span> component<span class="token punctuation">,</span> route <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    component
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å…«ã€å¯¼èˆªå®ˆå«æµç¨‹è§£æ" tabindex="-1"><a class="header-anchor" href="#å…«ã€å¯¼èˆªå®ˆå«æµç¨‹è§£æ"><span>å…«ã€å¯¼èˆªå®ˆå«æµç¨‹è§£æ</span></a></h2><p>é¦–å…ˆæˆ‘ä»¬å¯¹å¯¼èˆªå®ˆå«è¿›è¡Œä¸€ä¸ªå›é¡¾ã€‚åœ¨ vue-router ä¸­ï¼Œå¯¼èˆªå®ˆå«å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»ï¼š</p><ul><li>å…¨å±€å®ˆå«ï¼šæŒ‚è½½åœ¨å…¨å±€è·¯ç”±å®ä¾‹ä¸Šé¢ï¼Œæ¯ä¸€ä¸ªå¯¼èˆªçš„æ›´æ–°éƒ½ä¼šè§¦å‘ <ul><li>å‰ç½®å®ˆå«ï¼šbeforeEach</li><li>è§£æå®ˆå«ï¼šbeforeResolve</li><li>åç½®å®ˆå«ï¼šafterEach</li></ul></li><li>è·¯ç”±ç‹¬äº«å®ˆå«ï¼šæŒ‚è½½åœ¨è·¯ç”±é…ç½®è¡¨ä¸Šé¢çš„ï¼Œå½“è¿›å…¥æŒ‡å®šè·¯ç”±çš„æ—¶å€™ä¼šè§¦å‘ <ul><li>è¿›å…¥è·¯ç”±æ—¶ï¼šbeforeEnter</li></ul></li><li>ç»„ä»¶å†…å®ˆå«ï¼šå®šä¹‰åœ¨ç»„ä»¶ä¸Šé¢çš„ï¼Œå±äºç»„ä»¶çº§åˆ«çš„å®ˆå«ï¼Œå½“åŠ è½½æˆ–è€…æ›´æ–°æŒ‡å®šç»„ä»¶æ—¶å€™ä¼šè§¦å‘ <ul><li>ç»„ä»¶æ¸²æŸ“ï¼šbeforeRouteEnter</li><li>ç»„ä»¶è·¯ç”±æ›´æ–°ï¼šbeforeRouteUpdate</li><li>ç¦»å¼€ç»„ä»¶ï¼šbeforeRouteLeave</li></ul></li></ul><p>å®Œæ•´çš„è§£ææµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="/dcblog/assets/2023-09-15-022139-DxizPX2c.png" alt="image-20230915102139386" tabindex="0" loading="lazy"><figcaption>image-20230915102139386</figcaption></figure><ol><li>å¯¼èˆªè§¦å‘ï¼Œè§¦å‘çš„å½¢å¼åŒ…æ‹¬ router.pushã€router.replaceã€router.go ç­‰ç­‰</li><li>åœ¨å¸è½½çš„ç»„ä»¶é‡Œé¢è°ƒç”¨ beforeRouteLeave å®ˆå«</li><li>è°ƒç”¨å…¨å±€çš„ beforeEach å®ˆå«ï¼Œå¼€å¯å®ˆå«çš„ç¬¬ä¸€é“æ‹¦æˆª</li><li>å®¡è§†æ–°çš„ç»„ä»¶ï¼Œåˆ¤æ–­æ–°æ—§ç»„ä»¶æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´çš„è¯ï¼Œåœ¨é‡ç”¨çš„ç»„ä»¶é‡Œè°ƒç”¨ beforeRouteUpdate å®ˆå« <ul><li>ä¾‹å¦‚å‡è®¾æœ‰ä¸€ä¸ªå¸¦æœ‰åŠ¨æ€å‚æ•°çš„è·¯å¾„ /user/:idï¼Œåœ¨ user/1 è·³è½¬åˆ° user/2 çš„æ—¶å€™ï¼Œè¿™é‡Œæ¸²æŸ“çš„ç»„ä»¶è‚¯å®šæ˜¯ç›¸åŒçš„ï¼Œå‡è®¾æ˜¯ useerDetails ç»„ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªç»„ä»¶å°±ä¼šè¢«å¤ç”¨ï¼Œæ­¤æ—¶ beforeRouteUpdate å°±ä¼šè¢«è°ƒç”¨</li></ul></li><li>è°ƒç”¨è·¯ç”±é…ç½®è¡¨ä¸­çš„ beforeEnter</li><li>æ¥ä¸‹æ¥åœ¨ç»„ä»¶çš„ setup æˆ–è€… beforeCreate ç”Ÿå‘½å‘¨æœŸä¼šè°ƒç”¨ç»„ä»¶çº§å®ˆå« beforeRouteEnterï¼Œåœ¨ç»„ä»¶æ¸²æŸ“å‰è§¦å‘ä¸€ä¸ªé’©å­</li><li>æ‰§è¡Œè§£æå®ˆå« beforeResolve</li><li>åœ¨å¯¼èˆªè¢«ç¡®è®¤ä¹‹åï¼Œå°±æ˜¯ç»„ä»¶çš„ this å¯¹è±¡ç”Ÿæˆåï¼Œä¼šè°ƒç”¨å…¨å±€åç½®å®ˆå« afterEach è¿›è¡Œæ‹¦æˆª</li><li>è§¦å‘ DOM æ›´æ–°</li><li>é”€æ¯ç»„ä»¶å‰ï¼ˆæ‰§è¡Œ Unmountedï¼‰ï¼Œä¼šè°ƒç”¨ beforeRouteLeave å®ˆå«</li></ol><h3 id="_1-å¯¼èˆªå®ˆå«ç›¸å…³æºç " tabindex="-1"><a class="header-anchor" href="#_1-å¯¼èˆªå®ˆå«ç›¸å…³æºç "><span>1. å¯¼èˆªå®ˆå«ç›¸å…³æºç </span></a></h3><p>å½“å¯¼èˆªè§¦å‘çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªåä¸º navigate çš„æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œè¿™ä¸ª navigate æ–¹æ³•å°±å¤„ç†äº†å¯¼èˆªå®ˆå«çš„ç›¸å…³é€»è¾‘ï¼Œnavigate æ–¹æ³•ä½äº router.ts æ–‡ä»¶ä¸‹é¢ï¼Œæ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span>to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span> from<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> guards<span class="token operator">:</span> Lazy<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>leavingRecords<span class="token punctuation">,</span> updatingRecords<span class="token punctuation">,</span> enteringRecords<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">extractChangingRecords</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">)</span>

  guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
    leavingRecords<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&#39;beforeRouteLeave&#39;</span><span class="token punctuation">,</span>
    to<span class="token punctuation">,</span>
    from
  <span class="token punctuation">)</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> leavingRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    record<span class="token punctuation">.</span>leaveGuards<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>guard <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> canceledNavigationCheck <span class="token operator">=</span> <span class="token function">checkCanceledNavigationAndReject</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    to<span class="token punctuation">,</span>
    from
  <span class="token punctuation">)</span>

  guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token comment">// ...</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token comment">// ...</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token comment">// ...</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token comment">// ...</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span>
       <span class="token comment">// ...</span>
      <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿™é‡Œé“¾å¼è°ƒç”¨äº† promiseï¼Œæ¯ä¸€ä¸ª promise çš„å¤„ç†å°±æ˜¯å¤„ç†ä¸€ç§ç±»å‹çš„å¯¼èˆªå®ˆå«ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥é€æ­¥è§£ææ–¹æ³•çš„å„ä¸ªéƒ¨åˆ†ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">let</span> guards<span class="token operator">:</span> Lazy<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™é‡Œå£°æ˜äº†ä¸€ä¸ªåä¸º guards çš„æ•°ç»„ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªæ•°ç»„çœ‹ä½œæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—é‡Œé¢ä¼šå­˜æ”¾è¦å¤„ç†çš„å®ˆå«å›è°ƒï¼ˆguardï¼‰ï¼Œå¹¶ä¸”è¿™äº›å®ˆå«å›è°ƒä¸æ˜¯ç®€å•çš„æ”¾è¿›å»ï¼Œè€Œæ˜¯ä¼šè¢«è½¬ä¸º promise å­˜æ”¾è¿›å»ã€‚</p><h4 id="extractchangingrecords" tabindex="-1"><a class="header-anchor" href="#extractchangingrecords"><span>extractChangingRecords</span></a></h4><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>leavingRecords<span class="token punctuation">,</span> updatingRecords<span class="token punctuation">,</span> enteringRecords<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">extractChangingRecords</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>extract æ˜¯â€œæå–â€çš„æ„æ€ï¼Œè¯¥æ–¹æ³•è¡¨ç¤ºä»å½“å‰è·¯ç”±å’Œç›®æ ‡è·¯ç”±ä¸­æå–ç¦»å¼€çš„è·¯ç”±è®°å½•ï¼ˆleavingRecordsï¼‰ã€æ›´æ–°çš„è·¯ç”±è®°å½•ï¼ˆupdatingRecordsï¼‰ä»¥åŠæ–°è¿›å…¥çš„è·¯ç”±è®°å½•ï¼ˆenteringRecordsï¼‰</p><p>extractChangingRecords æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">extractChangingRecords</span><span class="token punctuation">(</span>to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span> from<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ¥ä¸‹æ¥å£°æ˜äº† 3 ä¸ªæ•°ç»„</span>
  
  <span class="token comment">// å­˜æ”¾è¦ç¦»å¼€çš„è·¯ç”±è®°å½•</span>
  <span class="token keyword">const</span> leavingRecords<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// å­˜æ”¾è¦æ›´æ–°çš„è·¯ç”±è®°å½•</span>
  <span class="token keyword">const</span> updatingRecords<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// å­˜æ”¾æ–°è¿›å…¥çš„è·¯ç”±è®°å½•</span>
  <span class="token keyword">const</span> enteringRecords<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// è¿™é‡Œæ˜¯åœ¨å» to å’Œ from æ‰€å¯¹åº”çš„ matched æ•°ç»„çš„æœ€å¤§å€¼</span>
  <span class="token comment">// å› ä¸ºè¿™é‡Œ to å’Œ from å¯¹åº”çš„ matched éƒ½éœ€è¦éå†ï¼Œä½†æ˜¯ä¸¤è€…çš„é•¿åº¦å¯èƒ½æ˜¯ä¸ä¸€è‡´</span>
  <span class="token comment">// ä¸ºäº†èƒ½å¤Ÿå…¨éƒ¨éå†ï¼Œè¿™é‡Œå–æœ€å¤§å€¼</span>
  <span class="token comment">// å‡è®¾ from çš„ matched çš„é•¿åº¦ä¸º 3ï¼Œ to çš„ matched çš„é•¿åº¦ä¸º 5ï¼Œè¿™é‡Œå°±åº”è¯¥ä»¥ 5 ä¸ºåŸºç¡€</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">,</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é¦–å…ˆæˆ–è€… from é‡Œé¢å¯¹åº”çš„ matched çš„å½“å‰é¡¹ç›®</span>
    <span class="token keyword">const</span> recordFrom <span class="token operator">=</span> from<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token comment">// ä¸€å®šè¦åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ¤æ–­æ˜¯å¦å’Œ to ä¸­å­˜åœ¨ç›¸åŒçš„è·¯ç”±è®°å½•ï¼Œå¦‚æœå­˜åœ¨ï¼Œè¯´æ˜è¯¥è·¯ç”±è®°å½•éœ€è¦æ›´æ–°ï¼Œæ‰€ä»¥å°†å…¶æ·»åŠ åˆ°æ›´æ–°çš„æ•°ç»„é‡Œé¢</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>record <span class="token operator">=&gt;</span> <span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> recordFrom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        updatingRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span>
      <span class="token comment">// å¦‚æœä¸å­˜åœ¨ç›¸åŒçš„è·¯ç”±è®°å½•ï¼Œé‚£ä¹ˆè¯´æ˜è¯¥è·¯ç”±æ­£åœ¨ç¦»å¼€ï¼Œå°†å…¶æ·»åŠ åˆ°ç¦»å¼€çš„æ•°ç»„</span>
      <span class="token keyword">else</span> leavingRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">const</span> recordTo <span class="token operator">=</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token comment">// å¦‚æœ recordTo å­˜åœ¨ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¯¥è·¯ç”±è®°å½•åœ¨ç›®æ ‡è·¯ç”±ä¸­å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>record <span class="token operator">=&gt;</span> <span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> recordTo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœä¸å­˜åœ¨ç›¸åŒçš„è·¯ç”±è®°å½•ï¼Œé‚£ä¹ˆè¯´æ˜è¯¥è·¯ç”±è®°å½•æ­£åœ¨è¿›å…¥ï¼Œå°†å…¶æ·»åŠ åˆ°è¿›å…¥çš„æ•°ç»„é‡Œé¢</span>
        enteringRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordTo<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>leavingRecords<span class="token punctuation">,</span> updatingRecords<span class="token punctuation">,</span> enteringRecords<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åæ€»ç»“ä¸€ä¸‹ï¼Œè¿™æ®µä»£ç æ‰€åšçš„äº‹æƒ…å°±æ˜¯æ ¹æ®å½“å‰è·¯ç”±å’Œç›®æ ‡è·¯ç”±çš„å·®å¼‚ï¼Œæå–è¦ç¦»å¼€ã€æ›´æ–°ä»¥åŠæ–°è¿›å…¥çš„è·¯ç”±è®°å½•ï¼Œè¿™äº›æå–å‡ºæ¥çš„è·¯ç”±è®°å½•ä¼šç”¨äºåç»­çš„æ“ä½œã€‚</p><h4 id="extractcomponentsguards" tabindex="-1"><a class="header-anchor" href="#extractcomponentsguards"><span>extractComponentsGuards</span></a></h4><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
  leavingRecords<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">&#39;beforeRouteLeave&#39;</span><span class="token punctuation">,</span>
  to<span class="token punctuation">,</span>
  from
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥æ–¹æ³•ä»åå­—ä¸Šé¢åŸºæœ¬ä¸Šå°±èƒ½å¤ŸçŒœåˆ°å®ƒæ˜¯åšä»€ä¹ˆçš„ï¼šæå–ç»„ä»¶ä¸Šé¢çš„å®ˆå«å‡½æ•°</p><p>è¯¥æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
  <span class="token comment">// æ ¹æ® to å’Œ from æå–å‡ºæ¥çš„è·¯ç”±è®°å½•ï¼Œå€¼ä¸ºä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€ï¼š</span>
  <span class="token comment">// leavingRecordsã€updatingRecordsã€enteringRecords</span>
  matched<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// å®ˆå«çš„ç±»å‹ï¼Œå€¼å¯ä»¥æ˜¯ beforeRouteEnterã€beforeRouteUpdate ä»¥åŠ beforeRouteLeave</span>
  guardType<span class="token operator">:</span> GuardType<span class="token punctuation">,</span>
  <span class="token comment">// ç›®æ ‡è·¯ç”±</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  <span class="token comment">// å½“å‰è·¯ç”±ï¼Œæˆ–è€…è¯´ç¦»å¼€çš„è·¯ç”±</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> guards<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
	<span class="token comment">// å¤–å±‚ for å¾ªç¯æ˜¯å¯¹å…¥å‚ matched è¿›è¡Œéå†ï¼Œä¿è¯ leavingRecordsã€updatingRecords æˆ–è€… enteringRecords</span>
  <span class="token comment">// é‡Œé¢æ‰€æœ‰çš„ record éƒ½èƒ½å¤Ÿå¾—åˆ°å‡ºæ¥</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å†…å±‚ for å¾ªç¯å¯¹æŸä¸ª record é‡Œé¢çš„æ‰€æœ‰ç»„ä»¶è¿›è¡Œéå†</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">in</span> record<span class="token punctuation">.</span>components<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      
      <span class="token comment">// è·å–åˆ°å¯¹åº”çš„ç»„ä»¶</span>
      <span class="token keyword">let</span> rawComponent <span class="token operator">=</span> record<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>guardType <span class="token operator">!==</span> <span class="token string">&#39;beforeRouteEnter&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>record<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>

      <span class="token comment">// åˆ¤æ–­æ˜¯å¦æ˜¯è·¯ç”±çº§åˆ«çš„ç»„ä»¶</span>
      <span class="token comment">// ä¸ç®¡ä¸‹é¢è¿›å…¥ if è¿˜æ˜¯ elseï¼Œæœ€åéƒ½ä¼šæ„å»ºå®ˆå«å›è°ƒå¯¹åº”çš„ promise é“¾</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRouteComponent</span><span class="token punctuation">(</span>rawComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        guard <span class="token operator">&amp;&amp;</span> guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> record<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// ...</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
          componentPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolved <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            <span class="token keyword">const</span> guard <span class="token operator">=</span> options<span class="token punctuation">[</span>guardType<span class="token punctuation">]</span>
            <span class="token keyword">return</span> guard <span class="token operator">&amp;&amp;</span> <span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> record<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> guards
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ extractComponentsGuards æ–¹æ³•çš„æœ€åï¼Œéƒ½ä¼šåšä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯å°†å¯¼èˆªå®ˆå«å‡½æ•°è½¬ä¸º promise æ¨å…¥åˆ°é˜Ÿåˆ—é‡Œé¢</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code>guard <span class="token operator">&amp;&amp;</span> guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> record<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™é‡Œå¯¹åº”äº†ä¸€ä¸ªæ–¹æ³• <code>guardToPromiseFn</code>ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†å¯¼èˆªå®ˆå«è½¬ä¸º promise ç„¶åæ¨å…¥åˆ°æ•°ç»„é‡Œé¢ã€‚</p><h4 id="guardtopromisefn" tabindex="-1"><a class="header-anchor" href="#guardtopromisefn"><span>guardToPromiseFn</span></a></h4><p>è¯¥æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>
  guard<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>
  guard<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  record<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>
  guard<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  record<span class="token operator">?</span><span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">,</span>
  name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  
  <span class="token comment">// è¿™æ®µä»£ç æ˜¯è·å–ä¸€ä¸ªå›è°ƒå‡½æ•°çš„æ•°ç»„ï¼Œè¿™ä¸ªå›è°ƒå°±æ˜¯ç”¨æˆ·ä¼ é€’ç»™ next æ–¹æ³•çš„å›è°ƒå‡½æ•°</span>
  <span class="token comment">// å¦‚æœæ•°ç»„ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ç»™ä¸€ä¸ªæ–°æ•°ç»„ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ enterCallbacks</span>
  <span class="token keyword">const</span> enterCallbackArray <span class="token operator">=</span>
    record <span class="token operator">&amp;&amp;</span>
    <span class="token comment">// name is defined if record is because of the function overload</span>
    <span class="token punctuation">(</span>record<span class="token punctuation">.</span>enterCallbacks<span class="token punctuation">[</span>name<span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>enterCallbacks<span class="token punctuation">[</span>name<span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token comment">// æ¥ä¸‹æ¥å‘å¤–éƒ¨è¿”å›äº†ä¸€ä¸ª promise</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      
      <span class="token comment">// å£°æ˜ next æ–¹æ³•ï¼Œè¯¥ next æ–¹æ³•å°±æ˜¯å¼€å‘è€…åœ¨ä½¿ç”¨å¯¼èˆªå®ˆå«æ—¶ï¼Œæ‰€ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°</span>
      <span class="token keyword">const</span> next<span class="token operator">:</span> <span class="token function-variable function">NavigationGuardNext</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
        valid<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> RouteLocationRaw <span class="token operator">|</span> NavigationGuardNextCallback <span class="token operator">|</span> Error
      <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// è¿™é‡Œè°ƒç”¨äº†å¯¼èˆªå®ˆå« guardï¼Œä¼ å…¥äº†åˆé€‚çš„å‚æ•°</span>
      <span class="token comment">// å°†è°ƒç”¨çš„ç»“æœå­˜å‚¨åˆ° guardReturn é‡Œé¢</span>
      <span class="token keyword">const</span> guardReturn <span class="token operator">=</span> <span class="token function">guard</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
        record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token operator">!</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        to<span class="token punctuation">,</span>
        from<span class="token punctuation">,</span>
        __DEV__ <span class="token operator">?</span> <span class="token function">canOnlyBeCalledOnce</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span> <span class="token operator">:</span> next
      <span class="token punctuation">)</span>
      
      <span class="token comment">// æ¥ä¸‹æ¥å°†è°ƒç”¨ç»“æœåŒ…è£…ä¸ºä¸€ä¸ª promise</span>
      <span class="token keyword">let</span> guardCall <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>guardReturn<span class="token punctuation">)</span>

      <span class="token comment">// å¦‚æœå¯¼èˆªå®ˆå«çš„å‚æ•°çš„ä¸ªæ•°å°äº 3ï¼Œé‚£ä¹ˆè¯´æ˜å¯¼èˆªå®ˆå«å†…éƒ¨æ²¡æœ‰ä½¿ç”¨ next å›è°ƒ</span>
      <span class="token comment">// ç›´æ¥å°† guardCall è®¾ç½®ä¸º guardCall.then(next)</span>
      <span class="token comment">// è¿™æ ·å¯ä»¥ä¿è¯å†…éƒ¨æ²¡æœ‰ä½¿ç”¨ next ä¹Ÿèƒ½å¤Ÿæ­£å¸¸å·¥ä½œ</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>guard<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> guardCall <span class="token operator">=</span> guardCall<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> guard<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ....</span>
      <span class="token punctuation">}</span>
      guardCall<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹ next æ–¹æ³•çš„å®ç°ï¼Œé¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯å›é¡¾ä¸€ä¸‹ next æ–¹æ³•çš„ç”¨æ³•ï¼š</p><ul><li>next( ) ï¼šè¡¨ç¤ºæ— ä»»ä½•æ‹¦æˆª</li><li>next(new Error(&#39;error message&#39;)) ï¼šè¡¨ç¤ºæ‹¦æˆªæˆåŠŸï¼Œç»ˆæ­¢è·¯ç”±è·³è½¬</li><li>next(true || false) ï¼štrue å…è®¸è·³è½¬ï¼Œfalse è¡¨ç¤ºç»ˆæ­¢è·³è½¬</li><li>next(&#39;/index&#39;) æˆ–è€… next({path: &#39;/index&#39;}) ï¼šè¿™ç§æƒ…å†µä¼šå¯¼è‡´æ­»å¾ªç¯ï¼Œä¹Ÿä¼šè¢«æ‹¦æˆªä¸‹æ¥</li><li>next(callback) ï¼šæ‰§è¡Œå›è°ƒå‡½æ•°</li></ul><p>next éƒ¨åˆ†çš„æºç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> next<span class="token operator">:</span> <span class="token function-variable function">NavigationGuardNext</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  valid<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> RouteLocationRaw <span class="token operator">|</span> NavigationGuardNextCallback <span class="token operator">|</span> Error
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¦‚æœå‚æ•°æ˜¯ falseï¼Œè¿›è¡Œè·¯ç”±æ‹¦æˆªï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>valid <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>
      <span class="token generic-function"><span class="token function">createRouterError</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationFailure<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
        ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_ABORTED</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          from<span class="token punctuation">,</span>
          to<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>valid <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ª Errorï¼Œè¿›è¡Œè·¯ç”±æ‹¦æˆª</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>valid<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRouteLocation</span><span class="token punctuation">(</span>valid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªè·¯ç”±è·¯å¾„ï¼Œä¼šè¿›è¡Œé‡å®šå‘ï¼Œæ­¤æ—¶ä¹Ÿéœ€è¦æŠ›å‡ºå¼‚å¸¸å¹¶æ‹¦æˆª</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>
      <span class="token generic-function"><span class="token function">createRouterError</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationRedirectError<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
        ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_GUARD_REDIRECT</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          from<span class="token operator">:</span> to<span class="token punctuation">,</span>
          to<span class="token operator">:</span> valid<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœæ˜¯å›è°ƒå‡½æ•°ï¼Œå°†è¿™ä¸ªå›è°ƒå‡½æ•°æ·»åŠ åˆ° record.enterCallbacks[name]ï¼Œç­‰å¾…å¯¼èˆªç¡®è®¤åå†æ‰§è¡Œ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      enterCallbackArray <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// since enterCallbackArray is truthy, both record and name also are</span>
      record<span class="token operator">!</span><span class="token punctuation">.</span>enterCallbacks<span class="token punctuation">[</span>name<span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">===</span> enterCallbackArray <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">typeof</span> valid <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      enterCallbackArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>valid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="runguardqueue" tabindex="-1"><a class="header-anchor" href="#runguardqueue"><span>runGuardQueue</span></a></h4><p>è¯¥æ–¹æ³•çœ‹åå­—æˆ‘ä»¬å°±çŸ¥é“ï¼Œæ˜¯ç”¨æ¥æ‰§è¡Œæ•´ä¸ªå¯¼èˆªå®ˆå«é˜Ÿåˆ—çš„</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// è¿™é‡Œæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯å¯¼èˆªå®ˆå«é˜Ÿåˆ—</span>
<span class="token keyword">function</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token operator">:</span> Lazy<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä½¿ç”¨ reduce æ–¹æ³•å¯¹ guards æ•°ç»„è¿›è¡Œä¸€ä¸ªè¿­ä»£ï¼Œé€ä¸ªæ‰§è¡Œå¯¼èˆªå®ˆå«ï¼Œå¹¶å°†å®ƒä»¬ä¸²è”èµ·æ¥å½¢æˆä¸€ä¸ª promise é“¾</span>
  <span class="token keyword">return</span> guards<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> guard<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">runWithContext</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// è¿™æ˜¯ reduce æ–¹æ³•çš„åˆå§‹åŒ–å€¼ï¼Œè¡¨ç¤ºåˆå§‹å€¼æ˜¯ä¸€ä¸ªå·²å†³çš„ Promise</span>
    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-å¯¼èˆªå®ˆå«æ‰§è¡Œæµç¨‹" tabindex="-1"><a class="header-anchor" href="#_2-å¯¼èˆªå®ˆå«æ‰§è¡Œæµç¨‹"><span>2. å¯¼èˆªå®ˆå«æ‰§è¡Œæµç¨‹</span></a></h3><h4 id="beforerouteleave" tabindex="-1"><a class="header-anchor" href="#beforerouteleave"><span>beforeRouteLeave</span></a></h4><p>è¯¥å¯¼èˆªå®ˆå«ä¼šåœ¨ç»„ä»¶å¤±æ´»çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œå¯¹åº”çš„ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token comment">// é¦–å…ˆä»ç»„ä»¶ä¸­æå– beforeRouteLeave ç±»å‹çš„å¯¼èˆªå®ˆå«</span>
<span class="token comment">// å°†å…¶æ”¾å…¥åˆ° guards é˜Ÿåˆ—é‡Œé¢</span>
guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
  leavingRecords<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">&#39;beforeRouteLeave&#39;</span><span class="token punctuation">,</span>
  to<span class="token punctuation">,</span>
  from
<span class="token punctuation">)</span>

<span class="token comment">// å°† record.leaveGuards é‡Œé¢çš„å®ˆå«å›è°ƒä¹Ÿæ”¾å…¥åˆ° guards æ•°ç»„é‡Œé¢</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> leavingRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  record<span class="token punctuation">.</span>leaveGuards<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>guard <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ‰§è¡Œ</span>
<span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="beforeeach" tabindex="-1"><a class="header-anchor" href="#beforeeach"><span>beforeEach</span></a></h4><p>è¿™æ˜¯å…¨å±€å‰ç½®å®ˆå«ï¼Œå¯¹åº”çš„æ‰§è¡Œä»£ç å¦‚ä¸‹ï¼š</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// é¦–å…ˆå°†é˜Ÿåˆ—æ¸…ç©º</span>
  guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// æ‹¿åˆ°æ‰€æœ‰ beforeEach ç±»å‹çš„å®ˆå«å›è°ƒ</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> beforeGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è½¬ä¸º promise æ¨å…¥åˆ° guards æ•°ç»„é‡Œé¢</span>
    guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

  <span class="token comment">// æ‰§è¡Œ</span>
  <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="beforerouteupdate" tabindex="-1"><a class="header-anchor" href="#beforerouteupdate"><span>beforeRouteUpdate</span></a></h4><p>æ¥ä¸‹æ¥æ˜¯ beforeRouteUpdate ç±»å‹çš„å®ˆå«å›è°ƒ</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™ç§ç±»å‹çš„å®ˆå«å›è°ƒæ˜¯å±äºç»„ä»¶çº§åˆ«çš„</span>
  <span class="token comment">// æ‰€ä»¥å…ˆä»ç»„ä»¶ä¸Šé¢å»æå–å¯¹åº”å®ˆå«å›è°ƒï¼Œè¿™é‡Œè¦ä»ç»„ä»¶æå–ï¼Œå°±è°ƒç”¨å‰é¢ä»‹ç»è¿‡çš„ extractComponentsGuards</span>
  guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
    updatingRecords<span class="token punctuation">,</span>
    <span class="token string">&#39;beforeRouteUpdate&#39;</span><span class="token punctuation">,</span>
    to<span class="token punctuation">,</span>
    from
  <span class="token punctuation">)</span>

  <span class="token comment">// å°† record.updateGuards é‡Œé¢çš„å›è°ƒä¹Ÿæ¨å…¥åˆ° guards æ•°ç»„é‡Œé¢</span>
  <span class="token comment">// æ³¨æ„ä»ç„¶æ˜¯è½¬ä¸ºäº† promise åæ‰æ¨å…¥è¿›å»çš„</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> updatingRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    record<span class="token punctuation">.</span>updateGuards<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>guard <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

  <span class="token comment">// æ‰§è¡Œ</span>
  <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="beforeenter" tabindex="-1"><a class="header-anchor" href="#beforeenter"><span>beforeEnter</span></a></h4><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// é¦–å…ˆæ¸…ç©ºé˜Ÿåˆ—</span>
  guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// beforeEnter æ˜¯è·¯ç”±ç‹¬äº«å®ˆå«</span>
  <span class="token comment">// éå† enteringRecords</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> enteringRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æŸ¥çœ‹å½“å‰éå†åˆ°çš„ record é¡¹æ˜¯å¦å­˜åœ¨ beforeEnter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ¥ä¸‹é‡Œä¼šåˆ¤æ–­æ˜¯å¦æ˜¯æ•°ç»„ï¼Œå¦‚æœæ˜¯æ•°ç»„ï¼Œå°±å¤šäº†ä¸€æ¬¡éå†è€Œå·²</span>
      <span class="token comment">// æ€»ä¹‹æœ€åä»ç„¶æ˜¯å°†å¯¹åº”çš„å®ˆå«å›è°ƒè½¬ä¸º promise æ¨å…¥åˆ° guards æ•°ç»„</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> beforeEnter <span class="token keyword">of</span> record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>beforeEnter<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

  <span class="token comment">// æ‰§è¡Œ</span>
  <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="beforerouterenter" tabindex="-1"><a class="header-anchor" href="#beforerouterenter"><span>beforeRouterEnter</span></a></h4><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>record <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>enterCallbacks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// ä»ç»„ä»¶ä¸Šé¢å»æå– beforeRouteEnter ç±»å‹çš„å®ˆå«å›è°ƒ</span>
  guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
    enteringRecords<span class="token punctuation">,</span>
    <span class="token string">&#39;beforeRouteEnter&#39;</span><span class="token punctuation">,</span>
    to<span class="token punctuation">,</span>
    from
  <span class="token punctuation">)</span>
  guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

  <span class="token comment">// æ‰§è¡Œ</span>
  <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="beforeresolve" tabindex="-1"><a class="header-anchor" href="#beforeresolve"><span>beforeResolve</span></a></h4><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ¸…ç©ºé˜Ÿåˆ—</span>
  guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// å°†æ‰€æœ‰ beforeResolve ç±»å‹çš„å®ˆå«å›è°ƒè½¬ä¸º promise åæ¨å…¥åˆ° guards æ•°ç»„</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> beforeResolveGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>

  <span class="token comment">// æ‰§è¡Œ</span>
  <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="aftereach" tabindex="-1"><a class="header-anchor" href="#aftereach"><span>afterEach</span></a></h4><p>afterEach ä½œä¸ºå…¨å±€åç½®å®ˆå«ï¼Œå®ƒçš„è§¦å‘æ˜¯åœ¨ navigate æ–¹æ³•è°ƒç”¨å®Œæ¯•å</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token function">navigate</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> NavigationRedirectError<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>failure<span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token comment">// ...</span>

  <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span>
    toLocation <span class="token keyword">as</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
    from<span class="token punctuation">,</span>
    failure
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼ŒafterEach çš„æ‰§è¡Œå°±æ˜¯åœ¨ triggerAfterEach æ–¹æ³•é‡Œé¢ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span>
  to<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  failure<span class="token operator">?</span><span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  afterGuards
    <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>guard <span class="token operator">=&gt;</span> <span class="token function">runWithContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/dcbestwords/dcBlog/edit/main/src/source_code/vue_related/vue-router4.x.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 1114686398@qq.com">dachao</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/dcblog/source_code/vue_related/mini-pinia.html" aria-label="å®ç°mini-Pinia"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->å®ç°mini-Pinia</div></a><!----></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">é»˜è®¤é¡µè„š</div><div class="vp-copyright">Copyright Â© 2024 Dachao </div></footer></div><!--]--><!--[--><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/dcblog/assets/app-DX_yn-pD.js" defer></script>
  </body>
</html>
